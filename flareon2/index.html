<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Julien Perrot @nieluj">
<title>Flare On 2 write-up</title>
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove the comments around the @import statement below when using this as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:0.85em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
#map_canvas img,#map_canvas embed,#map_canvas object,.map_canvas img,.map_canvas embed,.map_canvas object{max-width:none!important}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
.antialiased,body{-webkit-font-smoothing:antialiased}
img{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{display:inline-block;color:rgba(0,0,0,.8);font-size:.75em;line-height:1.4;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:-.15em .15em 0 .15em;padding:.2em .6em .2em .5em;vertical-align:middle;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.05em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.spread{width:100%}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1{padding-right:.75em;font-weight:bold}
td.hdlist1,td.hdlist2{vertical-align:top}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none}
span.footnote,span.footnoteref{vertical-align:super;font-size:.875em}
span.footnote a,span.footnoteref a{text-decoration:none}
span.footnote a:active,span.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em;line-height:1.3;font-size:.875em;margin-left:1.2em;text-indent:-1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
body{font-size:.9em}
h1,h2{letter-spacing:-.01em}
dt,th.tableblock,td.content{text-rendering:optimizeLegibility}
p,td.content{letter-spacing:-.01em}
p strong,td.content strong{letter-spacing:-.005em}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img{page-break-inside:avoid}
thead{display:table-header-group}
img{max-width:100%!important}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}

</style>
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-right">
<div id="header">
<h1>Flare On 2 write-up</h1>
<div class="details">
<span id="author" class="author">Julien Perrot @nieluj</span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">2015-10-04</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of contents</div>
<ul class="sectlevel1">
<li><a href="#_level_1">Level 1</a></li>
<li><a href="#_level_2">Level 2</a></li>
<li><a href="#_level_3">Level 3</a></li>
<li><a href="#_level_4">Level 4</a></li>
<li><a href="#_level_5">Level 5</a></li>
<li><a href="#_level_6">Level 6</a></li>
<li><a href="#_level_7">Level 7</a></li>
<li><a href="#_level_8">Level 8</a></li>
<li><a href="#_level_9">Level 9</a></li>
<li><a href="#_level_10">Level 10</a></li>
<li><a href="#_level_11">Level 11</a>
<ul class="sectlevel2">
<li><a href="#_cryptographic_algorithms">Cryptographic algorithms</a></li>
<li><a href="#_top_down_analysis">Top-down analysis</a>
<ul class="sectlevel3">
<li><a href="#_function_decrypt_and_write_secret">Function decrypt_and_write_secret</a></li>
<li><a href="#_function_decrypt_blocks">Function decrypt_blocks</a></li>
<li><a href="#_function_write_secret">Function write_secret</a></li>
</ul>
</li>
<li><a href="#_tl_dr_version">TL;DR version</a></li>
<li><a href="#_cryptograph_rb">cryptograph.rb</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This document illustrates the methodology followed to solve the 11 levels that constitute the 2015 edition
of the Flare Challenge.</p>
</div>
<div class="paragraph">
<p>Since the end of the contest, a few other write-ups were published on the Internet:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.fireeye.com/blog/threat-research/2015/09/flare-on_challenges.html" class="bare">https://www.fireeye.com/blog/threat-research/2015/09/flare-on_challenges.html</a></p>
</li>
<li>
<p><a href="https://blog.trailofbits.com/2015/09/09/flare-on-reversing-challenges-2015/" class="bare">https://blog.trailofbits.com/2015/09/09/flare-on-reversing-challenges-2015/</a></p>
</li>
<li>
<p><a href="http://acidshout.github.io/" class="bare">http://acidshout.github.io/</a></p>
</li>
<li>
<p><a href="http://mshetta.blogspot.co.uk/2015/09/flare-on-2015-walkthrough.html" class="bare">http://mshetta.blogspot.co.uk/2015/09/flare-on-2015-walkthrough.html</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The binaries are still provided by the Flare team at <a href="http://flare-on.com/files/2015_FLAREOn_Challenges.zip" class="bare">http://flare-on.com/files/2015_FLAREOn_Challenges.zip</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_level_1">Level 1</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first level of the challenge requires to examine a file named <code>i_am_happy_you_are_to_playing_the_flareon_challenge.exe</code>.</p>
</div>
<div class="paragraph">
<p>When started, the program asks for a password and will print <code>You are failure</code>, as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>C:\temp&gt;i_am_happy_you_are_to_playing_the_flareon_challenge.exe
Let's start out easy
Enter the password&gt; hello_flare
You are failure</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using IDA, it is possible to decompile the code from the entry point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-n">BOOL</span> <span class="tok-nf">start</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
  <span class="tok-n">HANDLE</span> <span class="tok-n">v0</span><span class="tok-p">;</span> <span class="tok-c1">// ST18_4@1</span>
  <span class="tok-kt">int</span> <span class="tok-n">v1</span><span class="tok-p">;</span> <span class="tok-c1">// ecx@1</span>
  <span class="tok-n">HANDLE</span> <span class="tok-n">hFile</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+8h] [bp-8h]@1</span>
  <span class="tok-n">DWORD</span> <span class="tok-n">NumberOfBytesWritten</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+Ch] [bp-4h]@1</span>

  <span class="tok-n">v0</span> <span class="tok-o">=</span> <span class="tok-n">GetStdHandle</span><span class="tok-p">(</span><span class="tok-mh">0xFFFFFFF6</span><span class="tok-p">);</span>
  <span class="tok-n">hFile</span> <span class="tok-o">=</span> <span class="tok-n">GetStdHandle</span><span class="tok-p">(</span><span class="tok-mh">0xFFFFFFF5</span><span class="tok-p">);</span>
  <span class="tok-n">WriteFile</span><span class="tok-p">(</span><span class="tok-n">hFile</span><span class="tok-p">,</span> <span class="tok-n">aLetSStartOutEa</span><span class="tok-p">,</span> <span class="tok-mh">0x2Au</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">NumberOfBytesWritten</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
  <span class="tok-n">ReadFile</span><span class="tok-p">(</span><span class="tok-n">v0</span><span class="tok-p">,</span> <span class="tok-n">byte_402158</span><span class="tok-p">,</span> <span class="tok-mh">0x32u</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">NumberOfBytesWritten</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
  <span class="tok-n">v1</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
  <span class="tok-k">while</span> <span class="tok-p">(</span> <span class="tok-p">((</span><span class="tok-kt">unsigned</span> <span class="tok-kr">__int8</span><span class="tok-p">)</span><span class="tok-n">byte_402158</span><span class="tok-p">[</span><span class="tok-n">v1</span><span class="tok-p">]</span> <span class="tok-o">^</span> <span class="tok-mh">0x7D</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-n">byte_402140</span><span class="tok-p">[</span><span class="tok-n">v1</span><span class="tok-p">]</span> <span class="tok-p">)</span>
  <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-o">++</span><span class="tok-n">v1</span> <span class="tok-o">&gt;=</span> <span class="tok-mi">24</span> <span class="tok-p">)</span>
      <span class="tok-k">return</span> <span class="tok-n">WriteFile</span><span class="tok-p">(</span><span class="tok-n">hFile</span><span class="tok-p">,</span> <span class="tok-n">aYouAreSuccess</span><span class="tok-p">,</span> <span class="tok-mh">0x12u</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">NumberOfBytesWritten</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
  <span class="tok-k">return</span> <span class="tok-n">WriteFile</span><span class="tok-p">(</span><span class="tok-n">hFile</span><span class="tok-p">,</span> <span class="tok-n">aYouAreFailure</span><span class="tok-p">,</span> <span class="tok-mh">0x12u</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">NumberOfBytesWritten</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The input string is stored at address <code>0x402158</code> and each byte is compared to a byte array at address <code>0x402140</code>,
after being xor-ed with the value <code>0x7d</code>.</p>
</div>
<div class="paragraph">
<p>The ruby script below can be used to read the <code>0x18</code> bytes at address <code>0x402140</code> (offset <code>0x540</code> in the file),
to apply a xor operation on each byte with the value 0x7d and then return the expected string.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-no">OFFSET</span> <span class="tok-o">=</span> <span class="tok-mh">0x540</span>
<span class="tok-no">COUNT</span> <span class="tok-o">=</span> <span class="tok-mh">0x18</span>

<span class="tok-n">f</span> <span class="tok-o">=</span> <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;i_am_happy_you_are_to_playing_the_flareon_challenge.exe&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;rb&quot;</span><span class="tok-p">)</span>

<span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">seek</span><span class="tok-p">(</span><span class="tok-no">OFFSET</span><span class="tok-p">,</span> <span class="tok-no">IO</span><span class="tok-o">::</span><span class="tok-no">SEEK_CUR</span><span class="tok-p">)</span>

<span class="tok-nb">p</span> <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-no">COUNT</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">map</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">x</span><span class="tok-o">|</span> <span class="tok-n">x</span> <span class="tok-o">^</span> <span class="tok-mh">0x7d</span><span class="tok-p">}</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>

<span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">close</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By running this script, we can obtain the validation email for the first level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>C:\temp&gt;ruby solve_01.rb
"bunny_sl0pe@flare-on.com"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_level_2">Level 2</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This level requires to analyze the provided program, <code>very_success.exe</code>. At first,
it looks quite similar to the previous level: when started, it asks for a password
and then prints the same message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>C:\temp&gt;very_success.exe
You crushed that last one! Let's up the game.
Enter the password&gt; AAAAA
You are failure</code></pre>
</div>
</div>
<div class="paragraph">
<p>As shown below, the entry point starts by calling the function at address <code>0x401000</code>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_02_001.png" alt="level_02_001" width="800"></span></p>
</div>
<div class="paragraph">
<p>Interestingly, this function pops the return address from the stack, which is equal to <code>0x4010E4</code>,
and stores it in a local variable (renamed <code>ref_data</code> in IDA) :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_02_002.png" alt="level_02_002" width="800"></span></p>
</div>
<div class="paragraph">
<p>The rest of the function prints a bunch of string on the standard output, reads at most 50 bytes
from the standard input and calls the function at address <code>0x401084</code> :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_02_003.png" alt="level_02_003" width="800"></span></p>
</div>
<div class="paragraph">
<p>This function takes three arguments: the return address from function <code>0x401000</code>, the string
read from the standard input and the number of bytes read. This last value is compared to <code>0x25</code>: if equal, the execution continues at
address <code>0x401098</code>, otherwise the function returns 0.</p>
</div>
<div class="paragraph">
<p>The function then starts a loop, reading each byte from the input, applying a certain operation on it and then
comparing the result with the data referenced by <code>ref_data</code>, starting from the end.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_02_004.png" alt="level_02_004" width="700"></span></p>
</div>
<div class="paragraph">
<p>The comparison is :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>input_string[i] ^ 0xC7 + ROL(1, bx &amp; 3) + 1 == ref_data[0x25 - 1 - i]</code></pre>
</div>
</div>
<div class="paragraph">
<p>As this is clearly reversible, it is possible to obtain the expected string by
applying the reverse operation on the data referenced at address <code>0x4010E4</code>, using
the Ruby script below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-no">OFFSET</span> <span class="tok-o">=</span> <span class="tok-mh">0x2E4</span> <span class="tok-c1"># ref_data</span>

<span class="tok-n">input</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;very_success.exe&quot;</span>

<span class="tok-n">f</span><span class="tok-o">=</span> <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-n">input</span><span class="tok-p">,</span> <span class="tok-s2">&quot;rb&quot;</span><span class="tok-p">)</span>
<span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">seek</span><span class="tok-p">(</span><span class="tok-no">OFFSET</span><span class="tok-p">)</span>
<span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-mh">0x25</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>
<span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">close</span>

<span class="tok-n">bx</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
<span class="tok-n">res</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
<span class="tok-n">data</span><span class="tok-o">.</span><span class="tok-n">reverse</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">b</span><span class="tok-o">|</span>

  <span class="tok-n">shift</span> <span class="tok-o">=</span> <span class="tok-n">bx</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0x3</span>
  <span class="tok-n">c</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">b</span> <span class="tok-o">-</span> <span class="tok-p">(</span><span class="tok-mi">1</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-mi">1</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">shift</span><span class="tok-p">)))</span> <span class="tok-o">^</span> <span class="tok-mh">0xc7</span>

  <span class="tok-n">res</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">c</span>
  <span class="tok-n">bx</span> <span class="tok-o">+=</span> <span class="tok-n">b</span>
<span class="tok-k">end</span>
<span class="tok-nb">p</span> <span class="tok-n">res</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Executing the script returns the validation email address for this level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>C:\temp&gt;ruby solve_02.rb
"a_Little_b1t_harder_plez@flare-on.com"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_level_3">Level 3</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next file to analyze, <code>elfie.exe</code>, is quite heavy, weighing around 12MB.</p>
</div>
<div class="paragraph">
<p>When executed, the program will only display the picture below:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_03_001.jpg" alt="level_03_001"></span></p>
</div>
<div class="paragraph">
<p>It can take a while to figure out what to do: opening the
binary in a disassembler and performing a top-down analysis from the entry point is not
a very good idea because of the vast quantity of code.</p>
</div>
<div class="paragraph">
<p>When examining the strings contained in the program, many references
to Python libraries can be found:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> strings elfie.exe
<span class="tok-go">[...]</span>
<span class="tok-go">zout00-PYZ.pyz</span>
<span class="tok-go">mpyi_os_path</span>
<span class="tok-go">mpyi_archive</span>
<span class="tok-go">mpyi_importers</span>
<span class="tok-go">s_pyi_bootstrap</span>
<span class="tok-go">spyi_carchive</span>
<span class="tok-go">bMicrosoft.VC90.CRT.manifest</span>
<span class="tok-go">bmsvcr90.dll</span>
<span class="tok-go">bmsvcp90.dll</span>
<span class="tok-go">bmsvcm90.dll</span>
<span class="tok-go">bpython27.dll</span>
<span class="tok-go">bselect.pyd</span>
<span class="tok-go">bunicodedata.pyd</span>
<span class="tok-go">bPySide.QtCore.pyd</span>
<span class="tok-go">b_hashlib.pyd</span>
<span class="tok-go">bbz2.pyd</span>
<span class="tok-go">b_ssl.pyd</span>
<span class="tok-go">bPySide.QtGui.pyd</span>
<span class="tok-go">b_socket.pyd</span>
<span class="tok-go">bpyside-python2.7.dll</span>
<span class="tok-go">bshiboken-python2.7.dll</span>
<span class="tok-go">bQtCore4.dll</span>
<span class="tok-go">bQtGui4.dll</span>
<span class="tok-go">belfie.exe.manifest</span>
<span class="tok-go">python27.dll</span>
<span class="tok-go">[...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, you can google a few strings to figure out what is going on, but long
story short, this program was built using the PyInstaller tool which is
used to embed all the dependencies required to run
a Python script into a big binary file.</p>
</div>
<div class="paragraph">
<p>These dependencies can be extracted using <a href="http://sourceforge.net/projects/pyinstallerextractor/" class="bare">http://sourceforge.net/projects/pyinstallerextractor/</a> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>C:\temp&gt;c:\Python27\python.exe pyinstxtractor.py elfie.exe
Successfully extracted Pyinstaller archive : elfie.exe

Now use Easy Python Decompiler v1.1 to decompile the pyc files
Choose Uncompyle2 as the decompiler engine as the other engine
is unstable and can crash although it is very fast.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Among the extracted resources, the <code>elfie</code> file looks interesting: it is a large obfuscated
Python script (4MB, over 57K lines) which looks as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span class="tok-n">O0OO0OO00000OOOO0OOOOO0O00O0O0O0</span> <span class="tok-o">=</span> <span class="tok-s">&#39;IRGppV0FJM3BRRlNwWGhNNG&#39;</span>
<span class="tok-n">OO0O0O00OO00OOOOOO0O0O0OOO0OOO0O</span> <span class="tok-o">=</span> <span class="tok-s">&#39;UczRkNZZ0JVRHJjbnRJUWlJV3FRTkpo&#39;</span>
<span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span>
<span class="tok-n">O00OO00OOO0OOOO0OOOO0OO00000OOO0</span> <span class="tok-o">+=</span> <span class="tok-s">&#39;aTBTMXd3OC8yY0ZqdzBIU0JMT0tEcktGckJUTkpvRGw2d&#39;</span>
<span class="tok-n">O00OO00OOO0OOOO0OOOO0OO00000OOO0</span> <span class="tok-o">+=</span> <span class="tok-s">&#39;nNocTB&#39;</span>
<span class="tok-kn">import</span> <span class="tok-nn">base64</span>
<span class="tok-k">exec</span><span class="tok-p">(</span><span class="tok-n">base64</span><span class="tok-o">.</span><span class="tok-n">b64decode</span><span class="tok-p">(</span><span class="tok-n">OOO0OOOOOOOO0000O000O00O0OOOO00O</span> <span class="tok-o">+</span> <span class="tok-n">O0O00OO0OO00OO00OO00O000OOO0O000</span> <span class="tok-o">+</span> <span class="tok-p">[</span><span class="tok-o">...</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-n">O00OOOOO000O00O0O00000OOO0000OOO</span> <span class="tok-o">+</span> <span class="tok-n">O0O0OOO000O000OO0O0O0OOOOO0OO000</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Obtaining the decoded Python instructions to will be executed only requires
the <code>exec</code> call to be replaced by <code>print</code> and that the standard output be redirected to a new file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>C:\temp&gt;c:\Python27\python.exe elfie &gt; elfie-decoded.py</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting Python file is still obfuscated, but a method at line 13 looks interesting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span class="tok-k">def</span> <span class="tok-nf">O000OOOOOO0OOOO00000OO0O0O000OO0</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
      <span class="tok-n">O0O0O0000OOO000O00000OOO000OO000</span> <span class="tok-o">=</span> <span class="tok-nb">getattr</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-s">&#39;txeTnialPot&#39;</span><span class="tok-p">[::</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">])()</span>
      <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">O0O0O0000OOO000O00000OOO000OO000</span> <span class="tok-o">==</span> <span class="tok-s">&#39;&#39;</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">((</span><span class="tok-n">OO00O00OOOO00OO000O00OO0OOOO0000</span> <span class="tok-k">for</span> <span class="tok-n">OO00O00OOOO00OO000O00OO0OOOO0000</span> <span class="tok-ow">in</span> <span class="tok-nb">reversed</span><span class="tok-p">(</span><span class="tok-s">&#39;moc.no-eralf@OOOOY.sev0000L.eiflE&#39;</span><span class="tok-p">)))):</span>
              <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">OO0O0O0O0OO0OO00000OO00O0O0000O0</span><span class="tok-o">.</span><span class="tok-n">setWindowTitle</span><span class="tok-p">(</span><span class="tok-s">&#39;!sseccus taerg&#39;</span><span class="tok-p">[::</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">])</span>
              <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">OOOOOOOOOO0O0OOOOO000OO000OO0O00</span> <span class="tok-o">=</span> <span class="tok-bp">True</span>
              <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">OO0O0O0O0OO0OO00000OO00O0O0000O0</span><span class="tok-o">.</span><span class="tok-n">setVisible</span><span class="tok-p">(</span><span class="tok-bp">False</span><span class="tok-p">)</span>
              <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">OO0O0O0O0OO0OO00000OO00O0O0000O0</span><span class="tok-o">.</span><span class="tok-n">setVisible</span><span class="tok-p">(</span><span class="tok-bp">True</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The validation email is present in the source code of the script, in a reversed form. Once reversed,
the correct email address appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="irb"><span class="tok-gp">irb(main):001:0&gt; </span><span class="tok-s1">&#39;moc.no-eralf@OOOOY.sev0000L.eiflE&#39;</span><span class="tok-o">.</span><span class="tok-n">reverse</span>
<span class="tok-go">=&gt; &quot;Elfie.L0000ves.YOOOO@flare-on.com&quot;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_level_4">Level 4</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The provided file, <code>youPecks</code>, can be opened in PeID for identification:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_04_001.png" alt="level_04_001"></span></p>
</div>
<div class="paragraph">
<p>According to PeID, the binary seems packed with UPX.</p>
</div>
<div class="paragraph">
<p>Running the program only prints <code>2 + 2 = 4</code>, as illustrated below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>C:\temp&gt;youPecks.exe
2 + 2 = 4</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, after unpacking the binary with <code>upx</code>, the resulting program seems to
behave differently:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>C:\temp&gt;upx.exe -d -o youPecks-upx.exe youPecks.exe
                       Ultimate Packer for eXecutables
                          Copyright (C) 1996 - 2013
UPX 3.91w       Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Sep 30th 2013

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
     25088 &lt;-     12800   51.02%    win32/pe     youPecks-upx.exe

Unpacked 1 file.

C:\temp&gt;youPecks-upx.exe
2 + 2 = 5</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time, the program prints <code>2 + 2 = 5</code> which, obviously, is wrong. Something
seems fishy here. When opening the file in IDA, a reference to byte <code>5</code> can be found
near the string <code>2 + 2</code>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_04_005.png" alt="level_04_005" width="700"></span></p>
</div>
<div class="paragraph">
<p>At this point, it can be assumed that the upx stub in the original <code>youPecks.exe</code>
is patching the data section during the unpacking process, whereas the <code>upx</code> tool
is still using the standard decompression algorithm.</p>
</div>
<div class="paragraph">
<p>A manual unpacking can be attempted at this point. Before doing so, it is a good precaution
to disable ASLR, to ensure that the sections are mapped at the same base address
during each execution. This can be achieved using the tool <code>setdllcharacteristics</code> provided
by Didier Stevens.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>C:\temp&gt;setdllcharacteristics.exe -d youPecks.exe
Original DLLCHARACTERISTICS = 0x8140
 DYNAMIC_BASE    = 1
 NX_COMPAT       = 1
 FORCE_INTEGRITY = 0
Updated  DLLCHARACTERISTICS = 0x8100
 DYNAMIC_BASE    = 0
 NX_COMPAT       = 1
 FORCE_INTEGRITY = 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The program is then debugged through OllyDbg, a breakpoint being set just before the
jump to the original entry point (first unconditional jump after the <code>popad</code> instruction).</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_04_002.png" alt="level_04_002" width="800"></span></p>
</div>
<div class="paragraph">
<p>The unpacked sections are then dumped to a file using the plugin <code>ollydump</code> :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_04_003.png" alt="level_04_003" width="500"></span></p>
</div>
<div class="paragraph">
<p>Finally, LordPE is used to rebuild the import table :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_04_004.png" alt="level_04_004" width="500"></span></p>
</div>
<div class="paragraph">
<p>The resulting program can be run to print the string <code>2 + 2 = 4</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>C:\temp&gt;youPecks-unpacked.exe
2 + 2 = 4</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is then possible to open the binary in IDA for analysis. First, we can check
that the value <code>4</code> is present in the data section:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_04_006.png" alt="level_04_006" width="700"></span></p>
</div>
<div class="paragraph">
<p>The assembly can then be analyzed, starting from the entry point. Interesting code
can be found at location <code>0x401560</code>: the first argument of the program is converted
to an integer and a MD5 digest is computed from this value. Additionally, the current
hour is obtained through a call to <code>_localtime64_s</code> and then stored in the <code>edi</code>
register.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_04_007.png" alt="level_04_007" width="700"></span></p>
</div>
<div class="paragraph">
<p>Further down, an index is computed from the value contained in <code>edi</code> and a string
is referenced using said index. The string content is then decoded from base64.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_04_008.png" alt="level_04_008"></span></p>
</div>
<div class="paragraph">
<p>Next, each byte of the data decoded from base64 (<code>md5_ref</code> in the screenshot below)
is compared to the MD5 digest calculated from the first argument.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_04_009.png" alt="level_04_009"></span></p>
</div>
<div class="paragraph">
<p>As the digest is computed on a single byte, it is possible
to find the expected value for <code>argv[1]</code> by computing every digest from 0 to 255
and then look for the digest corresponding to <code>md5_ref</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="irb"><span class="tok-gp">irb(main):008:0&gt; </span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-o">.</span><span class="tok-n">.</span><span class="tok-mi">255</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">to_a</span><span class="tok-o">.</span><span class="tok-n">map</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">x</span><span class="tok-o">|</span> <span class="tok-o">[</span><span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-no">Digest</span><span class="tok-o">::</span><span class="tok-no">MD5</span><span class="tok-o">.</span><span class="tok-n">hexdigest</span><span class="tok-p">(</span><span class="tok-o">[</span> <span class="tok-n">x</span> <span class="tok-o">].</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">))</span><span class="tok-o">]</span><span class="tok-p">}</span><span class="tok-o">.</span><span class="tok-n">select</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">x</span><span class="tok-o">|</span> <span class="tok-n">x</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]</span> <span class="tok-o">=~</span> <span class="tok-sr">/47ed73/</span><span class="tok-p">}</span>
<span class="tok-go"> =&gt; [[17, &quot;47ed733b8d10be225eceba344d533586&quot;]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To avoid a premature exit, the first argument of the program must be <code>17</code>. When
debugging the program, it has been observed that this value matches the current
hour obtained with the call to <code>_localtime64_s</code>. To summarize, the program must be
ran with the current hour as first argument.</p>
</div>
<div class="paragraph">
<p>As there is only one call to the function responsible for calculating a MD5 digest, we can
only assume at this point that the digest for every hour is precomputed and stored in base64. For
example, for value 17, we expect to find a string corresponding to :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="irb"><span class="tok-gp">irb(main):004:0&gt; </span><span class="tok-no">Base64</span><span class="tok-o">.</span><span class="tok-n">encode64</span><span class="tok-p">(</span><span class="tok-no">Digest</span><span class="tok-o">::</span><span class="tok-no">MD5</span><span class="tok-o">.</span><span class="tok-n">digest</span><span class="tok-p">(</span><span class="tok-o">[</span><span class="tok-mi">17</span><span class="tok-o">].</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C&#39;</span><span class="tok-p">)))</span>
<span class="tok-go">=&gt; &quot;R+1zO40QviJezro0TVM1hg==\n</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same exact string cannot be found but a similar string with
upper/lowercase swapped is present in the binary:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_04_012.PNG" alt="level_04_012"></span></p>
</div>
<div class="paragraph">
<p>This can be explained by looking at the function responsible for base64 decoding. The string used
as alphabet is not in the regular order (uppercase before lowercase letters), as shown below:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_04_013.PNG" alt="level_04_013"></span></p>
</div>
<div class="paragraph">
<p>Continuing the analysis, another base64 string is decoded (referenced by the local variable <code>ciphertext</code>
in the screenshot below) and a loop is executed to apply a xor operation on each byte of the
decoded data.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_04_010.png" alt="level_04_010"></span></p>
</div>
<div class="paragraph">
<p>The result can be observed when debugging the program:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_04_011.png" alt="level_04_011"></span></p>
</div>
<div class="paragraph">
<p>Finally, these operations can be reproduced by the Ruby script below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-nb">require</span> <span class="tok-s1">&#39;base64&#39;</span>

<span class="tok-no">START_OFFSET</span> <span class="tok-o">=</span> <span class="tok-mh">0x5260</span>
<span class="tok-no">END_OFFSET</span> <span class="tok-o">=</span> <span class="tok-mh">0x585F</span>

<span class="tok-n">f</span> <span class="tok-o">=</span> <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-no">ARGV</span><span class="tok-o">.</span><span class="tok-n">shift</span><span class="tok-p">,</span> <span class="tok-s2">&quot;rb&quot;</span><span class="tok-p">)</span>

<span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">seek</span> <span class="tok-no">START_OFFSET</span>

<span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-no">END_OFFSET</span> <span class="tok-o">-</span> <span class="tok-no">START_OFFSET</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">)</span>

<span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">close</span>

<span class="tok-n">b64_strings</span> <span class="tok-o">=</span> <span class="tok-n">data</span><span class="tok-o">.</span><span class="tok-n">split</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-se">\x00\x00\x00\x00</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>

<span class="tok-n">s1</span> <span class="tok-o">=</span> <span class="tok-n">b64_strings</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">]</span>
<span class="tok-n">s2</span> <span class="tok-o">=</span> <span class="tok-n">b64_strings</span><span class="tok-o">[</span><span class="tok-mi">24</span><span class="tok-o">]</span>

<span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-no">Base64</span><span class="tok-o">.</span><span class="tok-n">decode64</span><span class="tok-p">(</span><span class="tok-n">s1</span><span class="tok-o">.</span><span class="tok-n">swapcase</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">bytes</span>
<span class="tok-n">cipher</span> <span class="tok-o">=</span> <span class="tok-no">Base64</span><span class="tok-o">.</span><span class="tok-n">decode64</span><span class="tok-p">(</span><span class="tok-n">s2</span><span class="tok-o">.</span><span class="tok-n">swapcase</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">bytes</span>

<span class="tok-nb">puts</span> <span class="tok-n">cipher</span><span class="tok-o">.</span><span class="tok-n">map</span><span class="tok-o">.</span><span class="tok-n">with_index</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">i</span><span class="tok-o">|</span> <span class="tok-n">b</span> <span class="tok-o">^</span> <span class="tok-n">key</span><span class="tok-o">[</span><span class="tok-n">i</span> <span class="tok-o">%</span> <span class="tok-mi">16</span><span class="tok-o">]</span><span class="tok-p">}</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The complete validation email can be obtained by running the script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ./solve_04.rb youPecks-ollydump_.exe
<span class="tok-go">Uhr1thm3tic@flare-on.com</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_level_5">Level 5</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The archive for this level provides two files: <code>challenge.cap</code>, a network capture
file, and <code>sender</code> which is a win32 portable executable.</p>
</div>
<div class="paragraph">
<p>The capture file contains twelve HTTP POST requests, each one transmitting 4 bytes
corresponding to 4 printable characters (<code>UDYs</code> in the screenshot below).</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_05_001.png" alt="level_05_001"></span></p>
</div>
<div class="paragraph">
<p>To understand the meaning of these 4 characters, it is necessary to disassemble
the provided binary.</p>
</div>
<div class="paragraph">
<p>The main function only calls another function, <code>sub_821100</code> :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_05_002.png" alt="level_05_002"></span></p>
</div>
<div class="paragraph">
<p>IDA does a pretty good job at decompiling this function, as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="C"><span class="tok-kt">signed</span> <span class="tok-kt">int</span> <span class="tok-nf">sub_821100</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
  <span class="tok-n">HANDLE</span> <span class="tok-n">v0</span><span class="tok-p">;</span> <span class="tok-c1">// esi@1</span>
  <span class="tok-n">DWORD</span> <span class="tok-n">bytes_count</span><span class="tok-p">;</span> <span class="tok-c1">// esi@3</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">v3</span><span class="tok-p">;</span> <span class="tok-c1">// ecx@5</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">total_size</span><span class="tok-p">;</span> <span class="tok-c1">// edi@7</span>
  <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">dest_buffer</span><span class="tok-p">;</span> <span class="tok-c1">// ebx@7</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">count</span><span class="tok-p">;</span> <span class="tok-c1">// esi@8</span>
  <span class="tok-n">DWORD</span> <span class="tok-n">NumberOfBytesRead</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+4h] [bp-80008h]@1</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kr">__int8</span> <span class="tok-n">key_data</span><span class="tok-p">[</span><span class="tok-mi">524288</span><span class="tok-p">];</span> <span class="tok-c1">// [sp+8h] [bp-80004h]@3</span>

  <span class="tok-n">NumberOfBytesRead</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
  <span class="tok-n">v0</span> <span class="tok-o">=</span> <span class="tok-n">CreateFileA</span><span class="tok-p">(</span><span class="tok-s">&quot;key.txt&quot;</span><span class="tok-p">,</span> <span class="tok-n">GENERIC_READ</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">3u</span><span class="tok-p">,</span> <span class="tok-mh">0x80u</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
  <span class="tok-n">ReadFile</span><span class="tok-p">(</span><span class="tok-n">v0</span><span class="tok-p">,</span> <span class="tok-n">key_data</span><span class="tok-p">,</span> <span class="tok-mh">0x80000u</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">NumberOfBytesRead</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
  <span class="tok-n">CloseHandle</span><span class="tok-p">(</span><span class="tok-n">v0</span><span class="tok-p">);</span>
  <span class="tok-n">bytes_count</span> <span class="tok-o">=</span> <span class="tok-n">NumberOfBytesRead</span><span class="tok-p">;</span>

  <span class="tok-n">sub_821250</span><span class="tok-p">((</span><span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">key_data</span><span class="tok-p">,</span> <span class="tok-n">NumberOfBytesRead</span><span class="tok-p">);</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">bytes_count</span> <span class="tok-o">%</span> <span class="tok-mi">3</span> <span class="tok-p">)</span>
    <span class="tok-n">v3</span> <span class="tok-o">=</span> <span class="tok-mi">3</span> <span class="tok-o">*</span> <span class="tok-p">(</span><span class="tok-n">bytes_count</span> <span class="tok-o">/</span> <span class="tok-mi">3</span><span class="tok-p">)</span> <span class="tok-o">-</span> <span class="tok-n">bytes_count</span> <span class="tok-o">+</span> <span class="tok-mi">3</span><span class="tok-p">;</span>
  <span class="tok-k">else</span>
    <span class="tok-n">v3</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
  <span class="tok-n">total_size</span> <span class="tok-o">=</span> <span class="tok-mi">4</span> <span class="tok-o">*</span> <span class="tok-p">((</span><span class="tok-n">bytes_count</span> <span class="tok-o">+</span> <span class="tok-n">v3</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-mi">3</span><span class="tok-p">);</span>
  <span class="tok-n">dest_buffer</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">sub_821427</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">total_size</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">);</span>
  <span class="tok-n">sub_8212A0</span><span class="tok-p">(</span><span class="tok-n">bytes_count</span><span class="tok-p">,</span> <span class="tok-n">key_data</span><span class="tok-p">,</span> <span class="tok-n">dest_buffer</span><span class="tok-p">,</span> <span class="tok-n">total_size</span><span class="tok-p">);</span>

  <span class="tok-n">count</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
  <span class="tok-k">while</span> <span class="tok-p">(</span> <span class="tok-n">sub_821000</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">dest_buffer</span><span class="tok-p">[</span><span class="tok-n">count</span><span class="tok-p">],</span> <span class="tok-n">count</span><span class="tok-p">)</span> <span class="tok-p">)</span> <span class="tok-p">{</span>
      <span class="tok-n">count</span> <span class="tok-o">+=</span> <span class="tok-mi">4</span><span class="tok-p">;</span>
      <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">count</span> <span class="tok-o">&gt;=</span> <span class="tok-n">total_size</span> <span class="tok-p">)</span>
	  <span class="tok-k">return</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
  <span class="tok-k">return</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Four functions then need to be analyzed to understand the whole program: <code>sub_821250</code>,
<code>sub_821427</code>, <code>sub_8212A0</code> and <code>sub_821000</code>.</p>
</div>
<div class="paragraph">
<p>The function  <code>sub_821250</code> can be decompiled to the C code below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">void</span> <span class="tok-kr">__fastcall</span> <span class="tok-nf">sub_821250</span><span class="tok-p">(</span><span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">a1</span><span class="tok-p">,</span> <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">a2</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">v2</span><span class="tok-p">;</span> <span class="tok-c1">// esi@1</span>

  <span class="tok-n">v2</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">a2</span> <span class="tok-p">)</span>
  <span class="tok-p">{</span>
    <span class="tok-k">do</span>
    <span class="tok-p">{</span>
      <span class="tok-n">a1</span><span class="tok-p">[</span><span class="tok-n">v2</span><span class="tok-p">]</span> <span class="tok-o">+=</span> <span class="tok-n">aFlarebearstare</span><span class="tok-p">[</span><span class="tok-n">v2</span> <span class="tok-o">%</span> <span class="tok-mi">14</span><span class="tok-p">];</span>
      <span class="tok-o">++</span><span class="tok-n">v2</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-k">while</span> <span class="tok-p">(</span> <span class="tok-n">v2</span> <span class="tok-o">&lt;</span> <span class="tok-n">a2</span> <span class="tok-p">);</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It takes a string as input and will add the corresponding byte in the string <code>"flarebearstare"</code> to each byte in the input string.</p>
</div>
<div class="paragraph">
<p>The function <code>sub_821427</code> is used to allocate the specified amount of memory.</p>
</div>
<div class="paragraph">
<p>The function <code>sub_8212A0</code> implements a base64 encoding function. The encoding
alphabet is constructed by storing 4 different 128 bits integers on the stack,
using SSE instructions. As with the previous level, the alphabet used for encoding
is different than the regular base64 alphabet: lowercase letters have been swapped
with the uppercase letters.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_05_003.png" alt="level_05_003" width="800"></span></p>
</div>
<div class="paragraph">
<p>Finally, the function <code>sub_821000</code> is decompiled by IDA as below (without the error handling code) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">signed</span> <span class="tok-kt">int</span> <span class="tok-n">__usercall</span> <span class="tok-n">sub_821000</span><span class="tok-err">@</span><span class="tok-o">&lt;</span><span class="tok-n">eax</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">a1</span><span class="tok-err">@</span><span class="tok-o">&lt;</span><span class="tok-n">ecx</span><span class="tok-o">&gt;</span><span class="tok-p">,</span> <span class="tok-kt">char</span> <span class="tok-n">a2</span><span class="tok-err">@</span><span class="tok-o">&lt;</span><span class="tok-n">sil</span><span class="tok-o">&gt;</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">v2</span><span class="tok-p">;</span> <span class="tok-c1">// eax@1</span>
  <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">v3</span><span class="tok-p">;</span> <span class="tok-c1">// edi@1</span>
  <span class="tok-kt">signed</span> <span class="tok-kt">int</span> <span class="tok-n">result</span><span class="tok-p">;</span> <span class="tok-c1">// eax@2</span>
  <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">v5</span><span class="tok-p">;</span> <span class="tok-c1">// eax@3</span>
  <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">v6</span><span class="tok-p">;</span> <span class="tok-c1">// ebx@3</span>
  <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">v7</span><span class="tok-p">;</span> <span class="tok-c1">// eax@5</span>
  <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">v8</span><span class="tok-p">;</span> <span class="tok-c1">// esi@5</span>
  <span class="tok-n">LPVOID</span> <span class="tok-n">lpOptional</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+4h] [bp-4h]@1</span>

  <span class="tok-n">lpOptional</span> <span class="tok-o">=</span> <span class="tok-n">a1</span><span class="tok-p">;</span>
  <span class="tok-n">v2</span> <span class="tok-o">=</span> <span class="tok-n">InternetOpenA</span><span class="tok-p">(</span><span class="tok-s">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) KEY&quot;</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
  <span class="tok-n">v3</span> <span class="tok-o">=</span> <span class="tok-n">v2</span><span class="tok-p">;</span>
  <span class="tok-n">v5</span> <span class="tok-o">=</span> <span class="tok-n">InternetConnectA</span><span class="tok-p">(</span><span class="tok-n">v2</span><span class="tok-p">,</span> <span class="tok-s">&quot;localhost&quot;</span><span class="tok-p">,</span> <span class="tok-mh">0x50u</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">3u</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">1u</span><span class="tok-p">);</span>
  <span class="tok-n">v6</span> <span class="tok-o">=</span> <span class="tok-n">v5</span><span class="tok-p">;</span>
  <span class="tok-n">v7</span> <span class="tok-o">=</span> <span class="tok-n">HttpOpenRequestA</span><span class="tok-p">(</span><span class="tok-n">v5</span><span class="tok-p">,</span> <span class="tok-s">&quot;POST&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;/&quot;</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">1u</span><span class="tok-p">);</span>
  <span class="tok-n">v8</span> <span class="tok-o">=</span> <span class="tok-n">v7</span><span class="tok-p">;</span>
  <span class="tok-n">HttpSendRequestA</span><span class="tok-p">(</span><span class="tok-n">v7</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">lpOptional</span><span class="tok-p">,</span> <span class="tok-mi">4u</span><span class="tok-p">);</span>
  <span class="tok-n">InternetCloseHandle</span><span class="tok-p">(</span><span class="tok-n">v8</span><span class="tok-p">);</span>
  <span class="tok-n">InternetCloseHandle</span><span class="tok-p">(</span><span class="tok-n">v6</span><span class="tok-p">);</span>
  <span class="tok-n">InternetCloseHandle</span><span class="tok-p">(</span><span class="tok-n">v3</span><span class="tok-p">);</span>
  <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>

  <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In a nutshell, the following steps are executed by the program:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the content of the file <code>key.txt</code> is read</p>
</li>
<li>
<p>this data read previously is mixed with the string <code>flarebearstare</code></p>
</li>
<li>
<p>a new buffer is allocated to store the data encoded in base64, with the case swapped</p>
</li>
<li>
<p>finally, the base64 encoded string is sent via HTTP POST requests, 4 bytes at a time</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As the base64 encoding and the mixing operation with the string <code>flarebearstare</code> are reversible
, it is then possible to extract the payloads from the network capture file
and obtain the content of the original <code>key.txt</code> file.</p>
</div>
<div class="paragraph">
<p>The Ruby script below implements these manipulations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-nb">require</span> <span class="tok-s1">&#39;base64&#39;</span>

<span class="tok-no">FLARE_BEAR_STARE</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;flarebearstare&quot;</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>

<span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;55:44:59:73&quot;</span> <span class="tok-o">+</span>
    <span class="tok-s2">&quot;31:44:37:62&quot;</span> <span class="tok-o">+</span>
    <span class="tok-s2">&quot;4e:6d:64:45&quot;</span> <span class="tok-o">+</span>
    <span class="tok-s2">&quot;31:6f:33:67&quot;</span> <span class="tok-o">+</span>
    <span class="tok-s2">&quot;35:6d:73:31&quot;</span> <span class="tok-o">+</span>
    <span class="tok-s2">&quot;56:36:52:72&quot;</span> <span class="tok-o">+</span>
    <span class="tok-s2">&quot;59:43:56:76&quot;</span> <span class="tok-o">+</span>
    <span class="tok-s2">&quot;4f:44:4a:46&quot;</span> <span class="tok-o">+</span>
    <span class="tok-s2">&quot;31:44:70:78&quot;</span> <span class="tok-o">+</span>
    <span class="tok-s2">&quot;4b:54:78:41&quot;</span> <span class="tok-o">+</span>
    <span class="tok-s2">&quot;4a:39:78:75&quot;</span> <span class="tok-o">+</span>
    <span class="tok-s2">&quot;5a:57:3d:3d&quot;</span>

<span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">s</span><span class="tok-o">.</span><span class="tok-n">gsub</span><span class="tok-p">(</span><span class="tok-s1">&#39;:&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">scan</span><span class="tok-p">(</span><span class="tok-sr">/../</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">map</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">x</span><span class="tok-o">|</span> <span class="tok-n">x</span><span class="tok-o">.</span><span class="tok-n">to_i</span><span class="tok-p">(</span><span class="tok-mi">16</span><span class="tok-p">)}</span>
<span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">s</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">swapcase</span>

<span class="tok-n">t</span> <span class="tok-o">=</span> <span class="tok-no">Base64</span><span class="tok-o">.</span><span class="tok-n">decode64</span><span class="tok-p">(</span><span class="tok-n">s</span><span class="tok-p">)</span>
<span class="tok-n">t</span> <span class="tok-o">=</span> <span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>

<span class="tok-n">v</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
<span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-n">size</span><span class="tok-o">.</span><span class="tok-n">times</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">i</span><span class="tok-o">|</span>
  <span class="tok-n">v</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-p">(</span><span class="tok-n">t</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">]</span> <span class="tok-o">-</span> <span class="tok-no">FLARE_BEAR_STARE</span><span class="tok-o">[</span><span class="tok-n">i</span> <span class="tok-o">%</span> <span class="tok-mi">14</span><span class="tok-o">]</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-nb">p</span> <span class="tok-n">v</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Running this script returns the validation email for this level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>C:\temp&gt;ruby solve_05.rb
"Sp1cy_7_layer_OSI_dip@flare-on.com"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_level_6">Level 6</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Solving the level 6 requires the analysis of an android application, <code>android.apk</code>.</p>
</div>
<div class="paragraph">
<p>When started through an emulator, the application asks for a string to validate:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_06_001.png" alt="level_06_001"></span></p>
</div>
<div class="paragraph">
<p>The content of the application can simply be extracted using <code>unzip</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> unzip android.apk
<span class="tok-go">  inflating: AndroidManifest.xml</span>
<span class="tok-go">  inflating: res/anim/abc_fade_in.xml</span>
<span class="tok-go">  inflating: res/anim/abc_fade_out.xml</span>
<span class="tok-go">  inflating: res/anim/abc_grow_fade_in_from_bottom.xml</span>
<span class="tok-go">[...]</span>
<span class="tok-go">  extracting: resources.arsc</span>
<span class="tok-go">  inflating: classes.dex</span>
<span class="tok-go">  inflating: lib/armeabi/libvalidate.so</span>
<span class="tok-go">  inflating: META-INF/MANIFEST.MF</span>
<span class="tok-go">  inflating: META-INF/CERT.SF</span>
<span class="tok-go">  inflating: META-INF/CERT.RSA</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Two files are particularly interesting: <code>classes.dex</code> and <code>libvalidate.so</code>.</p>
</div>
<div class="paragraph">
<p>The first one can be converted to a JAR file using <code>dex2jar</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ./d2j-dex2jar.sh -o ../classes.jar ../classes.dex
<span class="tok-go">dex2jar ../classes.dex -&gt; ../classes.jar</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The result can be decompiled with <code>jd-gui</code> and the string entered through the application
seems to be checked against the <code>validate</code> method which is implemented in a
native library, <code>libvalidate.so</code>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_06_002.png" alt="level_06_002"></span></p>
</div>
<div class="paragraph">
<p>This library exports a few symbols, especially the function <code>Java_com_flareon_flare_Va</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> readelf -s ./lib/armeabi/libvalidate.so

<span class="tok-go">Symbol table &#39;.dynsym&#39; contains 65 entries:</span>
<span class="tok-go">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span>
<span class="tok-go">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span>
<span class="tok-go">     1: 00000000     0 FUNC    GLOBAL DEFAULT  UND __cxa_finalize</span>
<span class="tok-go">     2: 00000000     0 FUNC    GLOBAL DEFAULT  UND __cxa_atexit</span>
<span class="tok-go">     3: 00000fd1     0 FUNC    GLOBAL DEFAULT    8 __aeabi_uidiv</span>
<span class="tok-go">     4: 00001051    18 FUNC    GLOBAL DEFAULT    8 __aeabi_uidivmod</span>
<span class="tok-go">     5: 00000e65   364 FUNC    GLOBAL DEFAULT    8 Java_com_flareon_flare_Va</span>
<span class="tok-go">     6: 00000000     0 FUNC    GLOBAL DEFAULT  UND memset</span>
<span class="tok-go">     7: 00000000     0 FUNC    GLOBAL DEFAULT  UND memcpy</span>
<span class="tok-go">     8: 00000000     0 FUNC    GLOBAL DEFAULT  UND strle</span>
<span class="tok-go">[...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This function can be debugged remotely using IDA by pushing
the <code>android_server</code> binary on the smartphone and starting it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> adb push <span class="tok-nv">$HOME</span>/ida/dbgsrv/android_server /data/local/tmp
<span class="tok-gp">$</span> adb shell
<span class="tok-gp">#</span> su -
<span class="tok-gp">#</span> <span class="tok-nb">cd</span> /data/local/tmp
<span class="tok-gp">#</span> chmod <span class="tok-m">755</span> android_server
<span class="tok-gp">#</span> ls -al
<span class="tok-go">-rw-rw-rw- root     root      1078129 2015-07-27 09:40 android.apk</span>
<span class="tok-go">-rwxr-xr-x root     root       523480 2015-04-28 15:17 android_server</span>
<span class="tok-gp">#</span> ./android_server
<span class="tok-go">IDA Android 32-bit remote debug server(ST) v1.17. Hex-Rays (c) 2004-2014</span>
<span class="tok-go">Listening on port #23946...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once done, a TCP port forward must be set up with <code>adb</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ./adb forward tcp:23946 tcp:23946</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, the debugger can attach itself to the process corresponding to the
Flare application:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_06_003.png" alt="level_06_003"></span></p>
</div>
<div class="paragraph">
<p>A breakpoint must then be set up at the beginning of the <code>validate</code> method that
will be hit when the user clicks on the <code>Validate</code> button in the application:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_06_004.png" alt="level_06_004"></span></p>
</div>
<div class="paragraph">
<p>The function can be debugged step by step to facilitate its analysis. A few instructions below,
the function <code>strlen</code> is called on the string entered through the application and
the result is compared to 46. Hence, the application expects a string that is
46 characters long.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_06_005.png" alt="level_06_005"></span></p>
</div>
<div class="paragraph">
<p>The page <a href="https://en.wikipedia.org/wiki/Java_Native_Interface" class="bare">https://en.wikipedia.org/wiki/Java_Native_Interface</a> describes the prototype
of a JNI method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span class="tok-c1">//C++ code</span>
<span class="tok-n">extern</span> <span class="tok-s">&quot;C&quot;</span>
<span class="tok-n">JNIEXPORT</span> <span class="tok-kt">void</span> <span class="tok-n">JNICALL</span> <span class="tok-nf">Java_ClassName_MethodName</span>
  <span class="tok-o">(</span><span class="tok-n">JNIEnv</span> <span class="tok-o">*</span><span class="tok-n">env</span><span class="tok-o">,</span> <span class="tok-n">jobject</span> <span class="tok-n">obj</span><span class="tok-o">,</span> <span class="tok-n">jstring</span> <span class="tok-n">javaString</span><span class="tok-o">)</span>
<span class="tok-o">{</span>
    <span class="tok-c1">//Get the native string from javaString</span>
    <span class="tok-kd">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">nativeString</span> <span class="tok-o">=</span> <span class="tok-n">env</span><span class="tok-o">-&gt;</span><span class="tok-n">GetStringUTFChars</span><span class="tok-o">(</span><span class="tok-n">javaString</span><span class="tok-o">,</span> <span class="tok-mi">0</span><span class="tok-o">);</span>

    <span class="tok-c1">//Do something with the nativeString</span>

    <span class="tok-c1">//DON&#39;T FORGET THIS LINE!!!</span>
    <span class="tok-n">env</span><span class="tok-o">-&gt;</span><span class="tok-n">ReleaseStringUTFChars</span><span class="tok-o">(</span><span class="tok-n">javaString</span><span class="tok-o">,</span> <span class="tok-n">nativeString</span><span class="tok-o">);</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using this information, it is possible to decompile the function under IDA and
redefine the type of the arguments. The result is presented below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">int</span> <span class="tok-kr">__fastcall</span> <span class="tok-nf">Java_com_flareon_flare_ValidateActivity_validate</span><span class="tok-p">(</span><span class="tok-n">JNIEnv</span> <span class="tok-o">*</span><span class="tok-n">env</span><span class="tok-p">,</span> <span class="tok-n">jobject</span> <span class="tok-n">jobj</span><span class="tok-p">,</span> <span class="tok-n">jstring</span> <span class="tok-n">str</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-n">JNIEnv</span> <span class="tok-o">*</span><span class="tok-n">v3</span><span class="tok-p">;</span> <span class="tok-c1">// r5@1</span>
  <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">v4</span><span class="tok-p">;</span> <span class="tok-c1">// r0@1</span>
  <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">v5</span><span class="tok-p">;</span> <span class="tok-c1">// r6@1</span>
  <span class="tok-n">jstring</span> <span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">v6</span><span class="tok-p">)(</span><span class="tok-n">JNIEnv</span> <span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-p">);</span> <span class="tok-c1">// r3@4</span>
  <span class="tok-n">JNIEnv</span> <span class="tok-o">*</span><span class="tok-n">v7</span><span class="tok-p">;</span> <span class="tok-c1">// r0@4</span>
  <span class="tok-n">_UNKNOWN</span> <span class="tok-o">*</span><span class="tok-n">v8</span><span class="tok-p">;</span> <span class="tok-c1">// r1@4</span>
  <span class="tok-kt">int</span> <span class="tok-n">v9</span><span class="tok-p">;</span> <span class="tok-c1">// r4@5</span>
  <span class="tok-kt">int</span> <span class="tok-n">i_1</span><span class="tok-p">;</span> <span class="tok-c1">// r7@6</span>
  <span class="tok-kt">size_t</span> <span class="tok-n">i</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+0h] [bp-1BB8h]@3</span>
  <span class="tok-kt">int</span> <span class="tok-n">v13</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+4h] [bp-1BB4h]@3</span>
  <span class="tok-n">jstring</span> <span class="tok-n">v14</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+8h] [bp-1BB0h]@1</span>
  <span class="tok-kt">signed</span> <span class="tok-kt">int</span> <span class="tok-n">v15</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+Ch] [bp-1BACh]@3</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">v16</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+10h] [bp-1BA8h]@7</span>
  <span class="tok-n">_DWORD</span> <span class="tok-n">dest</span><span class="tok-p">[</span><span class="tok-mi">23</span><span class="tok-p">];</span> <span class="tok-c1">// [sp+1Ch] [bp-1B9Ch]@1</span>
  <span class="tok-n">_WORD</span> <span class="tok-n">s</span><span class="tok-p">[</span><span class="tok-mi">3476</span><span class="tok-p">];</span> <span class="tok-c1">// [sp+78h] [bp-1B40h]@1</span>

  <span class="tok-n">v3</span> <span class="tok-o">=</span> <span class="tok-n">env</span><span class="tok-p">;</span>
  <span class="tok-n">v14</span> <span class="tok-o">=</span> <span class="tok-n">str</span><span class="tok-p">;</span>
  <span class="tok-n">j_j_memset</span><span class="tok-p">(</span><span class="tok-n">s</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">6952u</span><span class="tok-p">);</span>
  <span class="tok-n">j_j_memcpy</span><span class="tok-p">(</span><span class="tok-n">dest</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">off_4B5DA004</span><span class="tok-p">,</span> <span class="tok-mh">0x5Cu</span><span class="tok-p">);</span>
  <span class="tok-n">v4</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-p">)((</span><span class="tok-kt">int</span> <span class="tok-p">(</span><span class="tok-kr">__fastcall</span> <span class="tok-o">*</span><span class="tok-p">)(</span><span class="tok-n">JNIEnv</span> <span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">jstring</span><span class="tok-p">,</span> <span class="tok-n">_DWORD</span><span class="tok-p">))(</span><span class="tok-o">*</span><span class="tok-n">v3</span><span class="tok-p">)</span><span class="tok-o">-&gt;</span><span class="tok-n">GetStringUTFChars</span><span class="tok-p">)(</span><span class="tok-n">v3</span><span class="tok-p">,</span> <span class="tok-n">v14</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
  <span class="tok-n">v5</span> <span class="tok-o">=</span> <span class="tok-n">v4</span><span class="tok-p">;</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">v4</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">j_j_strlen</span><span class="tok-p">(</span><span class="tok-n">v4</span><span class="tok-p">)</span> <span class="tok-o">&lt;=</span> <span class="tok-mh">0x2E</span> <span class="tok-p">)</span>
  <span class="tok-p">{</span>
    <span class="tok-n">v13</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-n">v15</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">j_j_strlen</span><span class="tok-p">(</span><span class="tok-n">v5</span><span class="tok-p">);</span> <span class="tok-n">i</span> <span class="tok-o">+=</span> <span class="tok-mi">2</span> <span class="tok-p">)</span>
    <span class="tok-p">{</span>
      <span class="tok-n">j_j_memset</span><span class="tok-p">(</span><span class="tok-n">s</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">6952u</span><span class="tok-p">);</span>
      <span class="tok-n">v9</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
      <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">v5</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-p">)</span>
      <span class="tok-p">{</span>
        <span class="tok-n">v9</span> <span class="tok-o">=</span> <span class="tok-n">v5</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">v5</span><span class="tok-p">[</span><span class="tok-n">i</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-p">)</span>
          <span class="tok-n">v9</span> <span class="tok-o">=</span> <span class="tok-p">((</span><span class="tok-n">v5</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-mi">8</span><span class="tok-p">)</span> <span class="tok-o">|</span> <span class="tok-p">(</span><span class="tok-kt">unsigned</span> <span class="tok-kt">int</span><span class="tok-p">)</span><span class="tok-n">v5</span><span class="tok-p">[</span><span class="tok-n">i</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">])</span> <span class="tok-o">&lt;=</span> <span class="tok-mh">0x7E7E</span> <span class="tok-o">?</span> <span class="tok-p">(</span><span class="tok-n">v5</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-mi">8</span><span class="tok-p">)</span> <span class="tok-o">|</span> <span class="tok-n">v5</span><span class="tok-p">[</span><span class="tok-n">i</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
      <span class="tok-p">}</span>
      <span class="tok-n">i_1</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
      <span class="tok-k">do</span>
      <span class="tok-p">{</span>
        <span class="tok-n">v16</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-kt">unsigned</span> <span class="tok-kr">__int16</span><span class="tok-p">)</span><span class="tok-n">word_4B5D7214</span><span class="tok-p">[</span><span class="tok-n">i_1</span><span class="tok-p">];</span>
        <span class="tok-k">while</span> <span class="tok-p">(</span> <span class="tok-o">!</span><span class="tok-p">(</span><span class="tok-n">v9</span> <span class="tok-o">%</span> <span class="tok-n">v16</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xFFFF</span><span class="tok-p">)</span> <span class="tok-p">)</span>
        <span class="tok-p">{</span>
          <span class="tok-o">++</span><span class="tok-n">s</span><span class="tok-p">[</span><span class="tok-n">i_1</span><span class="tok-p">];</span>
          <span class="tok-n">v9</span> <span class="tok-o">=</span> <span class="tok-n">v9</span> <span class="tok-o">/</span> <span class="tok-n">v16</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xFFFF</span><span class="tok-p">;</span>
          <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-p">(</span><span class="tok-kt">unsigned</span> <span class="tok-kt">int</span><span class="tok-p">)</span><span class="tok-n">v9</span> <span class="tok-o">&lt;=</span> <span class="tok-mi">1</span> <span class="tok-p">)</span>
            <span class="tok-k">goto</span> <span class="tok-n">LABEL_10</span><span class="tok-p">;</span>
        <span class="tok-p">}</span>
        <span class="tok-o">++</span><span class="tok-n">i_1</span><span class="tok-p">;</span>
      <span class="tok-p">}</span>
      <span class="tok-k">while</span> <span class="tok-p">(</span> <span class="tok-n">i_1</span> <span class="tok-o">!=</span> <span class="tok-mi">3476</span> <span class="tok-p">);</span>
<span class="tok-nl">LABEL_10</span><span class="tok-p">:</span>
      <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">j_j_memcmp</span><span class="tok-p">((</span><span class="tok-k">const</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">dest</span><span class="tok-p">[</span><span class="tok-n">v13</span><span class="tok-p">],</span> <span class="tok-n">s</span><span class="tok-p">,</span> <span class="tok-mh">0xD94u</span><span class="tok-p">)</span> <span class="tok-p">)</span>
        <span class="tok-n">v15</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
      <span class="tok-k">else</span>
        <span class="tok-o">++</span><span class="tok-n">v13</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-p">((</span><span class="tok-kt">void</span> <span class="tok-p">(</span><span class="tok-kr">__fastcall</span> <span class="tok-o">*</span><span class="tok-p">)(</span><span class="tok-n">_DWORD</span><span class="tok-p">,</span> <span class="tok-n">_DWORD</span><span class="tok-p">,</span> <span class="tok-n">_DWORD</span><span class="tok-p">))(</span><span class="tok-o">*</span><span class="tok-n">v3</span><span class="tok-p">)</span><span class="tok-o">-&gt;</span><span class="tok-n">ReleaseStringUTFChars</span><span class="tok-p">)(</span><span class="tok-n">v3</span><span class="tok-p">,</span> <span class="tok-n">v14</span><span class="tok-p">,</span> <span class="tok-n">v5</span><span class="tok-p">);</span>
    <span class="tok-n">v6</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">v3</span><span class="tok-p">)</span><span class="tok-o">-&gt;</span><span class="tok-n">NewStringUTF</span><span class="tok-p">;</span>
    <span class="tok-n">v7</span> <span class="tok-o">=</span> <span class="tok-n">v3</span><span class="tok-p">;</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">v13</span> <span class="tok-o">==</span> <span class="tok-mi">23</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">v15</span> <span class="tok-p">)</span>
      <span class="tok-n">v8</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">_UNKNOWN</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-s">&quot;That&#39;s it!&quot;</span><span class="tok-p">;</span>
    <span class="tok-k">else</span>
      <span class="tok-n">v8</span> <span class="tok-o">=</span> <span class="tok-o">&amp;</span><span class="tok-n">unk_4B5D8D3C</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
  <span class="tok-k">else</span>
  <span class="tok-p">{</span>
    <span class="tok-p">((</span><span class="tok-kt">void</span> <span class="tok-p">(</span><span class="tok-kr">__fastcall</span> <span class="tok-o">*</span><span class="tok-p">)(</span><span class="tok-n">_DWORD</span><span class="tok-p">,</span> <span class="tok-n">_DWORD</span><span class="tok-p">,</span> <span class="tok-n">_DWORD</span><span class="tok-p">))(</span><span class="tok-o">*</span><span class="tok-n">v3</span><span class="tok-p">)</span><span class="tok-o">-&gt;</span><span class="tok-n">ReleaseStringUTFChars</span><span class="tok-p">)(</span><span class="tok-n">v3</span><span class="tok-p">,</span> <span class="tok-n">v14</span><span class="tok-p">,</span> <span class="tok-n">v5</span><span class="tok-p">);</span>
    <span class="tok-n">v6</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">v3</span><span class="tok-p">)</span><span class="tok-o">-&gt;</span><span class="tok-n">NewStringUTF</span><span class="tok-p">;</span>
    <span class="tok-n">v7</span> <span class="tok-o">=</span> <span class="tok-n">v3</span><span class="tok-p">;</span>
    <span class="tok-n">v8</span> <span class="tok-o">=</span> <span class="tok-o">&amp;</span><span class="tok-n">unk_4B5D8D3C</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
  <span class="tok-k">return</span> <span class="tok-p">((</span><span class="tok-kt">int</span> <span class="tok-p">(</span><span class="tok-kr">__fastcall</span> <span class="tok-o">*</span><span class="tok-p">)(</span><span class="tok-n">JNIEnv</span> <span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">_UNKNOWN</span> <span class="tok-o">*</span><span class="tok-p">))</span><span class="tok-n">v6</span><span class="tok-p">)(</span><span class="tok-n">v7</span><span class="tok-p">,</span> <span class="tok-n">v8</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The function starts by clearing the content of a buffer (variable <code>s</code>). Then the data
at address <code>0x4B5DA004</code> is copied to another buffer, <code>dest</code>. This data corresponds
to an array of 23 valid memory addresses:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_06_006.png" alt="level_06_006"></span></p>
</div>
<div class="paragraph">
<p>Each one of these addresses references another array containing 3476 words, most
of them equal to 0:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_06_007.png" alt="level_06_007"></span></p>
</div>
<div class="paragraph">
<p>Next, the function starts a loop. At the beginning of each iteration, a word
(variable <code>v9</code>) is set using two characters of the input string, from the current position. Then another
loop is started, with 3476 iterations at most. For each iteration, a word (variable
<code>v16</code>) is looked up from an array at address <code>0x4B5D7214</code>. If the word <code>v9</code> can
be divided by <code>v16</code>, then the value at <code>v[i_1]</code> is incremented. This inner loop
will stop if <code>v9</code> is equal or less than 1 or after 3476 iterations.</p>
</div>
<div class="paragraph">
<p>The beginning of the array at address <code>0x4B5D7214</code> is shown below:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_06_008.png" alt="level_06_008"></span></p>
</div>
<div class="paragraph">
<p>A list of prime integers can be recognized.</p>
</div>
<div class="paragraph">
<p>After exiting the inner loop, the contents of the buffer <code>s</code> and the one
at address <code>dest[v13]</code> are compared. If equal, <code>v13</code> is incremented. Otherwise,
<code>v15</code> is set to 0.</p>
</div>
<div class="paragraph">
<p>At the end, if <code>v13</code> is equal to 23 and <code>v15</code> equal to 1, the string <code>That&#8217;s it!</code>
is returned.</p>
</div>
<div class="paragraph">
<p>The function implements a basic integer factoring algorithm: each pair of bytes
from the input string is transformed into a word and the result of the factorization
is stored in the array <code>s</code>. For each iteration, this result is compared to the expected
factorization (<code>dest[v13]</code>).</p>
</div>
<div class="paragraph">
<p>The Ruby script below uses the reference factorization to reconstruct the expected
input string :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-no">T1_ADDR</span> <span class="tok-o">=</span> <span class="tok-mh">0x5004</span>

<span class="tok-n">input</span> <span class="tok-o">=</span> <span class="tok-no">ARGV</span><span class="tok-o">.</span><span class="tok-n">shift</span>

<span class="tok-n">f</span> <span class="tok-o">=</span> <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-n">input</span><span class="tok-p">,</span> <span class="tok-s2">&quot;rb&quot;</span><span class="tok-p">)</span>

<span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">seek</span> <span class="tok-p">(</span><span class="tok-no">T1_ADDR</span> <span class="tok-o">-</span> <span class="tok-mh">0x1000</span><span class="tok-p">),</span> <span class="tok-no">IO</span><span class="tok-o">::</span><span class="tok-no">SEEK_SET</span>

<span class="tok-n">t1_data</span> <span class="tok-o">=</span> <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-mi">23</span> <span class="tok-o">*</span> <span class="tok-mi">4</span><span class="tok-p">)</span>

<span class="tok-n">t1</span> <span class="tok-o">=</span> <span class="tok-n">t1_data</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;L*&#39;</span><span class="tok-p">)</span>

<span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">seek</span> <span class="tok-mh">0x2214</span><span class="tok-p">,</span> <span class="tok-no">IO</span><span class="tok-o">::</span><span class="tok-no">SEEK_SET</span>

<span class="tok-n">word_2214_data</span> <span class="tok-o">=</span> <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-mi">6952</span><span class="tok-p">)</span>
<span class="tok-n">word_2214</span> <span class="tok-o">=</span> <span class="tok-n">word_2214_data</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;S*&#39;</span><span class="tok-p">)</span>

<span class="tok-n">res</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>

<span class="tok-n">t1</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">v</span><span class="tok-o">|</span>
  <span class="tok-n">offset</span> <span class="tok-o">=</span> <span class="tok-n">v</span> <span class="tok-o">-</span> <span class="tok-mh">0x1000</span>
  <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">seek</span> <span class="tok-n">offset</span><span class="tok-p">,</span> <span class="tok-no">IO</span><span class="tok-o">::</span><span class="tok-no">SEEK_SET</span>
  <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-mi">6952</span><span class="tok-p">)</span>
  <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-n">data</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;S*&#39;</span><span class="tok-p">)</span>
  <span class="tok-n">v</span> <span class="tok-o">=</span> <span class="tok-mi">1</span>
  <span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-n">each_with_index</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-n">i</span><span class="tok-o">|</span>
    <span class="tok-k">if</span> <span class="tok-n">x</span> <span class="tok-o">!=</span> <span class="tok-mi">0</span> <span class="tok-k">then</span>
      <span class="tok-n">v</span> <span class="tok-o">*=</span>  <span class="tok-p">(</span><span class="tok-n">word_2214</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">]</span> <span class="tok-o">**</span> <span class="tok-n">x</span><span class="tok-p">)</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
  <span class="tok-n">res</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-p">(</span><span class="tok-n">v</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">8</span><span class="tok-p">)</span>
  <span class="tok-n">res</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-p">(</span><span class="tok-n">v</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xff</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-nb">p</span> <span class="tok-n">res</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>

<span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">close</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the script returns the validation email:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ruby solve_06.rb libvalidate.so
<span class="tok-go">&quot;Should_have_g0ne_to_tashi_$tation@flare-on.com&quot;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_level_7">Level 7</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The provided file for this level is a Win32 portable executable, coded in .NET.</p>
</div>
<div class="paragraph">
<p>Opening the file with <code>ILSpy</code> is not very helpful:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_07_001.png" alt="level_07_001"></span></p>
</div>
<div class="paragraph">
<p>The binary seems obfuscated. A few references to <code>SmartAssembly</code> can be found,
which is indeed a .NET obfuscator.</p>
</div>
<div class="paragraph">
<p>The tool <code>de4dot</code> can be used to get a clean binary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>c:\temp&gt;de4dot.exe -f e:\level_07\YUSoMeta -o e:\level_07\YUSoMeta-cleaned.exe

de4dot v3.1.41592.3405 Copyright (C) 2011-2014 de4dot@gmail.com
Latest version and source code: https://github.com/0xd4d/de4dot
21 deobfuscator modules loaded!

Detected SmartAssembly 6.9.0.114 (e:\level_07\YUSoMeta)
Cleaning e:\level_07\YUSoMeta
Renaming all obfuscated symbols
Saving e:\level_07\YUSoMeta-cleaned.exe</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time, the decompilation with <code>ILSpy</code> works perfectly:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_07_002.png" alt="level_07_002"></span></p>
</div>
<div class="paragraph">
<p>The <code>Main</code> method reads a string from the console that is then
compared to another string, generated by the methods <code>smethod_0</code>
and <code>smethod_3</code>. At this point, we want to analyze these two methods in order
to generate the expected string.</p>
</div>
<div class="paragraph">
<p>The code from <code>smethod_0</code> is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="csharp"><span class="tok-c1">// ns2.Class3</span>
<span class="tok-k">static</span> <span class="tok-kt">string</span> <span class="tok-nf">smethod_0</span><span class="tok-p">(</span><span class="tok-n">Class1</span> <span class="tok-n">class1_0</span><span class="tok-p">,</span> <span class="tok-kt">byte</span><span class="tok-p">[]</span> <span class="tok-n">byte_0</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
	<span class="tok-kt">byte</span><span class="tok-p">[]</span> <span class="tok-n">array</span> <span class="tok-p">=</span> <span class="tok-n">Class3</span><span class="tok-p">.</span><span class="tok-n">smethod_2</span><span class="tok-p">();</span>
	<span class="tok-kt">string</span> <span class="tok-n">text</span> <span class="tok-p">=</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">;</span>
	<span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-p">=</span> <span class="tok-m">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-p">&lt;</span> <span class="tok-n">byte_0</span><span class="tok-p">.</span><span class="tok-n">Length</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-p">++)</span>
	<span class="tok-p">{</span>
		<span class="tok-n">text</span> <span class="tok-p">+=</span> <span class="tok-p">(</span><span class="tok-kt">char</span><span class="tok-p">)(</span><span class="tok-n">byte_0</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-p">^</span> <span class="tok-n">array</span><span class="tok-p">[</span><span class="tok-n">i</span> <span class="tok-p">%</span> <span class="tok-n">array</span><span class="tok-p">.</span><span class="tok-n">Length</span><span class="tok-p">]);</span>
	<span class="tok-p">}</span>
	<span class="tok-k">return</span> <span class="tok-n">text</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This method will simply get a byte array from <code>smethod_2</code>
and apply a xor operation on the parameter using this array.</p>
</div>
<div class="paragraph">
<p>The code of <code>smethod_2</code> is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="csharp"><span class="tok-c1">// ns2.Class3</span>
<span class="tok-k">static</span> <span class="tok-kt">byte</span><span class="tok-p">[]</span> <span class="tok-nf">smethod_2</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
	<span class="tok-k">return</span> <span class="tok-n">Assembly</span><span class="tok-p">.</span><span class="tok-n">GetExecutingAssembly</span><span class="tok-p">().</span><span class="tok-n">ManifestModule</span><span class="tok-p">.</span><span class="tok-n">ResolveMethod</span><span class="tok-p">(</span><span class="tok-m">100663297</span><span class="tok-p">).</span><span class="tok-n">GetMethodBody</span><span class="tok-p">().</span><span class="tok-n">GetILAsByteArray</span><span class="tok-p">();</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Interestingly, the byte array returned is the bytecode of a specific method
from the program. We can expect that this array will not be the same in the deobfuscated
version of the binary compared to the original one.</p>
</div>
<div class="paragraph">
<p>The code of method <code>smethod_3</code> is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="csharp"><span class="tok-c1">// ns2.Class3</span>
<span class="tok-k">static</span> <span class="tok-kt">string</span> <span class="tok-nf">smethod_3</span><span class="tok-p">()</span>
<span class="tok-p">{</span>
	<span class="tok-n">StringBuilder</span> <span class="tok-n">stringBuilder</span> <span class="tok-p">=</span> <span class="tok-k">new</span> <span class="tok-n">StringBuilder</span><span class="tok-p">();</span>
	<span class="tok-n">MD5</span> <span class="tok-n">mD</span> <span class="tok-p">=</span> <span class="tok-n">MD5</span><span class="tok-p">.</span><span class="tok-n">Create</span><span class="tok-p">();</span>
	<span class="tok-k">foreach</span> <span class="tok-p">(</span><span class="tok-n">CustomAttributeData</span> <span class="tok-n">current</span> <span class="tok-k">in</span> <span class="tok-n">CustomAttributeData</span><span class="tok-p">.</span><span class="tok-n">GetCustomAttributes</span><span class="tok-p">(</span><span class="tok-n">Assembly</span><span class="tok-p">.</span><span class="tok-n">GetExecutingAssembly</span><span class="tok-p">()))</span>
	<span class="tok-p">{</span>
		<span class="tok-n">stringBuilder</span><span class="tok-p">.</span><span class="tok-n">Append</span><span class="tok-p">(</span><span class="tok-n">current</span><span class="tok-p">.</span><span class="tok-n">ToString</span><span class="tok-p">());</span>
	<span class="tok-p">}</span>
	<span class="tok-kt">byte</span><span class="tok-p">[]</span> <span class="tok-n">bytes</span> <span class="tok-p">=</span> <span class="tok-n">Encoding</span><span class="tok-p">.</span><span class="tok-n">Unicode</span><span class="tok-p">.</span><span class="tok-n">GetBytes</span><span class="tok-p">(</span><span class="tok-n">stringBuilder</span><span class="tok-p">.</span><span class="tok-n">ToString</span><span class="tok-p">());</span>
	<span class="tok-kt">byte</span><span class="tok-p">[]</span> <span class="tok-k">value</span> <span class="tok-p">=</span> <span class="tok-n">mD</span><span class="tok-p">.</span><span class="tok-n">ComputeHash</span><span class="tok-p">(</span><span class="tok-n">bytes</span><span class="tok-p">);</span>
	<span class="tok-k">return</span> <span class="tok-n">BitConverter</span><span class="tok-p">.</span><span class="tok-n">ToString</span><span class="tok-p">(</span><span class="tok-k">value</span><span class="tok-p">).</span><span class="tok-n">Replace</span><span class="tok-p">(</span><span class="tok-s">&quot;-&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the previously seen <code>smethod_2</code>, the output of this method will vary
between the two versions of the binary, because of the call to <code>GetExecutingAssembly</code>.</p>
</div>
<div class="paragraph">
<p>A few different methods can then be followed to recover the expected string. I chose
to code a small program that will read the assembly from a specified file,
the methods <code>smethod_2</code> and <code>smethod_3</code> being slightly modified
to operate on this assembly. The program source is presented below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="csharp"><span class="tok-k">using</span> <span class="tok-nn">System</span><span class="tok-p">;</span>
<span class="tok-k">using</span> <span class="tok-nn">System.Collections.Generic</span><span class="tok-p">;</span>
<span class="tok-k">using</span> <span class="tok-nn">System.Linq</span><span class="tok-p">;</span>
<span class="tok-k">using</span> <span class="tok-nn">System.Text</span><span class="tok-p">;</span>
<span class="tok-k">using</span> <span class="tok-nn">System.Threading.Tasks</span><span class="tok-p">;</span>
<span class="tok-k">using</span> <span class="tok-nn">System.Reflection</span><span class="tok-p">;</span>
<span class="tok-k">using</span> <span class="tok-nn">System.Security.Cryptography</span><span class="tok-p">;</span>

<span class="tok-k">namespace</span> <span class="tok-nn">level07_calc</span>
<span class="tok-p">{</span>
    <span class="tok-k">class</span> <span class="tok-nc">Program</span>
    <span class="tok-p">{</span>
        <span class="tok-k">static</span> <span class="tok-kt">byte</span><span class="tok-p">[]</span> <span class="tok-nf">smethod_2</span><span class="tok-p">(</span><span class="tok-n">Assembly</span> <span class="tok-n">asm</span><span class="tok-p">)</span>
        <span class="tok-p">{</span>
            <span class="tok-k">return</span> <span class="tok-n">asm</span><span class="tok-p">.</span><span class="tok-n">ManifestModule</span><span class="tok-p">.</span><span class="tok-n">ResolveMethod</span><span class="tok-p">(</span><span class="tok-m">0</span><span class="tok-n">x6000001</span><span class="tok-p">).</span><span class="tok-n">GetMethodBody</span><span class="tok-p">().</span><span class="tok-n">GetILAsByteArray</span><span class="tok-p">();</span>
        <span class="tok-p">}</span>

        <span class="tok-k">static</span> <span class="tok-kt">string</span> <span class="tok-nf">smethod_0</span><span class="tok-p">(</span><span class="tok-n">Assembly</span> <span class="tok-n">asm</span><span class="tok-p">,</span> <span class="tok-kt">byte</span><span class="tok-p">[]</span> <span class="tok-n">byte_0</span><span class="tok-p">)</span>
        <span class="tok-p">{</span>
            <span class="tok-kt">byte</span><span class="tok-p">[]</span> <span class="tok-n">array</span> <span class="tok-p">=</span> <span class="tok-n">smethod_2</span><span class="tok-p">(</span><span class="tok-n">asm</span><span class="tok-p">);</span>
            <span class="tok-kt">string</span> <span class="tok-n">text</span> <span class="tok-p">=</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">;</span>
            <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span> <span class="tok-p">=</span> <span class="tok-m">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-p">&lt;</span> <span class="tok-n">byte_0</span><span class="tok-p">.</span><span class="tok-n">Length</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-p">++)</span>
            <span class="tok-p">{</span>
                <span class="tok-n">text</span> <span class="tok-p">+=</span> <span class="tok-p">(</span><span class="tok-kt">char</span><span class="tok-p">)(</span><span class="tok-n">byte_0</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-p">^</span> <span class="tok-n">array</span><span class="tok-p">[</span><span class="tok-n">i</span> <span class="tok-p">%</span> <span class="tok-n">array</span><span class="tok-p">.</span><span class="tok-n">Length</span><span class="tok-p">]);</span>
            <span class="tok-p">}</span>
            <span class="tok-k">return</span> <span class="tok-n">text</span><span class="tok-p">;</span>
        <span class="tok-p">}</span>

        <span class="tok-k">static</span> <span class="tok-kt">string</span> <span class="tok-nf">smethod_3</span><span class="tok-p">(</span><span class="tok-n">Assembly</span> <span class="tok-n">asm</span><span class="tok-p">)</span>
        <span class="tok-p">{</span>
            <span class="tok-n">StringBuilder</span> <span class="tok-n">stringBuilder</span> <span class="tok-p">=</span> <span class="tok-k">new</span> <span class="tok-n">StringBuilder</span><span class="tok-p">();</span>
            <span class="tok-n">MD5</span> <span class="tok-n">mD</span> <span class="tok-p">=</span> <span class="tok-n">MD5</span><span class="tok-p">.</span><span class="tok-n">Create</span><span class="tok-p">();</span>
            <span class="tok-k">foreach</span> <span class="tok-p">(</span><span class="tok-n">CustomAttributeData</span> <span class="tok-n">current</span> <span class="tok-k">in</span> <span class="tok-n">CustomAttributeData</span><span class="tok-p">.</span><span class="tok-n">GetCustomAttributes</span><span class="tok-p">(</span><span class="tok-n">asm</span><span class="tok-p">))</span>
            <span class="tok-p">{</span>
                <span class="tok-n">stringBuilder</span><span class="tok-p">.</span><span class="tok-n">Append</span><span class="tok-p">(</span><span class="tok-n">current</span><span class="tok-p">.</span><span class="tok-n">ToString</span><span class="tok-p">());</span>
            <span class="tok-p">}</span>
            <span class="tok-kt">byte</span><span class="tok-p">[]</span> <span class="tok-n">bytes</span> <span class="tok-p">=</span> <span class="tok-n">Encoding</span><span class="tok-p">.</span><span class="tok-n">Unicode</span><span class="tok-p">.</span><span class="tok-n">GetBytes</span><span class="tok-p">(</span><span class="tok-n">stringBuilder</span><span class="tok-p">.</span><span class="tok-n">ToString</span><span class="tok-p">());</span>
            <span class="tok-kt">byte</span><span class="tok-p">[]</span> <span class="tok-k">value</span> <span class="tok-p">=</span> <span class="tok-n">mD</span><span class="tok-p">.</span><span class="tok-n">ComputeHash</span><span class="tok-p">(</span><span class="tok-n">bytes</span><span class="tok-p">);</span>
            <span class="tok-k">return</span> <span class="tok-n">BitConverter</span><span class="tok-p">.</span><span class="tok-n">ToString</span><span class="tok-p">(</span><span class="tok-k">value</span><span class="tok-p">).</span><span class="tok-n">Replace</span><span class="tok-p">(</span><span class="tok-s">&quot;-&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">);</span>
        <span class="tok-p">}</span>

        <span class="tok-k">static</span> <span class="tok-k">void</span> <span class="tok-nf">Main</span><span class="tok-p">(</span><span class="tok-kt">string</span><span class="tok-p">[]</span> <span class="tok-n">args</span><span class="tok-p">)</span>
        <span class="tok-p">{</span>
            <span class="tok-n">String</span> <span class="tok-n">input</span> <span class="tok-p">=</span> <span class="tok-n">args</span><span class="tok-p">[</span><span class="tok-m">0</span><span class="tok-p">];</span>

            <span class="tok-kt">var</span> <span class="tok-n">asm</span> <span class="tok-p">=</span> <span class="tok-n">Assembly</span><span class="tok-p">.</span><span class="tok-n">LoadFile</span><span class="tok-p">(</span><span class="tok-n">args</span><span class="tok-p">[</span><span class="tok-m">0</span><span class="tok-p">]);</span>

            <span class="tok-kt">byte</span><span class="tok-p">[]</span> <span class="tok-n">byte_2</span> <span class="tok-p">=</span> <span class="tok-k">new</span> <span class="tok-kt">byte</span><span class="tok-p">[]</span>
              <span class="tok-p">{</span> <span class="tok-m">31</span><span class="tok-p">,</span> <span class="tok-m">100</span><span class="tok-p">,</span> <span class="tok-m">116</span><span class="tok-p">,</span> <span class="tok-m">97</span><span class="tok-p">,</span> <span class="tok-m">0</span><span class="tok-p">,</span> <span class="tok-m">84</span><span class="tok-p">,</span> <span class="tok-m">69</span><span class="tok-p">,</span> <span class="tok-m">21</span><span class="tok-p">,</span>
                <span class="tok-m">115</span><span class="tok-p">,</span> <span class="tok-m">97</span><span class="tok-p">,</span> <span class="tok-m">109</span><span class="tok-p">,</span> <span class="tok-m">29</span><span class="tok-p">,</span> <span class="tok-m">79</span><span class="tok-p">,</span> <span class="tok-m">68</span><span class="tok-p">,</span> <span class="tok-m">21</span><span class="tok-p">,</span> <span class="tok-m">104</span><span class="tok-p">,</span>
                <span class="tok-m">115</span><span class="tok-p">,</span> <span class="tok-m">104</span><span class="tok-p">,</span> <span class="tok-m">21</span><span class="tok-p">,</span> <span class="tok-m">84</span><span class="tok-p">,</span> <span class="tok-m">78</span>
              <span class="tok-p">};</span>

            <span class="tok-kt">var</span> <span class="tok-n">s1</span> <span class="tok-p">=</span> <span class="tok-n">Program</span><span class="tok-p">.</span><span class="tok-n">smethod_0</span><span class="tok-p">(</span><span class="tok-n">asm</span><span class="tok-p">,</span> <span class="tok-n">byte_2</span><span class="tok-p">);</span>
            <span class="tok-kt">var</span> <span class="tok-n">s2</span> <span class="tok-p">=</span> <span class="tok-n">Program</span><span class="tok-p">.</span><span class="tok-n">smethod_3</span><span class="tok-p">(</span><span class="tok-n">asm</span><span class="tok-p">);</span>
            <span class="tok-n">Console</span><span class="tok-p">.</span><span class="tok-n">WriteLine</span><span class="tok-p">(</span><span class="tok-n">s1</span> <span class="tok-p">+</span> <span class="tok-s">&quot;_&quot;</span> <span class="tok-p">+</span> <span class="tok-n">s2</span><span class="tok-p">);</span>
        <span class="tok-p">}</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the program on the <code>YUSoMeta</code> file will return the expected string.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>c:\temp&gt;level07_calc.exe YUSoMeta.exe
metaprogrammingisherd_DD9BE1704C690FB422F1509A46ABC988</code></pre>
</div>
</div>
<div class="paragraph">
<p>As expected, the result is different on the deobfuscated version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>c:\temp&gt;level07_calc.exe c:\temp\YUSoMeta-cleaned.exe
↔L{a ^o↨[nm↔En↨@|h§^d_6E51105290B0D056B93C06ED630404C6</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, entering the expected string when running <code>YUSoMeta</code> returns the validation
address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>c:\temp&gt;YUSoMeta.exe
Warning! This program is 100% tamper-proof!
Please enter the correct password: metaprogrammingisherd_DD9BE1704C690FB422F1509
A46ABC988
Thank you for providing the correct password.
Use the following email address to proceed to the next challenge: Justr3adth3sou
rc3@flare-on.com</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_level_8">Level 8</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The program for this level is a Win32 executable named <code>gdssagh</code>. As shown below,
the file contains strings that seem to be encoded in base64.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> strings gdssagh
<span class="tok-go">!This program cannot be run in DOS mode.</span>
<span class="tok-go">Rich</span>
<span class="tok-go">.text</span>
<span class="tok-go">`.rdata</span>
<span class="tok-go">@.data</span>
<span class="tok-go">iVBORw0KGgoAAAANSUhEUgAAAlgAAAHgCAIAAAD2dYQOAAEAAElEQVR4nIT9b5Ak13UfCp57</span>
<span class="tok-go">8ubNW7eysrOrq6trenp6GoPBcDAcjkCQhGCIhGmQomg/WfbKtGQ7HLbCsbGxX97au/Ei/OHt</span>
<span class="tok-go">ft5dvxfvbXgdu7L3xYsNr0PPT6a1WlpS6FESDfFBFAiCIDgYDgaNRqPR6Ompqa6uzs7Kunnz</span>
<span class="tok-go">5smT+6F6QNnWxubExHTU1J+u/HN+f87v3BT/h3/275xbWJdrHQwHcYu1tWfM1O+vMGM2W0Sy</span>
<span class="tok-go">U3kochqkAyn1xB3FsZGSAShJVBqbQEIAKKX03jMAAzGQ1hK19M6Wc5HnOTBrrR05u5h3E725</span>
<span class="tok-go">OTKxzrN8PJnlWdWKSAVJQ8p5UohSSuec9x5RIqL3HhGZKUmSwaDvvCPvGXgyHmd5vrU9iuN0</span>
<span class="tok-go">YYvHkxmARJDek0RtC7e1uW2tJcexMcCIgIjoaToaDhFAAkopJ0fHw9FoNp0WuR2MhnGcHh6P</span>
<span class="tok-go">[...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Decoding this data will result in a PNG file shown below:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_08_001.jpg" alt="level_08_001"></span></p>
</div>
<div class="paragraph">
<p>At this point, we want to use the <code>zteg</code> tool on the image to check if any data
is encoded using steganographic techniques:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> zsteg 0.png
<span class="tok-go">imagedata           .. text: &quot; $%NPP&gt;=&lt;&quot;</span>
<span class="tok-go">b1,r,msb,xy         .. file: Applesoft BASIC program data, first line number 64</span>
<span class="tok-go">b1,rgb,msb,xy       .. file: PE32 executable Intel 80386, for MS Windows</span>
<span class="tok-go">b1,bgr,lsb,xy       .. file: GLS_BINARY_LSB_FIRST</span>
<span class="tok-go">b2,rgb,msb,xy       .. text: &quot;UDDADPAE&quot;</span>
<span class="tok-go">b2,bgr,msb,xy       .. text: &quot;|IAEQ@DDD&quot;</span>
<span class="tok-go">b4,r,msb,xy         .. text: &quot;Ab@pT&amp;we-b e&quot;</span>
<span class="tok-go">b4,g,msb,xy         .. text: &quot;%`$Q\&quot;wTf@&quot;</span>
<span class="tok-go">b4,b,msb,xy         .. text: &quot;C$qFqgf#0wpq&quot;</span>
<span class="tok-go">b4,rgb,msb,xy       .. text: &quot;BcrpAPpv#&quot;</span>
<span class="tok-go">b4,bgr,msb,xy       .. text: &quot;@CrbqP@v s&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the <code>b1,rgb,msb,xy</code> method, <code>zsteg</code> detects an embedded PE32 executable. This method means
that the first bit of the red, green and blue components must be extracted and that the bitstream
must be reconstructed starting by the most significant bit.</p>
</div>
<div class="paragraph">
<p>The Ruby script below reconstructs the bitstream according to this schema and saves
the result in a file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-nb">require</span> <span class="tok-s1">&#39;chunky_png&#39;</span>

<span class="tok-k">class</span> <span class="tok-nc">BitStream</span>
  <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">(</span><span class="tok-n">basename</span><span class="tok-p">)</span>
    <span class="tok-vi">@basename</span> <span class="tok-o">=</span> <span class="tok-n">basename</span>
    <span class="tok-vi">@msb_first</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
    <span class="tok-n">reset</span>
  <span class="tok-k">end</span>

  <span class="tok-k">def</span> <span class="tok-nf">&lt;&lt;</span><span class="tok-p">(</span><span class="tok-n">bit</span><span class="tok-p">)</span>
    <span class="tok-vi">@current_msb</span> <span class="tok-o">|=</span> <span class="tok-p">(</span><span class="tok-n">bit</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-vi">@count</span><span class="tok-p">)</span>
    <span class="tok-vi">@count</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span>
    <span class="tok-k">if</span> <span class="tok-vi">@count</span> <span class="tok-o">==</span> <span class="tok-mi">8</span>
      <span class="tok-vi">@msb_first</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-vi">@current_msb</span>
      <span class="tok-n">reset</span>
    <span class="tok-k">end</span>
    <span class="tok-nb">self</span>
  <span class="tok-k">end</span>

  <span class="tok-k">def</span> <span class="tok-nf">reset</span>
    <span class="tok-vi">@count</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
    <span class="tok-vi">@current_msb</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
  <span class="tok-k">end</span>

  <span class="tok-k">def</span> <span class="tok-nf">finalize</span>
    <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-si">#{</span><span class="tok-vi">@basename</span><span class="tok-si">}</span><span class="tok-s2">-msb.bin&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;wb&quot;</span><span class="tok-p">)</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">f</span><span class="tok-o">|</span>
      <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">write</span> <span class="tok-vi">@msb_first</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span>

<span class="tok-n">image</span> <span class="tok-o">=</span> <span class="tok-no">ChunkyPNG</span><span class="tok-o">::</span><span class="tok-no">Image</span><span class="tok-o">.</span><span class="tok-n">from_file</span><span class="tok-p">(</span><span class="tok-s1">&#39;0.png&#39;</span><span class="tok-p">)</span>

<span class="tok-n">rgb</span> <span class="tok-o">=</span> <span class="tok-no">BitStream</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-s2">&quot;rgb&quot;</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-o">.</span><span class="tok-n">.image</span><span class="tok-o">.</span><span class="tok-n">dimension</span><span class="tok-o">.</span><span class="tok-n">height</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">y</span><span class="tok-o">|</span>
  <span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-o">.</span><span class="tok-n">.image</span><span class="tok-o">.</span><span class="tok-n">dimension</span><span class="tok-o">.</span><span class="tok-n">width</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">x</span><span class="tok-o">|</span>
    <span class="tok-n">red</span> <span class="tok-o">=</span> <span class="tok-no">ChunkyPNG</span><span class="tok-o">::</span><span class="tok-no">Color</span><span class="tok-o">.</span><span class="tok-n">r</span><span class="tok-p">(</span><span class="tok-n">image</span><span class="tok-o">[</span><span class="tok-n">x</span><span class="tok-p">,</span><span class="tok-n">y</span><span class="tok-o">]</span><span class="tok-p">)</span>
    <span class="tok-n">green</span> <span class="tok-o">=</span> <span class="tok-no">ChunkyPNG</span><span class="tok-o">::</span><span class="tok-no">Color</span><span class="tok-o">.</span><span class="tok-n">g</span><span class="tok-p">(</span><span class="tok-n">image</span><span class="tok-o">[</span><span class="tok-n">x</span><span class="tok-p">,</span><span class="tok-n">y</span><span class="tok-o">]</span><span class="tok-p">)</span>
    <span class="tok-n">blue</span> <span class="tok-o">=</span> <span class="tok-no">ChunkyPNG</span><span class="tok-o">::</span><span class="tok-no">Color</span><span class="tok-o">.</span><span class="tok-n">b</span><span class="tok-p">(</span><span class="tok-n">image</span><span class="tok-o">[</span><span class="tok-n">x</span><span class="tok-p">,</span><span class="tok-n">y</span><span class="tok-o">]</span><span class="tok-p">)</span>

    <span class="tok-n">rb</span> <span class="tok-o">=</span> <span class="tok-n">red</span> <span class="tok-o">&amp;</span> <span class="tok-mi">1</span>
    <span class="tok-n">gb</span> <span class="tok-o">=</span> <span class="tok-n">green</span> <span class="tok-o">&amp;</span> <span class="tok-mi">1</span>
    <span class="tok-n">bb</span> <span class="tok-o">=</span> <span class="tok-n">blue</span> <span class="tok-o">&amp;</span> <span class="tok-mi">1</span>

    <span class="tok-n">rgb</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">rb</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">gb</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">bb</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span>

<span class="tok-n">rgb</span><span class="tok-o">.</span><span class="tok-n">finalize</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The file extracted is indeed a PE32 executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ruby extract_pe.rb
<span class="tok-gp">$</span> file rgb-msb.bin
<span class="tok-go">rgb-msb.bin: PE32 executable (console) Intel 80386, for MS Windows</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the executable returns the validation email:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> wine rgb-msb.bin
<span class="tok-go">Im_in_ur_p1cs@flare-on.com</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_level_9">Level 9</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal of this level is to analyze the Win32 executable <code>you_are_very_good_at_this</code>. When started,
the program asks for a password, as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>C:\temp&gt;you_are_very_good_at_this.exe
I have evolved since the first challenge. You have not. Bring it.
Enter the password&gt; helloworld
You are failure</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to open the file in IDA in order to analyze the disassembly. However, the code
uses many anti-disassembly tricks, like <code>jump label+1</code>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_09_001.png" alt="level_09_001"></span></p>
</div>
<div class="paragraph">
<p>A full static analysis does not feel like the right approach here. Even debugging is made difficult
because of the presence of numerous junk instructions.</p>
</div>
<div class="paragraph">
<p>Using OllyDbg, it is possible to record a trace showing the executed instructions and the memory
accesses. This trace was useful to analyze the behaviour of the program.</p>
</div>
<div class="paragraph">
<p>Inside the trace, it can be observed that a specific sequence of instructions repeats itself
several times (many junk instructions have been removed):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>main  00401A99   MOV ECX,DWORD PTR SS:[EBP-14]      [0018FF74]=1                ECX=00000001
main  00401A9C   MOV AL,BYTE PTR DS:[ECX+EAX]       [00402187]=41 ('A')         EAX=00402141
[...]
main  0018FDC0   MOV AH,BYTE PTR SS:[EBX+ESP+0B4]   [0018FE82]=15               EAX=00401541
[...]
main  0018FDC4   XOR AL,AH                                                      EAX=00401554
[...]
main  0018FDC0   MOV CL,BYTE PTR SS:[EBX+ESP+88]    [0018FE56]=F5               ECX=000000F5
[...]
main  00401B14   ROL AL,CL                                                      EAX=0040158A
main  00401B16   MOV EBX,DWORD PTR SS:[EBX+ESP+2C]  [0018FDFE]=F080B8CC         EBX=F080B8CC
[...]
main  0018FDC4   CMPXCHG BL,DL                                                  EAX=004015CC
main  0018FDC7   RETN                               [0018FDCC]=you_are_very_good_at_this.00401B38;ESP=0018FDD0</code></pre>
</div>
</div>
<div class="paragraph">
<p>It seems that the instruction at address <code>00401A9C</code> reads one byte from the password given as input, depending
on the value stored in the <code>ecx</code> register (during the recording of this trace, the password was <code>"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</code>).
This sequence can be found forty and one times in the trace file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> grep -F <span class="tok-s1">&#39;MOV AL,BYTE PTR DS:[ECX+EAX]&#39;</span> trace.txt
<span class="tok-go">main  00401A9C                    MOV AL,BYTE PTR DS:[ECX+EAX]            [00402186]=41 (&#39;A&#39;)         EAX=00402141</span>
<span class="tok-go">main  00401A9C                    MOV AL,BYTE PTR DS:[ECX+EAX]            [00402187]=41 (&#39;A&#39;)         EAX=00402141</span>
<span class="tok-go">main  00401A9C                    MOV AL,BYTE PTR DS:[ECX+EAX]            [00402188]=41 (&#39;A&#39;)         EAX=00402141</span>
<span class="tok-go">[...]</span>
<span class="tok-go">main  00401A9C                    MOV AL,BYTE PTR DS:[ECX+EAX]            [004021AE]=41 (&#39;A&#39;)         EAX=00402141</span>
<span class="tok-gp">$</span> grep -F <span class="tok-s1">&#39;MOV AL,BYTE PTR DS:[ECX+EAX]&#39;</span> trace.txt <span class="tok-p">|</span> wc -l
<span class="tok-go">41</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The program loops on each byte of the input string, applies certain arithmetic operations (<code>ROL(AH ^ AL, CL)</code>) and compares
the result to BL with the <code>CMPXCHG</code> instruction. For each iteration, it is possible to reverse these operations
to obtain the expected value of <code>AL = ROR(BL, CL) ^ AH</code>, being given the values of <code>BL</code>, <code>AH</code> and <code>CL</code> that can be extracted
from the recorded trace.</p>
</div>
<div class="paragraph">
<p>The Ruby script below extracts the values of the registers <code>BL</code>, <code>AH</code> and <code>CL</code> for each iteration
and computes the expected value for <code>AL</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-no">BIT_WIDTH</span> <span class="tok-o">=</span> <span class="tok-mi">8</span>

<span class="tok-k">def</span> <span class="tok-nf">ror</span><span class="tok-p">(</span><span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">count</span><span class="tok-p">)</span>
  <span class="tok-n">count</span> <span class="tok-o">=</span> <span class="tok-n">count</span> <span class="tok-o">%</span> <span class="tok-no">BIT_WIDTH</span>
  <span class="tok-p">(</span><span class="tok-n">b</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-n">count</span> <span class="tok-p">)</span> <span class="tok-o">|</span> <span class="tok-p">(</span><span class="tok-n">b</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-p">(</span><span class="tok-no">BIT_WIDTH</span> <span class="tok-o">-</span> <span class="tok-n">count</span><span class="tok-p">))</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xFF</span>
<span class="tok-k">end</span>

<span class="tok-n">bl</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
<span class="tok-n">ah</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
<span class="tok-n">cl</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>

<span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;trace.txt&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;r&quot;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">each_line</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">line</span><span class="tok-o">|</span>
  <span class="tok-k">case</span> <span class="tok-n">line</span>
  <span class="tok-k">when</span> <span class="tok-sr">/MOV EBX,DWORD PTR SS:\[EBX\+ESP\+2C\].+EBX=......(..)/</span>
    <span class="tok-n">bl</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-vg">$1</span><span class="tok-o">.</span><span class="tok-n">to_i</span><span class="tok-p">(</span><span class="tok-mi">16</span><span class="tok-p">)</span>
  <span class="tok-k">when</span> <span class="tok-sr">/MOV AH,BYTE PTR SS:\[EBX\+ESP\+0B4\].+\]=(..)/</span>
    <span class="tok-n">ah</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-vg">$1</span><span class="tok-o">.</span><span class="tok-n">to_i</span><span class="tok-p">(</span><span class="tok-mi">16</span><span class="tok-p">)</span>
  <span class="tok-k">when</span> <span class="tok-sr">/MOV CL,BYTE PTR SS:\[EBX\+ESP\+88\].+\]=(..)/</span>
    <span class="tok-n">cl</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-vg">$1</span><span class="tok-o">.</span><span class="tok-n">to_i</span><span class="tok-p">(</span><span class="tok-mi">16</span><span class="tok-p">)</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span>

<span class="tok-n">al</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
<span class="tok-n">bl</span><span class="tok-o">.</span><span class="tok-n">each_with_index</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">i</span><span class="tok-o">|</span>
  <span class="tok-n">al</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-p">(</span><span class="tok-n">ror</span><span class="tok-p">(</span><span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">cl</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">]</span><span class="tok-p">)</span> <span class="tok-o">^</span> <span class="tok-n">ah</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">]</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-nb">p</span> <span class="tok-n">al</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Running this script returns the validation email:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ruby solve_09.rb
<span class="tok-go">&quot;Is_th1s_3v3n_mai_finul_foarm@flare-on.com&quot;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_level_10">Level 10</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For this level, a new Win32 executable named <code>loader.exe</code> must be analyzed. Running the program under Windows 7 64-bits shows the following
message box:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_001.png" alt="level_10_001"></span></p>
</div>
<div class="paragraph">
<p>When started under Windows XP, the program silently returns:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_002.png" alt="level_10_002"></span></p>
</div>
<div class="paragraph">
<p>According to the <code>strings</code> command, an AutoIt script seems embedded in the binary.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> strings loader.exe
<span class="tok-go">[...]</span>
<span class="tok-go"> !&quot;#$%&amp;&#39;()*+,-./0123456789:;&lt;=&gt;?@abcdefghijklmnopqrstuvwxyz[\]^_`ABCDEFGHIJKLMNOPQRSTUVWXYZ{|}~</span>
<span class="tok-go">This is a third-party compiled AutoIt script.</span>
<span class="tok-go">GetNativeSystemInfo</span>
<span class="tok-go">IsWow64Process</span>
<span class="tok-go">[...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This script can be recovered using the tool <code>Exe2Aut</code>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_003.png" alt="level_10_003"></span></p>
</div>
<div class="paragraph">
<p>The script begins by copying two files (<code>challenge.sys</code> and <code>ioctl.exe</code>) in the system directory
(<code>c:\windows\system32</code>), then the function <code>dothis</code> is called several times. This function takes
two parameters <code>$data</code> and <code>$key</code>, decrypts <code>$data</code> using <code>$key</code> and executes the decrypted data
after converting it to a string.</p>
</div>
<div class="paragraph">
<p>The decryption process is handled by the function <code>decrypt</code>. This function prepares a call to <code>CallWindowProc</code> with 5 parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>$codebuffer</code> object from opcodes harcoded in the function <code>decrypt</code>,</p>
</li>
<li>
<p><code>$buffer</code> object from the <code>$data</code> argument,</p>
</li>
<li>
<p>size of <code>$data</code></p>
</li>
<li>
<p><code>$key</code> as string</p>
</li>
<li>
<p>0</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To get information about the decryption algorithm, it is necessary to dump the hardcoded opcodes to a file and disassemble it. The
result can be seen in IDA:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_004.png" alt="level_10_004"></span></p>
</div>
<div class="paragraph">
<p>Further down, the astute reverser can recognize a piece of code that looks like the initialization function
of the RC4 algorithm:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_005.png" alt="level_10_005"></span></p>
</div>
<div class="paragraph">
<p>To test this hypothesis, a decryption is attempted on a string passed to the <code>dothis</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="irb"><span class="tok-gp">irb(main):001:0&gt; </span><span class="tok-nb">require</span> <span class="tok-s1">&#39;rc4&#39;</span>
<span class="tok-go"> =&gt; true</span>
<span class="tok-gp">irb(main):002:0&gt; </span><span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;flarebearstare&quot;</span>
<span class="tok-go"> =&gt; &quot;flarebearstare&quot;</span>
<span class="tok-gp">irb(main):003:0&gt; </span><span class="tok-n">dec</span> <span class="tok-o">=</span> <span class="tok-no">RC4</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">)</span>
<span class="tok-go"> =&gt; #&lt;RC4:0x00000002017b90 @q2=0, @q1=0, @key=[102, 108, [...], 112, 34]&gt;</span>
<span class="tok-gp">irb(main):004:0&gt; </span><span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;96d587b8139933d17e3598505e729da736bb66aa6cfa5180289fb6845530&quot;</span><span class="tok-o">.</span><span class="tok-n">scan</span><span class="tok-p">(</span><span class="tok-sr">/../</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">map</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">x</span><span class="tok-o">|</span> <span class="tok-n">x</span><span class="tok-o">.</span><span class="tok-n">to_i</span><span class="tok-p">(</span><span class="tok-mi">16</span><span class="tok-p">)}</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>
<span class="tok-go"> =&gt; &quot;\x96\xD5\x87\xB8\x13\x993\xD1~5\x98P^r\x9D\xA76\xBBf\xAAl\xFAQ\x80(\x9F\xB6\x84U0&quot;</span>
<span class="tok-gp">irb(main):005:0&gt; </span><span class="tok-n">dec</span><span class="tok-o">.</span><span class="tok-n">decrypt</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">)</span>
<span class="tok-go"> =&gt; &quot;_StartService(&quot;&quot;, &quot;challenge&quot;)&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The calls to <code>dothis</code> can then be replaced by the decrypted strings in order to obtain
the following result :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="autoit"><span class="tok-nv">$nret</span> <span class="tok-o">=</span> <span class="tok-nf">Execute</span><span class="tok-p">(</span>&#39;<span class="tok-n">_CreateService</span><span class="tok-p">(</span><span class="tok-s">&quot;&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;challenge&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;challenge&quot;</span><span class="tok-p">,</span> <span class="tok-nv">@SystemDir</span> <span class="tok-o">&amp;</span> <span class="tok-s">&quot;\\challenge.sys&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">,</span> <span class="tok-nv">$SERVICE_KERNEL_DRIVER</span><span class="tok-p">,</span> <span class="tok-nv">$SERVICE_DEMAND_START</span><span class="tok-p">)</span>&#39;<span class="tok-p">)</span>
<span class="tok-nb">If</span> <span class="tok-nv">$nret</span> <span class="tok-nb">Then</span>
  <span class="tok-nb">If</span> <span class="tok-nf">Execute</span><span class="tok-p">(</span>&#39;<span class="tok-n">_StartService</span><span class="tok-p">(</span><span class="tok-s">&quot;&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;challenge&quot;</span><span class="tok-p">)</span>&#39;<span class="tok-p">)</span> <span class="tok-nb">Then</span>
    <span class="tok-nf">Execute</span><span class="tok-p">(</span>&#39;<span class="tok-nf">ShellExecute</span><span class="tok-p">(</span><span class="tok-nv">@SystemDir</span> <span class="tok-o">&amp;</span> <span class="tok-s">&quot;\\ioctl.exe&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;22E0DC&quot;</span><span class="tok-p">)</span>&#39;<span class="tok-p">)</span>
  <span class="tok-nb">EndIf</span>
<span class="tok-nb">EndIf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The AutoIt script creates a service to load the driver <code>challenge.sys</code>, starts the service
and executes the program <code>ioctl.exe</code> with <code>22E0DC</code> as parameter.</p>
</div>
<div class="paragraph">
<p>The file <code>challenge.sys</code> and <code>ioctl.exe</code> are indeed present on the filesystem
but running the latter with the given parameter does not return any result:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_006.png" alt="level_10_006"></span></p>
</div>
<div class="paragraph">
<p>The <code>ioctl.exe</code> program is very basic and can be decompiled cleanly using IDA:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">int</span> <span class="tok-kr">__cdecl</span> <span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">argc</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">**</span><span class="tok-n">argv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">**</span><span class="tok-n">envp</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">v3</span><span class="tok-p">;</span> <span class="tok-c1">// ST18_4@1</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kr">__int32</span> <span class="tok-n">param</span><span class="tok-p">;</span> <span class="tok-c1">// ebx@1</span>
  <span class="tok-n">HANDLE</span> <span class="tok-n">v5</span><span class="tok-p">;</span> <span class="tok-c1">// esi@1</span>
  <span class="tok-kt">int</span> <span class="tok-n">result</span><span class="tok-p">;</span> <span class="tok-c1">// eax@2</span>
  <span class="tok-n">HANDLE</span> <span class="tok-n">dev_handle</span><span class="tok-p">;</span> <span class="tok-c1">// edi@3</span>
  <span class="tok-k">struct</span> <span class="tok-n">_OVERLAPPED</span> <span class="tok-n">Overlapped</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+8h] [bp-24h]@5</span>
  <span class="tok-n">DWORD</span> <span class="tok-n">BytesReturned</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+1Ch] [bp-10h]@1</span>
  <span class="tok-kt">int</span> <span class="tok-n">OutBuffer</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+20h] [bp-Ch]@1</span>
  <span class="tok-kt">int</span> <span class="tok-n">v11</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+24h] [bp-8h]@1</span>

  <span class="tok-n">OutBuffer</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
  <span class="tok-n">v11</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
  <span class="tok-n">v3</span> <span class="tok-o">=</span> <span class="tok-n">argv</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">];</span>
  <span class="tok-n">BytesReturned</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
  <span class="tok-n">param</span> <span class="tok-o">=</span> <span class="tok-n">strtoul</span><span class="tok-p">(</span><span class="tok-n">v3</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">16</span><span class="tok-p">);</span>
  <span class="tok-n">v5</span> <span class="tok-o">=</span> <span class="tok-n">CreateEventA</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">v5</span> <span class="tok-p">)</span>
  <span class="tok-p">{</span>
    <span class="tok-n">dev_handle</span> <span class="tok-o">=</span> <span class="tok-n">CreateFileA</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-se">\\\\</span><span class="tok-s">.</span><span class="tok-se">\\</span><span class="tok-s">challenge&quot;</span><span class="tok-p">,</span> <span class="tok-mh">0xC0000000</span><span class="tok-p">,</span> <span class="tok-mi">3u</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">3u</span><span class="tok-p">,</span> <span class="tok-mh">0x40000000u</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">dev_handle</span> <span class="tok-o">==</span> <span class="tok-p">(</span><span class="tok-n">HANDLE</span><span class="tok-p">)</span><span class="tok-o">-</span><span class="tok-mi">1</span> <span class="tok-p">)</span>
    <span class="tok-p">{</span>
      <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;open device fail!</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
      <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-k">else</span>
    <span class="tok-p">{</span>
      <span class="tok-n">Overlapped</span><span class="tok-p">.</span><span class="tok-n">Internal</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
      <span class="tok-n">Overlapped</span><span class="tok-p">.</span><span class="tok-n">InternalHigh</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
      <span class="tok-n">Overlapped</span><span class="tok-p">.</span><span class="tok-n">Offset</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
      <span class="tok-n">Overlapped</span><span class="tok-p">.</span><span class="tok-n">OffsetHigh</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
      <span class="tok-n">ResetEvent</span><span class="tok-p">(</span><span class="tok-n">v5</span><span class="tok-p">);</span>
      <span class="tok-n">Overlapped</span><span class="tok-p">.</span><span class="tok-n">hEvent</span> <span class="tok-o">=</span> <span class="tok-n">v5</span><span class="tok-p">;</span>
      <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">DeviceIoControl</span><span class="tok-p">(</span><span class="tok-n">dev_handle</span><span class="tok-p">,</span> <span class="tok-n">param</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">OutBuffer</span><span class="tok-p">,</span> <span class="tok-mi">8u</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">BytesReturned</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">Overlapped</span><span class="tok-p">)</span> <span class="tok-p">)</span>
      <span class="tok-p">{</span>
        <span class="tok-n">GetOverlappedResult</span><span class="tok-p">(</span><span class="tok-n">dev_handle</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">Overlapped</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">BytesReturned</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">);</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
      <span class="tok-p">}</span>
      <span class="tok-k">else</span>
      <span class="tok-p">{</span>
        <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;device ioctl fail!</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
      <span class="tok-p">}</span>
    <span class="tok-p">}</span>
  <span class="tok-p">}</span>
  <span class="tok-k">else</span>
  <span class="tok-p">{</span>
    <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;CreateEvent fail!</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
    <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
  <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, reversing the driver <code>challenge.sys</code> seems required to identify
the code path that is executed when receiving the ioctl <code>0x22E0DC</code>.</p>
</div>
<div class="paragraph">
<p>The driver entry calls the initialization function <code>sub_29ED85</code> and then jumps
at location <code>sub_29CC90</code>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_007.png" alt="level_10_007"></span></p>
</div>
<div class="paragraph">
<p>This function can be decompiled with IDA:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-n">NTSTATUS</span> <span class="tok-kr">__stdcall</span> <span class="tok-nf">sub_29CC90</span><span class="tok-p">(</span><span class="tok-n">PDRIVER_OBJECT</span> <span class="tok-n">DriverObject</span><span class="tok-p">,</span> <span class="tok-n">PUNICODE_STRING</span> <span class="tok-n">RegistryPath</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-n">NTSTATUS</span> <span class="tok-n">result</span><span class="tok-p">;</span> <span class="tok-c1">// eax@5</span>
  <span class="tok-kt">int</span> <span class="tok-n">v3</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+0h] [bp-30h]@4</span>
  <span class="tok-n">NTSTATUS</span> <span class="tok-n">v4</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+0h] [bp-30h]@6</span>
  <span class="tok-n">UNICODE_STRING</span> <span class="tok-n">DestinationString</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+4h] [bp-2Ch]@4</span>
  <span class="tok-n">PDEVICE_OBJECT</span> <span class="tok-n">DeviceObject</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+Ch] [bp-24h]@1</span>
  <span class="tok-n">UNICODE_STRING</span> <span class="tok-n">SymbolicLinkName</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+10h] [bp-20h]@6</span>
  <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+18h] [bp-18h]@1</span>
  <span class="tok-kt">int</span> <span class="tok-n">v9</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+1Ch] [bp-14h]@1</span>
  <span class="tok-kr">__int16</span> <span class="tok-n">v10</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+20h] [bp-10h]@1</span>
  <span class="tok-kr">__int16</span> <span class="tok-n">v11</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+22h] [bp-Eh]@1</span>
  <span class="tok-kt">char</span> <span class="tok-n">v12</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+24h] [bp-Ch]@1</span>
  <span class="tok-kt">char</span> <span class="tok-n">v13</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+25h] [bp-Bh]@1</span>
  <span class="tok-kt">char</span> <span class="tok-n">v14</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+26h] [bp-Ah]@1</span>
  <span class="tok-kt">char</span> <span class="tok-n">v15</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+27h] [bp-9h]@1</span>
  <span class="tok-kt">char</span> <span class="tok-n">v16</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+28h] [bp-8h]@1</span>
  <span class="tok-kt">char</span> <span class="tok-n">v17</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+29h] [bp-7h]@1</span>
  <span class="tok-kt">char</span> <span class="tok-n">v18</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+2Ah] [bp-6h]@1</span>
  <span class="tok-kt">char</span> <span class="tok-n">v19</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+2Bh] [bp-5h]@1</span>

  <span class="tok-n">DeviceObject</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
  <span class="tok-n">v9</span> <span class="tok-o">=</span> <span class="tok-o">-</span><span class="tok-mi">571561217</span><span class="tok-p">;</span>
  <span class="tok-n">v10</span> <span class="tok-o">=</span> <span class="tok-mi">4919</span><span class="tok-p">;</span>
  <span class="tok-n">v11</span> <span class="tok-o">=</span> <span class="tok-o">-</span><span class="tok-mi">16657</span><span class="tok-p">;</span>
  <span class="tok-n">v12</span> <span class="tok-o">=</span> <span class="tok-o">-</span><span class="tok-mi">120</span><span class="tok-p">;</span>
  <span class="tok-n">v13</span> <span class="tok-o">=</span> <span class="tok-mi">119</span><span class="tok-p">;</span>
  <span class="tok-n">v14</span> <span class="tok-o">=</span> <span class="tok-mi">102</span><span class="tok-p">;</span>
  <span class="tok-n">v15</span> <span class="tok-o">=</span> <span class="tok-mi">85</span><span class="tok-p">;</span>
  <span class="tok-n">v16</span> <span class="tok-o">=</span> <span class="tok-mi">17</span><span class="tok-p">;</span>
  <span class="tok-n">v17</span> <span class="tok-o">=</span> <span class="tok-mi">34</span><span class="tok-p">;</span>
  <span class="tok-n">v18</span> <span class="tok-o">=</span> <span class="tok-mi">51</span><span class="tok-p">;</span>
  <span class="tok-n">v19</span> <span class="tok-o">=</span> <span class="tok-mi">68</span><span class="tok-p">;</span>
  <span class="tok-k">for</span> <span class="tok-p">(</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">27</span><span class="tok-p">;</span> <span class="tok-o">++</span><span class="tok-n">i</span> <span class="tok-p">)</span>
    <span class="tok-n">DriverObject</span><span class="tok-o">-&gt;</span><span class="tok-n">MajorFunction</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">PDRIVER_DISPATCH</span><span class="tok-p">)</span><span class="tok-n">sub_29C1A0</span><span class="tok-p">;</span>
  <span class="tok-n">DriverObject</span><span class="tok-o">-&gt;</span><span class="tok-n">DriverUnload</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">PDRIVER_UNLOAD</span><span class="tok-p">)</span><span class="tok-n">sub_29B5C0</span><span class="tok-p">;</span>
  <span class="tok-n">RtlInitUnicodeString</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">DestinationString</span><span class="tok-p">,</span> <span class="tok-n">off_29D684</span><span class="tok-p">);</span>
  <span class="tok-n">v3</span> <span class="tok-o">=</span> <span class="tok-n">sub_29D9E4</span><span class="tok-p">(</span><span class="tok-n">DriverObject</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">DestinationString</span><span class="tok-p">,</span> <span class="tok-mi">34</span><span class="tok-p">,</span> <span class="tok-mi">256</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-s">L&quot;68&quot;</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">v9</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">DeviceObject</span><span class="tok-p">);</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">v3</span> <span class="tok-o">&gt;=</span> <span class="tok-mi">0</span> <span class="tok-p">)</span>
  <span class="tok-p">{</span>
    <span class="tok-n">RtlInitUnicodeString</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">SymbolicLinkName</span><span class="tok-p">,</span> <span class="tok-n">SourceString</span><span class="tok-p">);</span>
    <span class="tok-n">v4</span> <span class="tok-o">=</span> <span class="tok-n">IoCreateSymbolicLink</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">SymbolicLinkName</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">DestinationString</span><span class="tok-p">);</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">v4</span> <span class="tok-o">&gt;=</span> <span class="tok-mi">0</span> <span class="tok-p">)</span>
    <span class="tok-p">{</span>
      <span class="tok-n">sub_29C180</span><span class="tok-p">(</span><span class="tok-n">v4</span><span class="tok-p">);</span>
      <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-k">else</span>
    <span class="tok-p">{</span>
      <span class="tok-n">DbgPrint</span><span class="tok-p">(</span><span class="tok-s">&quot;Cannot create symbolic link: %x&quot;</span><span class="tok-p">,</span> <span class="tok-n">v4</span><span class="tok-p">);</span>
      <span class="tok-n">IoDeleteDevice</span><span class="tok-p">(</span><span class="tok-n">DeviceObject</span><span class="tok-p">);</span>
      <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
  <span class="tok-p">}</span>
  <span class="tok-k">else</span>
  <span class="tok-p">{</span>
    <span class="tok-n">DbgPrint</span><span class="tok-p">(</span><span class="tok-s">&quot;Cannot create device: %x&quot;</span><span class="tok-p">,</span> <span class="tok-n">v3</span><span class="tok-p">);</span>
    <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
  <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The driver dispatch function seems to be <code>sub_29C1A0</code> (renamed <code>driver_dispatch</code> for the rest of this analysis) and can
also be decompiled :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">int</span> <span class="tok-kr">__stdcall</span> <span class="tok-nf">driver_dispatch</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">a1</span><span class="tok-p">,</span> <span class="tok-n">PIRP</span> <span class="tok-n">Irp</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kt">char</span> <span class="tok-n">v2</span><span class="tok-p">;</span> <span class="tok-c1">// ST0F_1@3</span>
  <span class="tok-p">[...]</span>
  <span class="tok-kt">char</span> <span class="tok-n">v94</span><span class="tok-p">;</span> <span class="tok-c1">// ST0F_1@101</span>
  <span class="tok-n">PIO_STACK_LOCATION</span> <span class="tok-n">v96</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+Ch] [bp-14h]@1</span>

  <span class="tok-n">Irp</span><span class="tok-o">-&gt;</span><span class="tok-n">IoStatus</span><span class="tok-p">.</span><span class="tok-n">Status</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
  <span class="tok-n">Irp</span><span class="tok-o">-&gt;</span><span class="tok-n">IoStatus</span><span class="tok-p">.</span><span class="tok-n">Information</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
  <span class="tok-n">v96</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">PIO_STACK_LOCATION</span><span class="tok-p">)</span><span class="tok-n">sub_29CC30</span><span class="tok-p">(</span><span class="tok-n">Irp</span><span class="tok-p">);</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">v96</span><span class="tok-o">-&gt;</span><span class="tok-n">MajorFunction</span> <span class="tok-o">==</span> <span class="tok-mi">14</span> <span class="tok-p">)</span>
  <span class="tok-p">{</span>
    <span class="tok-k">switch</span> <span class="tok-p">(</span> <span class="tok-n">v96</span><span class="tok-o">-&gt;</span><span class="tok-n">Parameters</span><span class="tok-p">.</span><span class="tok-n">Read</span><span class="tok-p">.</span><span class="tok-n">ByteOffset</span><span class="tok-p">.</span><span class="tok-n">LowPart</span> <span class="tok-o">-</span> <span class="tok-p">(</span><span class="tok-n">_DWORD</span><span class="tok-p">)</span><span class="tok-o">&amp;</span><span class="tok-n">loc_22E004</span> <span class="tok-p">)</span>
    <span class="tok-p">{</span>
      <span class="tok-k">case</span> <span class="tok-mi">0u</span><span class="tok-o">:</span>
        <span class="tok-n">v2</span> <span class="tok-o">=</span> <span class="tok-n">sub_105E0</span><span class="tok-p">(</span><span class="tok-mi">65</span><span class="tok-p">);</span>
        <span class="tok-k">break</span><span class="tok-p">;</span>
      <span class="tok-k">case</span> <span class="tok-mi">4u</span><span class="tok-o">:</span>
        <span class="tok-n">sub_10910</span><span class="tok-p">(</span><span class="tok-mi">65</span><span class="tok-p">);</span>
        <span class="tok-k">break</span><span class="tok-p">;</span>
      <span class="tok-k">case</span> <span class="tok-mi">8u</span><span class="tok-o">:</span>
        <span class="tok-n">v3</span> <span class="tok-o">=</span> <span class="tok-n">sub_10C40</span><span class="tok-p">(</span><span class="tok-mi">65</span><span class="tok-p">);</span>
        <span class="tok-k">break</span><span class="tok-p">;</span>
      <span class="tok-p">[...]</span>
      <span class="tok-k">case</span> <span class="tok-mi">384u</span><span class="tok-o">:</span>
        <span class="tok-n">v93</span> <span class="tok-o">=</span> <span class="tok-n">sub_239B0</span><span class="tok-p">(</span><span class="tok-mi">65</span><span class="tok-p">);</span>
        <span class="tok-k">break</span><span class="tok-p">;</span>
      <span class="tok-k">case</span> <span class="tok-mi">388u</span><span class="tok-o">:</span>
        <span class="tok-n">v94</span> <span class="tok-o">=</span> <span class="tok-n">sub_23CD0</span><span class="tok-p">(</span><span class="tok-mi">65</span><span class="tok-p">);</span>
        <span class="tok-k">break</span><span class="tok-p">;</span>
      <span class="tok-k">case</span> <span class="tok-mi">392u</span><span class="tok-o">:</span>
        <span class="tok-n">sub_23FD0</span><span class="tok-p">(</span><span class="tok-mi">65</span><span class="tok-p">);</span>
        <span class="tok-k">break</span><span class="tok-p">;</span>
      <span class="tok-k">default</span><span class="tok-o">:</span>
        <span class="tok-k">break</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
  <span class="tok-p">}</span>
  <span class="tok-n">IofCompleteRequest</span><span class="tok-p">(</span><span class="tok-n">Irp</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
  <span class="tok-k">return</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The dispatch of IRP is executed through a switch-case structure, the index
being calculated relatively to <code>0x22E004</code>. For example, for the ioctl <code>22E0DC</code>, the index
would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="irb"><span class="tok-gp">irb(main):001:0&gt; </span><span class="tok-mh">0x22E0DC</span> <span class="tok-o">-</span> <span class="tok-mh">0x22E004</span>
<span class="tok-go"> =&gt; 216</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The corresponding function is <code>sub_29B620</code>, as shown below:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_008.png" alt="level_10_008"></span></p>
</div>
<div class="paragraph">
<p>This function starts by clearing a 24-bytes buffer on the stack. Then, on the first 21 bytes, each bit position
is tested with an <code>and</code> instruction, with the operand <code>1</code> to <code>0x80</code>. If the next instruction is
<code>jz</code>, the bit needs to be cleared to avoid a premature exit. If the next instruction is <code>jnz</code>, the bits needs
to be set.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_009.png" alt="level_10_009"></span></p>
</div>
<div class="paragraph">
<p>Using these indications, it is possible to reconstruct the expected buffer. The Ruby script below
implements these operations that can be tedious when done manually.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-nb">require</span> <span class="tok-s1">&#39;metasm&#39;</span>
<span class="tok-kp">include</span> <span class="tok-no">Metasm</span>

<span class="tok-no">IOCTL_22E0DC_HANDLER</span> <span class="tok-o">=</span> <span class="tok-mh">0x29B620</span>

<span class="tok-n">exefmt</span> <span class="tok-o">=</span> <span class="tok-no">Metasm</span><span class="tok-o">.</span><span class="tok-n">const_get</span><span class="tok-p">(</span><span class="tok-s2">&quot;PE&quot;</span><span class="tok-p">)</span>

<span class="tok-n">exe</span> <span class="tok-o">=</span> <span class="tok-n">exefmt</span><span class="tok-o">.</span><span class="tok-n">decode_file</span><span class="tok-p">(</span><span class="tok-no">ARGV</span><span class="tok-o">.</span><span class="tok-n">shift</span><span class="tok-p">)</span>

<span class="tok-n">exe</span><span class="tok-o">.</span><span class="tok-n">disassemble</span><span class="tok-p">(</span><span class="tok-o">[</span> <span class="tok-no">IOCTL_22E0DC_HANDLER</span> <span class="tok-o">]</span><span class="tok-p">)</span>

<span class="tok-n">dasm</span> <span class="tok-o">=</span> <span class="tok-n">exe</span><span class="tok-o">.</span><span class="tok-n">disassembler</span>

<span class="tok-n">init_state</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-ss">values</span><span class="tok-p">:</span> <span class="tok-no">Hash</span><span class="tok-o">.</span><span class="tok-n">new</span> <span class="tok-p">{</span> <span class="tok-o">|</span><span class="tok-n">h</span><span class="tok-p">,</span><span class="tok-n">k</span><span class="tok-o">|</span> <span class="tok-n">h</span><span class="tok-o">[</span><span class="tok-n">k</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-mi">0</span> <span class="tok-p">}</span> <span class="tok-p">}</span>
<span class="tok-n">dasm</span><span class="tok-o">.</span><span class="tok-n">function_walk</span><span class="tok-p">(</span><span class="tok-no">IOCTL_22E0DC_HANDLER</span><span class="tok-p">,</span> <span class="tok-n">init_state</span><span class="tok-p">)</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">args</span><span class="tok-o">|</span>
  <span class="tok-n">event_type</span> <span class="tok-o">=</span> <span class="tok-n">args</span><span class="tok-o">.</span><span class="tok-n">first</span>
  <span class="tok-k">next</span> <span class="tok-k">if</span> <span class="tok-n">event_type</span> <span class="tok-o">!=</span> <span class="tok-ss">:di</span>

  <span class="tok-n">di</span> <span class="tok-o">=</span> <span class="tok-n">args</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span>
  <span class="tok-n">state</span> <span class="tok-o">=</span> <span class="tok-n">args</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">]</span>
  <span class="tok-n">ins</span> <span class="tok-o">=</span> <span class="tok-n">di</span><span class="tok-o">.</span><span class="tok-n">instruction</span>

  <span class="tok-k">case</span> <span class="tok-n">ins</span><span class="tok-o">.</span><span class="tok-n">opname</span>
  <span class="tok-k">when</span> <span class="tok-s2">&quot;movzx&quot;</span>
    <span class="tok-n">offset</span> <span class="tok-o">=</span> <span class="tok-n">ins</span><span class="tok-o">.</span><span class="tok-n">args</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">].</span><span class="tok-n">imm</span><span class="tok-o">.</span><span class="tok-n">reduce</span>
    <span class="tok-n">state</span><span class="tok-o">[</span><span class="tok-ss">:curr_offset</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-n">offset</span>
  <span class="tok-k">when</span> <span class="tok-s2">&quot;and&quot;</span>
    <span class="tok-n">state</span><span class="tok-o">[</span><span class="tok-ss">:bit_pos</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-n">ins</span><span class="tok-o">.</span><span class="tok-n">args</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">].</span><span class="tok-n">reduce</span>
  <span class="tok-k">when</span> <span class="tok-s2">&quot;jnz&quot;</span>
    <span class="tok-n">offset</span> <span class="tok-o">=</span> <span class="tok-n">state</span><span class="tok-o">[</span><span class="tok-ss">:curr_offset</span><span class="tok-o">]</span>
    <span class="tok-n">state</span><span class="tok-o">[</span><span class="tok-ss">:values</span><span class="tok-o">][</span><span class="tok-n">offset</span><span class="tok-o">]</span> <span class="tok-o">|=</span> <span class="tok-n">state</span><span class="tok-o">[</span><span class="tok-ss">:bit_pos</span><span class="tok-o">]</span>
  <span class="tok-k">end</span>
  <span class="tok-n">state</span>
<span class="tok-k">end</span>

<span class="tok-n">values</span> <span class="tok-o">=</span> <span class="tok-n">init_state</span><span class="tok-o">[</span><span class="tok-ss">:values</span><span class="tok-o">]</span>
<span class="tok-nb">puts</span> <span class="tok-n">values</span><span class="tok-o">.</span><span class="tok-n">sort_by</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">offset</span><span class="tok-p">,</span> <span class="tok-n">value</span><span class="tok-o">|</span> <span class="tok-n">offset</span> <span class="tok-p">}</span><span class="tok-o">.</span><span class="tok-n">map</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">offset</span><span class="tok-p">,</span> <span class="tok-n">value</span><span class="tok-o">|</span> <span class="tok-n">value</span> <span class="tok-p">}</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the script returns the string.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ruby -I metasm solve_10.rb challenge.sys
<span class="tok-go">try this ioctl: 22E068</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately, the string obtained is not the validation email address
but an indication to try another ioctl. As shown previously, the index to the
switch-case can be computed as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="irb"><span class="tok-gp">irb(main):001:0&gt; </span><span class="tok-mh">0x22E068</span> <span class="tok-o">-</span> <span class="tok-mh">0x22E004</span>
<span class="tok-go"> =&gt; 100</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The function <code>sub_2c760</code> seems to be the handler for this ioctl:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_010.png" alt="level_10_010"></span></p>
</div>
<div class="paragraph">
<p>This functions starts by setting many variables on the stack:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_011.png" alt="level_10_011"></span></p>
</div>
<div class="paragraph">
<p>Then many instructions are executed to transform these variables:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_012.png" alt="level_10_012"></span></p>
</div>
<div class="paragraph">
<p>Finally, the function calls another function, <code>sub_10570</code> with three parameters: address <code>0x29D890</code>, <code>[ebp+a2]</code>, <code>[ebp+a3]</code>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_013.PNG" alt="level_10_013"></span></p>
</div>
<div class="paragraph">
<p>This function can be decompiled as below by IDA:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-kr">__stdcall</span> <span class="tok-nf">sub_10570</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">arg1</span><span class="tok-p">,</span> <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">arg2</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">arg3</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">result</span><span class="tok-p">;</span> <span class="tok-c1">// eax@4</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">n_iter</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+0h] [bp-Ch]@1</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">index</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+4h] [bp-8h]@1</span>

  <span class="tok-n">n_iter</span> <span class="tok-o">=</span> <span class="tok-o">*</span><span class="tok-n">arg2</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">3</span><span class="tok-p">;</span>
  <span class="tok-k">for</span> <span class="tok-p">(</span> <span class="tok-n">index</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">index</span> <span class="tok-o">&lt;</span> <span class="tok-n">n_iter</span><span class="tok-p">;</span> <span class="tok-o">++</span><span class="tok-n">index</span> <span class="tok-p">)</span>
    <span class="tok-n">sub_10490</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">arg1</span><span class="tok-p">[</span><span class="tok-mi">2</span> <span class="tok-o">*</span> <span class="tok-n">index</span><span class="tok-p">],</span> <span class="tok-n">arg3</span><span class="tok-p">);</span>
  <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">arg1</span><span class="tok-p">[</span><span class="tok-mi">2</span> <span class="tok-o">*</span> <span class="tok-n">n_iter</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">];</span>
  <span class="tok-o">*</span><span class="tok-n">arg2</span> <span class="tok-o">=</span> <span class="tok-n">result</span><span class="tok-p">;</span>
  <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next function, <code>sub_10490</code>, is decompiled as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-kr">__stdcall</span> <span class="tok-nf">sub_10490</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">crypted_data</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">key_data</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">result</span><span class="tok-p">;</span> <span class="tok-c1">// eax@4</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">dw_0</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+0h] [bp-24h]@1</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">v4</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+14h] [bp-10h]@1</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">dw_1</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+18h] [bp-Ch]@1</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+20h] [bp-4h]@1</span>

  <span class="tok-n">dw_0</span> <span class="tok-o">=</span> <span class="tok-o">*</span><span class="tok-n">crypted_data</span><span class="tok-p">;</span>
  <span class="tok-n">dw_1</span> <span class="tok-o">=</span> <span class="tok-n">crypted_data</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">];</span>
  <span class="tok-n">v4</span> <span class="tok-o">=</span> <span class="tok-mh">0xC6EF3720</span><span class="tok-p">;</span>
  <span class="tok-k">for</span> <span class="tok-p">(</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">32</span><span class="tok-p">;</span> <span class="tok-o">++</span><span class="tok-n">i</span> <span class="tok-p">)</span>
  <span class="tok-p">{</span>
    <span class="tok-n">dw_1</span> <span class="tok-o">-=</span> <span class="tok-p">(</span><span class="tok-n">key_data</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-n">dw_0</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">5</span><span class="tok-p">))</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-n">v4</span> <span class="tok-o">+</span> <span class="tok-n">dw_0</span><span class="tok-p">)</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-n">key_data</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-mi">16</span> <span class="tok-o">*</span> <span class="tok-n">dw_0</span><span class="tok-p">);</span>
    <span class="tok-n">dw_0</span> <span class="tok-o">-=</span> <span class="tok-p">(</span><span class="tok-n">key_data</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-n">dw_1</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">5</span><span class="tok-p">))</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-n">v4</span> <span class="tok-o">+</span> <span class="tok-n">dw_1</span><span class="tok-p">)</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">key_data</span> <span class="tok-o">+</span> <span class="tok-mi">16</span> <span class="tok-o">*</span> <span class="tok-n">dw_1</span><span class="tok-p">);</span>
    <span class="tok-n">v4</span> <span class="tok-o">+=</span> <span class="tok-mh">0x61C88647</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
  <span class="tok-o">*</span><span class="tok-n">crypted_data</span> <span class="tok-o">=</span> <span class="tok-n">dw_0</span><span class="tok-p">;</span>
  <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">dw_1</span><span class="tok-p">;</span>
  <span class="tok-n">crypted_data</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">dw_1</span><span class="tok-p">;</span>
  <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This function decrypts two double words, using the provided key. By looking up the constants in Google,
many references to the TEA encryption algorithm can be found. However, the decrypting operations do
not look similar.</p>
</div>
<div class="paragraph">
<p>To obtain the decrypted data, the three parameters to the function <code>sub_10570</code> must be resolved.</p>
</div>
<div class="paragraph">
<p>According to the cross-references to the local variable, the second argument, which represents
the crypted data length, is not modified by the function and is equal to <code>0x28</code>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_014.png" alt="level_10_014"></span></p>
</div>
<div class="paragraph">
<p>Similary, the stack variables used as decryption key are kept unmodified from the beginning
of the function:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_015.png" alt="level_10_015"></span></p>
</div>
<div class="paragraph">
<p>From that conclusion, we can obtain the decryption key which is <code>30313233343536373839414243444546</code> in hexadecimal
or <code>0123456789ABCDEF</code> in ASCII.</p>
</div>
<div class="paragraph">
<p>The last difficulty is to identify the data that will decrypted by the pseudo-TEA algorithm. According to IDA,
this data is stored in a buffer at address <code>0x29D890</code> and, from the value of the second argument,
we already know that the size of this buffer is <code>0x28 (40)</code> bytes.</p>
</div>
<div class="paragraph">
<p>In the data section, this buffer is initialized to zero, as shown below:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_016.png" alt="level_10_016"></span></p>
</div>
<div class="paragraph">
<p>One way of obtaining the data to decrypt is to start a kernel debugger and set
up a breakpoint before calling the decryption function. Unfortunately, the buffer
still seems initialized to zero:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_018.png" alt="level_10_018"></span></p>
</div>
<div class="paragraph">
<p>Going back to IDA, we can see that each byte of the buffer has a data cross-reference
to an instruction at the end of a sub-function that modifies the value of the byte:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_10_017.png" alt="level_10_017"></span></p>
</div>
<div class="paragraph">
<p>By following each cross-reference to each byte, it is possible to reconstruct the buffer.</p>
</div>
<div class="paragraph">
<p>By using the backtracking feature of Metasm, these steps can be reproduced by the script below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-nb">require</span> <span class="tok-s1">&#39;metasm&#39;</span>
<span class="tok-kp">include</span> <span class="tok-no">Metasm</span>

<span class="tok-k">class</span> <span class="tok-nc">FLARE_TEA</span>

  <span class="tok-no">DELTA</span> <span class="tok-o">=</span> <span class="tok-mh">0x9e3779b9</span>
  <span class="tok-no">ITERATIONS</span> <span class="tok-o">=</span> <span class="tok-mi">32</span>
  <span class="tok-no">BIT_MASK</span> <span class="tok-o">=</span> <span class="tok-mh">0xFFFFFFFF</span>

  <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">)</span>
    <span class="tok-vi">@key</span> <span class="tok-o">=</span> <span class="tok-n">key</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;L*&#39;</span><span class="tok-p">)</span>
    <span class="tok-nb">puts</span> <span class="tok-s2">&quot;[+] key: &quot;</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">b_to_h</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">)</span>
  <span class="tok-k">end</span>

  <span class="tok-k">def</span> <span class="tok-nf">decrypt_chunk</span><span class="tok-p">(</span><span class="tok-n">dw0</span><span class="tok-p">,</span> <span class="tok-n">dw1</span><span class="tok-p">)</span>
    <span class="tok-n">y</span><span class="tok-p">,</span> <span class="tok-n">z</span> <span class="tok-o">=</span> <span class="tok-n">dw0</span><span class="tok-p">,</span> <span class="tok-n">dw1</span>
    <span class="tok-n">sum</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-no">DELTA</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-mi">5</span><span class="tok-p">)</span> <span class="tok-o">&amp;</span> <span class="tok-no">BIT_MASK</span>
    <span class="tok-no">ITERATIONS</span><span class="tok-o">.</span><span class="tok-n">times</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">i</span><span class="tok-o">|</span>
      <span class="tok-n">z</span> <span class="tok-o">-=</span> <span class="tok-p">(</span><span class="tok-vi">@key</span><span class="tok-o">[</span><span class="tok-mi">3</span><span class="tok-o">]</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-n">y</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">5</span><span class="tok-p">))</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-n">y</span> <span class="tok-o">+</span> <span class="tok-n">sum</span><span class="tok-p">)</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-vi">@key</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">]</span> <span class="tok-o">+</span> <span class="tok-mi">16</span> <span class="tok-o">*</span> <span class="tok-n">y</span><span class="tok-p">)</span>
      <span class="tok-n">z</span> <span class="tok-o">&amp;=</span>  <span class="tok-no">BIT_MASK</span>
      <span class="tok-n">y</span> <span class="tok-o">-=</span> <span class="tok-p">(</span><span class="tok-vi">@key</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-n">z</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">5</span><span class="tok-p">))</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-n">z</span> <span class="tok-o">+</span> <span class="tok-n">sum</span><span class="tok-p">)</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-vi">@key</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">]</span> <span class="tok-o">+</span> <span class="tok-mi">16</span> <span class="tok-o">*</span> <span class="tok-n">z</span><span class="tok-p">)</span>
      <span class="tok-n">y</span> <span class="tok-o">&amp;=</span> <span class="tok-no">BIT_MASK</span>
      <span class="tok-n">sum</span> <span class="tok-o">-=</span> <span class="tok-no">DELTA</span>
      <span class="tok-n">sum</span> <span class="tok-o">&amp;=</span> <span class="tok-no">BIT_MASK</span>
    <span class="tok-k">end</span>
    <span class="tok-k">return</span> <span class="tok-o">[</span><span class="tok-n">y</span><span class="tok-p">,</span> <span class="tok-n">z</span><span class="tok-o">]</span>
  <span class="tok-k">end</span>

  <span class="tok-k">def</span> <span class="tok-nf">decrypt</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">)</span>
    <span class="tok-nb">puts</span> <span class="tok-s2">&quot;[+] data: &quot;</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">b_to_h</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">)</span>
    <span class="tok-n">res</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
    <span class="tok-n">dwords</span> <span class="tok-o">=</span> <span class="tok-n">data</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;L*&#39;</span><span class="tok-p">)</span>
    <span class="tok-k">while</span> <span class="tok-ow">not</span> <span class="tok-n">dwords</span><span class="tok-o">.</span><span class="tok-n">empty?</span>
      <span class="tok-n">dw0</span><span class="tok-p">,</span> <span class="tok-n">dw1</span> <span class="tok-o">=</span> <span class="tok-n">dwords</span><span class="tok-o">.</span><span class="tok-n">shift</span><span class="tok-p">,</span> <span class="tok-n">dwords</span><span class="tok-o">.</span><span class="tok-n">shift</span>
      <span class="tok-n">y</span><span class="tok-p">,</span> <span class="tok-n">z</span> <span class="tok-o">=</span> <span class="tok-n">decrypt_chunk</span><span class="tok-p">(</span><span class="tok-n">dw0</span><span class="tok-p">,</span> <span class="tok-n">dw1</span><span class="tok-p">)</span>
      <span class="tok-n">res</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">y</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">z</span>
    <span class="tok-k">end</span>
    <span class="tok-c1"># pack and remove padding</span>
    <span class="tok-k">return</span> <span class="tok-n">res</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;L*&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">strip</span>
  <span class="tok-k">end</span>

  <span class="tok-kp">private</span>
  <span class="tok-k">def</span> <span class="tok-nf">b_to_h</span><span class="tok-p">(</span><span class="tok-n">s</span><span class="tok-p">)</span>
    <span class="tok-n">s</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">map</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">x</span><span class="tok-o">|</span> <span class="tok-s2">&quot;%2.2x&quot;</span> <span class="tok-o">%</span> <span class="tok-n">x</span><span class="tok-p">}</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">(</span><span class="tok-s2">&quot; &quot;</span><span class="tok-p">)</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span>

<span class="tok-no">KEY</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;0123456789ABCDEF&quot;</span>
<span class="tok-no">IOCTL_22E068_HANDLER</span> <span class="tok-o">=</span> <span class="tok-mh">0x2c760</span>
<span class="tok-no">BUFFER_ADDR</span> <span class="tok-o">=</span> <span class="tok-mh">0x29D890</span>

<span class="tok-n">exefmt</span> <span class="tok-o">=</span> <span class="tok-no">Metasm</span><span class="tok-o">.</span><span class="tok-n">const_get</span><span class="tok-p">(</span><span class="tok-s2">&quot;PE&quot;</span><span class="tok-p">)</span>
<span class="tok-n">file</span> <span class="tok-o">=</span> <span class="tok-no">ARGV</span><span class="tok-o">.</span><span class="tok-n">shift</span> <span class="tok-o">||</span> <span class="tok-s2">&quot;challenge-xp.sys&quot;</span>
<span class="tok-n">exe</span> <span class="tok-o">=</span> <span class="tok-n">exefmt</span><span class="tok-o">.</span><span class="tok-n">decode_file</span><span class="tok-p">(</span><span class="tok-n">file</span><span class="tok-p">)</span>
<span class="tok-n">exe</span><span class="tok-o">.</span><span class="tok-n">disassemble</span><span class="tok-p">(</span><span class="tok-o">[</span> <span class="tok-no">IOCTL_22E068_HANDLER</span> <span class="tok-o">]</span><span class="tok-p">)</span>

<span class="tok-n">dasm</span> <span class="tok-o">=</span> <span class="tok-n">exe</span><span class="tok-o">.</span><span class="tok-n">disassembler</span>

<span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
<span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-o">.</span><span class="tok-n">.</span><span class="tok-mi">40</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">offset</span><span class="tok-o">|</span>
  <span class="tok-n">dasm</span><span class="tok-o">.</span><span class="tok-n">each_xref</span><span class="tok-p">(</span><span class="tok-no">BUFFER_ADDR</span> <span class="tok-o">+</span> <span class="tok-n">offset</span><span class="tok-p">,</span> <span class="tok-ss">:w</span><span class="tok-p">)</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">xref</span><span class="tok-o">|</span>
    <span class="tok-k">next</span> <span class="tok-k">if</span> <span class="tok-n">xref</span><span class="tok-o">.</span><span class="tok-n">len</span> <span class="tok-o">!=</span> <span class="tok-mi">1</span>
    <span class="tok-n">di</span> <span class="tok-o">=</span> <span class="tok-n">dasm</span><span class="tok-o">.</span><span class="tok-n">decoded</span><span class="tok-o">[</span><span class="tok-n">xref</span><span class="tok-o">.</span><span class="tok-n">origin</span><span class="tok-o">]</span>
    <span class="tok-n">ins</span> <span class="tok-o">=</span> <span class="tok-n">di</span><span class="tok-o">.</span><span class="tok-n">instruction</span>
    <span class="tok-n">arg</span> <span class="tok-o">=</span> <span class="tok-n">ins</span><span class="tok-o">.</span><span class="tok-n">args</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">]</span>
    <span class="tok-k">next</span> <span class="tok-k">unless</span> <span class="tok-n">ins</span><span class="tok-o">.</span><span class="tok-n">opname</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;mov&quot;</span> <span class="tok-ow">and</span> <span class="tok-n">arg</span> <span class="tok-ow">and</span> <span class="tok-n">arg</span><span class="tok-o">.</span><span class="tok-n">kind_of?</span> <span class="tok-no">Ia32</span><span class="tok-o">::</span><span class="tok-no">Reg</span>

    <span class="tok-n">exp</span> <span class="tok-o">=</span> <span class="tok-no">Expression</span><span class="tok-o">[</span><span class="tok-n">arg</span><span class="tok-o">.</span><span class="tok-n">symbolic</span><span class="tok-o">]</span>
    <span class="tok-n">res</span> <span class="tok-o">=</span> <span class="tok-n">dasm</span><span class="tok-o">.</span><span class="tok-n">backtrace</span><span class="tok-p">(</span><span class="tok-n">exp</span><span class="tok-p">,</span> <span class="tok-n">xref</span><span class="tok-o">.</span><span class="tok-n">origin</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">first</span>
    <span class="tok-n">a</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">res</span><span class="tok-o">.</span><span class="tok-n">reduce</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span>

<span class="tok-n">crypted</span> <span class="tok-o">=</span> <span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>
<span class="tok-n">flare_tea</span> <span class="tok-o">=</span> <span class="tok-no">FLARE_TEA</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-no">KEY</span><span class="tok-p">)</span>
<span class="tok-nb">puts</span> <span class="tok-n">flare_tea</span><span class="tok-o">.</span><span class="tok-n">decrypt</span><span class="tok-p">(</span><span class="tok-n">crypted</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the script returns the validation email:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ruby -I~/git/hub/metasm solve_10_1.rb challenge-xp.sys
<span class="tok-go">[+] key: 30 31 32 33 34 35 36 37 38 39 41 42 43 44 45 46</span>
<span class="tok-go">[+] data: 56 7f dc fa aa 27 99 c4 6c 7c fc 92 61 61 47 1a 19 b9 63 fd 0c f2 b6 20 c0 2d 5c fd d9 71 54 96 4f 43 f7 ff bb 4c 5d 31</span>
<span class="tok-go">unconditional_conditions@flare-on.com</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_level_11">Level 11</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For this level, FireEye provides a new Win32 PE to analyze named <code>CryptoGraph.exe</code>.</p>
</div>
<div class="paragraph">
<p>The program needs at least one argument to run. With just one argument, it loops forever and does not return:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_001.png" alt="level_11_001"></span></p>
</div>
<div class="sect2">
<h3 id="_cryptographic_algorithms">Cryptographic algorithms</h3>
<div class="paragraph">
<p>As the filename seems to imply, the code may implement some cryptographic algorithms. The KANAL plugin
of PeID detects RC5 and MD5 implementations in the binary:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_002.png" alt="level_11_002"></span></p>
</div>
<div class="paragraph">
<p>KANAL can produce an IDC script to automatically add comments and mark positions in IDA:</p>
</div>
<div class="listingblock">
<div class="title">kanal.idc</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="lineno"> 1</span> <span class="tok-cp">#include &lt;idc.idc&gt;</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="tok-k">static</span> <span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-kt">void</span><span class="tok-p">)</span>
<span class="lineno"> 4</span> <span class="tok-p">{</span>
<span class="lineno"> 5</span> 	<span class="tok-k">auto</span> <span class="tok-n">slotidx</span><span class="tok-p">;</span>
<span class="lineno"> 6</span> 	<span class="tok-n">slotidx</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> 	<span class="tok-n">MarkPosition</span><span class="tok-p">(</span><span class="tok-mh">0x00410008</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">slotidx</span> <span class="tok-o">+</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-s">&quot;CryptGenRandom [Import]&quot;</span><span class="tok-p">);</span>
<span class="lineno"> 9</span> 	<span class="tok-n">MakeComm</span><span class="tok-p">(</span><span class="tok-n">PrevNotTail</span><span class="tok-p">(</span><span class="tok-mh">0x00410009</span><span class="tok-p">),</span> <span class="tok-s">&quot;CryptGenRandom [Import]</span><span class="tok-se">\n</span><span class="tok-s">Microsoft CryptoAPI import&quot;</span><span class="tok-p">);</span>
<span class="lineno">10</span> 	<span class="tok-n">MarkPosition</span><span class="tok-p">(</span><span class="tok-mh">0x004021E4</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">slotidx</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-s">&quot;MD5&quot;</span><span class="tok-p">);</span>
<span class="lineno">11</span> 	<span class="tok-n">MakeComm</span><span class="tok-p">(</span><span class="tok-n">PrevNotTail</span><span class="tok-p">(</span><span class="tok-mh">0x004021E5</span><span class="tok-p">),</span> <span class="tok-s">&quot;MD5</span><span class="tok-se">\n</span><span class="tok-s">MD5 transform (</span><span class="tok-se">\&quot;</span><span class="tok-s">compress</span><span class="tok-se">\&quot;</span><span class="tok-s">) constants&quot;</span><span class="tok-p">);</span>
<span class="lineno">12</span> 	<span class="tok-n">MarkPosition</span><span class="tok-p">(</span><span class="tok-mh">0x00402A17</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">slotidx</span> <span class="tok-o">+</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-s">&quot;RC5 / RC6 [Init, -Delta]&quot;</span><span class="tok-p">);</span>
<span class="lineno">13</span> 	<span class="tok-n">MakeComm</span><span class="tok-p">(</span><span class="tok-n">PrevNotTail</span><span class="tok-p">(</span><span class="tok-mh">0x00402A18</span><span class="tok-p">),</span> <span class="tok-s">&quot;RC5 / RC6 [Init, -Delta]</span><span class="tok-se">\n</span><span class="tok-s">RC5/6 32bit magic constants, negative Delta&quot;</span><span class="tok-p">);</span>
<span class="lineno">14</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The result can be seen in IDA, for the MD5 constant (used in the <code>MD5Transform</code> function) :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_003.png" alt="level_11_003"></span></p>
</div>
<div class="paragraph">
<p>And for RC5 (used in the <code>RC5Setup</code> function) :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_004.png" alt="level_11_004"></span></p>
</div>
<div class="paragraph">
<p>It can be noticed that the key is initialized in an special way, compared to the standard implementations
(as <a href="http://www.ussrback.com/crypto/misc/rc5ref.c">rc5ref.c</a>).</p>
</div>
<div class="paragraph">
<p>The usual setup looks like the code below :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">void</span> <span class="tok-nf">RC5_SETUP</span><span class="tok-p">(</span><span class="tok-kt">unsigned</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">K</span><span class="tok-p">)</span> <span class="tok-cm">/* secret input key K[0...b-1]      */</span>
<span class="tok-p">{</span>  <span class="tok-n">WORD</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">j</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">u</span><span class="tok-o">=</span><span class="tok-n">w</span><span class="tok-o">/</span><span class="tok-mi">8</span><span class="tok-p">,</span> <span class="tok-n">A</span><span class="tok-p">,</span> <span class="tok-n">B</span><span class="tok-p">,</span> <span class="tok-n">L</span><span class="tok-p">[</span><span class="tok-n">c</span><span class="tok-p">];</span>
   <span class="tok-cm">/* Initialize L, then S, then mix key into S */</span>
   <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-o">=</span><span class="tok-n">b</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-n">L</span><span class="tok-p">[</span><span class="tok-n">c</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">]</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">!=-</span><span class="tok-mi">1</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">--</span><span class="tok-p">)</span> <span class="tok-n">L</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-o">/</span><span class="tok-n">u</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">L</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-o">/</span><span class="tok-n">u</span><span class="tok-p">]</span><span class="tok-o">&lt;&lt;</span><span class="tok-mi">8</span><span class="tok-p">)</span><span class="tok-o">+</span><span class="tok-n">K</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>
   <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">S</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-o">=</span><span class="tok-mh">0xb7e15163</span><span class="tok-p">,</span><span class="tok-n">i</span><span class="tok-o">=</span><span class="tok-mi">1</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">&lt;</span><span class="tok-n">t</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-n">S</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">S</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">]</span><span class="tok-o">+</span><span class="tok-mh">0x9e3779b9</span><span class="tok-p">;</span>
   <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">A</span><span class="tok-o">=</span><span class="tok-n">B</span><span class="tok-o">=</span><span class="tok-n">i</span><span class="tok-o">=</span><span class="tok-n">j</span><span class="tok-o">=</span><span class="tok-n">k</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">k</span><span class="tok-o">&lt;</span><span class="tok-mi">3</span><span class="tok-o">*</span><span class="tok-n">t</span><span class="tok-p">;</span> <span class="tok-n">k</span><span class="tok-o">++</span><span class="tok-p">,</span><span class="tok-n">i</span><span class="tok-o">=</span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-o">%</span><span class="tok-n">t</span><span class="tok-p">,</span><span class="tok-n">j</span><span class="tok-o">=</span><span class="tok-p">(</span><span class="tok-n">j</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-o">%</span><span class="tok-n">c</span><span class="tok-p">)</span>   <span class="tok-cm">/* 3*t &gt; 3*c */</span>
     <span class="tok-p">{</span> <span class="tok-n">A</span> <span class="tok-o">=</span> <span class="tok-n">S</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">ROTL</span><span class="tok-p">(</span><span class="tok-n">S</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span><span class="tok-o">+</span><span class="tok-p">(</span><span class="tok-n">A</span><span class="tok-o">+</span><span class="tok-n">B</span><span class="tok-p">),</span><span class="tok-mi">3</span><span class="tok-p">);</span>
       <span class="tok-n">B</span> <span class="tok-o">=</span> <span class="tok-n">L</span><span class="tok-p">[</span><span class="tok-n">j</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">ROTL</span><span class="tok-p">(</span><span class="tok-n">L</span><span class="tok-p">[</span><span class="tok-n">j</span><span class="tok-p">]</span><span class="tok-o">+</span><span class="tok-p">(</span><span class="tok-n">A</span><span class="tok-o">+</span><span class="tok-n">B</span><span class="tok-p">),(</span><span class="tok-n">A</span><span class="tok-o">+</span><span class="tok-n">B</span><span class="tok-p">));</span>
     <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In <code>CryptoGraph.exe</code>, the sub-keys are initialized with a <code>sub</code> operation and
the negative value of the constant <code>Q</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="irb"><span class="tok-gp">irb(main):001:0&gt; </span><span class="tok-s2">&quot;%x&quot;</span> <span class="tok-o">%</span> <span class="tok-p">(</span><span class="tok-o">-</span><span class="tok-mh">0x9e3779b9</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xFFFFFFFF</span><span class="tok-p">)</span>
<span class="tok-go"> =&gt; &quot;61c88647&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As mentioned by the <a href="https://securelist.com/files/2015/02/Equation_group_questions_and_answers.pdf">Equation Group: questions and answers</a>
report from Kapersky, this implementation is unusual and was found in several advanced malwares like Regin and those used by the Equation Group.
This may be some kind of reference coming from the author of this challenge or just some kind of coincidence.</p>
</div>
<div class="paragraph">
<p>By following the cross-references to the <code>MD5Transform</code> (<code>0x4021A0</code>) and <code>RC5Setup</code> (<code>0x402A10</code>) functions and comparing
the code to reference implementations of the two algorithms, a few other functions can be identified :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>MD5Init</code> at <code>0x401FE0</code></p>
</li>
<li>
<p><code>MD5Update</code> at <code>0x402040</code></p>
</li>
<li>
<p><code>MD5Final</code> at <code>0x4020F0</code></p>
</li>
<li>
<p><code>RC5Key</code> at <code>0x402AC0</code></p>
</li>
<li>
<p><code>RC5Decrypt_dwords</code> at <code>0x402A60</code>, called to decrypt two unsigned 32-bit integers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally, the two structures below were loaded in IDA and mapped to the variables referenced
by these functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-cm">/* MD5 context. */</span>
<span class="tok-k">typedef</span> <span class="tok-k">struct</span> <span class="tok-p">{</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">long</span> <span class="tok-n">state</span><span class="tok-p">[</span><span class="tok-mi">4</span><span class="tok-p">];</span>     <span class="tok-cm">/* state (ABCD) */</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">long</span> <span class="tok-n">count</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">];</span> <span class="tok-cm">/* number of bits, modulo 2^64 (lsb first) */</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">char</span> <span class="tok-n">buffer</span><span class="tok-p">[</span><span class="tok-mi">64</span><span class="tok-p">];</span>   <span class="tok-cm">/* input buffer */</span>
<span class="tok-p">}</span> <span class="tok-n">MD5_CTX</span><span class="tok-p">;</span>

<span class="tok-cm">/* RC5 context */</span>
<span class="tok-k">typedef</span> <span class="tok-k">struct</span> <span class="tok-p">{</span>
    <span class="tok-kt">unsigned</span> <span class="tok-kt">long</span> <span class="tok-o">*</span><span class="tok-n">S</span><span class="tok-p">;</span>     <span class="tok-cm">/* subkeys */</span>
    <span class="tok-kt">unsigned</span> <span class="tok-kt">long</span> <span class="tok-n">rounds</span><span class="tok-p">;</span> <span class="tok-cm">/* number of rounds */</span>
<span class="tok-p">}</span> <span class="tok-n">RC5_CTX</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Concerning the algorithm implementations in the <code>CryptoGraph.exe</code> binary, some specificities need to be
addressed. At the end of the <code>MD5Final</code> function, each double-word of the final state is byte-swapped and
then copied to the destination buffer, as illustrated by the screenshot below:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_005.png" alt="level_11_005"></span></p>
</div>
<div class="paragraph">
<p>In a standard implementation (see <a href="https://www.cs.cmu.edu/~jcl/linux/seal/md5.c">md5.c</a>),
the result must be in little endian byte order. The byte-swap operation is only required
on big endian architectures, as shown below:</p>
</div>
<div class="listingblock">
<div class="title">md5.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-cp">#ifdef __BIG_ENDIAN</span>
<span class="tok-cp"># define SWAP(n)							\</span>
<span class="tok-cp">    (((n) &lt;&lt; 24) | (((n) &amp; 0xff00) &lt;&lt; 8) | (((n) &gt;&gt; 8) &amp; 0xff00) | ((n) &gt;&gt; 24))</span>
<span class="tok-cp">#else</span>
<span class="tok-cp"># define SWAP(n) (n)</span>
<span class="tok-cp">#endif</span>

<span class="tok-p">[...]</span>

<span class="tok-cm">/* Put result from CTX in first 16 bytes following RESBUF.  The result</span>
<span class="tok-cm">   must be in little endian byte order.</span>

<span class="tok-cm">   IMPORTANT: On some systems it is required that RESBUF is correctly</span>
<span class="tok-cm">   aligned for a 32 bits value.  */</span>
<span class="tok-kt">void</span> <span class="tok-o">*</span>
<span class="tok-n">md5_read_ctx</span> <span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-p">,</span> <span class="tok-n">resbuf</span><span class="tok-p">)</span>
     <span class="tok-k">const</span> <span class="tok-k">struct</span> <span class="tok-n">md5_ctx</span> <span class="tok-o">*</span><span class="tok-n">ctx</span><span class="tok-p">;</span>
     <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">resbuf</span><span class="tok-p">;</span>
<span class="tok-p">{</span>
  <span class="tok-p">((</span><span class="tok-n">u32</span> <span class="tok-o">*</span><span class="tok-p">)</span> <span class="tok-n">resbuf</span><span class="tok-p">)[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">SWAP</span> <span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">A</span><span class="tok-p">);</span>
  <span class="tok-p">((</span><span class="tok-n">u32</span> <span class="tok-o">*</span><span class="tok-p">)</span> <span class="tok-n">resbuf</span><span class="tok-p">)[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">SWAP</span> <span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">B</span><span class="tok-p">);</span>
  <span class="tok-p">((</span><span class="tok-n">u32</span> <span class="tok-o">*</span><span class="tok-p">)</span> <span class="tok-n">resbuf</span><span class="tok-p">)[</span><span class="tok-mi">2</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">SWAP</span> <span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">C</span><span class="tok-p">);</span>
  <span class="tok-p">((</span><span class="tok-n">u32</span> <span class="tok-o">*</span><span class="tok-p">)</span> <span class="tok-n">resbuf</span><span class="tok-p">)[</span><span class="tok-mi">3</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">SWAP</span> <span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">D</span><span class="tok-p">);</span>

  <span class="tok-k">return</span> <span class="tok-n">resbuf</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Consequently, the implementation of the <code>MD5</code> algorithm in <code>CryptoGraph.exe</code> is not standard.</p>
</div>
<div class="paragraph">
<p>Another interesting observation is that the function <code>MD5Update</code> is called several times
by another function at address <code>0x402870</code>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_006.png" alt="level_11_006"></span></p>
</div>
<div class="paragraph">
<p>The hashes are computed from data initialized by two constants, <code>xmmword_414690</code> and <code>xmmword_4146A0</code>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_007.png" alt="level_11_007"></span></p>
</div>
<div class="paragraph">
<p>These two constants are respectively <code>ipad</code> and <code>opad</code>: they are used to compute
hash-based message authentication code, as described on <a href="https://en.wikipedia.org/wiki/Hash-based_message_authentication_code">Wikipedia</a>.</p>
</div>
<div class="paragraph">
<p>The function at address <code>0x402870</code> can be called to compute a HMAC-MD5 code, given
a specify key and a message to authenticate.</p>
</div>
<div class="paragraph">
<p>Concerning the RC5 <code>algorithm</code>, the function <code>RC5Decrypt_dwords</code> is called by a single function at address
<code>0x402BE0</code>, renamed to <code>RC5Decrypt</code>. This function is used to decrypt a block of data and
is shown below (after being decompiled by IDA):</p>
</div>
<div id="rc5_decrypt_c" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">int</span> <span class="tok-kr">__stdcall</span> <span class="tok-nf">RC5Decrypt</span><span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">crypted</span><span class="tok-p">,</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">plaintext</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">size_in_bytes</span><span class="tok-p">,</span> <span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-n">a4</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">rounded_size</span><span class="tok-p">;</span> <span class="tok-c1">// edi@1</span>
  <span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-n">crypted_dwords</span><span class="tok-p">;</span> <span class="tok-c1">// ebx@2</span>
  <span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-n">plaintext_dwords</span><span class="tok-p">;</span> <span class="tok-c1">// esi@2</span>
  <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">iter_count</span><span class="tok-p">;</span> <span class="tok-c1">// edi@3</span>
  <span class="tok-kt">int</span> <span class="tok-n">v8</span><span class="tok-p">;</span> <span class="tok-c1">// eax@4</span>
  <span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-n">v9</span><span class="tok-p">;</span> <span class="tok-c1">// edx@5</span>
  <span class="tok-kt">int</span> <span class="tok-n">result</span><span class="tok-p">;</span> <span class="tok-c1">// eax@5</span>

  <span class="tok-n">rounded_size</span> <span class="tok-o">=</span> <span class="tok-n">size_in_bytes</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xFFFFFFF8</span><span class="tok-p">;</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">size_in_bytes</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xFFFFFFF8</span> <span class="tok-p">)</span>
  <span class="tok-p">{</span> <span class="tok-cm">/* last two dwords */</span>
    <span class="tok-n">crypted_dwords</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">crypted</span> <span class="tok-o">+</span> <span class="tok-n">rounded_size</span> <span class="tok-o">-</span> <span class="tok-mi">8</span><span class="tok-p">;</span>
    <span class="tok-n">plaintext_dwords</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">plaintext</span> <span class="tok-o">+</span> <span class="tok-n">rounded_size</span> <span class="tok-o">-</span> <span class="tok-mi">8</span><span class="tok-p">;</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">rounded_size</span> <span class="tok-o">&gt;</span> <span class="tok-mi">8</span> <span class="tok-p">)</span>
    <span class="tok-p">{</span>
      <span class="tok-n">iter_count</span> <span class="tok-o">=</span> <span class="tok-p">((</span><span class="tok-n">rounded_size</span> <span class="tok-o">-</span> <span class="tok-mi">9</span><span class="tok-p">)</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">3</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
      <span class="tok-k">do</span>
      <span class="tok-p">{</span>
        <span class="tok-n">RC5Decrypt_dwords</span><span class="tok-p">(</span><span class="tok-n">crypted_dwords</span><span class="tok-p">,</span> <span class="tok-n">plaintext_dwords</span><span class="tok-p">);</span>
        <span class="tok-o">*</span><span class="tok-n">plaintext_dwords</span> <span class="tok-o">^=</span> <span class="tok-o">*</span><span class="tok-p">(</span><span class="tok-n">crypted_dwords</span> <span class="tok-o">-</span> <span class="tok-mi">2</span><span class="tok-p">);</span>
        <span class="tok-n">v8</span> <span class="tok-o">=</span> <span class="tok-o">*</span><span class="tok-p">(</span><span class="tok-n">crypted_dwords</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">);</span>
        <span class="tok-n">crypted_dwords</span> <span class="tok-o">-=</span> <span class="tok-mi">2</span><span class="tok-p">;</span>
        <span class="tok-n">plaintext_dwords</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">^=</span> <span class="tok-n">v8</span><span class="tok-p">;</span>
        <span class="tok-n">plaintext_dwords</span> <span class="tok-o">-=</span> <span class="tok-mi">2</span><span class="tok-p">;</span>
        <span class="tok-o">--</span><span class="tok-n">iter_count</span><span class="tok-p">;</span>
      <span class="tok-p">}</span>
      <span class="tok-k">while</span> <span class="tok-p">(</span> <span class="tok-n">iter_count</span> <span class="tok-p">);</span>
    <span class="tok-p">}</span>
    <span class="tok-cm">/* Decrypt the first two dwords */</span>
    <span class="tok-n">RC5Decrypt_dwords</span><span class="tok-p">(</span><span class="tok-n">crypted_dwords</span><span class="tok-p">,</span> <span class="tok-n">plaintext_dwords</span><span class="tok-p">);</span>
    <span class="tok-n">v9</span> <span class="tok-o">=</span> <span class="tok-n">plaintext</span><span class="tok-p">;</span>
    <span class="tok-o">*</span><span class="tok-n">v9</span> <span class="tok-o">^=</span> <span class="tok-o">*</span><span class="tok-n">a4</span><span class="tok-p">;</span>
    <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">a4</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">];</span>
    <span class="tok-n">v9</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">^=</span> <span class="tok-n">result</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
  <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The data is decrypted two double-words at a time, starting from the end
of the buffer. After each decryption, the result is xor-ed with the
previous double-words in the crypted buffer
(that will be decrypted at the next iteration).</p>
</div>
<div class="paragraph">
<p>The first two double-words are decrypted then xor-ed with the values
specified by the last argument.</p>
</div>
<div class="paragraph">
<p>To complement this bottom-up approach and understand how the cryptographic
algorithms are used through <code>CryptoGraph.exe</code>, the next step is to follow
the code flow, starting from the entry point.</p>
</div>
</div>
<div class="sect2">
<h3 id="_top_down_analysis">Top-down analysis</h3>
<div class="paragraph">
<p>After the usual initialization functions (computing the value of security cookie, <code>___tmainCRTStartup</code>, etc), the
main function is finally identified at address <code>0x401F60</code>. Its code can
be decompiled cleanly by IDA and is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">int</span> <span class="tok-kr">__cdecl</span> <span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">argc</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">**</span><span class="tok-n">argv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">**</span><span class="tok-n">envp</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-n">HANDLE</span> <span class="tok-n">handle</span><span class="tok-p">;</span> <span class="tok-c1">// esi@1</span>
  <span class="tok-kt">char</span> <span class="tok-n">v4</span><span class="tok-p">;</span> <span class="tok-c1">// al@3</span>

  <span class="tok-n">handle</span> <span class="tok-o">=</span> <span class="tok-n">CreateFileW</span><span class="tok-p">(</span><span class="tok-s">L&quot;secret.jpg&quot;</span><span class="tok-p">,</span> <span class="tok-mh">0x40000000u</span><span class="tok-p">,</span> <span class="tok-mi">2u</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">2u</span><span class="tok-p">,</span> <span class="tok-mh">0x80u</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">handle</span> <span class="tok-o">!=</span> <span class="tok-p">(</span><span class="tok-n">HANDLE</span><span class="tok-p">)</span><span class="tok-o">-</span><span class="tok-mi">1</span> <span class="tok-p">)</span>
  <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">argc</span> <span class="tok-o">&gt;</span> <span class="tok-mi">1</span> <span class="tok-p">)</span>
    <span class="tok-p">{</span>
      <span class="tok-n">v4</span> <span class="tok-o">=</span> <span class="tok-n">atoi</span><span class="tok-p">((</span><span class="tok-kt">int</span><span class="tok-p">)</span><span class="tok-n">argv</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]);</span>
      <span class="tok-n">sub_401910</span><span class="tok-p">((</span><span class="tok-kt">int</span><span class="tok-p">)</span><span class="tok-n">handle</span><span class="tok-p">,</span> <span class="tok-n">v4</span><span class="tok-p">);</span>
      <span class="tok-n">print_string</span><span class="tok-p">(</span><span class="tok-s">L&quot;The </span><span class="tok-se">\&quot;</span><span class="tok-s">secret.jpg</span><span class="tok-se">\&quot;</span><span class="tok-s"> has been written to the current execution folder.</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
      <span class="tok-n">CloseHandle</span><span class="tok-p">(</span><span class="tok-n">handle</span><span class="tok-p">);</span>
      <span class="tok-k">return</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-n">print_string</span><span class="tok-p">(</span><span class="tok-s">L&quot;The number of parameters passed in is incorrect.</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
    <span class="tok-n">CloseHandle</span><span class="tok-p">(</span><span class="tok-n">handle</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
  <span class="tok-k">return</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A handle is opened on the file <code>secret.jpg</code>, the first argument is converted to
an integer and the function <code>sub_401910</code> (renamed <code>decrypt_and_write_secret</code> during the analysis) is called with these two values as parameters.
After returning from this function, the program should print <code>The "secret.jpg" has been written to the current execution folder</code>.</p>
</div>
<div class="paragraph">
<p>The callgraph from the <code>main</code> function is shown below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/main_l2.svg" alt="main l2">
</div>
</div>
<div class="paragraph">
<p>Obvisouly, the next step is to take a look at the function <code>decrypt_and_write_secret</code>.</p>
</div>
<div class="sect3">
<h4 id="_function_decrypt_and_write_secret">Function decrypt_and_write_secret</h4>
<div class="paragraph">
<p>The function starts by reading the contents of the resource number 120 into a buffer referenced by the register <code>esi</code>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_008.png" alt="level_11_008"></span></p>
</div>
<div class="paragraph">
<p>and continues by doing the same for resource 121, this time referencing the data read with <code>edi</code>:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_009.png" alt="level_11_009"></span></p>
</div>
<div class="paragraph">
<p>Further down, a crypto provider is initialized and some computations are realized on the data of resource 120: the data
is divided into 3 arrays of 16 bytes, each one stored in a xmmword (128-bits). Finally, the three xmmwords are xor-ed
and the result is stored in the memory area pointed by <code>esi</code>.</p>
</div>
<div class="paragraph">
<p>After that, the function <code>sub_4015D0</code> (renamed <code>decrypt_blocks</code>) is called as shown on the screenshot below:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_010.png" alt="level_11_010"></span></p>
</div>
<div class="paragraph">
<p>After returning, the function <code>sub_401CF0</code> (renamed <code>write_secret</code>) is called. This one is added to the backlog of functions for further analysis.</p>
</div>
</div>
<div class="sect3">
<h4 id="_function_decrypt_blocks">Function decrypt_blocks</h4>
<div class="paragraph">
<p>The callgraph of the function <code>decrypt_blocks</code> is shown below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/decrypt_blocks_l2.svg" alt="decrypt blocks l2">
</div>
</div>
<div class="paragraph">
<p>First, the function sub_401000 (renamed <code>check_res_121_data</code>) is called with <code>res_121_data</code> as argument.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_015.png" alt="level_11_015"></span></p>
</div>
<div class="paragraph">
<p>This function can be decompiled as such:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="lineno"> 1</span> <span class="tok-kt">char</span> <span class="tok-n">__thiscall</span> <span class="tok-nf">check_res_121_data</span><span class="tok-p">(</span><span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">res_121_data</span><span class="tok-p">)</span>
<span class="lineno"> 2</span> <span class="tok-p">{</span>
<span class="lineno"> 3</span>   <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">res_121_data_</span><span class="tok-p">;</span> <span class="tok-c1">// esi@1</span>
<span class="lineno"> 4</span>   <span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-n">ref_md5</span><span class="tok-p">;</span> <span class="tok-c1">// edx@3</span>
<span class="lineno"> 5</span>   <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">bytes_to_check</span><span class="tok-p">;</span> <span class="tok-c1">// esi@3</span>
<span class="lineno"> 6</span>   <span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-n">pdigest</span><span class="tok-p">;</span> <span class="tok-c1">// ecx@3</span>
<span class="lineno"> 7</span>   <span class="tok-kt">bool</span> <span class="tok-n">finished</span><span class="tok-p">;</span> <span class="tok-c1">// cf@5</span>
<span class="lineno"> 8</span>   <span class="tok-n">MD5_CTX</span> <span class="tok-n">md5_ctx</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+8h] [bp-70h]@1</span>
<span class="lineno"> 9</span>   <span class="tok-kt">char</span> <span class="tok-n">digest</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+64h] [bp-14h]@1</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>   <span class="tok-n">res_121_data_</span> <span class="tok-o">=</span> <span class="tok-n">res_121_data</span><span class="tok-p">;</span>
<span class="lineno">12</span>   <span class="tok-n">MD5Init</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">md5_ctx</span><span class="tok-p">);</span>
<span class="lineno">13</span>   <span class="tok-n">MD5Update</span><span class="tok-p">(</span><span class="tok-n">res_121_data_</span> <span class="tok-o">+</span> <span class="tok-mi">48</span><span class="tok-p">,</span> <span class="tok-mh">0x600</span><span class="tok-p">);</span>
<span class="lineno">14</span>   <span class="tok-n">MD5Final</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">md5_ctx</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">digest</span><span class="tok-p">);</span>
<span class="lineno">15</span>   <span class="tok-cm">/* compare res_121_data to &quot;FLARE-ON&quot; */</span>
<span class="lineno">16</span>   <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-o">*</span><span class="tok-p">(</span><span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">res_121_data_</span> <span class="tok-o">==</span> <span class="tok-mh">0x52414C46</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-o">*</span><span class="tok-p">((</span><span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">res_121_data_</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-mh">0x4E4F2D45</span> <span class="tok-p">)</span>
<span class="lineno">17</span>   <span class="tok-p">{</span>
<span class="lineno">18</span>     <span class="tok-n">ref_md5</span> <span class="tok-o">=</span> <span class="tok-n">res_121_data_</span> <span class="tok-o">+</span> <span class="tok-mi">32</span><span class="tok-p">;</span>
<span class="lineno">19</span>     <span class="tok-n">bytes_to_check</span> <span class="tok-o">=</span> <span class="tok-mi">12</span><span class="tok-p">;</span>
<span class="lineno">20</span>     <span class="tok-n">pdigest</span> <span class="tok-o">=</span> <span class="tok-o">&amp;</span><span class="tok-n">digest</span><span class="tok-p">;</span>
<span class="lineno">21</span>     <span class="tok-k">while</span> <span class="tok-p">(</span> <span class="tok-o">*</span><span class="tok-n">pdigest</span> <span class="tok-o">==</span> <span class="tok-o">*</span><span class="tok-n">ref_md5</span> <span class="tok-p">)</span>
<span class="lineno">22</span>     <span class="tok-p">{</span>
<span class="lineno">23</span>       <span class="tok-o">++</span><span class="tok-n">pdigest</span><span class="tok-p">;</span>
<span class="lineno">24</span>       <span class="tok-o">++</span><span class="tok-n">ref_md5</span><span class="tok-p">;</span>
<span class="lineno">25</span>       <span class="tok-n">finished</span> <span class="tok-o">=</span> <span class="tok-n">bytes_to_check</span> <span class="tok-o">&lt;</span> <span class="tok-mi">4</span><span class="tok-p">;</span>
<span class="lineno">26</span>       <span class="tok-n">bytes_to_check</span> <span class="tok-o">-=</span> <span class="tok-mi">4</span><span class="tok-p">;</span>
<span class="lineno">27</span>       <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">finished</span> <span class="tok-p">)</span>
<span class="lineno">28</span>         <span class="tok-k">return</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="lineno">29</span>     <span class="tok-p">}</span>
<span class="lineno">30</span>   <span class="tok-p">}</span>
<span class="lineno">31</span>   <span class="tok-k">return</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="lineno">32</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This gives us a few indications on the content of the resource 121. The first 8 bytes must be equal to
the string <code>FLARE-ON</code>. Starting from offset 48, <code>0x600</code> bytes are hashed through the MD5 algorithm. The
resulting digest is compared to a reference digest at offset 32.</p>
</div>
<div class="paragraph">
<p>Back to the function  <code>decrypt_blocks</code>, the beginning of the decompilation is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="lineno"> 1</span> <span class="tok-kt">int</span> <span class="tok-kr">__fastcall</span> <span class="tok-nf">decrypt_blocks</span><span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">ctx</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">unused</span><span class="tok-p">,</span> <span class="tok-kt">char</span> <span class="tok-n">first_arg</span><span class="tok-p">,</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">res_120_xor</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">unused_1</span><span class="tok-p">,</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">res_121_data</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">unused_2</span><span class="tok-p">)</span>
<span class="lineno"> 2</span> <span class="tok-p">{</span>
<span class="lineno"> 3</span>   <span class="tok-p">[...]</span>
<span class="lineno"> 4</span>   <span class="tok-n">v7</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="lineno"> 5</span>   <span class="tok-n">result_value</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="lineno"> 6</span>   <span class="tok-n">ctx_</span> <span class="tok-o">=</span> <span class="tok-n">ctx</span><span class="tok-p">;</span>
<span class="lineno"> 7</span>   <span class="tok-n">ctx__</span> <span class="tok-o">=</span> <span class="tok-n">ctx</span><span class="tok-p">;</span>
<span class="lineno"> 8</span>   <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-o">!</span><span class="tok-n">res_121_data</span> <span class="tok-p">)</span>
<span class="lineno"> 9</span>     <span class="tok-k">goto</span> <span class="tok-n">LABEL_29</span><span class="tok-p">;</span>
<span class="lineno">10</span>   <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-o">!</span><span class="tok-n">check_res_121_data</span><span class="tok-p">((</span><span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">res_121_data</span><span class="tok-p">)</span> <span class="tok-p">)</span>
<span class="lineno">11</span>   <span class="tok-p">{</span>
<span class="lineno">12</span>     <span class="tok-n">v7</span> <span class="tok-o">=</span> <span class="tok-n">result_value</span><span class="tok-p">;</span>
<span class="lineno">13</span> <span class="tok-nl">LABEL_29</span><span class="tok-p">:</span>
<span class="lineno">14</span>     <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">v7</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="lineno">15</span>     <span class="tok-n">result_value</span> <span class="tok-o">=</span> <span class="tok-n">result</span><span class="tok-p">;</span>
<span class="lineno">16</span>     <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-p">;</span>
<span class="lineno">17</span>   <span class="tok-p">}</span>
<span class="lineno">18</span>   <span class="tok-n">memcpy_s</span><span class="tok-p">((</span><span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">ctx_</span> <span class="tok-o">+</span> <span class="tok-mi">8</span><span class="tok-p">,</span> <span class="tok-mh">0x630u</span><span class="tok-p">,</span> <span class="tok-n">res_121_data</span><span class="tok-p">,</span> <span class="tok-mh">0x630u</span><span class="tok-p">);</span>
<span class="lineno">19</span>   <span class="tok-o">*</span><span class="tok-p">((</span><span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">ctx_</span> <span class="tok-o">+</span> <span class="tok-mi">398</span><span class="tok-p">)</span> <span class="tok-o">=</span> <span class="tok-o">*</span><span class="tok-p">((</span><span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">ctx_</span> <span class="tok-o">+</span> <span class="tok-mi">4</span><span class="tok-p">);</span>
<span class="lineno">20</span>   <span class="tok-o">*</span><span class="tok-p">((</span><span class="tok-n">_BYTE</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">ctx_</span> <span class="tok-o">+</span> <span class="tok-mi">24</span><span class="tok-p">)</span> <span class="tok-o">|=</span> <span class="tok-n">first_arg</span><span class="tok-p">;</span>
<span class="lineno">21</span>   <span class="tok-n">sub_4014E0</span><span class="tok-p">(</span><span class="tok-n">res_120_xor</span><span class="tok-p">,</span> <span class="tok-mi">16</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">ctx_</span> <span class="tok-o">+</span> <span class="tok-mi">24</span><span class="tok-p">,</span> <span class="tok-n">v9</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-p">((</span><span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">ctx_</span> <span class="tok-o">+</span> <span class="tok-mi">398</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-p">)</span><span class="tok-n">rc5_key</span><span class="tok-p">);</span>
<span class="lineno">22</span>   <span class="tok-n">rc5_ctx</span><span class="tok-p">.</span><span class="tok-n">rounds</span> <span class="tok-o">=</span> <span class="tok-o">*</span><span class="tok-p">((</span><span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">res_121_data</span> <span class="tok-o">+</span> <span class="tok-mi">3</span><span class="tok-p">);</span>
<span class="lineno">23</span>   <span class="tok-n">KR</span> <span class="tok-o">=</span> <span class="tok-mi">2</span> <span class="tok-o">*</span> <span class="tok-n">rc5_ctx</span><span class="tok-p">.</span><span class="tok-n">rounds</span> <span class="tok-o">+</span> <span class="tok-mi">2</span><span class="tok-p">;</span>
<span class="lineno">24</span>   <span class="tok-n">S_mem</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-kt">unsigned</span> <span class="tok-kr">__int32</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">alloc_mem</span><span class="tok-p">(</span><span class="tok-mi">4</span> <span class="tok-o">*</span> <span class="tok-n">KR</span> <span class="tok-o">|</span> <span class="tok-o">-</span><span class="tok-p">((</span><span class="tok-kt">unsigned</span> <span class="tok-kr">__int64</span><span class="tok-p">)</span><span class="tok-n">KR</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">30</span> <span class="tok-o">!=</span> <span class="tok-mi">0</span><span class="tok-p">));</span>
<span class="lineno">25</span>   <span class="tok-n">rc5_ctx</span><span class="tok-p">.</span><span class="tok-n">S</span> <span class="tok-o">=</span> <span class="tok-n">S_mem</span><span class="tok-p">;</span>
<span class="lineno">26</span>   <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">S_mem</span> <span class="tok-p">)</span>
<span class="lineno">27</span>   <span class="tok-p">{</span>
<span class="lineno">28</span>     <span class="tok-n">RC5Setup</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">rc5_ctx</span><span class="tok-p">);</span>
<span class="lineno">29</span>     <span class="tok-n">RC5Key</span><span class="tok-p">(</span><span class="tok-n">rc5_key</span><span class="tok-p">,</span> <span class="tok-mi">16u</span><span class="tok-p">);</span>
<span class="lineno">30</span>   <span class="tok-p">}</span>
<span class="lineno">31</span>   <span class="tok-n">dwords</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="lineno">32</span>   <span class="tok-n">dwords</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="lineno">33</span>   <span class="tok-n">RC5_decrypt</span><span class="tok-p">((</span><span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">ctx_</span> <span class="tok-o">+</span> <span class="tok-mi">56</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">ctx_</span> <span class="tok-o">+</span> <span class="tok-mi">56</span><span class="tok-p">,</span> <span class="tok-mi">48</span><span class="tok-p">,</span> <span class="tok-n">dwords</span><span class="tok-p">);</span>
<span class="lineno">34</span>   <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-o">!*</span><span class="tok-p">((</span><span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">ctx_</span> <span class="tok-o">+</span> <span class="tok-mi">14</span><span class="tok-p">)</span> <span class="tok-p">)</span>
<span class="lineno">35</span>   <span class="tok-p">{</span>
<span class="lineno">36</span>     <span class="tok-n">MD5Init</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">md5_ctx</span><span class="tok-p">);</span>
<span class="lineno">37</span>     <span class="tok-n">MD5Update</span><span class="tok-p">((</span><span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">ctx_</span> <span class="tok-o">+</span> <span class="tok-mi">56</span><span class="tok-p">,</span> <span class="tok-mi">32</span><span class="tok-p">);</span>
<span class="lineno">38</span>     <span class="tok-n">MD5Final</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">md5_ctx</span><span class="tok-p">,</span> <span class="tok-n">digest</span><span class="tok-p">);</span>
<span class="lineno">39</span>     <span class="tok-n">pref_digest</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">ctx_</span> <span class="tok-o">+</span> <span class="tok-mi">88</span><span class="tok-p">;</span>
<span class="lineno">40</span>     <span class="tok-n">bytes_to_check</span> <span class="tok-o">=</span> <span class="tok-mi">12</span><span class="tok-p">;</span>
<span class="lineno">41</span>     <span class="tok-n">pdigest</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">digest</span><span class="tok-p">;</span>
<span class="lineno">42</span>     <span class="tok-k">while</span> <span class="tok-p">(</span> <span class="tok-o">*</span><span class="tok-n">pdigest</span> <span class="tok-o">==</span> <span class="tok-o">*</span><span class="tok-n">pref_digest</span> <span class="tok-p">)</span>
<span class="lineno">43</span>     <span class="tok-p">{</span>
<span class="lineno">44</span>       <span class="tok-o">++</span><span class="tok-n">pdigest</span><span class="tok-p">;</span>
<span class="lineno">45</span>       <span class="tok-o">++</span><span class="tok-n">pref_digest</span><span class="tok-p">;</span>
<span class="lineno">46</span>       <span class="tok-n">finished</span> <span class="tok-o">=</span> <span class="tok-n">bytes_to_check</span> <span class="tok-o">&lt;</span> <span class="tok-mi">4</span><span class="tok-p">;</span>
<span class="lineno">47</span>       <span class="tok-n">bytes_to_check</span> <span class="tok-o">-=</span> <span class="tok-mi">4</span><span class="tok-p">;</span>
<span class="lineno">48</span>       <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">finished</span> <span class="tok-p">)</span>
<span class="lineno">49</span>         <span class="tok-k">goto</span> <span class="tok-n">LABEL_11</span><span class="tok-p">;</span>
<span class="lineno">50</span>     <span class="tok-p">}</span>
<span class="lineno">51</span>   <span class="tok-p">}</span>
<span class="lineno">52</span>   <span class="tok-o">++</span><span class="tok-n">result_value</span><span class="tok-p">;</span>
<span class="lineno">53</span> <span class="tok-nl">LABEL_11</span><span class="tok-p">:</span>
<span class="lineno">54</span>   <span class="tok-p">[...]</span>
<span class="lineno">55</span>   <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-p">;</span>
<span class="lineno">56</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The pointer to <code>ctx</code> seems to be used as a structure. At line 18, the entire
content of resource 121 is copied to <code>ctx + 8</code>. From the previous analysis
of the <code>check_res_121_data</code> function, we obtained a few indications on
the meaning of this data. Furthermore, by examining the way the <code>ctx</code> pointer
is accessed, its structure can be guessed. For example, a block
of 48 bytes is decrypted by the RC5 algorithm at offset 56.</p>
</div>
<div class="paragraph">
<p>The decompilation can be cleaned a little bit by defining the two structures below
and applying this definition to the <code>ctx</code> pointer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-k">typedef</span> <span class="tok-k">struct</span> <span class="tok-p">{</span>
    <span class="tok-n">_DWORD</span> <span class="tok-n">dw0</span><span class="tok-p">;</span>
    <span class="tok-kt">char</span> <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-mi">28</span><span class="tok-p">];</span>
    <span class="tok-kt">char</span> <span class="tok-n">ref_md5sum</span><span class="tok-p">[</span><span class="tok-mi">16</span><span class="tok-p">];</span>
<span class="tok-p">}</span> <span class="tok-n">BLOCK</span><span class="tok-p">;</span>

<span class="tok-k">typedef</span> <span class="tok-k">struct</span> <span class="tok-p">{</span>
    <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">unk</span><span class="tok-p">;</span>           <span class="tok-cm">/* +0 */</span>
    <span class="tok-n">HCRYPTPROV</span> <span class="tok-n">provider</span><span class="tok-p">;</span> <span class="tok-cm">/* +4 */</span>
    <span class="tok-kt">char</span> <span class="tok-n">str_1</span><span class="tok-p">[</span><span class="tok-mi">8</span><span class="tok-p">];</span>       <span class="tok-cm">/* +8, res_121_data, FLARE-ON */</span>
    <span class="tok-kt">int</span> <span class="tok-n">v1</span><span class="tok-p">;</span>              <span class="tok-cm">/* +16, 0x8000 */</span>
    <span class="tok-kt">int</span> <span class="tok-n">v2</span><span class="tok-p">;</span>              <span class="tok-cm">/* +20, 0xF */</span>
    <span class="tok-kt">char</span> <span class="tok-n">str_2</span><span class="tok-p">[</span><span class="tok-mi">16</span><span class="tok-p">];</span>      <span class="tok-cm">/* +24, random data */</span>
    <span class="tok-kt">char</span> <span class="tok-n">ref_md5sum</span><span class="tok-p">[</span><span class="tok-mi">16</span><span class="tok-p">];</span> <span class="tok-cm">/* +40, md5 of the 0x600 bytes below */</span>
    <span class="tok-n">BLOCK</span> <span class="tok-n">bl0</span><span class="tok-p">;</span>           <span class="tok-cm">/* +56 */</span>
    <span class="tok-kt">char</span> <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-mh">0x5d0</span><span class="tok-p">];</span>    <span class="tok-cm">/* +104, random data */</span>
    <span class="tok-kt">int</span> <span class="tok-n">v3</span><span class="tok-p">;</span>              <span class="tok-cm">/* +1592 */</span>
<span class="tok-p">}</span> <span class="tok-n">FLARE_CTX</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The fields <code>v1</code> and <code>v2</code> are obtained by debugging the program and examining the memory.</p>
</div>
<div class="paragraph">
<p>The result is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="lineno"> 1</span> <span class="tok-kt">int</span> <span class="tok-kr">__fastcall</span> <span class="tok-nf">decrypt_blocks</span><span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">ctx</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">unused</span><span class="tok-p">,</span> <span class="tok-kt">char</span> <span class="tok-n">first_arg</span><span class="tok-p">,</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">res_120_xor</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">unused_1</span><span class="tok-p">,</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">res_121_data</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">unused_2</span><span class="tok-p">)</span>
<span class="lineno"> 2</span>   <span class="tok-p">[...]</span>
<span class="lineno"> 3</span>   <span class="tok-n">memcpy_s</span><span class="tok-p">(</span><span class="tok-n">ctx_</span><span class="tok-o">-&gt;</span><span class="tok-n">str_1</span><span class="tok-p">,</span> <span class="tok-mh">0x630u</span><span class="tok-p">,</span> <span class="tok-n">res_121_data</span><span class="tok-p">,</span> <span class="tok-mh">0x630u</span><span class="tok-p">);</span>
<span class="lineno"> 4</span>   <span class="tok-n">ctx_</span><span class="tok-o">-&gt;</span><span class="tok-n">v3</span> <span class="tok-o">=</span> <span class="tok-n">ctx_</span><span class="tok-o">-&gt;</span><span class="tok-n">v1</span><span class="tok-p">;</span> <span class="tok-cm">/* 0x8000 */</span>
<span class="lineno"> 5</span>   <span class="tok-n">ctx_</span><span class="tok-o">-&gt;</span><span class="tok-n">str_2</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">|=</span> <span class="tok-n">first_arg</span><span class="tok-p">;</span> <span class="tok-cm">/* atoi(argv[1]) */</span>
<span class="lineno"> 6</span>   <span class="tok-cm">/* res_120_xor = 73 22 F7 E5 E9 47 61 76  E6 D2 EB 86 FB EB DF 7E */</span>
<span class="lineno"> 7</span>   <span class="tok-n">sub_4014E0</span><span class="tok-p">(</span><span class="tok-n">res_120_xor</span><span class="tok-p">,</span> <span class="tok-mi">16</span><span class="tok-p">,</span> <span class="tok-n">ctx_</span><span class="tok-o">-&gt;</span><span class="tok-n">str_2</span><span class="tok-p">,</span> <span class="tok-n">v9</span><span class="tok-p">,</span> <span class="tok-n">ctx_</span><span class="tok-o">-&gt;</span><span class="tok-n">v3</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-p">)</span><span class="tok-n">rc5_key</span><span class="tok-p">);</span>
<span class="lineno"> 8</span>   <span class="tok-n">rc5_ctx</span><span class="tok-p">.</span><span class="tok-n">rounds</span> <span class="tok-o">=</span> <span class="tok-o">*</span><span class="tok-p">((</span><span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">res_121_data</span> <span class="tok-o">+</span> <span class="tok-mi">3</span><span class="tok-p">);</span> <span class="tok-cm">/* res_121_data + 3 &lt;=&gt; ctx-&gt;v2 == 0xF */</span>
<span class="lineno"> 9</span>   <span class="tok-n">KR</span> <span class="tok-o">=</span> <span class="tok-mi">2</span> <span class="tok-o">*</span> <span class="tok-n">rc5_ctx</span><span class="tok-p">.</span><span class="tok-n">rounds</span> <span class="tok-o">+</span> <span class="tok-mi">2</span><span class="tok-p">;</span>
<span class="lineno">10</span>   <span class="tok-n">S_mem</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-kt">unsigned</span> <span class="tok-kr">__int32</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">alloc_mem</span><span class="tok-p">(</span><span class="tok-mi">4</span> <span class="tok-o">*</span> <span class="tok-n">KR</span> <span class="tok-o">|</span> <span class="tok-o">-</span><span class="tok-p">((</span><span class="tok-kt">unsigned</span> <span class="tok-kr">__int64</span><span class="tok-p">)</span><span class="tok-n">KR</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">30</span> <span class="tok-o">!=</span> <span class="tok-mi">0</span><span class="tok-p">));</span>
<span class="lineno">11</span>   <span class="tok-n">rc5_ctx</span><span class="tok-p">.</span><span class="tok-n">S</span> <span class="tok-o">=</span> <span class="tok-n">S_mem</span><span class="tok-p">;</span>
<span class="lineno">12</span>   <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">S_mem</span> <span class="tok-p">)</span>
<span class="lineno">13</span>   <span class="tok-p">{</span>
<span class="lineno">14</span>     <span class="tok-n">RC5Setup</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">rc5_ctx</span><span class="tok-p">);</span>
<span class="lineno">15</span>     <span class="tok-n">RC5Key</span><span class="tok-p">(</span><span class="tok-n">rc5_key</span><span class="tok-p">,</span> <span class="tok-mi">16u</span><span class="tok-p">);</span>
<span class="lineno">16</span>   <span class="tok-p">}</span>
<span class="lineno">17</span>   <span class="tok-n">dwords</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="lineno">18</span>   <span class="tok-n">dwords</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
<span class="lineno">19</span>   <span class="tok-n">RC5_decrypt</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ctx_</span><span class="tok-o">-&gt;</span><span class="tok-n">bl0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">ctx_</span><span class="tok-o">-&gt;</span><span class="tok-n">bl0</span><span class="tok-p">,</span> <span class="tok-mi">48</span><span class="tok-p">,</span> <span class="tok-n">dwords</span><span class="tok-p">);</span>
<span class="lineno">20</span>   <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-o">!</span><span class="tok-n">ctx_</span><span class="tok-o">-&gt;</span><span class="tok-n">bl0</span><span class="tok-p">.</span><span class="tok-n">dw0</span> <span class="tok-p">)</span>
<span class="lineno">21</span>   <span class="tok-p">{</span>
<span class="lineno">22</span>     <span class="tok-n">MD5Init</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">md5_ctx</span><span class="tok-p">);</span>
<span class="lineno">23</span>     <span class="tok-n">MD5Update</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ctx_</span><span class="tok-o">-&gt;</span><span class="tok-n">bl0</span><span class="tok-p">,</span> <span class="tok-mi">32</span><span class="tok-p">);</span>
<span class="lineno">24</span>     <span class="tok-n">MD5Final</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">md5_ctx</span><span class="tok-p">,</span> <span class="tok-n">digest</span><span class="tok-p">);</span>
<span class="lineno">25</span>     <span class="tok-n">pref_digest</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">ctx_</span><span class="tok-o">-&gt;</span><span class="tok-n">bl0</span><span class="tok-p">.</span><span class="tok-n">ref_md5sum</span><span class="tok-p">;</span>
<span class="lineno">26</span>     <span class="tok-n">bytes_to_check</span> <span class="tok-o">=</span> <span class="tok-mi">12</span><span class="tok-p">;</span>
<span class="lineno">27</span>     <span class="tok-n">pdigest</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">digest</span><span class="tok-p">;</span>
<span class="lineno">28</span>     <span class="tok-k">while</span> <span class="tok-p">(</span> <span class="tok-o">*</span><span class="tok-n">pdigest</span> <span class="tok-o">==</span> <span class="tok-o">*</span><span class="tok-n">pref_digest</span> <span class="tok-p">)</span>
<span class="lineno">29</span>     <span class="tok-p">{</span>
<span class="lineno">30</span>       <span class="tok-o">++</span><span class="tok-n">pdigest</span><span class="tok-p">;</span>
<span class="lineno">31</span>       <span class="tok-o">++</span><span class="tok-n">pref_digest</span><span class="tok-p">;</span>
<span class="lineno">32</span>       <span class="tok-n">finished</span> <span class="tok-o">=</span> <span class="tok-n">bytes_to_check</span> <span class="tok-o">&lt;</span> <span class="tok-mi">4</span><span class="tok-p">;</span>
<span class="lineno">33</span>       <span class="tok-n">bytes_to_check</span> <span class="tok-o">-=</span> <span class="tok-mi">4</span><span class="tok-p">;</span>
<span class="lineno">34</span>       <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">finished</span> <span class="tok-p">)</span>
<span class="lineno">35</span>         <span class="tok-k">goto</span> <span class="tok-n">LABEL_11</span><span class="tok-p">;</span>
<span class="lineno">36</span>     <span class="tok-p">}</span>
<span class="lineno">37</span>   <span class="tok-p">}</span>
<span class="lineno">38</span>   <span class="tok-o">++</span><span class="tok-n">result_value</span><span class="tok-p">;</span>
<span class="lineno">39</span> <span class="tok-nl">LABEL_11</span><span class="tok-p">:</span>
<span class="lineno">40</span>   <span class="tok-p">[...]</span>
<span class="lineno">41</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This code can be summarized as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>a context is initialized from the content of resource 121</p>
</li>
<li>
<p>the first byte of <code>atoi(argv[1])</code> is mixed to the first byte of the <code>ctx&#8594;str_2</code> string</p>
</li>
<li>
<p>the function <code>sub_4014E0</code> (renamed <code>calc_rc5_key</code>) is called with the following arguments: <code>res_120_xor = 73 22 F7 E5 E9 47 61 76  E6 D2 EB 86 FB EB DF 7E</code>, 16,
<code>ctx&#8594;str_2</code>, <code>v9 = 0</code>, <code>ctx&#8594;v3 = 0x8000</code> and a pointer to a buffer on the stack which is later used as an RC5 key</p>
</li>
<li>
<p>a RC5 context is initialized, with the previously calculated key from the call to <code>sub_4014E0</code> and the number of rounds
specified by <code>ctx&#8594;v2</code> which is equal to 15</p>
</li>
<li>
<p>the context of <code>ctx&#8594;bl0</code> is decrypted using the modified RC5 algorithm (see <a href="#rc5_decrypt_c">Source code of RC5Decrypt function</a>)</p>
</li>
<li>
<p>the field <code>ctx&#8594;bl0.dw0</code> must be equal to 0 after decryption. If so,</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>a MD5 digest is computed on the first 32 bytes of <code>ctx&#8594;bl0</code></p>
</li>
<li>
<p>the resulting digest is checked against a reference digest in the decrypted data (<code>ctx&#8594;bl0.ref_md5sum</code>)</p>
</li>
<li>
<p>if the two digests match, execution continues to <code>LABEL_11</code>. If not, a variable is incremented</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>At this point, we can make the reasonable assumption that, if the decryption succeeds, it is expected that
the double word <code>ctx&#8594;bl0.dw0</code> must be equal to 0. When testing with a random value as first argument, this is
clearly not the case:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_011.png" alt="level_11_011"></span></p>
</div>
<div class="paragraph">
<p>The function <code>sub_4014E0</code> seems to be used to derivate a RC5 key from the arguments. IDA manages to decompile this function in a clean
manner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">int</span> <span class="tok-n">__usercall</span> <span class="tok-n">sub_4014E0</span><span class="tok-err">@</span><span class="tok-o">&lt;</span><span class="tok-n">eax</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">key</span><span class="tok-err">@</span><span class="tok-o">&lt;</span><span class="tok-n">ecx</span><span class="tok-o">&gt;</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">len</span><span class="tok-err">@</span><span class="tok-o">&lt;</span><span class="tok-n">edx</span><span class="tok-o">&gt;</span><span class="tok-p">,</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">message</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">unused</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">iter_count</span><span class="tok-p">,</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">rc5_key</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">key_</span><span class="tok-p">;</span> <span class="tok-c1">// edi@1</span>
  <span class="tok-kt">int</span> <span class="tok-n">len_</span><span class="tok-p">;</span> <span class="tok-c1">// esi@1</span>
  <span class="tok-kt">int</span> <span class="tok-n">v8</span><span class="tok-p">;</span> <span class="tok-c1">// ecx@1</span>
  <span class="tok-n">MD5_CTX</span> <span class="tok-n">md5_ctx</span><span class="tok-p">;</span> <span class="tok-c1">// [sp+10h] [bp-84h]@1</span>
  <span class="tok-kt">char</span> <span class="tok-n">tmp</span><span class="tok-p">[</span><span class="tok-mi">16</span><span class="tok-p">];</span> <span class="tok-c1">// [sp+6Ch] [bp-28h]@1</span>
  <span class="tok-kt">char</span> <span class="tok-n">hmac_key</span><span class="tok-p">[</span><span class="tok-mi">16</span><span class="tok-p">];</span> <span class="tok-c1">// [sp+7Ch] [bp-18h]@1</span>

  <span class="tok-n">key_</span> <span class="tok-o">=</span> <span class="tok-n">key</span><span class="tok-p">;</span>
  <span class="tok-n">len_</span> <span class="tok-o">=</span> <span class="tok-n">len</span><span class="tok-p">;</span>
  <span class="tok-n">MD5Init</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">md5_ctx</span><span class="tok-p">);</span>
  <span class="tok-n">MD5Update</span><span class="tok-p">(</span><span class="tok-n">key_</span><span class="tok-p">,</span> <span class="tok-n">len_</span><span class="tok-p">);</span>
  <span class="tok-n">MD5Final</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">md5_ctx</span><span class="tok-p">,</span> <span class="tok-n">hmac_key</span><span class="tok-p">);</span>
  <span class="tok-n">HMAC_MD5_ntimes</span><span class="tok-p">(</span><span class="tok-n">tmp</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-p">)</span><span class="tok-n">hmac_key</span><span class="tok-p">,</span> <span class="tok-n">v8</span><span class="tok-p">,</span> <span class="tok-n">message</span><span class="tok-p">,</span> <span class="tok-n">v8</span><span class="tok-p">,</span> <span class="tok-n">iter_count</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">);</span>
  <span class="tok-k">return</span> <span class="tok-nf">memcpy_s</span><span class="tok-p">(</span><span class="tok-n">rc5_key</span><span class="tok-p">,</span> <span class="tok-mi">16u</span><span class="tok-p">,</span> <span class="tok-n">tmp</span><span class="tok-p">,</span> <span class="tok-mi">16u</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>First, the data pointed by the first argument (<code>res_120_xor</code>) is hashed to obtain
a MD5 digest, then a message authentication code is computed using the digest as key and the third argument
as message. The HMAC-MD5 operation is in fact repeated as many times as specified by the 5th argument
(<code>iter_count = 0x8000</code>) using the same key but with the previous HMAC as message.</p>
</div>
<div class="paragraph">
<p>As seen before, only the first byte of <code>atoi(argv[1])</code> is mixed with <code>ctx&#8594;str_2</code> which is used
as input to <code>sub_4014E0</code>. The other parameters of this function being constant, it must be then
possible to test each possible value for <code>argv[1]</code> (0 to 255) and check which one leads to
a successful decryption (<code>ctx&#8594;bl0.dw0 == 0</code>).</p>
</div>
<div class="paragraph">
<p>This can be done manually, by debugging the program started with each possibility but for obvious
reasons, this is quite tedious. To automate this process, a script can be used to start the program
with all the values from 0 to 255. Moreover, for each run, we need to tell if the decryption was successful or not.</p>
</div>
<div class="paragraph">
<p>From the previous analysis, we know that a different code path is followed if the decryption is unsuccessful: in that case,
 the variable <code>result_value</code> is incremented.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_012.png" alt="level_11_012"></span></p>
</div>
<div class="paragraph">
<p>It may then be possible to patch the code to replace the increment with an invalid instruction. By doing so,
only the right value will not crash the program.</p>
</div>
<div class="paragraph">
<p>By setting a breakpoint before executing this instruction and running the program, we can examine the status of the
process. Specifically, the <code>eax</code> register is interesting because it does not reference a valid memory address. It may
be possible to crash the program by writing a value at the location pointed by <code>eax</code>. The binary code is patched to obtain
the result below:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_013.png" alt="level_11_013"></span></p>
</div>
<div class="paragraph">
<p>As the original instruction referenced a memory location in the data section, the operand is modified by the PE loader, when
applying relocations. The new instruction will also be modified by the relocation process but this should only affect
the operand (value written to the memory), so the instruction will still remain invalid.</p>
</div>
<div class="paragraph">
<p>The batch script below starts the patched version of <code>CryptoGraph.exe</code> with each possible value:</p>
</div>
<div class="listingblock">
<div class="title">find_first_arg.bat</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="bat"><span class="tok-p">@</span><span class="tok-k">echo</span> <span class="tok-k">off</span>
<span class="tok-k">for</span> <span class="tok-n">/l</span> <span class="tok-nv">%%x</span> in (<span class="tok-m">0</span><span class="tok-p">,</span> <span class="tok-m">1</span><span class="tok-p">,</span> <span class="tok-m">255</span>) <span class="tok-k">do</span> (
   <span class="tok-k">echo</span> <span class="tok-nv">%%x</span>
   CryptoGraphPatched <span class="tok-nv">%%x</span>
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before running the script, it is recommended to disable error reporting and the error pop-up
by setting by following the instructions at <a href="https://msdn.microsoft.com/en-us/library/bb513638.aspx" class="bare">https://msdn.microsoft.com/en-us/library/bb513638.aspx</a>.</p>
</div>
<div class="paragraph">
<p>The script only stops when the argument is equal to 205:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>C:\temp&gt;find_first_arg.bat
0
1
2
3
[...]
205</code></pre>
</div>
</div>
<div class="paragraph">
<p>Debugging the program with the right value shows that the decryption is successful this time:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_014.png" alt="level_11_014"></span></p>
</div>
<div class="paragraph">
<p>The digest can also be computed on the first 32 bytes of the decrypted data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="irb"><span class="tok-gp">irb(main):001:0&gt; </span><span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;00 00 00 00 00 00 01 00 39 6C 1A DA B5 01 08 02 B0 54 48 92 F0 0F B7 D3 71 C9 80 74 B9 A2 22 29&quot;</span>
<span class="tok-go"> =&gt; &quot;00 00 00 00 00 00 01 00 39 6C 1A DA B5 01 08 02 B0 54 48 92 F0 0F B7 D3 71 C9 80 74 B9 A2 22 29&quot;</span>
<span class="tok-gp">irb(main):002:0&gt; </span><span class="tok-nb">require</span> <span class="tok-s1">&#39;digest&#39;</span>
<span class="tok-go"> =&gt; true</span>
<span class="tok-gp">irb(main):003:0&gt; </span><span class="tok-no">Digest</span><span class="tok-o">::</span><span class="tok-no">MD5</span><span class="tok-o">.</span><span class="tok-n">hexdigest</span><span class="tok-p">(</span> <span class="tok-n">s</span><span class="tok-o">.</span><span class="tok-n">gsub</span><span class="tok-p">(</span><span class="tok-sr">/\s+/</span><span class="tok-p">,</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">scan</span><span class="tok-p">(</span><span class="tok-sr">/../</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">map</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">x</span><span class="tok-o">|</span> <span class="tok-n">x</span><span class="tok-o">.</span><span class="tok-n">to_i</span><span class="tok-p">(</span><span class="tok-mi">16</span><span class="tok-p">)}</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span> <span class="tok-p">)</span>
<span class="tok-go"> =&gt; &quot;88d48c0cae734f5b57d8e3cc8c711759&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the same digest but with a different byte order, as expected (last line in the memory dump of the previous screenshot).</p>
</div>
<div class="paragraph">
<p>At this point, we know that by starting the program with <code>205</code> as argument, the location <code>LABEL_11</code> will
be reached in the expected state (first block being decrypted successfully). The analysis of <code>sub_4015D0</code>
can continue from this location.</p>
</div>
<div class="paragraph">
<p>After reaching <code>LABEL_11</code>, the program will try to decrypt the next block, that is to say the next 48 bytes
pointed by <code>ctx&#8594;data</code>, this times with different parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the HMAC key is <code>bl0&#8594;data + 4</code></p>
</li>
<li>
<p>the HMAC message is <code>bl0&#8594;data + 12</code></p>
</li>
<li>
<p>the HMAC iteration count is pointed by <code>bl0&#8594;data</code> (<code>0x10000 = 65536</code>)</p>
</li>
<li>
<p>the RC5 decryption function is called 3 times on the same block</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With these indications, the previously defined structures can be refined as follow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-k">typedef</span> <span class="tok-k">struct</span> <span class="tok-p">{</span>
    <span class="tok-n">_DWORD</span> <span class="tok-n">block_idx</span><span class="tok-p">;</span>
    <span class="tok-n">_DWORD</span> <span class="tok-n">hmac_iter_count</span><span class="tok-p">;</span>
    <span class="tok-kt">char</span> <span class="tok-n">hmac_key</span><span class="tok-p">[</span><span class="tok-mi">8</span><span class="tok-p">];</span>
    <span class="tok-kt">char</span> <span class="tok-n">hmac_mess</span><span class="tok-p">[</span><span class="tok-mi">16</span><span class="tok-p">];</span>
    <span class="tok-kt">char</span> <span class="tok-n">ref_md5sum</span><span class="tok-p">[</span><span class="tok-mi">16</span><span class="tok-p">];</span>
<span class="tok-p">}</span> <span class="tok-n">BLOCK</span><span class="tok-p">;</span>

<span class="tok-k">typedef</span> <span class="tok-k">struct</span> <span class="tok-p">{</span>
    <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">unk</span><span class="tok-p">;</span>             <span class="tok-cm">/* +0 */</span>
    <span class="tok-n">HCRYPTPROV</span> <span class="tok-n">provider</span><span class="tok-p">;</span>   <span class="tok-cm">/* +4 */</span>
    <span class="tok-kt">char</span> <span class="tok-n">header</span><span class="tok-p">[</span><span class="tok-mi">8</span><span class="tok-p">];</span>        <span class="tok-cm">/* +8, res_121_data, FLARE-ON */</span>
    <span class="tok-kt">int</span> <span class="tok-n">hmac_iter_count</span><span class="tok-p">;</span>   <span class="tok-cm">/* +16 */</span>
    <span class="tok-kt">int</span> <span class="tok-n">rc5_rounds</span><span class="tok-p">;</span>        <span class="tok-cm">/* +20 */</span>
    <span class="tok-kt">char</span> <span class="tok-n">hmac_mess</span><span class="tok-p">[</span><span class="tok-mi">16</span><span class="tok-p">];</span>    <span class="tok-cm">/* +24 */</span>
    <span class="tok-kt">char</span> <span class="tok-n">ref_md5sum</span><span class="tok-p">[</span><span class="tok-mi">16</span><span class="tok-p">];</span>   <span class="tok-cm">/* +40, md5 of the 0x600 bytes below */</span>
    <span class="tok-n">BLOCK</span> <span class="tok-n">blocks</span><span class="tok-p">[</span><span class="tok-mi">32</span><span class="tok-p">];</span>         <span class="tok-cm">/* +56 */</span>
    <span class="tok-kt">int</span> <span class="tok-n">current_hmac_iter</span><span class="tok-p">;</span> <span class="tok-cm">/* +1592 */</span>
<span class="tok-p">}</span> <span class="tok-n">FLARE_CTX</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Loading these new definitions in IDA is helpful to get
a cleaner decompilation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">int</span> <span class="tok-kr">__fastcall</span> <span class="tok-nf">decrypt_blocks</span><span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">ctx</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">unused</span><span class="tok-p">,</span> <span class="tok-kt">char</span> <span class="tok-n">first_arg</span><span class="tok-p">,</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">res_120_xor</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">unused_1</span><span class="tok-p">,</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">res_121_data</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">unused_2</span><span class="tok-p">)</span>
  <span class="tok-p">[...]</span>
<span class="tok-nl">LABEL_11</span><span class="tok-p">:</span>
  <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">S_mem</span> <span class="tok-p">)</span>
    <span class="tok-n">j__free</span><span class="tok-p">(</span><span class="tok-n">S_mem</span><span class="tok-p">);</span>
  <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
  <span class="tok-n">v27</span> <span class="tok-o">=</span> <span class="tok-mi">2</span><span class="tok-p">;</span>
  <span class="tok-n">block_idx</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
  <span class="tok-n">pblock</span> <span class="tok-o">=</span> <span class="tok-o">&amp;</span><span class="tok-n">ctx_</span><span class="tok-o">-&gt;</span><span class="tok-n">blocks</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">];</span>
  <span class="tok-k">do</span>
  <span class="tok-p">{</span>
    <span class="tok-n">v17</span> <span class="tok-o">=</span> <span class="tok-n">pblock</span><span class="tok-p">[</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">].</span><span class="tok-n">hmac_iter_count</span> <span class="tok-o">+</span> <span class="tok-n">ctx__</span><span class="tok-o">-&gt;</span><span class="tok-n">current_hmac_iter</span> <span class="tok-o">*</span> <span class="tok-p">((</span><span class="tok-kt">unsigned</span> <span class="tok-kt">int</span><span class="tok-p">)</span><span class="tok-n">result</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">4</span><span class="tok-p">);</span>
    <span class="tok-n">ctx__</span><span class="tok-o">-&gt;</span><span class="tok-n">current_hmac_iter</span> <span class="tok-o">=</span> <span class="tok-n">v17</span><span class="tok-p">;</span>
    <span class="tok-n">MD5Init</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">md5_ctx</span><span class="tok-p">);</span>
    <span class="tok-n">MD5Update</span><span class="tok-p">(</span><span class="tok-n">pblock</span><span class="tok-p">[</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">].</span><span class="tok-n">hmac_key</span><span class="tok-p">,</span> <span class="tok-mi">8</span><span class="tok-p">);</span>
    <span class="tok-n">MD5Final</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">md5_ctx</span><span class="tok-p">,</span> <span class="tok-n">hmac_key</span><span class="tok-p">);</span>
    <span class="tok-cm">/* computes the RC5 key */</span>
    <span class="tok-n">HMAC_MD5_ntimes</span><span class="tok-p">(</span><span class="tok-n">hmac_result</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-p">)</span><span class="tok-n">hmac_key</span><span class="tok-p">,</span> <span class="tok-n">v18</span><span class="tok-p">,</span> <span class="tok-n">pblock</span><span class="tok-p">[</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">].</span><span class="tok-n">hmac_mess</span><span class="tok-p">,</span> <span class="tok-n">v18</span><span class="tok-p">,</span> <span class="tok-n">v17</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">);</span>
    <span class="tok-n">memcpy_s</span><span class="tok-p">(</span><span class="tok-n">rc5_key</span><span class="tok-p">,</span> <span class="tok-mi">16u</span><span class="tok-p">,</span> <span class="tok-n">hmac_result</span><span class="tok-p">,</span> <span class="tok-mi">16u</span><span class="tok-p">);</span>
    <span class="tok-n">block_idx_</span> <span class="tok-o">=</span> <span class="tok-n">block_idx</span><span class="tok-p">;</span>
    <span class="tok-n">rc5_ctx</span><span class="tok-p">.</span><span class="tok-n">rounds</span> <span class="tok-o">=</span> <span class="tok-n">block_idx</span> <span class="tok-o">+</span> <span class="tok-n">ctx__</span><span class="tok-o">-&gt;</span><span class="tok-n">rc5_rounds</span><span class="tok-p">;</span>
    <span class="tok-n">KR</span> <span class="tok-o">=</span> <span class="tok-mi">2</span> <span class="tok-o">*</span> <span class="tok-n">rc5_ctx</span><span class="tok-p">.</span><span class="tok-n">rounds</span> <span class="tok-o">+</span> <span class="tok-mi">2</span><span class="tok-p">;</span>
    <span class="tok-n">rc5_ctx</span><span class="tok-p">.</span><span class="tok-n">S</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-kt">unsigned</span> <span class="tok-kr">__int32</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">alloc_mem</span><span class="tok-p">(</span><span class="tok-mi">4</span> <span class="tok-o">*</span> <span class="tok-n">KR</span> <span class="tok-o">|</span> <span class="tok-o">-</span><span class="tok-p">((</span><span class="tok-kt">unsigned</span> <span class="tok-kr">__int64</span><span class="tok-p">)</span><span class="tok-n">KR</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">30</span> <span class="tok-o">!=</span> <span class="tok-mi">0</span><span class="tok-p">));</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">rc5_ctx</span><span class="tok-p">.</span><span class="tok-n">S</span> <span class="tok-p">)</span>
    <span class="tok-p">{</span>
      <span class="tok-n">RC5Setup</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">rc5_ctx</span><span class="tok-p">);</span>
      <span class="tok-n">RC5Key</span><span class="tok-p">(</span><span class="tok-n">rc5_key</span><span class="tok-p">,</span> <span class="tok-mh">0x10u</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
    <span class="tok-n">dwords</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">block_idx_</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
    <span class="tok-n">rc5_iter</span> <span class="tok-o">=</span> <span class="tok-n">v27</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
    <span class="tok-n">dwords</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">block_idx_</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
    <span class="tok-k">do</span>
    <span class="tok-p">{</span>
      <span class="tok-n">RC5_decrypt</span><span class="tok-p">(</span><span class="tok-n">pblock</span><span class="tok-p">,</span> <span class="tok-n">pblock</span><span class="tok-p">,</span> <span class="tok-mi">48</span><span class="tok-p">,</span> <span class="tok-n">dwords</span><span class="tok-p">);</span>
      <span class="tok-o">--</span><span class="tok-n">rc5_iter</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-k">while</span> <span class="tok-p">(</span> <span class="tok-n">rc5_iter</span> <span class="tok-p">);</span>
    <span class="tok-cm">/* checks decryption result */</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">pblock</span><span class="tok-o">-&gt;</span><span class="tok-n">block_idx</span> <span class="tok-o">==</span> <span class="tok-n">block_idx_</span> <span class="tok-p">)</span>
    <span class="tok-p">{</span>
      <span class="tok-n">MD5Init</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">md5_ctx</span><span class="tok-p">);</span>
      <span class="tok-n">MD5Update</span><span class="tok-p">(</span><span class="tok-n">pblock</span><span class="tok-p">,</span> <span class="tok-mi">32</span><span class="tok-p">);</span>
      <span class="tok-n">MD5Final</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">md5_ctx</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">v34</span><span class="tok-p">);</span>
      <span class="tok-n">v21</span> <span class="tok-o">=</span> <span class="tok-n">pblock</span><span class="tok-o">-&gt;</span><span class="tok-n">ref_md5sum</span><span class="tok-p">;</span>
      <span class="tok-n">v22</span> <span class="tok-o">=</span> <span class="tok-mi">12</span><span class="tok-p">;</span>
      <span class="tok-n">v23</span> <span class="tok-o">=</span> <span class="tok-o">&amp;</span><span class="tok-n">v34</span><span class="tok-p">;</span>
      <span class="tok-cm">/* compare the two digests */</span>
      <span class="tok-k">while</span> <span class="tok-p">(</span> <span class="tok-o">*</span><span class="tok-p">(</span><span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">v23</span> <span class="tok-o">==</span> <span class="tok-o">*</span><span class="tok-p">(</span><span class="tok-n">_DWORD</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">v21</span> <span class="tok-p">)</span>
      <span class="tok-p">{</span>
        <span class="tok-n">v23</span> <span class="tok-o">+=</span> <span class="tok-mi">4</span><span class="tok-p">;</span>
        <span class="tok-n">v21</span> <span class="tok-o">+=</span> <span class="tok-mi">4</span><span class="tok-p">;</span>
        <span class="tok-n">finished</span> <span class="tok-o">=</span> <span class="tok-n">v22</span> <span class="tok-o">&lt;</span> <span class="tok-mi">4</span><span class="tok-p">;</span>
        <span class="tok-n">v22</span> <span class="tok-o">-=</span> <span class="tok-mi">4</span><span class="tok-p">;</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">finished</span> <span class="tok-p">)</span>
          <span class="tok-k">goto</span> <span class="tok-n">LABEL_24</span><span class="tok-p">;</span>
      <span class="tok-p">}</span>
    <span class="tok-p">}</span>
    <span class="tok-cm">/* wrong digest */</span>
    <span class="tok-o">++</span><span class="tok-n">result_value</span><span class="tok-p">;</span>
<span class="tok-nl">LABEL_24</span><span class="tok-p">:</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span> <span class="tok-n">rc5_ctx</span><span class="tok-p">.</span><span class="tok-n">S</span> <span class="tok-p">)</span>
      <span class="tok-n">j__free</span><span class="tok-p">(</span><span class="tok-n">rc5_ctx</span><span class="tok-p">.</span><span class="tok-n">S</span><span class="tok-p">);</span>
    <span class="tok-o">++</span><span class="tok-n">pblock</span><span class="tok-p">;</span>
    <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">dwords</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">];</span>
    <span class="tok-n">v24</span> <span class="tok-o">=</span> <span class="tok-n">__ROL4__</span><span class="tok-p">(</span><span class="tok-n">v27</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">);</span>
    <span class="tok-n">block_idx</span> <span class="tok-o">=</span> <span class="tok-n">dwords</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">];</span>
    <span class="tok-n">v27</span> <span class="tok-o">=</span> <span class="tok-n">v24</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
  <span class="tok-k">while</span> <span class="tok-p">(</span> <span class="tok-n">dwords</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">&lt;</span> <span class="tok-mi">32u</span> <span class="tok-p">);</span>
  <span class="tok-k">return</span> <span class="tok-n">result</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Starting from location <code>LABEL_11</code>, the program tries to decrypt the 31 remaining blocks, each block
being decrypted in function of the content of the previously decrypted block.</p>
</div>
<div class="paragraph">
<p>This function can be rewritten in Ruby as below (full code: <a href="cryptograph.rb">cryptograph.rb</a>):</p>
</div>
<div class="listingblock">
<div class="title">cryptograph.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby">  <span class="tok-c1"># sub_4015D0</span>
  <span class="tok-k">def</span> <span class="tok-nf">decrypt_blocks</span><span class="tok-p">(</span><span class="tok-n">count</span> <span class="tok-o">=</span> <span class="tok-mi">31</span><span class="tok-p">)</span>
    <span class="tok-vi">@init_message</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">]</span> <span class="tok-o">|=</span> <span class="tok-mi">205</span>

    <span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-vi">@init_key</span> <span class="tok-c1"># res 120 data, xored</span>
    <span class="tok-n">message</span> <span class="tok-o">=</span> <span class="tok-vi">@init_message</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span> <span class="tok-c1"># res 121 data, at offset 16</span>
    <span class="tok-n">rc5_iter</span> <span class="tok-o">=</span> <span class="tok-mi">1</span>

    <span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-o">.</span><span class="tok-n">.count</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">b_idx</span><span class="tok-o">|</span>
      <span class="tok-n">bl</span> <span class="tok-o">=</span> <span class="tok-vi">@blocks</span><span class="tok-o">[</span><span class="tok-n">b_idx</span><span class="tok-o">]</span>

      <span class="tok-n">rc5_key</span> <span class="tok-o">=</span> <span class="tok-n">calc_rc5_key</span><span class="tok-p">(</span><span class="tok-no">FlareMD5</span><span class="tok-o">.</span><span class="tok-n">digest</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">),</span> <span class="tok-n">message</span><span class="tok-p">,</span> <span class="tok-vi">@iter</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
      <span class="tok-n">rc5</span> <span class="tok-o">=</span> <span class="tok-no">RC5</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-n">rc5_key</span><span class="tok-p">,</span> <span class="tok-vi">@rc5_rounds</span> <span class="tok-o">+</span> <span class="tok-n">b_idx</span><span class="tok-p">)</span>

      <span class="tok-n">crypted</span> <span class="tok-o">=</span> <span class="tok-n">bl</span><span class="tok-o">.</span><span class="tok-n">crypted</span>
      <span class="tok-n">rc5_iter</span><span class="tok-o">.</span><span class="tok-n">times</span> <span class="tok-k">do</span>
        <span class="tok-n">crypted</span> <span class="tok-o">=</span> <span class="tok-n">decrypt_data</span><span class="tok-p">(</span><span class="tok-n">rc5</span><span class="tok-p">,</span> <span class="tok-n">crypted</span><span class="tok-p">,</span> <span class="tok-n">b_idx</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">b_idx</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
      <span class="tok-k">end</span>
      <span class="tok-n">bl</span><span class="tok-o">.</span><span class="tok-n">parse_plaintext</span><span class="tok-p">(</span><span class="tok-n">crypted</span><span class="tok-p">)</span>

      <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">message</span> <span class="tok-o">=</span> <span class="tok-n">bl</span><span class="tok-o">.</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">bl</span><span class="tok-o">.</span><span class="tok-n">message</span>
      <span class="tok-vi">@iter</span> <span class="tok-o">=</span> <span class="tok-n">bl</span><span class="tok-o">.</span><span class="tok-n">iter_count</span> <span class="tok-o">+</span> <span class="tok-vi">@iter</span> <span class="tok-o">*</span> <span class="tok-p">(</span><span class="tok-n">b_idx</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">4</span><span class="tok-p">)</span>
      <span class="tok-n">rc5_iter</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-o">.</span><span class="tok-n">rotl_32</span><span class="tok-p">(</span><span class="tok-n">b_idx</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-mi">1</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>

  <span class="tok-c1"># sub_4014E0</span>
  <span class="tok-k">def</span> <span class="tok-nf">calc_rc5_key</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">message</span><span class="tok-p">,</span> <span class="tok-n">iter_count</span><span class="tok-p">,</span> <span class="tok-n">val</span><span class="tok-p">)</span>
    <span class="tok-n">expanded_message</span> <span class="tok-o">=</span> <span class="tok-n">message</span> <span class="tok-o">+</span> <span class="tok-o">[</span> <span class="tok-n">val</span> <span class="tok-o">].</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;N&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">mac</span> <span class="tok-o">=</span> <span class="tok-no">HMAC</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-no">FlareMD5</span><span class="tok-p">)</span>

    <span class="tok-n">mac</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">expanded_message</span>
    <span class="tok-n">prev_hmac</span> <span class="tok-o">=</span> <span class="tok-n">mac</span><span class="tok-o">.</span><span class="tok-n">digest</span>

    <span class="tok-p">(</span><span class="tok-n">iter_count</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">times</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">i</span><span class="tok-o">|</span>
      <span class="tok-n">mac</span><span class="tok-o">.</span><span class="tok-n">reset</span>
      <span class="tok-n">mac</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">prev_hmac</span>
      <span class="tok-n">curr_hmac</span> <span class="tok-o">=</span> <span class="tok-n">mac</span><span class="tok-o">.</span><span class="tok-n">digest</span>

      <span class="tok-n">qw0</span><span class="tok-p">,</span> <span class="tok-n">qw1</span> <span class="tok-o">=</span> <span class="tok-n">prev_hmac</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;Q2&#39;</span><span class="tok-p">),</span> <span class="tok-n">curr_hmac</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;Q2&#39;</span><span class="tok-p">)</span>
      <span class="tok-n">prev_hmac</span> <span class="tok-o">=</span> <span class="tok-o">[</span> <span class="tok-n">qw0</span><span class="tok-p">,</span> <span class="tok-n">qw1</span> <span class="tok-o">].</span><span class="tok-n">transpose</span><span class="tok-o">.</span><span class="tok-n">map</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">x</span><span class="tok-p">,</span><span class="tok-n">y</span><span class="tok-o">|</span> <span class="tok-n">x</span> <span class="tok-o">^</span> <span class="tok-n">y</span><span class="tok-p">}</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;Q2&#39;</span><span class="tok-p">)</span>
    <span class="tok-k">end</span>
    <span class="tok-k">return</span> <span class="tok-n">prev_hmac</span>
  <span class="tok-k">end</span>

  <span class="tok-c1"># sub_402BE0</span>
  <span class="tok-k">def</span> <span class="tok-nf">decrypt_data</span><span class="tok-p">(</span><span class="tok-n">rc5</span><span class="tok-p">,</span> <span class="tok-n">crypted</span><span class="tok-p">,</span> <span class="tok-n">y0</span><span class="tok-p">,</span> <span class="tok-n">y1</span><span class="tok-p">)</span>
    <span class="tok-k">raise</span> <span class="tok-s2">&quot;needs padding&quot;</span> <span class="tok-k">if</span> <span class="tok-n">crypted</span><span class="tok-o">.</span><span class="tok-n">size</span> <span class="tok-o">%</span> <span class="tok-mi">8</span> <span class="tok-o">!=</span> <span class="tok-mi">0</span>
    <span class="tok-n">ct</span> <span class="tok-o">=</span> <span class="tok-n">crypted</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;L*&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">iter</span> <span class="tok-o">=</span> <span class="tok-n">ct</span><span class="tok-o">.</span><span class="tok-n">size</span> <span class="tok-o">/</span> <span class="tok-mi">2</span> <span class="tok-o">-</span> <span class="tok-mi">1</span>
    <span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-o">.</span><span class="tok-n">.iter</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">reverse_each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">i</span><span class="tok-o">|</span>
      <span class="tok-n">pt0</span><span class="tok-p">,</span> <span class="tok-n">pt1</span> <span class="tok-o">=</span> <span class="tok-n">rc5</span><span class="tok-o">.</span><span class="tok-n">decrypt_words</span><span class="tok-p">(</span><span class="tok-n">ct</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-o">]</span><span class="tok-p">,</span> <span class="tok-n">ct</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-o">]</span><span class="tok-p">)</span>
      <span class="tok-n">x0</span> <span class="tok-o">=</span> <span class="tok-n">i</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span> <span class="tok-o">?</span> <span class="tok-n">ct</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">*</span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-o">]</span>   <span class="tok-p">:</span> <span class="tok-n">y0</span>
      <span class="tok-n">x1</span> <span class="tok-o">=</span> <span class="tok-n">i</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span> <span class="tok-o">?</span> <span class="tok-n">ct</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">*</span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-o">]</span> <span class="tok-p">:</span> <span class="tok-n">y1</span>
      <span class="tok-n">ct</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-o">]</span>   <span class="tok-o">=</span> <span class="tok-n">pt0</span> <span class="tok-o">^</span> <span class="tok-n">x0</span>
      <span class="tok-n">ct</span><span class="tok-o">[</span><span class="tok-mi">2</span><span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-n">pt1</span> <span class="tok-o">^</span> <span class="tok-n">x1</span>
    <span class="tok-k">end</span>
    <span class="tok-n">ct</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;L*&#39;</span><span class="tok-p">)</span>
  <span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As the first block is successfully decrypted (with <code>argv[1] == 205</code>), every next block is also
correctly decrypted but the program never returns.</p>
</div>
<div class="paragraph">
<p>The problem is that the time required to compute the RC5 key increases greatly for each block, the bottleneck
being the number of HMAC-MD5 computed (<code>ctx&#8594;current_hmac_iter</code> field). For example, for the 10th block, this
value is equal to <code>0x2000000</code>. Computing the key for the 11th block seems to take forever.</p>
</div>
<div class="paragraph">
<p>As it seems that we have met a dead-end here, the next step is to analyze the function <code>write_secret</code> that
was put aside before.</p>
</div>
</div>
<div class="sect3">
<h4 id="_function_write_secret">Function write_secret</h4>
<div class="paragraph">
<p>This function is called just after having decrypted all the blocks, as shown below:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_016.png" alt="level_11_016"></span></p>
</div>
<div class="paragraph">
<p>As decrypting the 32 blocks takes forever, this function is never reached (at least for now). For now,
a static analysis can be attempted.</p>
</div>
<div class="paragraph">
<p>The callgraph of the function is shown below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/write_secret_l2.svg" alt="write secret l2" width="800">
</div>
</div>
<div class="paragraph">
<p>The beginning of this function is decompiled as follows, in a simplified version without the error checking code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">char</span> <span class="tok-n">__thiscall</span> <span class="tok-nf">sub_401CF0</span><span class="tok-p">(</span><span class="tok-n">FLARE_CTX</span> <span class="tok-o">*</span><span class="tok-n">ctx</span><span class="tok-p">,</span> <span class="tok-n">HANDLE</span> <span class="tok-o">*</span><span class="tok-n">fhandle</span><span class="tok-p">,</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">res_120_data</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">res_120_size</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
  <span class="tok-n">res_122_h</span> <span class="tok-o">=</span> <span class="tok-n">FindResourceW</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-n">LPCWSTR</span><span class="tok-p">)</span><span class="tok-mi">122</span><span class="tok-p">,</span> <span class="tok-s">L&quot;RT_RCDATA&quot;</span><span class="tok-p">);</span>
  <span class="tok-n">res_122_size</span> <span class="tok-o">=</span> <span class="tok-n">SizeofResource</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">res_122_h</span><span class="tok-p">);</span>
  <span class="tok-n">res_122_data</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">alloc_mem</span><span class="tok-p">(</span><span class="tok-n">res_122_size</span><span class="tok-p">);</span>
  <span class="tok-n">read_res_data</span><span class="tok-p">(</span><span class="tok-n">res_122_data</span><span class="tok-p">,</span> <span class="tok-n">res_122_h</span><span class="tok-p">);</span>

  <span class="tok-n">idx</span> <span class="tok-o">=</span> <span class="tok-n">sub_401B60</span><span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-p">,</span> <span class="tok-n">res_120_data</span><span class="tok-p">,</span> <span class="tok-n">res_120_size</span><span class="tok-p">);</span>
  <span class="tok-n">RC5_init</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">rc5_ctx</span><span class="tok-p">,</span> <span class="tok-n">idx</span> <span class="tok-o">+</span> <span class="tok-mi">2</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">rc5_rounds</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">blocks</span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">].</span><span class="tok-n">hmac_key</span><span class="tok-p">,</span> <span class="tok-mi">8u</span><span class="tok-p">);</span>
<span class="tok-p">[...]</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The content of resource 122 is read into a memory buffer and an index is computed by the function <code>sub_401B60</code> from
the data of resource 120. This index seems to be used to select a key from the decrypted blocks.</p>
</div>
<div class="paragraph">
<p>Before analyzing this function, you may recall that the first 16 bytes of resource 120 have been xor-ed to obtain the
following result: <code>res_120_xor = 73 22 F7 E5 E9 47 61 76  E6 D2 EB 86 FB EB DF 7E</code>.</p>
</div>
<div class="paragraph">
<p>The function <code>sub_401B60</code> (renamed <code>calc_index</code>) starts by calculating some values: the <code>eax</code> register is equal to <code>res_120_xor[2] | 0x31000C01 = 0x86ebd2e6 | 0x31000C01 = 0xb7ebdee7</code>. Using
a well-known <a href="https://yesteapea.wordpress.com/2013/03/03/counting-the-number-of-set-bits-in-an-integer/">technique</a>, the
number of bits set in <code>eax</code> is computed, the result being 24. Using this result, the value of the field <code>ctx&#8594;current_hmac_iter</code> is shifted to the right: the
function exits prematurely if the result is equal to 0.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_018.png" alt="level_11_018"></span></p>
</div>
<div class="paragraph">
<p>From the previous analysis, we know that the field <code>ctx&#8594;current_hmac_iter</code> is updated as follow (with <code>result</code> being equal to the current block index):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c">  <span class="tok-n">v17</span> <span class="tok-o">=</span> <span class="tok-n">pblock</span><span class="tok-p">[</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">].</span><span class="tok-n">hmac_iter_count</span> <span class="tok-o">+</span> <span class="tok-n">ctx__</span><span class="tok-o">-&gt;</span><span class="tok-n">current_hmac_iter</span> <span class="tok-o">*</span> <span class="tok-p">((</span><span class="tok-kt">unsigned</span> <span class="tok-kt">int</span><span class="tok-p">)</span><span class="tok-n">result</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">4</span><span class="tok-p">);</span>
  <span class="tok-n">ctx__</span><span class="tok-o">-&gt;</span><span class="tok-n">current_hmac_iter</span> <span class="tok-o">=</span> <span class="tok-n">v17</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The field <code>pblock[-1].hmac_iter_count</code> is obtained by decrypting the data of the previous block so it is not predictable. However, by looking at each block decrypted, we can obtain the following results:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>block 0 : <code>hmac_iter_count = 0x8000</code></p>
</li>
<li>
<p>block 1 : <code>hmac_iter_count = 0x10000 = 0x8000 &lt;&lt; 1</code></p>
</li>
<li>
<p>block 2 : <code>hmac_iter_count = 0x20000 = 0x8000 &lt;&lt; 2</code></p>
</li>
<li>
<p>etc</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>so the previous formula can be simplified as such:</p>
</div>
<div class="paragraph">
<p><code>current_hmac_iter = (0x8000 &lt;&lt; block_index) + current_hmac_iter * (block_index &gt;&gt; 4)</code>.</p>
</div>
<div class="paragraph">
<p>For the function to continue its execution, we need <code>current_hmac_iter &gt;&gt; 24 != 0</code>. The first block index satisfying this condition is 9:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="irb"><span class="tok-gp">irb(main):001:0&gt; </span><span class="tok-p">(</span><span class="tok-mh">0x8000</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-mi">9</span><span class="tok-p">)</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">24</span>
<span class="tok-go"> =&gt; 1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, a new condition is tested on <code>ctx&#8594;current_hmac_iter</code>. This time, when shifted to the right 26 times, the result must not be equal to zero.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_019.png" alt="level_11_019"></span></p>
</div>
<div class="paragraph">
<p>The first block index satisfying this condition is 11:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-n">irb</span><span class="tok-p">(</span><span class="tok-n">main</span><span class="tok-p">):</span><span class="tok-mo">004</span><span class="tok-p">:</span><span class="tok-mi">0</span><span class="tok-o">&gt;</span> <span class="tok-p">(</span><span class="tok-mh">0x8000</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-mi">11</span><span class="tok-p">)</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">26</span>
 <span class="tok-o">=&gt;</span> <span class="tok-mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From these two conditions, we can deduce that the valid block index is either 9 or 10.</p>
</div>
<div class="paragraph">
<p>Finally, if the two conditions are met, the function raises an exception with the content of the register <code>esi</code> which is equal
to <code>res_120_xor[1] | 16 = 0x766147f9</code>. The catch clause of the exception calls a function to count the number bits set in <code>0x766147f9</code>,
which is 18. This value is divided by 2 and the resulting value 9 is returned.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_020.png" alt="level_11_020"></span></p>
</div>
<div class="paragraph">
<p>The first 9 blocks must be decrypted in order for the right index to be returned by <code>calc_index</code>. The file <code>CryptoGraph.exe</code> is
patched once again, this time to change the limit of the number of blocks decrypted:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_021.png" alt="level_11_021"></span></p>
</div>
<div class="paragraph">
<p>Using OllyDbg, the result of the function <code>calc_index</code> can be confirmed:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_017.png" alt="level_11_017"></span></p>
</div>
<div class="paragraph">
<p>The value in register <code>eax</code> is indeed equal to 9.</p>
</div>
<div class="paragraph">
<p>Now that the right index is known, the function continues its execution with the code below (simplified decompilation without error checking):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c">   <span class="tok-n">idx</span> <span class="tok-o">=</span> <span class="tok-n">calc_index</span><span class="tok-p">(</span><span class="tok-n">ctx_</span><span class="tok-p">,</span> <span class="tok-n">res_120_data_1</span><span class="tok-p">,</span> <span class="tok-n">res_120_size</span><span class="tok-p">);</span>
   <span class="tok-cm">/* Initialize a RC5 context using the key corresponding to the index */</span>
   <span class="tok-n">RC5_init</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">rc5_ctx</span><span class="tok-p">,</span> <span class="tok-n">idx</span> <span class="tok-o">+</span> <span class="tok-mi">2</span> <span class="tok-o">*</span> <span class="tok-n">ctx_</span><span class="tok-o">-&gt;</span><span class="tok-n">rc5_rounds</span><span class="tok-p">,</span> <span class="tok-n">ctx_</span><span class="tok-o">-&gt;</span><span class="tok-n">blocks</span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">].</span><span class="tok-n">hmac_key</span><span class="tok-p">,</span> <span class="tok-mi">8u</span><span class="tok-p">);</span>
   <span class="tok-n">v26</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
   <span class="tok-n">dwords</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">idx</span><span class="tok-p">;</span>
   <span class="tok-n">dwords</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">idx</span><span class="tok-p">;</span>
   <span class="tok-n">RC5_decrypt</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">res_122_data</span><span class="tok-p">[</span><span class="tok-mi">16</span> <span class="tok-o">*</span> <span class="tok-n">idx</span><span class="tok-p">],</span> <span class="tok-o">&amp;</span><span class="tok-n">rc5_key</span><span class="tok-p">,</span> <span class="tok-mi">16</span><span class="tok-p">,</span> <span class="tok-n">dwords</span><span class="tok-p">);</span>

   <span class="tok-cm">/* Reads resource 124 content to memory */</span>
   <span class="tok-n">res_124_h</span> <span class="tok-o">=</span> <span class="tok-n">FindResourceW</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-n">LPCWSTR</span><span class="tok-p">)</span><span class="tok-mi">124</span><span class="tok-p">,</span> <span class="tok-s">L&quot;RT_RCDATA&quot;</span><span class="tok-p">);</span>
   <span class="tok-n">res_124_size</span> <span class="tok-o">=</span> <span class="tok-n">SizeofResource</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">res_124_h</span><span class="tok-p">);</span>
   <span class="tok-n">res_124_data</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">alloc_mem</span><span class="tok-p">(</span><span class="tok-n">res_124_size</span><span class="tok-p">);</span>
   <span class="tok-n">read_res_data</span><span class="tok-p">(</span><span class="tok-n">res_124_data</span><span class="tok-p">,</span> <span class="tok-n">res_124_h</span><span class="tok-p">);</span>

   <span class="tok-cm">/* Initialize a RC5 context from the previously decrypted key */</span>
   <span class="tok-n">rc5_ctx</span><span class="tok-p">.</span><span class="tok-n">rounds</span> <span class="tok-o">=</span> <span class="tok-mi">15</span><span class="tok-p">;</span>
   <span class="tok-n">rc5_ctx</span><span class="tok-p">.</span><span class="tok-n">S</span> <span class="tok-o">=</span> <span class="tok-n">alloc_mem</span><span class="tok-p">(</span><span class="tok-mh">0x80u</span><span class="tok-p">);</span>
   <span class="tok-n">RC5Setup</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">rc5_ctx</span><span class="tok-p">);</span>
   <span class="tok-n">RC5Key</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">rc5_key</span><span class="tok-p">,</span> <span class="tok-mh">0x16</span><span class="tok-p">);</span>

   <span class="tok-cm">/* Decrypt res_124_data in place */</span>
   <span class="tok-n">dwords</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">res_124_size</span><span class="tok-p">;</span>
   <span class="tok-n">dwords</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">res_124_size</span><span class="tok-p">;</span>
   <span class="tok-n">RC5_decrypt</span><span class="tok-p">(</span><span class="tok-n">res_124_data</span><span class="tok-p">,</span> <span class="tok-n">res_124_data</span><span class="tok-p">,</span> <span class="tok-n">res_124_size</span><span class="tok-p">,</span> <span class="tok-n">dwords</span><span class="tok-p">);</span>

   <span class="tok-cm">/* Write plaintext to file */</span>
   <span class="tok-n">WriteFile</span><span class="tok-p">(</span><span class="tok-n">hFile</span><span class="tok-p">,</span> <span class="tok-n">res_124_data</span><span class="tok-p">,</span> <span class="tok-n">res_124_size</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">numberOfBytesWritten</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>16 bytes, extracted from the content of resource 122 at offset <code>16 * idx</code>, are decrypted
to obtain a new RC5 key. This key is then used to decrypt the content of resource 124: the
resulting plaintext is then written to the file <code>secret.jpg</code>.</p>
</div>
<div class="paragraph">
<p>By running the patched version of <code>CryptoGraph.exe</code>, that will only decrypt the 10 first blocks, with the correct argument (205), the file <code>secret.jpg</code>
can be correctly decrypted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>C:\temp&gt;CryptoGraphPatched.exe 205
The "secret.jpg" has been written to the current execution folder.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting picture is shown below:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/level_11_secret.jpg" alt="level_11_secret"></span></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tl_dr_version">TL;DR version</h3>
<div class="paragraph">
<p>The binary needs to be patched as follow to stop the main loop after having
decrypted 10 blocks (0 to 9):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> diff -u &lt;<span class="tok-o">(</span>xxd CryptoGraph.exe<span class="tok-o">)</span> &lt;<span class="tok-o">(</span>xxd CryptoGraphPatched.exe<span class="tok-o">)</span>
<span class="tok-go">--- /proc/self/fd/11    2015-09-20 18:12:55.439580562 +0200</span>
<span class="tok-go">+++ /proc/self/fd/12    2015-09-20 18:12:55.439580562 +0200</span>
<span class="tok-go">@@ -202,7 +202,7 @@</span>
<span class="tok-go"> 0000c90: 73ef eb06 ff05 3080 4100 8b44 2410 85c0  s.....0.A..D$...</span>
<span class="tok-go"> 0000ca0: 7409 50e8 b513 0000 83c4 048b 4c24 1c83  t.P.........L$..</span>
<span class="tok-go"> 0000cb0: c330 8b44 2420 d1c1 8944 2428 894c 241c  .0.D$ ...D$(.L$.</span>
<span class="tok-go">-0000cc0: 83f8 200f 8287 feff ff5f 5e5b 8b8c 24d0  .. ......_^[..$.</span>
<span class="tok-go">+0000cc0: 83f8 0a0f 8287 feff ff5f 5e5b 8b8c 24d0  ........._^[..$.</span>
<span class="tok-go"> 0000cd0: 0000 0033 cce8 7413 0000 8be5 5dc2 1400  ...3..t.....]...</span>
<span class="tok-go"> 0000ce0: a130 8041 008b 8c24 dc00 0000 405f 5e5b  .0.A...$....@_^[</span>
<span class="tok-go"> 0000cf0: 33cc a330 8041 00e8 5213 0000 8be5 5dc2  3..0.A..R.....].</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the patched binary is started  with <code>205</code> as argument, it will
write the <code>secret.jpg</code> file in the current directory.</p>
</div>
</div>
<div class="sect2">
<h3 id="_cryptograph_rb">cryptograph.rb</h3>
<div class="paragraph">
<p>As reference, a full reimplementation in Ruby of <code>CryptoGraph.exe</code> is provided (full code: <a href="cryptograph.rb">cryptograph.rb</a>).</p>
</div>
<div class="paragraph">
<p>Running this script against the binary returns the secret image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ruby cryptograph.rb CryptoGraph.exe
<span class="tok-go">[0] iter: 0x00010000, key: 396c1adab5010802, message: b0544892f00fb7d371c98074b9a22229</span>
<span class="tok-go">[1] iter: 0x00020000, key: b643d24dd4ef10c6, message: 30f52ae8ab8cca75fa596a459951d5dc</span>
<span class="tok-go">[2] iter: 0x00040000, key: 772d13a8324adf43, message: 1156266cb601a46fcd1b23008b85de09</span>
<span class="tok-go">[3] iter: 0x00080000, key: 7725f7e27c707591, message: fd140b83b05d2ea07d34bcfe530be7d3</span>
<span class="tok-go">[4] iter: 0x00100000, key: 55886ef1395bb1d7, message: 9a63c6f727567a4e1257af5caeecceb6</span>
<span class="tok-go">[5] iter: 0x00200000, key: 183af674ee81c54e, message: 65cf49c81d638dc218753fdffcb7e558</span>
<span class="tok-go">[6] iter: 0x00400000, key: b8b7e07fa7498f88, message: 81c86cd216d4b12ae132b71b575acc76</span>
<span class="tok-go">[7] iter: 0x00800000, key: cd9bd81201f22b84, message: 5d07aaf3a4a131fde86b16097ef3af0e</span>
<span class="tok-go">[8] iter: 0x01000000, key: 81eaa8163d61df39, message: 44f6d113555c9aa1949d0b10a74797c9</span>
<span class="tok-go">[9] iter: 0x02000000, key: be7572ff6af5002e, message: 5582baa870d7d71c31bfad4659724eda</span>
<span class="tok-go">[*] File written to secret.jpg</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2015-10-04 20:12:39 CEST
</div>
</div>
</body>
</html>