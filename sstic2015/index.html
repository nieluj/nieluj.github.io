<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Julien Perrot @nieluj">
<title>Challenge SSTIC 2015 : éléments de solution</title>
<link rel="stylesheet" href="stylesheets/asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<link rel="stylesheet" href="stylesheets/pygments-default.css">
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.4.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</head>
<body class="article toc2 toc-right">
<div id="header">
<h1>Challenge SSTIC 2015 : éléments de solution</h1>
<div class="details">
<span id="author" class="author">Julien Perrot @nieluj</span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">2015-04-23</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table des matières</div>
<ul class="sectlevel1">
<li><a href="#_rubberducky">Stage 1 : carte mémoire</a></li>
<li><a href="#_quake3">Stage 2 : Quake 3</a></li>
<li><a href="#_stage_3_paint">Stage 3 : Paint</a></li>
<li><a href="#_stage_4_javascript">Stage 4 : JavaScript</a></li>
<li><a href="#_stage_5_st20">Stage 5 : ST20</a>
<ul class="sectlevel2">
<li><a href="#_découverte">Découverte</a></li>
<li><a href="#_présentation_de_l_architecture">Présentation de l&#8217;architecture</a></li>
<li><a href="#_rétro_conception">Rétro-conception</a>
<ul class="sectlevel3">
<li><a href="#_transputer_0">Transputer 0</a></li>
<li><a href="#_transputers_1_2_et_3">Transputers 1, 2 et 3</a></li>
<li><a href="#_transputers_4_à_12">Transputers 4 à 12</a></li>
</ul>
</li>
<li><a href="#_implémentation_de_l_algorithme">Implémentation de l&#8217;algorithme</a></li>
<li><a href="#_attaque_par_force_brute">Attaque par force brute</a></li>
</ul>
</li>
<li><a href="#_stego_stage">Stage 6 : stéganographie</a>
<ul class="sectlevel2">
<li><a href="#_congratulations_jpg">congratulations.jpg</a></li>
<li><a href="#_congratulations_png">congratulations.png</a></li>
<li><a href="#_congratulations_tiff">congratulations.tiff</a></li>
<li><a href="#_congratulations_gif">congratulations.gif</a></li>
</ul>
</li>
<li><a href="#_conclusion">Conclusion</a></li>
<li><a href="#_annexes">Annexes</a>
<ul class="sectlevel2">
<li><a href="#_stage_4">Stage 4</a></li>
<li><a href="#_stage_5">Stage 5</a></li>
<li><a href="#_stage_6">Stage 6</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Ce document présente la méthodologie suivie pour résoudre l&#8217;édition
2015 du challenge SSTIC. La validation de celui-ci nécessite de retrouver une
adresse email au sein d&#8217;un fichier téléchargé depuis le site Internet du
symposium.</p>
</div>
<div class="paragraph">
<p>Six étapes doivent être séquentiellement résolues pour obtenir l&#8217;adresse email
recherchée :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>l&#8217;étude d&#8217;une image de carte SD contenant une charge utile pour Rubber Ducky ;</p>
</li>
<li>
<p>l&#8217;identification d&#8217;une clé de déchiffrement dans une carte du jeu Quake 3 ;</p>
</li>
<li>
<p>la reconstitution d&#8217;une image depuis les déplacements et les clics d&#8217;une souris
extraits d&#8217;une capture USB ;</p>
</li>
<li>
<p>l&#8217;analyse d&#8217;un code JavaScript obfusqué pour identifier une routine de
déchiffrement et obtenir la clé valide avec une attaque par force brute ;</p>
</li>
<li>
<p>la rétro-conception d&#8217;une routine de déchiffrement implémentée sur un
processeur ST20 permettant de constater une faiblesse dans l&#8217;algorithme
qui peut alors être exploitée pour obtenir la clé attendue ;</p>
</li>
<li>
<p>enfin, l&#8217;analyse de quatre images imbriquées, l&#8217;adresse de validation étant
affichée sur la dernière image.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rubberducky">Stage 1 : carte mémoire</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le fichier <a href="http://static.sstic.org/challenge2015/challenge.zip">challenge.zip</a>
téléchargé sur la page du challenge contient une image de carte SD, comme
présenté ci-dessous :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> wget http://static.sstic.org/challenge2015/challenge.zip
<span class="tok-gp">$</span> unzip challenge.zip
<span class="tok-go">Archive:  challenge.zip</span>
<span class="tok-go">  inflating: sdcard.img</span>
<span class="tok-gp">$</span> file sdcard.img
<span class="tok-go">sdcard.img: DOS/MBR boot sector</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette image peut être montée en loopback pour en examiner le contenu :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> sudo mount -o loop sdcard.img /mnt/loop
<span class="tok-gp">$</span> ls -al /mnt/loop
<span class="tok-go">total 33472</span>
<span class="tok-go">drwxr-xr-x 2 root root    16384 janv.  1  1970 .</span>
<span class="tok-go">drwxr-xr-x 7 root root     4096 avril  3 19:54 ..</span>
<span class="tok-go">-rwxr-xr-x 1 root root 34253730 mars  26 02:49 inject.bin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Un rapide examen du fichier <code>inject.bin</code> ne relève rien de particulier :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> file /mnt/loop/inject.bin
<span class="tok-go">/mnt/loop/inject.bin: data</span>
<span class="tok-gp">$</span> strings /mnt/loop/inject.bin <span class="tok-p">|</span> wc -l
<span class="tok-go">0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Par contre, la commande <code>strings</code> appelée directement sur l&#8217;image
retourne deux chaînes intéressantes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> strings sdcard.img<span class="tok-p">|</span>tail -n 2
<span class="tok-go">INJECT  BIN</span>
<span class="tok-go">java -jar encoder.jar -i /tmp/duckyscript.txt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le nom du fichier <code>duckyscript.txt</code> fait penser au
<a href="http://hakshop.myshopify.com/products/usb-rubber-ducky-deluxe">Rubber Ducky</a>,
outil bien connu des <a href="https://twitter.com/pentesteur">pentesteurs</a>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rubberducky.jpeg" alt="rubberducky">
</div>
<div class="title">Figure 1. Rubber Ducky</div>
</div>
<div class="paragraph">
<p>Un &#8220;Rubber Ducky&#8221; est une clé USB permettant de lancer un code exécutable
sur le poste d&#8217;une victime, selon le principe suivant :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la clé USB est connectée à l&#8217;ordinateur ;</p>
</li>
<li>
<p>elle émule un périphérique de type clavier ;</p>
</li>
<li>
<p>ce périphérique va simuler des frappes au clavier pour exécuter un script
de décodage permettant de reconstituer la charge binaire finale
(généralement un exécutable Windows) ;</p>
</li>
<li>
<p>enfin, la charge finale est déclenchée sur le poste de la victime.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La séquence de frappes clavier à simuler est décrite dans un fichier au format
<a href="https://github.com/hak5darren/USB-Rubber-Ducky/wiki/Duckyscript">&#8220;Ducky Script&#8221;</a>.
Ce fichier est ensuite compilé avec l&#8217;outil <code>duckendoder</code> pour produire un fichier
binaire <code>input.bin</code> : au moment de la connexion de la clé USB,
le micro-contrôleur ira lire le contenu de ce fichier pour démarrer l&#8217;attaque.</p>
</div>
<div class="paragraph">
<p>L&#8217;objectif à ce stade est de pouvoir retrouver le code source du script à partir
du fichier <code>input.bin</code> présent sur la carte SD. Heureusement, l&#8217;outil
<a href="https://code.google.com/p/ducky-decode/source/browse/trunk/ducky-decode.pl?r=6"><code>ducky-decode.pl</code></a>
permet justement de réaliser cette opération.</p>
</div>
<div class="paragraph">
<p>Le lancement de ce script sur notre fichier <code>input.bin</code> retourne le résultat
 suivant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ./ducky-decode.pl -f /mnt/loop/inject.bin
<span class="tok-go">00ff 007d</span>
<span class="tok-go">GUI R</span>

<span class="tok-go">DELAY 500</span>

<span class="tok-go">ENTER</span>

<span class="tok-go">DELAY 1000</span>
<span class="tok-go"> c m d</span>
<span class="tok-go">ENTER</span>

<span class="tok-go">DELAY 50</span>
<span class="tok-go"> p o w e r s h e l l</span>
<span class="tok-go">SPACE</span>
<span class="tok-go"> - e n c</span>
<span class="tok-go">SPACE</span>
<span class="tok-go"> Z g B 1 [...] D s A f Q A = 00a0</span>
<span class="tok-go">ENTER</span>
<span class="tok-go"> p o w e r s h e l l</span>
<span class="tok-go">SPACE</span>
<span class="tok-go"> - e n c</span>
<span class="tok-go">SPACE</span>
<span class="tok-go"> Z g B 1 [...] D s A f Q A = 00a0</span>
<span class="tok-go"> [...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La signification du paramètre <code>-enc</code> de <code>powershell</code> est détaillée sur la page
<a href="https://technet.microsoft.com/fr-fr/library/hh847736.aspx" class="bare">https://technet.microsoft.com/fr-fr/library/hh847736.aspx</a> : il permet
de passer des commandes à exécuter codées en base64. La valeur <code>00a0</code> correspond
à un opcode Ducky Script inconnu de <code>ducky-decode.pl</code> et donc non décodé.</p>
</div>
<div class="paragraph">
<p>On peut donc tenter d&#8217;extraire la chaîne passée en paramètre puis la décoder
avec la commande <code>base64</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ./ducky-decode.pl -f /tmp/inject.bin <span class="tok-p">|</span> grep <span class="tok-s2">&quot;Z g&quot;</span> <span class="tok-p">|</span> head -n <span class="tok-m">1</span> <span class="tok-p">|</span>  sed <span class="tok-s1">&#39;s/\(\s\|00a0\)//g&#39;</span> <span class="tok-p">|</span> base64 -d
<span class="tok-go">function write_file_bytes{param([Byte[]] $file_bytes, [string] $file_path = &quot;.\stage2.zip&quot;);$f = [io.file]::OpenWrite($file_path);$f.Seek($f.Length,0);$f.Write($file_bytes,0,$file_bytes.Length);$f.Close();}function check_correct_environment{$e=[Environment]::CurrentDirectory.split(&quot;\&quot;);$e=$e[$e.Length-1]+[Environment]::UserName;$e -eq &quot;challenge2015sstic&quot;;}if(check_correct_environment){write_file_bytes([Convert]::FromBase64String(&#39;UEsDBAoDAAAAADaK[...]8AJFW2UwdXtOh6gUsBzWnXw==&#39;));}else{write_file_bytes([Convert]::FromBase64String(&#39;VAByAHkASABhAHIAZABlAHIA&#39;));}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme anticipé, on obtient alors une série d&#8217;instructions Powershell qui réalisent
les opérations suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>définition d&#8217;une fonction <code>write_file_bytes</code> qui écrit les données <code>$file_bytes</code> à la fin
du fichier spécifié par <code>$file_path</code> (<code>stage2.zip</code> par défaut);</p>
</li>
<li>
<p>définition d&#8217;une fonction <code>check_correct_environment</code> qui teste si le nom
de l&#8217;utilisateur courant est bien <code>challenge2015sstic</code> ;</p>
</li>
<li>
<p>en fonction du résultat de l&#8217;appel à <code>check_correct_environment</code>, appel de la fonction
<code>write_file_bytes</code> avec :</p>
<div class="ulist">
<ul>
<li>
<p>une longue chaîne de caractères en base64 si le résultat est positif,</p>
</li>
<li>
<p>la chaîne <code>"VAByAHkASABhAHIAZABlAHIA"</code> (&#8220;Try harder&#8221;) sinon.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour reconstruire le fichier <code>stage2.zip</code>, il ne reste plus qu&#8217;à extraire les
données des instructions Powershell, les décoder puis écrire le résultat
binaire dans le fichier de sortie. Le script Ruby ci-dessous réalise ces opérations :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>
<span class="tok-c1"># encoding: UTF-8</span>

<span class="tok-nb">require</span> <span class="tok-s1">&#39;base64&#39;</span>

<span class="tok-n">input</span> <span class="tok-o">=</span> <span class="tok-no">ARGV</span><span class="tok-o">.</span><span class="tok-n">shift</span>

<span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;stage2.zip&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;wb&quot;</span><span class="tok-p">)</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">fo</span><span class="tok-o">|</span>
  <span class="tok-no">IO</span><span class="tok-o">.</span><span class="tok-n">popen</span><span class="tok-p">(</span><span class="tok-s2">&quot;./ducky-decode.pl -f </span><span class="tok-si">#{</span><span class="tok-n">input</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">each_line</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">line</span><span class="tok-o">|</span>
    <span class="tok-k">next</span> <span class="tok-k">unless</span> <span class="tok-n">line</span> <span class="tok-o">=~</span> <span class="tok-sr">/^ Z/</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">gsub</span><span class="tok-p">(</span><span class="tok-sr">/( |00a0)/</span><span class="tok-p">,</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">strip</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">t</span> <span class="tok-o">=</span> <span class="tok-no">Base64</span><span class="tok-o">.</span><span class="tok-n">decode64</span><span class="tok-p">(</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">force_encoding</span><span class="tok-p">(</span><span class="tok-s2">&quot;UTF-16LE&quot;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">encode</span><span class="tok-p">(</span><span class="tok-s2">&quot;UTF-8&quot;</span><span class="tok-p">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-k">if</span> <span class="tok-n">t</span> <span class="tok-o">=~</span> <span class="tok-sr">/FromBase64String\(&#39;([^&#39;]+)&#39;\)/</span>
      <span class="tok-n">fo</span><span class="tok-o">.</span><span class="tok-n">write</span> <span class="tok-no">Base64</span><span class="tok-o">.</span><span class="tok-n">decode64</span><span class="tok-p">(</span><span class="tok-vg">$1</span><span class="tok-p">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>teste si la ligne commence par " Z"</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>suppression des espaces et opcode non décodé</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>conversion d&#8217;UTF-16LE vers UTF-8</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>extraction des données de <code>stage2.zip</code> et écriture dans le fichier de sortie</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le fichier obtenu peut alors être testé :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> md5sum stage2.zip
<span class="tok-go">979ff7961addd9ce982ff51fe2a0a058  stage2.zip</span>
<span class="tok-gp">$</span> unzip -t stage2.zip
<span class="tok-go">Archive:  stage2.zip</span>
<span class="tok-go">    testing: encrypted                OK</span>
<span class="tok-go">    testing: memo.txt                 OK</span>
<span class="tok-go">    testing: sstic.pk3                OK</span>
<span class="tok-go">No errors detected in compressed data of stage2.zip.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;analyse de cette archive constitue la seconde étape de ce challenge.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quake3">Stage 2 : Quake 3</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le fichier <code>memo.txt</code> de l&#8217;archive <code>stage2.zip</code> est le suivant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> cat memo.txt
<span class="tok-go">Cipher: AES-OFB</span>
<span class="tok-go">IV: 0x5353544943323031352d537461676532</span>
<span class="tok-go">Key: Damn... I ALWAYS forget it. Fortunately I found a way to hide it into my favorite game !</span>

<span class="tok-go">SHA256: 91d0a6f55cce427132fc638b6beecf105c2cb0c817a4b7846ddb04e3132ea945 - encrypted</span>
<span class="tok-go">SHA256: 845f8b000f70597cf55720350454f6f3af3420d8d038bb14ce74d6f4ac5b9187 - decrypted</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce mémo nous donne des informations sur le mode de chiffrement, le vecteur
d&#8217;initialisation utilisé et quelques indications sur la clé : celle-ci
semble en effet cachée dans un jeu.</p>
</div>
<div class="paragraph">
<p>Le fichier <code>sstic.pk3</code>, également présent dans l&#8217;archive <code>stage2.zip</code>, est en fait
une carte pour le jeu Quake 3 Arena. En chargeant la carte et en explorant les
lieux, on aperçoit certaines textures contenant des données hexadécimales. On suppose
à ce stade qu&#8217;il s&#8217;agit de morceaux de la clé à reconstituer.</p>
</div>
<div class="paragraph">
<p>La vidéo ci-dessous présente un parcours de la carte sous OpenArena
permettant de retrouver l&#8217;ensemble de ces textures :</p>
</div>
<div class="videoblock">
<div class="content">
<video controls>
  <source src='demo.webm' type='video/webm'>
  <source src='demo.mp4' type='video/mp4'>

Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Ces textures, extraites depuis le fichier <code>sstic.pk3</code> sont présentées ci-dessous
dans leur ordre de découverte :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_montage.png" alt="rk montage">
</div>
</div>
<div class="paragraph">
<p>Enfin, la pièce finale après le rocket jump affiche la séquence à respecter pour obtenir
la clé finale :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_seq.jpg" alt="rk seq">
</div>
</div>
<div class="paragraph">
<p>En combinant les textures observées avec la séquence finale, on peut déduire
la clé de déchiffrement :</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 12%;">
<col style="width: 12%;">
<col style="width: 12%;">
<col style="width: 12%;">
<col style="width: 12%;">
<col style="width: 12%;">
<col style="width: 12%;">
<col style="width: 12%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Drapeau</th>
<th class="tableblock halign-left valign-top">Pulse</th>
<th class="tableblock halign-left valign-top">Location</th>
<th class="tableblock halign-left valign-top">Goutte</th>
<th class="tableblock halign-left valign-top">Drapeau</th>
<th class="tableblock halign-left valign-top">Maillon</th>
<th class="tableblock halign-left valign-top">Wi-Fi</th>
<th class="tableblock halign-left valign-top">PC</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Blanc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Orange</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Blanc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Orange</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Blanc</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>9e2f31f7</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>8153296b</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3d9b0ba6</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7695dc7c</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>b0daf152</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>b54cdc34</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ffe0d355</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>26609fac</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Une fois la clé identifiée, le déchiffrement peut être réalisé par le script
suivant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-nb">require</span> <span class="tok-s1">&#39;openssl&#39;</span>
<span class="tok-nb">require</span> <span class="tok-s1">&#39;digest&#39;</span>

<span class="tok-k">def</span> <span class="tok-nf">hex_to_bin</span><span class="tok-p">(</span><span class="tok-n">s</span><span class="tok-p">)</span>
  <span class="tok-n">s</span><span class="tok-o">.</span><span class="tok-n">scan</span><span class="tok-p">(</span><span class="tok-sr">/../</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">map</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">x</span><span class="tok-o">|</span> <span class="tok-n">x</span><span class="tok-o">.</span><span class="tok-n">to_i</span><span class="tok-p">(</span><span class="tok-mi">16</span><span class="tok-p">)}</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-n">iv</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;5353544943323031352d537461676532&quot;</span>
<span class="tok-n">key</span>  <span class="tok-o">=</span> <span class="tok-s2">&quot;9e2f31f7&quot;</span> <span class="tok-c1"># flag green</span>
<span class="tok-n">key</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;8153296b&quot;</span> <span class="tok-c1"># pulse white</span>
<span class="tok-n">key</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;3d9b0ba6&quot;</span> <span class="tok-c1"># loc orange</span>
<span class="tok-n">key</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;7695dc7c&quot;</span> <span class="tok-c1"># drop white</span>
<span class="tok-n">key</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;b0daf152&quot;</span> <span class="tok-c1"># flag orange</span>
<span class="tok-n">key</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;b54cdc34&quot;</span> <span class="tok-c1"># link green</span>
<span class="tok-n">key</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;ffe0d355&quot;</span> <span class="tok-c1"># wifi green</span>
<span class="tok-n">key</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;26609fac&quot;</span> <span class="tok-c1"># pc white</span>

<span class="tok-n">encrypted_data</span> <span class="tok-o">=</span> <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;input/encrypted&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;rb&quot;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">read</span>
<span class="tok-n">encrypted_sha256</span> <span class="tok-o">=</span> <span class="tok-no">Digest</span><span class="tok-o">::</span><span class="tok-no">SHA256</span><span class="tok-o">.</span><span class="tok-n">hexdigest</span><span class="tok-p">(</span><span class="tok-n">encrypted_data</span><span class="tok-p">)</span>

<span class="tok-k">raise</span> <span class="tok-k">unless</span> <span class="tok-n">encrypted_sha256</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;91d0a6f55cce427132fc638b6beecf105c2cb0c817a4b7846ddb04e3132ea945&quot;</span>

<span class="tok-n">cipher</span> <span class="tok-o">=</span> <span class="tok-no">OpenSSL</span><span class="tok-o">::</span><span class="tok-no">Cipher</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-s1">&#39;aes-256-ofb&#39;</span><span class="tok-p">)</span>
<span class="tok-n">cipher</span><span class="tok-o">.</span><span class="tok-n">decrypt</span>
<span class="tok-n">cipher</span><span class="tok-o">.</span><span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-n">hex_to_bin</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">)</span>
<span class="tok-n">cipher</span><span class="tok-o">.</span><span class="tok-n">iv</span> <span class="tok-o">=</span> <span class="tok-n">hex_to_bin</span><span class="tok-p">(</span><span class="tok-n">iv</span><span class="tok-p">)</span>

<span class="tok-n">plain</span> <span class="tok-o">=</span> <span class="tok-n">cipher</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span><span class="tok-n">encrypted_data</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-n">cipher</span><span class="tok-o">.</span><span class="tok-n">final</span>

<span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;decrypted&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;wb&quot;</span><span class="tok-p">)</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">f</span><span class="tok-o">|</span>
   <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">write</span> <span class="tok-n">plain</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Étrangement, l&#8217;empreinte sha256 du fichier obtenu ne correspond pas à celle
mentionnée dans le fichier <code>memo.txt</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> sha256sum decrypted
<span class="tok-go">f9ca4432afe87cbb1fca914e35ce69708c6bfa360b82bff21503b6723d1cfbf0  decrypted</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cependant, en observant la fin du fichier, on constate la présence de données de
bourrage :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> hexdump -C decrypted<span class="tok-p">|</span> tail -n 4
<span class="tok-go">0007a4e0  00 70 61 69 6e 74 2e 63  61 70 50 4b 05 06 00 00  |.paint.capPK....|</span>
<span class="tok-go">0007a4f0  00 00 03 00 03 00 a4 00  00 00 46 a4 07 00 00 00  |..........F.....|</span>
<span class="tok-go">0007a500  10 10 10 10 10 10 10 10  10 10 10 10 10 10 10 10  |................|</span>
<span class="tok-go">0007a510</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En supprimant les 16 derniers octets, on retrouve la bonne empreinte :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>decrypted <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">count</span><span class="tok-o">=</span><span class="tok-k">$((</span> <span class="tok-k">$(</span>stat -c %s decrypted<span class="tok-k">)</span> <span class="tok-o">-</span> <span class="tok-m">16</span><span class="tok-k">))</span> <span class="tok-p">|</span> sha256sum -
<span class="tok-go">500992+0 records in</span>
<span class="tok-go">500992+0 records out</span>
<span class="tok-go">500992 bytes (501 kB) copied, 0.520727 s, 962 kB/s</span>
<span class="tok-go">845f8b000f70597cf55720350454f6f3af3420d8d038bb14ce74d6f4ac5b9187  -</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;archive obtenue peut alors être testée pour en découvrir le contenu :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> unzip -t decrypted
<span class="tok-go">Archive:  decrypted</span>
<span class="tok-go">    testing: encrypted                OK</span>
<span class="tok-go">    testing: memo.txt                 OK</span>
<span class="tok-go">    testing: paint.cap                OK</span>
<span class="tok-go">No errors detected in compressed data of decrypted.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;étude de ces fichiers fait l&#8217;objet de l&#8217;étape suivante du challenge.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stage_3_paint">Stage 3 : Paint</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le fichier <code>memo.txt</code> obtenu à l&#8217;étape précédente contient les informations
suivantes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">#</span> cat memo.txt
<span class="tok-go">Cipher: Serpent-1-CBC-With-CTS</span>
<span class="tok-go">IV: 0x5353544943323031352d537461676533</span>
<span class="tok-go">Key: Well, definitely can&#39;t remember it... So this time I securely stored it with Paint.</span>

<span class="tok-go">SHA256: 6b39ac2220e703a48b3de1e8365d9075297c0750e9e4302fc3492f98bdf3a0b0 - encrypted</span>
<span class="tok-go">SHA256: 7beabe40888fbbf3f8ff8f4ee826bb371c596dd0cebe0796d2dae9f9868dd2d2 - decrypted</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette fois ci, la clé de déchiffrement semble avoir été stockée avec le logiciel
Paint, ce qui est plutôt original. L&#8217;archive contient également un fichier
<code>paint.cap</code> qu&#8217;il est possible d&#8217;ouvrir avec Wireshark, comme présenté ci-dessous :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_paint_cap.png" alt="rk paint cap">
</div>
</div>
<div class="paragraph">
<p>Il s&#8217;agit d&#8217;une capture d&#8217;une trace USB dans laquelle on distingue trois types
de messages :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>des requêtes de type &#8220;Request DEVICE&#8221; pour énumérer les périphériques ;</p>
</li>
<li>
<p>des réponses &#8220;Response DEVICE&#8221; aux précédentes requêtes ;</p>
</li>
<li>
<p>enfin des messages de type &#8220;URB_INTERRUPT&#8221;.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Au niveau des périphériques découverts, on retrouve en particulier une souris
USB :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_mouse_cap.png" alt="rk mouse cap">
</div>
</div>
<div class="paragraph">
<p>Le reste de la capture est une série de messages &#8220;URB_INTERRUPT&#8221; tel que celui
présenté ci-dessous :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_urb_cap.png" alt="rk urb cap">
</div>
</div>
<div class="paragraph">
<p>Certaines données (&#8220;Leftover Capture Data&#8221;) ne sont pas décodées par Wireshark,
faute de pouvoir les interpréter correctement.</p>
</div>
<div class="paragraph">
<p>La lecture du fichier <a href="http://lxr.free-electrons.com/source/drivers/hid/usbhid/usbmouse.c#L81"><code>usbmouse.c</code></a>,
responsable du support des souris USB dans le noyau Linux, permet de comprendre le format
de ces données :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-n">input_report_key</span><span class="tok-p">(</span><span class="tok-n">dev</span><span class="tok-p">,</span> <span class="tok-n">BTN_LEFT</span><span class="tok-p">,</span>   <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0x01</span><span class="tok-p">);</span>
<span class="tok-n">input_report_key</span><span class="tok-p">(</span><span class="tok-n">dev</span><span class="tok-p">,</span> <span class="tok-n">BTN_RIGHT</span><span class="tok-p">,</span>  <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0x02</span><span class="tok-p">);</span>
<span class="tok-n">input_report_key</span><span class="tok-p">(</span><span class="tok-n">dev</span><span class="tok-p">,</span> <span class="tok-n">BTN_MIDDLE</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0x04</span><span class="tok-p">);</span>
<span class="tok-n">input_report_key</span><span class="tok-p">(</span><span class="tok-n">dev</span><span class="tok-p">,</span> <span class="tok-n">BTN_SIDE</span><span class="tok-p">,</span>   <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0x08</span><span class="tok-p">);</span>
<span class="tok-n">input_report_key</span><span class="tok-p">(</span><span class="tok-n">dev</span><span class="tok-p">,</span> <span class="tok-n">BTN_EXTRA</span><span class="tok-p">,</span>  <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0x10</span><span class="tok-p">);</span>

<span class="tok-n">input_report_rel</span><span class="tok-p">(</span><span class="tok-n">dev</span><span class="tok-p">,</span> <span class="tok-n">REL_X</span><span class="tok-p">,</span>     <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]);</span>
<span class="tok-n">input_report_rel</span><span class="tok-p">(</span><span class="tok-n">dev</span><span class="tok-p">,</span> <span class="tok-n">REL_Y</span><span class="tok-p">,</span>     <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">]);</span>
<span class="tok-n">input_report_rel</span><span class="tok-p">(</span><span class="tok-n">dev</span><span class="tok-p">,</span> <span class="tok-n">REL_WHEEL</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le premier octet contient l&#8217;état des différents boutons de la souris, les octets
deux et trois représentent le déplacement de la souris sur les axes X et Y et
le dernier octet correspond au déplacement de la roulette.</p>
</div>
<div class="paragraph">
<p>L&#8217;analyse de la trace va nous permettre de reconstituer tous les déplacements de la souris
ainsi que les clics effectués. On peut donc ainsi espérer retrouver le dessin
réalisé sous Paint, en associant à chaque clic un pixel.</p>
</div>
<div class="paragraph">
<p>Le script Ruby ci-dessous exploite les informations des interruptions pour
récupérer les coordonnées de chaque clic et construire l&#8217;image correspondante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-nb">require</span> <span class="tok-s1">&#39;sdl&#39;</span>

<span class="tok-n">clicks</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
<span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-n">y</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span>
<span class="tok-n">min_x</span><span class="tok-p">,</span> <span class="tok-n">max_x</span><span class="tok-p">,</span> <span class="tok-n">min_y</span><span class="tok-p">,</span> <span class="tok-n">max_y</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-no">IO</span><span class="tok-o">.</span><span class="tok-n">popen</span><span class="tok-p">(</span><span class="tok-s2">&quot;tshark -r input/paint.cap -V&quot;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">each_line</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">line</span><span class="tok-o">|</span>
  <span class="tok-k">next</span> <span class="tok-k">unless</span> <span class="tok-n">line</span> <span class="tok-o">=~</span> <span class="tok-sr">/Leftover Capture Data: (.{8})/</span>
  <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-vg">$1</span><span class="tok-o">.</span><span class="tok-n">scan</span><span class="tok-p">(</span><span class="tok-sr">/../</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">map</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">x</span><span class="tok-o">|</span> <span class="tok-n">x</span><span class="tok-o">.</span><span class="tok-n">to_i</span><span class="tok-p">(</span><span class="tok-mi">16</span><span class="tok-p">)}</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;c*&#39;</span><span class="tok-p">)</span>

  <span class="tok-n">buttons</span><span class="tok-p">,</span> <span class="tok-n">x_dep</span><span class="tok-p">,</span> <span class="tok-n">y_dep</span><span class="tok-p">,</span> <span class="tok-n">dev_spec</span> <span class="tok-o">=</span> <span class="tok-o">*</span><span class="tok-n">data</span>

  <span class="tok-n">x</span> <span class="tok-o">+=</span> <span class="tok-n">x_dep</span> <span class="tok-k">if</span> <span class="tok-n">x_dep</span> <span class="tok-o">!=</span> <span class="tok-mi">0</span>
  <span class="tok-n">y</span> <span class="tok-o">+=</span> <span class="tok-n">y_dep</span> <span class="tok-k">if</span> <span class="tok-n">y_dep</span> <span class="tok-o">!=</span> <span class="tok-mi">0</span>

  <span class="tok-n">min_x</span> <span class="tok-o">=</span> <span class="tok-n">x</span> <span class="tok-k">if</span> <span class="tok-n">x</span> <span class="tok-o">&lt;</span> <span class="tok-n">min_x</span>
  <span class="tok-n">max_x</span> <span class="tok-o">=</span> <span class="tok-n">x</span> <span class="tok-k">if</span> <span class="tok-n">x</span> <span class="tok-o">&gt;</span> <span class="tok-n">max_x</span>
  <span class="tok-n">min_y</span> <span class="tok-o">=</span> <span class="tok-n">y</span> <span class="tok-k">if</span> <span class="tok-n">y</span> <span class="tok-o">&lt;</span> <span class="tok-n">min_y</span>
  <span class="tok-n">max_y</span> <span class="tok-o">=</span> <span class="tok-n">y</span> <span class="tok-k">if</span> <span class="tok-n">y</span> <span class="tok-o">&gt;</span> <span class="tok-n">max_y</span>

  <span class="tok-o">[</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">2</span> <span class="tok-o">].</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">bit</span><span class="tok-o">|</span>
    <span class="tok-k">if</span> <span class="tok-p">((</span><span class="tok-n">buttons</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-n">bit</span><span class="tok-p">)</span> <span class="tok-o">&amp;</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-mi">1</span> <span class="tok-k">then</span>
      <span class="tok-n">clicks</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-o">[</span><span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-n">y</span><span class="tok-o">]</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span>

<span class="tok-n">extra_space</span> <span class="tok-o">=</span> <span class="tok-mi">128</span>
<span class="tok-n">width</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">max_x</span> <span class="tok-o">-</span> <span class="tok-n">min_x</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-n">extra_space</span>
<span class="tok-n">height</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">max_y</span> <span class="tok-o">-</span> <span class="tok-n">min_y</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-n">extra_space</span>

<span class="tok-no">SDL</span><span class="tok-o">.</span><span class="tok-n">init</span><span class="tok-p">(</span><span class="tok-no">SDL</span><span class="tok-o">::</span><span class="tok-no">INIT_VIDEO</span><span class="tok-p">)</span>
<span class="tok-n">screen</span> <span class="tok-o">=</span> <span class="tok-no">SDL</span><span class="tok-o">::</span><span class="tok-no">Screen</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-n">width</span><span class="tok-p">,</span> <span class="tok-n">height</span><span class="tok-p">,</span><span class="tok-mi">16</span><span class="tok-p">,</span><span class="tok-no">SDL</span><span class="tok-o">::</span><span class="tok-no">HWSURFACE</span><span class="tok-p">)</span>

<span class="tok-n">white</span> <span class="tok-o">=</span> <span class="tok-n">screen</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-o">.</span><span class="tok-n">map_rgb</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">,</span> <span class="tok-mi">255</span><span class="tok-p">,</span> <span class="tok-mi">255</span><span class="tok-p">)</span>
<span class="tok-n">black</span> <span class="tok-o">=</span> <span class="tok-n">screen</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-o">.</span><span class="tok-n">map_rgb</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">)</span>
<span class="tok-n">screen</span><span class="tok-o">.</span><span class="tok-n">fill_rect</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">width</span><span class="tok-p">,</span> <span class="tok-n">height</span><span class="tok-p">,</span> <span class="tok-n">white</span><span class="tok-p">)</span>

<span class="tok-n">clicks</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-n">y</span><span class="tok-o">|</span>
  <span class="tok-n">screen</span><span class="tok-o">.</span><span class="tok-n">put_pixel</span><span class="tok-p">(</span><span class="tok-n">x</span> <span class="tok-o">-</span> <span class="tok-n">min_x</span> <span class="tok-o">+</span> <span class="tok-n">extra_space</span> <span class="tok-o">/</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <i class="conum" data-value="2"></i><b>(2)</b>
                   <span class="tok-n">y</span> <span class="tok-o">-</span> <span class="tok-n">min_y</span> <span class="tok-o">+</span> <span class="tok-n">extra_space</span> <span class="tok-o">/</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
                   <span class="tok-n">black</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-n">screen</span><span class="tok-o">.</span><span class="tok-n">flip</span>
<span class="tok-nb">sleep</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span>
<span class="tok-n">screen</span><span class="tok-o">.</span><span class="tok-n">save_bmp</span><span class="tok-p">(</span><span class="tok-s2">&quot;screen.bmp&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Dimensions de la bounding-box</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Translation des coordonnées du point vers la bounding-box</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le résultat obtenu est le suivant :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_trim.png" alt="rk trim">
</div>
</div>
<div class="paragraph">
<p>Pour obtenir la clé de déchiffrement, il faut donc calculer
l&#8217;empreinte de la chaîne &#8220;The quick brown fox jumps over
the lobster dog&#8221; (référence au challenge SSTIC 2011) à l&#8217;aide
de l&#8217;algorithme Blake256.</p>
</div>
<div class="paragraph">
<p>Cet algorithme étant récent, il n&#8217;est pas implémenté dans les
bibliothèques classiques telles qu&#8217;OpenSSL. Il faut donc télécharger
puis compiler l&#8217;implémentation de référence à l&#8217;adresse
<a href="https://131002.net/blake/blake_c.tar.gz" class="bare">https://131002.net/blake/blake_c.tar.gz</a> .</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> wget https://131002.net/blake/blake_c.tar.gz
<span class="tok-gp">$</span> tar xvf blake_c.tar.gz
<span class="tok-go">blake/</span>
<span class="tok-go">blake/blake256.c</span>
<span class="tok-go">blake/blake384.c</span>
<span class="tok-go">blake/blake224.c</span>
<span class="tok-go">blake/README</span>
<span class="tok-go">blake/blake.h</span>
<span class="tok-go">blake/Makefile</span>
<span class="tok-go">blake/blake512.c</span>
<span class="tok-go">blake/astyle-clean.sh</span>
<span class="tok-gp">$</span> <span class="tok-nb">cd </span>blake
<span class="tok-gp">$</span> make
<span class="tok-go">make</span>
<span class="tok-go">cc -Wall -O3 -fomit-frame-pointer    blake224.c   -o blake224</span>
<span class="tok-go">cc -Wall -O3 -fomit-frame-pointer    blake256.c   -o blake256</span>
<span class="tok-go">cc -Wall -O3 -fomit-frame-pointer    blake384.c   -o blake384</span>
<span class="tok-go">cc -Wall -O3 -fomit-frame-pointer    blake512.c   -o blake512</span>
<span class="tok-go">Checking test vectors</span>
<span class="tok-go">./blake224</span>
<span class="tok-go">./blake256</span>
<span class="tok-go">./blake384</span>
<span class="tok-go">./blake512</span>
<span class="tok-gp">$</span> <span class="tok-nb">echo</span> -n <span class="tok-s2">&quot;The quick brown fox jumps over the lobster dog&quot;</span> &gt; key
<span class="tok-gp">$</span> ./blake256 key
<span class="tok-go">66c1ba5e8ca29a8ab6c105a9be9e75fe0ba07997a839ffeae9700b00b7269c8d key</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il ne reste plus qu&#8217;à déchiffrer le fichier <code>encrypted</code> à l&#8217;aide des informations
contenues dans le mémo, à savoir l&#8217;algorithme de chiffrement et le mode
(Serpent-1-CBC-With-CTS) ainsi que le vecteur d&#8217;initialisation.</p>
</div>
<div class="paragraph">
<p>Le script Ruby ci-dessous réalise l&#8217;opération de déchiffrement, en se basant
sur les bindings vers la bibliothèque CryptoPP :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-nb">require</span> <span class="tok-s1">&#39;cryptopp&#39;</span>

<span class="tok-no">IV</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;5353544943323031352d537461676533&quot;</span>
<span class="tok-no">KEY</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;66c1ba5e8ca29a8ab6c105a9be9e75fe0ba07997a839ffeae9700b00b7269c8d&quot;</span>

<span class="tok-n">inputfile</span><span class="tok-p">,</span> <span class="tok-n">outputfile</span> <span class="tok-o">=</span> <span class="tok-no">ARGV</span><span class="tok-o">.</span><span class="tok-n">shift</span><span class="tok-p">,</span> <span class="tok-no">ARGV</span><span class="tok-o">.</span><span class="tok-n">shift</span>

<span class="tok-n">serpent</span> <span class="tok-o">=</span> <span class="tok-no">CryptoPP</span><span class="tok-o">::</span><span class="tok-no">Serpent</span><span class="tok-o">.</span><span class="tok-n">new</span>
<span class="tok-n">serpent</span><span class="tok-o">.</span><span class="tok-n">block_mode</span> <span class="tok-o">=</span> <span class="tok-ss">:cbc_cts</span>
<span class="tok-n">serpent</span><span class="tok-o">.</span><span class="tok-n">iv_hex</span> <span class="tok-o">=</span> <span class="tok-no">IV</span>
<span class="tok-n">serpent</span><span class="tok-o">.</span><span class="tok-n">key_hex</span> <span class="tok-o">=</span> <span class="tok-no">KEY</span>

<span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-n">inputfile</span><span class="tok-p">,</span> <span class="tok-s2">&quot;rb&quot;</span><span class="tok-p">)</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">fi</span><span class="tok-o">|</span>
  <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-n">outputfile</span><span class="tok-p">,</span> <span class="tok-s2">&quot;wb&quot;</span><span class="tok-p">)</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">fo</span><span class="tok-o">|</span>
    <span class="tok-n">serpent</span><span class="tok-o">.</span><span class="tok-n">decrypt_io</span> <span class="tok-n">fi</span><span class="tok-p">,</span> <span class="tok-n">fo</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les données en clair sont alors récupérées à l&#8217;aide du script :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ./decrypt.rb input/encrypted input/decrypted
<span class="tok-gp">$</span> sha256sum input/decrypted
<span class="tok-go">7beabe40888fbbf3f8ff8f4ee826bb371c596dd0cebe0796d2dae9f9868dd2d2  input/decrypted</span>
<span class="tok-gp">$</span> file input/decrypted
<span class="tok-go">input/decrypted: Zip archive data, at least v2.0 to extract</span>
<span class="tok-gp">$</span> unzip -t input/decrypted
<span class="tok-go">Archive:  input/decrypted</span>
<span class="tok-go">    testing: stage4.html              OK</span>
<span class="tok-go">No errors detected in compressed data of input/decrypted.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;empreinte sha256 est correcte et le fichier obtenu est une archive zip
contenant un fichier HTML qui sera analysé dans l&#8217;étape suivante.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stage_4_javascript">Stage 4 : JavaScript</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le chargement du fichier <code>stage4.html</code> obtenu précédemment dans un navigateur
donne le résultat suivant :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_stage4_1.png" alt="rk stage4 1">
</div>
</div>
<div class="paragraph">
<p>Pour comprendre la raison de l&#8217;erreur, on est alors tenté de regarder le code source
de la page. Le corps du fichier est uniquement constitué de code JavaScript
qui commence par l&#8217;initialisation d&#8217;une variable <code>data</code> :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_stage4_2.png" alt="rk stage4 2">
</div>
</div>
<div class="paragraph">
<p>Ensuite, le script définit une seconde variable <code>hash</code> puis exécute une série
d&#8217;instructions JavaScript obfusquées :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_stage4_3.png" alt="rk stage4 3">
</div>
</div>
<div class="paragraph">
<p>Le premier réflexe est d&#8217;essayer de réindenter le fichier pour faciliter sa
lisibilité. Pour cela, on passe en mode hipster moustachu en installant Node.js et l&#8217;outil
<a href="https://github.com/beautify-web/js-beautify"><code>js-beautify</code></a>. Le résultat obtenu
est le suivant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span class="tok-nt">&lt;html&gt;</span>

<span class="tok-nt">&lt;head&gt;</span>
[...]
<span class="tok-nt">&lt;/head&gt;</span>

<span class="tok-nt">&lt;body&gt;</span>
    <span class="tok-nt">&lt;script&gt;</span>
        <span class="tok-kd">var</span> <span class="tok-nx">data</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;2b1f25cf8db5d243f[...]bfd3ac1646ffe2&quot;</span><span class="tok-p">;</span>
        <span class="tok-kd">var</span> <span class="tok-nx">hash</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;08c3be636f7dffd91971f65be4cec3c6d162cb1c&quot;</span><span class="tok-p">;</span>
        <span class="tok-nx">$</span> <span class="tok-o">=</span> <span class="tok-o">~</span><span class="tok-p">[];</span>
        <span class="tok-nx">$</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
            <span class="tok-nx">___</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span>
            <span class="tok-nx">$$$$</span><span class="tok-o">:</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-p">[]</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">],</span>
            <span class="tok-nx">__$</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span>
            <span class="tok-nx">$_$_</span><span class="tok-o">:</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-p">[]</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">],</span>
            <span class="tok-nx">_$_</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span>
            <span class="tok-nx">$_$$</span><span class="tok-o">:</span> <span class="tok-p">({}</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">],</span>
            <span class="tok-nx">$$_$</span><span class="tok-o">:</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">[</span><span class="tok-nx">$</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">],</span>
            <span class="tok-nx">_$$</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span>
            <span class="tok-nx">$$$_</span><span class="tok-o">:</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-s2">&quot;&quot;</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">],</span>
            <span class="tok-nx">$__</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span>
            <span class="tok-nx">$_$</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span>
            <span class="tok-nx">$$__</span><span class="tok-o">:</span> <span class="tok-p">({}</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">],</span>
            <span class="tok-nx">$$_</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span>
            <span class="tok-nx">$$$</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span>
            <span class="tok-nx">$___</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span>
            <span class="tok-nx">$__$</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span>
        <span class="tok-p">};</span>
        <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_</span> <span class="tok-o">=</span> <span class="tok-nx">$</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_$</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">_$</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_</span><span class="tok-p">[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">__$</span><span class="tok-p">])</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$$</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">__$</span><span class="tok-p">])</span> <span class="tok-o">+</span> <span class="tok-p">((</span><span class="tok-o">!</span><span class="tok-nx">$</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">_$$</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">__</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_</span><span class="tok-p">[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$$_</span><span class="tok-p">])</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-s2">&quot;&quot;</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">__$</span><span class="tok-p">])</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">_</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-s2">&quot;&quot;</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">_$_</span><span class="tok-p">])</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_</span><span class="tok-p">[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_$</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">__</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">_$</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span><span class="tok-p">;</span>
        <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$$</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-s2">&quot;&quot;</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">_$$</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">__</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">_</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$$</span><span class="tok-p">;</span>
        <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">___</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_</span><span class="tok-p">][</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_</span><span class="tok-p">];</span>
        <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$$</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;\&quot;&quot;</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;__=&quot;</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$$_$</span> <span class="tok-o">+</span> <span class="tok-p">[...]</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;\&quot;&quot;</span><span class="tok-p">)())();</span>
    <span class="tok-nt">&lt;/script&gt;</span>
<span class="tok-nt">&lt;/body&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On peut alors lancer un interpréteur JavaScript avec Node.js et exécuter
les instructions ligne par ligne pour suivre le déroulement du script :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">$</span> <span class="tok-o">=</span> <span class="tok-o">~</span><span class="tok-p">[];</span>
<span class="tok-o">-</span><span class="tok-mi">1</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">$</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-nx">___</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span> <span class="tok-nx">$$$$</span><span class="tok-o">:</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-p">[]</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">],</span> <span class="tok-nx">__$</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span> <span class="tok-nx">$_$_</span><span class="tok-o">:</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-p">[]</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">],</span> <span class="tok-nx">_$_</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span> <span class="tok-nx">$_$$</span><span class="tok-o">:</span> <span class="tok-p">({}</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">],</span> <span class="tok-nx">$$_$</span><span class="tok-o">:</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">[</span><span class="tok-nx">$</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">],</span> <span class="tok-nx">_$$</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span> <span class="tok-nx">$$$_</span><span class="tok-o">:</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-s2">&quot;&quot;</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">],</span> <span class="tok-nx">$__</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span> <span class="tok-nx">$_$</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span> <span class="tok-nx">$$__</span><span class="tok-o">:</span> <span class="tok-p">({}</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">],</span> <span class="tok-nx">$$_</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span> <span class="tok-nx">$$$</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span> <span class="tok-nx">$___</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span><span class="tok-p">,</span> <span class="tok-nx">$__$</span><span class="tok-o">:</span> <span class="tok-o">++</span><span class="tok-nx">$</span> <span class="tok-p">};</span>
<span class="tok-p">{</span> <span class="tok-nx">___</span><span class="tok-o">:</span> <span class="tok-mi">0</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;$$$$&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;f&#39;</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;__$&#39;</span><span class="tok-o">:</span> <span class="tok-mi">1</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;$_$_&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;a&#39;</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;_$_&#39;</span><span class="tok-o">:</span> <span class="tok-mi">2</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;$_$$&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;b&#39;</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;$$_$&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;d&#39;</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;_$$&#39;</span><span class="tok-o">:</span> <span class="tok-mi">3</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;$$$_&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;e&#39;</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;$__&#39;</span><span class="tok-o">:</span> <span class="tok-mi">4</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;$_$&#39;</span><span class="tok-o">:</span> <span class="tok-mi">5</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;$$__&#39;</span><span class="tok-o">:</span> <span class="tok-s1">&#39;c&#39;</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;$$_&#39;</span><span class="tok-o">:</span> <span class="tok-mi">6</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;$$$&#39;</span><span class="tok-o">:</span> <span class="tok-mi">7</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;$___&#39;</span><span class="tok-o">:</span> <span class="tok-mi">8</span><span class="tok-p">,</span>
  <span class="tok-s1">&#39;$__$&#39;</span><span class="tok-o">:</span> <span class="tok-mi">9</span> <span class="tok-p">}</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_</span> <span class="tok-o">=</span> <span class="tok-nx">$</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_$</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">_$</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_</span><span class="tok-p">[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">__$</span><span class="tok-p">])</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$$</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">__$</span><span class="tok-p">])</span> <span class="tok-o">+</span> <span class="tok-p">((</span><span class="tok-o">!</span><span class="tok-nx">$</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">_$$</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">__</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_</span><span class="tok-p">[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$$_</span><span class="tok-p">])</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-s2">&quot;&quot;</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">__$</span><span class="tok-p">])</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">_</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-s2">&quot;&quot;</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">_$_</span><span class="tok-p">])</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_</span><span class="tok-p">[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_$</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">__</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">_$</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span><span class="tok-p">;</span>
<span class="tok-s1">&#39;constructor&#39;</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$$</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-s2">&quot;&quot;</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">_$$</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">__</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">_</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$$</span><span class="tok-p">;</span>
<span class="tok-s1">&#39;return&#39;</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">___</span><span class="tok-p">)[</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_</span><span class="tok-p">][</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$_</span><span class="tok-p">];</span>
<span class="tok-p">[</span><span class="tok-nb">Function</span><span class="tok-o">:</span> <span class="tok-nb">Function</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ces instructions se contentent de définir un objet <code>$</code>. On peut remarquer que
le champ <code>$.$</code> est une fonction qui retourne elle-même une fonction (prototype
<code>Function: Function</code>).</p>
</div>
<div class="paragraph">
<p>L&#8217;exécution de la dernière ligne retourne l&#8217;erreur suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span>  <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$$</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;\&quot;&quot;</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;__=&quot;</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$$_$</span> <span class="tok-o">+</span> <span class="tok-p">[...]</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;\&quot;&quot;</span><span class="tok-p">)())();</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nx">ReferenceError</span><span class="tok-o">:</span> <span class="tok-nb">document</span> <span class="tok-nx">is</span> <span class="tok-nx">not</span> <span class="tok-nx">defined</span>
    <span class="tok-nx">at</span> <span class="tok-nb">eval</span> <span class="tok-p">(</span><span class="tok-nb">eval</span> <span class="tok-nx">at</span> <span class="tok-o">&lt;</span><span class="tok-nx">anonymous</span><span class="tok-o">&gt;</span> <span class="tok-p">(</span><span class="tok-nx">repl</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">:</span><span class="tok-mi">3</span><span class="tok-p">),</span> <span class="tok-o">&lt;</span><span class="tok-nx">anonymous</span><span class="tok-o">&gt;:</span><span class="tok-mi">2</span><span class="tok-o">:</span><span class="tok-mi">4</span><span class="tok-p">)</span>
    <span class="tok-nx">at</span> <span class="tok-nx">repl</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">:</span><span class="tok-mi">13972</span>
    <span class="tok-nx">at</span> <span class="tok-nx">REPLServer</span><span class="tok-p">.</span><span class="tok-nx">self</span><span class="tok-p">.</span><span class="tok-nb">eval</span> <span class="tok-p">(</span><span class="tok-nx">repl</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">110</span><span class="tok-o">:</span><span class="tok-mi">21</span><span class="tok-p">)</span>
    <span class="tok-nx">at</span> <span class="tok-nx">repl</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">249</span><span class="tok-o">:</span><span class="tok-mi">20</span>
    <span class="tok-nx">at</span> <span class="tok-nx">REPLServer</span><span class="tok-p">.</span><span class="tok-nx">self</span><span class="tok-p">.</span><span class="tok-nb">eval</span> <span class="tok-p">(</span><span class="tok-nx">repl</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">122</span><span class="tok-o">:</span><span class="tok-mi">7</span><span class="tok-p">)</span>
    <span class="tok-nx">at</span> <span class="tok-nx">Interface</span><span class="tok-p">.</span><span class="tok-o">&lt;</span><span class="tok-nx">anonymous</span><span class="tok-o">&gt;</span> <span class="tok-p">(</span><span class="tok-nx">repl</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">239</span><span class="tok-o">:</span><span class="tok-mi">12</span><span class="tok-p">)</span>
    <span class="tok-nx">at</span> <span class="tok-nx">Interface</span><span class="tok-p">.</span><span class="tok-nx">EventEmitter</span><span class="tok-p">.</span><span class="tok-nx">emit</span> <span class="tok-p">(</span><span class="tok-nx">events</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">95</span><span class="tok-o">:</span><span class="tok-mi">17</span><span class="tok-p">)</span>
    <span class="tok-nx">at</span> <span class="tok-nx">Interface</span><span class="tok-p">.</span><span class="tok-nx">_onLine</span> <span class="tok-p">(</span><span class="tok-nx">readline</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">202</span><span class="tok-o">:</span><span class="tok-mi">10</span><span class="tok-p">)</span>
    <span class="tok-nx">at</span> <span class="tok-nx">Interface</span><span class="tok-p">.</span><span class="tok-nx">_line</span> <span class="tok-p">(</span><span class="tok-nx">readline</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">531</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-p">)</span>
    <span class="tok-nx">at</span> <span class="tok-nx">Interface</span><span class="tok-p">.</span><span class="tok-nx">_ttyWrite</span> <span class="tok-p">(</span><span class="tok-nx">readline</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">760</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>double appel de la fonction <code>$.$</code> sur une chaîne de caractères</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le script référence l&#8217;objet <code>document</code>, qui existe dans le contexte d&#8217;un navigateur
mais pas dans celui d&#8217;un interpréteur en console. On constate la présence de la fonction
<code>eval</code> en haut de la pile d&#8217;appels. On soupçonne alors que le code JavaScript final
est construit par concaténation de différentes chaînes de caractères puis exécuté
avec un appel à <code>eval</code> (ou fonction équivalente).</p>
</div>
<div class="paragraph">
<p>Comme évoqué précédemment, la fonction <code>$.$</code> retourne une fonction. En lui passant
des arguments de différente nature, on peut essayer de deviner son comportement :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">f</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;coucou&#39;</span><span class="tok-p">);</span>
<span class="tok-p">[</span><span class="tok-nb">Function</span><span class="tok-p">]</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">f</span><span class="tok-p">();</span>
<span class="tok-nx">ReferenceError</span><span class="tok-o">:</span> <span class="tok-nx">coucou</span> <span class="tok-nx">is</span> <span class="tok-nx">not</span> <span class="tok-nx">defined</span>
    <span class="tok-nx">at</span> <span class="tok-nb">eval</span> <span class="tok-p">(</span><span class="tok-nb">eval</span> <span class="tok-nx">at</span> <span class="tok-o">&lt;</span><span class="tok-nx">anonymous</span><span class="tok-o">&gt;</span> <span class="tok-p">(</span><span class="tok-nx">repl</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">:</span><span class="tok-mi">7</span><span class="tok-p">),</span> <span class="tok-o">&lt;</span><span class="tok-nx">anonymous</span><span class="tok-o">&gt;:</span><span class="tok-mi">2</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-p">)</span>
    <span class="tok-nx">at</span> <span class="tok-nx">repl</span><span class="tok-o">:</span><span class="tok-mi">1</span><span class="tok-o">:</span><span class="tok-mi">1</span>
    <span class="tok-nx">at</span> <span class="tok-nx">REPLServer</span><span class="tok-p">.</span><span class="tok-nx">self</span><span class="tok-p">.</span><span class="tok-nb">eval</span> <span class="tok-p">(</span><span class="tok-nx">repl</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">110</span><span class="tok-o">:</span><span class="tok-mi">21</span><span class="tok-p">)</span>
    <span class="tok-nx">at</span> <span class="tok-nx">repl</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">249</span><span class="tok-o">:</span><span class="tok-mi">20</span>
    <span class="tok-nx">at</span> <span class="tok-nx">REPLServer</span><span class="tok-p">.</span><span class="tok-nx">self</span><span class="tok-p">.</span><span class="tok-nb">eval</span> <span class="tok-p">(</span><span class="tok-nx">repl</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">122</span><span class="tok-o">:</span><span class="tok-mi">7</span><span class="tok-p">)</span>
    <span class="tok-nx">at</span> <span class="tok-nx">Interface</span><span class="tok-p">.</span><span class="tok-o">&lt;</span><span class="tok-nx">anonymous</span><span class="tok-o">&gt;</span> <span class="tok-p">(</span><span class="tok-nx">repl</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">239</span><span class="tok-o">:</span><span class="tok-mi">12</span><span class="tok-p">)</span>
    <span class="tok-nx">at</span> <span class="tok-nx">Interface</span><span class="tok-p">.</span><span class="tok-nx">EventEmitter</span><span class="tok-p">.</span><span class="tok-nx">emit</span> <span class="tok-p">(</span><span class="tok-nx">events</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">95</span><span class="tok-o">:</span><span class="tok-mi">17</span><span class="tok-p">)</span>
    <span class="tok-nx">at</span> <span class="tok-nx">Interface</span><span class="tok-p">.</span><span class="tok-nx">_onLine</span> <span class="tok-p">(</span><span class="tok-nx">readline</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">202</span><span class="tok-o">:</span><span class="tok-mi">10</span><span class="tok-p">)</span>
    <span class="tok-nx">at</span> <span class="tok-nx">Interface</span><span class="tok-p">.</span><span class="tok-nx">_line</span> <span class="tok-p">(</span><span class="tok-nx">readline</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">531</span><span class="tok-o">:</span><span class="tok-mi">8</span><span class="tok-p">)</span>
    <span class="tok-nx">at</span> <span class="tok-nx">Interface</span><span class="tok-p">.</span><span class="tok-nx">_ttyWrite</span> <span class="tok-p">(</span><span class="tok-nx">readline</span><span class="tok-p">.</span><span class="tok-nx">js</span><span class="tok-o">:</span><span class="tok-mi">760</span><span class="tok-o">:</span><span class="tok-mi">14</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La fonction <code>$.$</code> semble définir une nouvelle fonction qui exécute
la chaîne de caractères passée en argument. Ce comportement est confirmé par le
test ci-dessous :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">f</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-s1">&#39;console.log(2+3)&#39;</span><span class="tok-p">);</span>
<span class="tok-p">[</span><span class="tok-nb">Function</span><span class="tok-p">]</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">f</span><span class="tok-p">();</span>
<span class="tok-mi">5</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A ce stade, on cherche à récupérer la chaîne de caractères avant les deux
appels successifs à la fonction <code>$.$</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">s</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$$</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;\&quot;&quot;</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;__=&quot;</span> <span class="tok-o">+</span> <span class="tok-p">[...]</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;\\&quot;</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">__$</span> <span class="tok-o">+</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">__$</span> <span class="tok-o">+</span> <span class="tok-s2">&quot;\&quot;&quot;</span><span class="tok-p">;</span>
<span class="tok-s1">&#39;return&quot;__=docu\\155e\\156t;$$$=[...]_,$_$);\\12\\11\\11&quot;&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le résultat correspond bien à du code JavaScript qui semble se contenter de
retourner une seconde chaîne de caractères. Un appel à la fonction <code>$.$</code> permet
d&#8217;obtenir le code JavaScript qui référence bien l&#8217;objet <code>document</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-o">&gt;</span> <span class="tok-nx">s1</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">.</span><span class="tok-nx">$</span><span class="tok-p">(</span><span class="tok-nx">s</span><span class="tok-p">)();</span>
<span class="tok-s1">&#39;__=document;$$$=\&#39;stage5\&#39;;$$_$=\&#39;load\&#39;;[...];$_$);\n\t\t&#39;</span>
<span class="tok-o">&gt;</span> <span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">s1</span><span class="tok-p">);</span>
<span class="tok-nx">__</span><span class="tok-o">=</span><span class="tok-nb">document</span><span class="tok-p">;</span><span class="tok-nx">$$$</span><span class="tok-o">=</span><span class="tok-s1">&#39;stage5&#39;</span><span class="tok-p">;</span><span class="tok-nx">$$_$</span><span class="tok-o">=</span><span class="tok-s1">&#39;load&#39;</span><span class="tok-p">;[...],</span><span class="tok-nx">$_$</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le contenu de la variable <code>s1</code> est sauvegardé dans un fichier puis le code
est réindenté avec <code>js-beautify</code> pour obtenir le résultat ci-dessous :</p>
</div>
<div class="listingblock">
<div class="title">Fichier <code>obfu.js</code></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-nx">__</span> <span class="tok-o">=</span> <span class="tok-nb">document</span><span class="tok-p">;</span>
<span class="tok-nx">$$$</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;stage5&#39;</span><span class="tok-p">;</span>
<span class="tok-nx">$$_$</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;load&#39;</span><span class="tok-p">;</span>
<span class="tok-nx">$_$$</span> <span class="tok-o">=</span> <span class="tok-s1">&#39; &#39;</span><span class="tok-p">;</span>
<span class="tok-nx">_$$$$$</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;user&#39;</span><span class="tok-p">;</span>
<span class="tok-nx">_$$$</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;div&#39;</span><span class="tok-p">;</span>
<span class="tok-nx">$$_$$$</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;navigator&#39;</span><span class="tok-p">;</span>
<span class="tok-nx">$$_$$</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;preferences&#39;</span><span class="tok-p">;</span>
<span class="tok-p">[...]</span>
<span class="tok-nx">________________________</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">;</span>
<span class="tok-nx">_________________________</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;byteLength&#39;</span><span class="tok-p">;</span>
<span class="tok-nx">__________________________</span> <span class="tok-o">=</span> <span class="tok-nx">$_$$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;String&#39;</span><span class="tok-p">;</span>
<span class="tok-nx">__</span><span class="tok-p">[</span><span class="tok-nx">___</span><span class="tok-p">](</span><span class="tok-s1">&#39;&lt;h&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">______________</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;&gt;Down&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">$$_$</span> <span class="tok-o">+</span> <span class="tok-nx">$_$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;manager&lt;/h&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">______________</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;&gt;&#39;</span><span class="tok-p">);</span>
<span class="tok-nx">__</span><span class="tok-p">[</span><span class="tok-nx">___</span><span class="tok-p">](</span><span class="tok-s1">&#39;&lt;&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">_$$$</span> <span class="tok-o">+</span> <span class="tok-nx">$_$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;id&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">$$$$_</span> <span class="tok-o">+</span> <span class="tok-nx">_$$$$</span> <span class="tok-o">+</span> <span class="tok-nx">___$</span> <span class="tok-o">+</span> <span class="tok-nx">_$$$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;&gt;&lt;i&gt;&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">$$_$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;ing...&lt;/i&gt;&lt;/&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">_$$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;&gt;&#39;</span><span class="tok-p">);</span>
<span class="tok-nx">__</span><span class="tok-p">[</span><span class="tok-nx">___</span><span class="tok-p">](</span><span class="tok-s1">&#39;&lt;&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">_$$$</span> <span class="tok-o">+</span> <span class="tok-nx">$_$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;style&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">$$$$_</span> <span class="tok-o">+</span> <span class="tok-nx">_$$$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;display:none&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">_$$$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;&gt;&lt;a&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">$_$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;target&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">$$$$_</span> <span class="tok-o">+</span> <span class="tok-nx">_$$$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;blank&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">_$$$$</span> <span class="tok-o">+</span> <span class="tok-nx">$_$$</span> <span class="tok-o">+</span> <span class="tok-nx">$$$_$</span> <span class="tok-o">+</span> <span class="tok-nx">$$$$_</span> <span class="tok-o">+</span> <span class="tok-nx">_$$$$</span> <span class="tok-o">+</span> <span class="tok-nx">$$$$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;://browser/content/&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">$$_$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;/&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">$$_$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;.xul&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">_$$$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;&gt;Back&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">$_$$</span> <span class="tok-o">+</span> <span class="tok-nx">$_$$$</span> <span class="tok-o">+</span> <span class="tok-nx">$_$$</span> <span class="tok-o">+</span> <span class="tok-nx">$$_$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;&lt;/a&gt;&lt;/&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">_$$$</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;&gt;&#39;</span><span class="tok-p">);</span>

<span class="tok-p">[...]</span>

<span class="tok-kd">function</span> <span class="tok-nx">___________________________</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-nx">$_</span> <span class="tok-o">=</span> <span class="tok-nx">_____</span><span class="tok-p">(</span><span class="tok-nx">__________</span><span class="tok-p">[</span><span class="tok-nx">_____________</span><span class="tok-p">](</span><span class="tok-nx">__________</span><span class="tok-p">[</span><span class="tok-nx">__________________</span><span class="tok-p">](</span><span class="tok-nx">______$_</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-nx">______________</span><span class="tok-p">,</span> <span class="tok-nx">_________________</span><span class="tok-p">));</span>
    <span class="tok-nx">_$__</span> <span class="tok-o">=</span> <span class="tok-nx">_____</span><span class="tok-p">(</span><span class="tok-nx">__________</span><span class="tok-p">[</span><span class="tok-nx">_____________</span><span class="tok-p">](</span><span class="tok-nx">__________</span><span class="tok-p">[</span><span class="tok-nx">__________________</span><span class="tok-p">](</span><span class="tok-nx">_______$</span><span class="tok-p">)</span> <span class="tok-o">-</span> <span class="tok-nx">_________________</span><span class="tok-p">,</span> <span class="tok-nx">_________________</span><span class="tok-p">));</span>
    <span class="tok-nx">_$</span> <span class="tok-o">=</span> <span class="tok-p">{};</span>
    <span class="tok-nx">_$</span><span class="tok-p">[</span><span class="tok-nx">_$______</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nx">__$_____</span><span class="tok-p">;</span>
    <span class="tok-nx">_$</span><span class="tok-p">[</span><span class="tok-nx">___$____</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nx">$_</span><span class="tok-p">;</span>
    <span class="tok-nx">_$</span><span class="tok-p">[</span><span class="tok-nx">____________</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nx">_$__</span><span class="tok-p">[</span><span class="tok-nx">____________</span><span class="tok-p">]</span> <span class="tok-o">*</span> <span class="tok-nx">________________</span><span class="tok-p">;</span>
    <span class="tok-nx">__$</span><span class="tok-p">[</span><span class="tok-nx">$____</span><span class="tok-p">](</span><span class="tok-nx">_$_</span><span class="tok-p">,</span> <span class="tok-nx">_$__</span><span class="tok-p">,</span> <span class="tok-nx">_$</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-nx">__$_</span><span class="tok-p">])[</span><span class="tok-nx">__$__</span><span class="tok-p">](</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">_$___</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-nx">__$</span><span class="tok-p">[</span><span class="tok-nx">__$_</span><span class="tok-p">](</span><span class="tok-nx">_$</span><span class="tok-p">,</span> <span class="tok-nx">_$___</span><span class="tok-p">,</span> <span class="tok-nx">_____________________</span><span class="tok-p">(</span><span class="tok-nx">____$_</span><span class="tok-p">))[</span><span class="tok-nx">__$__</span><span class="tok-p">](</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">___$_</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-nx">____$</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">______________________</span><span class="tok-p">(</span><span class="tok-nx">___$_</span><span class="tok-p">);</span>
            <span class="tok-nx">__$</span><span class="tok-p">[</span><span class="tok-nx">_$____</span><span class="tok-p">](</span><span class="tok-nx">___$__</span><span class="tok-p">,</span> <span class="tok-nx">____$</span><span class="tok-p">)[</span><span class="tok-nx">__$__</span><span class="tok-p">](</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">____$$</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">_____$</span> <span class="tok-o">==</span> <span class="tok-nx">_______________________</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">______________________</span><span class="tok-p">(</span><span class="tok-nx">____$$</span><span class="tok-p">)))</span> <span class="tok-p">{</span>
                    <span class="tok-nx">_____$_</span> <span class="tok-o">=</span> <span class="tok-p">{};</span>
                    <span class="tok-nx">_____$_</span><span class="tok-p">[</span><span class="tok-nx">______$</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nx">$_______</span><span class="tok-p">;</span>
                    <span class="tok-nx">_____$</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">_$_____</span><span class="tok-p">([</span><span class="tok-nx">____$</span><span class="tok-p">],</span> <span class="tok-nx">_____$_</span><span class="tok-p">);</span>
                    <span class="tok-nx">__$____</span> <span class="tok-o">=</span> <span class="tok-nx">___$___</span><span class="tok-p">[</span><span class="tok-nx">____$__</span><span class="tok-p">](</span><span class="tok-nx">_____$</span><span class="tok-p">);</span>
                    <span class="tok-nx">__</span><span class="tok-p">[</span><span class="tok-nx">____</span><span class="tok-p">](</span><span class="tok-nx">___$</span><span class="tok-p">)[</span><span class="tok-nx">__$___</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nx">____$___</span> <span class="tok-o">+</span> <span class="tok-nx">__$____</span> <span class="tok-o">+</span> <span class="tok-nx">_____$__</span><span class="tok-p">;</span>
                <span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-p">{</span>
                    <span class="tok-nx">__</span><span class="tok-p">[</span><span class="tok-nx">____</span><span class="tok-p">](</span><span class="tok-nx">___$</span><span class="tok-p">)[</span><span class="tok-nx">__$___</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">;</span>
                <span class="tok-p">}</span>
            <span class="tok-p">});</span>
        <span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
            <span class="tok-nx">__</span><span class="tok-p">[</span><span class="tok-nx">____</span><span class="tok-p">](</span><span class="tok-nx">___$</span><span class="tok-p">)[</span><span class="tok-nx">__$___</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">;</span>
        <span class="tok-p">});</span>
    <span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
        <span class="tok-nx">__</span><span class="tok-p">[</span><span class="tok-nx">____</span><span class="tok-p">](</span><span class="tok-nx">___$</span><span class="tok-p">)[</span><span class="tok-nx">__$___</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nx">$</span><span class="tok-p">;</span>
    <span class="tok-p">});</span>
<span class="tok-p">}</span>
<span class="tok-nx">$$</span><span class="tok-p">[</span><span class="tok-nx">$________</span><span class="tok-p">](</span><span class="tok-nx">___________________________</span><span class="tok-p">,</span> <span class="tok-nx">$_$</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La structure du code commence à apparaître mais sa compréhension est rendue
difficile par l&#8217;utilisation de nombreuses variables nommées de façon similaire.</p>
</div>
<div class="paragraph">
<p>L&#8217;outil <a href="#_clean_js">clean.js</a> basé sur <a href="http://esprima.org">esprima</a> a été développé pour simplifier le code
obtenu. Cet outil travaille sur l&#8217;arbre syntaxique abstrait du code JavaScript pour remplacer
les références aux constantes globales par les valeurs associées et simplifier certaines expressions
binaires (concaténation de chaînes de caractères et opérations arithmétiques sur des entiers).</p>
</div>
<div class="paragraph">
<p>L&#8217;exécution de cet outil, ainsi qu&#8217;un retraitement manuel (renommage des fonctions
et des variables locales), aboutit au code nettoyé suivant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><span class="tok-kd">var</span> <span class="tok-nx">data</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;2b1f25c[...]1646ffe2&quot;</span><span class="tok-p">;</span>
<span class="tok-kd">var</span> <span class="tok-nx">hash</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;08c3be636f7dffd91971f65be4cec3c6d162cb1c&quot;</span><span class="tok-p">;</span>

<span class="tok-nx">ua</span> <span class="tok-o">=</span> <span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">navigator</span><span class="tok-p">.</span><span class="tok-nx">userAgent</span><span class="tok-p">;</span>
<span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">write</span><span class="tok-p">(</span><span class="tok-s1">&#39;&lt;h1&gt;Download manager&lt;/h1&gt;&#39;</span><span class="tok-p">);</span>
<span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">write</span><span class="tok-p">(</span><span class="tok-s1">&#39;&lt;div id=&quot;status&quot;&gt;&lt;i&gt;loading...&lt;/i&gt;&lt;/div&gt;&#39;</span><span class="tok-p">);</span>
<span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">write</span><span class="tok-p">(</span><span class="tok-s1">&#39;&lt;div style=&quot;display:none&quot;&gt;&lt;a target=&quot;blank&quot; href=&quot;chrome://browser/content/preferences/preferences.xul&quot;&gt;Back to preferences&lt;/a&gt;&lt;/div&gt;&#39;</span><span class="tok-p">);</span>

<span class="tok-kd">function</span> <span class="tok-nx">stringToBytes</span><span class="tok-p">(</span><span class="tok-nx">arg</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">res</span> <span class="tok-o">=</span> <span class="tok-p">[];</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-nx">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-nx">i</span> <span class="tok-o">&lt;</span> <span class="tok-nx">arg</span><span class="tok-p">.</span><span class="tok-nx">length</span><span class="tok-p">;</span> <span class="tok-o">++</span><span class="tok-nx">i</span><span class="tok-p">)</span>
        <span class="tok-nx">res</span><span class="tok-p">.</span><span class="tok-nx">push</span><span class="tok-p">(</span><span class="tok-nx">arg</span><span class="tok-p">.</span><span class="tok-nx">charCodeAt</span><span class="tok-p">(</span><span class="tok-nx">i</span><span class="tok-p">));</span>
    <span class="tok-k">return</span> <span class="tok-k">new</span> <span class="tok-nx">Uint8Array</span><span class="tok-p">(</span><span class="tok-nx">res</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-kd">function</span> <span class="tok-nx">hexToBytes</span><span class="tok-p">(</span><span class="tok-nx">arg</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">res</span> <span class="tok-o">=</span> <span class="tok-p">[];</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-nx">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-nx">i</span> <span class="tok-o">&lt;</span> <span class="tok-nx">arg</span><span class="tok-p">.</span><span class="tok-nx">length</span> <span class="tok-o">/</span> <span class="tok-mi">2</span><span class="tok-p">;</span> <span class="tok-o">++</span><span class="tok-nx">i</span><span class="tok-p">)</span>
        <span class="tok-nx">res</span><span class="tok-p">.</span><span class="tok-nx">push</span><span class="tok-p">(</span><span class="tok-nb">parseInt</span><span class="tok-p">(</span><span class="tok-nx">arg</span><span class="tok-p">.</span><span class="tok-nx">substr</span><span class="tok-p">(</span><span class="tok-nx">i</span> <span class="tok-o">*</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">),</span> <span class="tok-mi">16</span><span class="tok-p">));</span>
    <span class="tok-k">return</span> <span class="tok-k">new</span> <span class="tok-nx">Uint8Array</span><span class="tok-p">(</span><span class="tok-nx">res</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-kd">function</span> <span class="tok-nx">bytesToHex</span><span class="tok-p">(</span><span class="tok-nx">arg</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-nx">res</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">;</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-nx">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-nx">i</span> <span class="tok-o">&lt;</span> <span class="tok-nx">arg</span><span class="tok-p">.</span><span class="tok-nx">byteLength</span><span class="tok-p">;</span> <span class="tok-o">++</span><span class="tok-nx">i</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-nx">s</span> <span class="tok-o">=</span> <span class="tok-nx">arg</span><span class="tok-p">[</span><span class="tok-nx">i</span><span class="tok-p">].</span><span class="tok-nx">toString</span><span class="tok-p">(</span><span class="tok-mi">16</span><span class="tok-p">);</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">s</span><span class="tok-p">.</span><span class="tok-nx">length</span> <span class="tok-o">&lt;</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
            <span class="tok-nx">res</span> <span class="tok-o">+=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
        <span class="tok-nx">res</span> <span class="tok-o">+=</span> <span class="tok-nx">s</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-k">return</span> <span class="tok-nx">res</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kd">function</span> <span class="tok-nx">f3</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-nx">iv</span> <span class="tok-o">=</span> <span class="tok-nx">stringToBytes</span><span class="tok-p">(</span><span class="tok-nx">ua</span><span class="tok-p">.</span><span class="tok-nx">substr</span><span class="tok-p">(</span><span class="tok-nx">ua</span><span class="tok-p">.</span><span class="tok-nx">indexOf</span><span class="tok-p">(</span><span class="tok-s1">&#39;(&#39;</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">16</span><span class="tok-p">));</span>
    <span class="tok-nx">key</span> <span class="tok-o">=</span> <span class="tok-nx">stringToBytes</span><span class="tok-p">(</span><span class="tok-nx">ua</span><span class="tok-p">.</span><span class="tok-nx">substr</span><span class="tok-p">(</span><span class="tok-nx">ua</span><span class="tok-p">.</span><span class="tok-nx">indexOf</span><span class="tok-p">(</span><span class="tok-s1">&#39;)&#39;</span><span class="tok-p">)</span> <span class="tok-o">-</span> <span class="tok-mi">16</span><span class="tok-p">,</span> <span class="tok-mi">16</span><span class="tok-p">));</span>
    <span class="tok-nx">ctx</span> <span class="tok-o">=</span> <span class="tok-p">{};</span>
    <span class="tok-nx">ctx</span><span class="tok-p">[</span><span class="tok-s1">&#39;name&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;AES-CBC&#39;</span><span class="tok-p">;</span>
    <span class="tok-nx">ctx</span><span class="tok-p">[</span><span class="tok-s1">&#39;iv&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nx">iv</span><span class="tok-p">;</span>
    <span class="tok-nx">ctx</span><span class="tok-p">[</span><span class="tok-s1">&#39;length&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-nx">key</span><span class="tok-p">[</span><span class="tok-s1">&#39;length&#39;</span><span class="tok-p">]</span> <span class="tok-o">*</span> <span class="tok-mi">8</span><span class="tok-p">;</span>
    <span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">crypto</span><span class="tok-p">.</span><span class="tok-nx">subtle</span><span class="tok-p">.</span><span class="tok-nx">importKey</span><span class="tok-p">(</span><span class="tok-s1">&#39;raw&#39;</span><span class="tok-p">,</span> <span class="tok-nx">key</span><span class="tok-p">,</span> <span class="tok-nx">ctx</span><span class="tok-p">,</span> <span class="tok-kc">false</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s1">&#39;decrypt&#39;</span><span class="tok-p">]).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">arg0</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">crypto</span><span class="tok-p">.</span><span class="tok-nx">subtle</span><span class="tok-p">.</span><span class="tok-nx">decrypt</span><span class="tok-p">(</span><span class="tok-nx">ctx</span><span class="tok-p">,</span> <span class="tok-nx">arg0</span><span class="tok-p">,</span> <span class="tok-nx">hexToBytes</span><span class="tok-p">(</span><span class="tok-nx">data</span><span class="tok-p">)).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">arg1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-nx">plainText</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Uint8Array</span><span class="tok-p">(</span><span class="tok-nx">arg1</span><span class="tok-p">);</span>
            <span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">crypto</span><span class="tok-p">.</span><span class="tok-nx">subtle</span><span class="tok-p">.</span><span class="tok-nx">digest</span><span class="tok-p">({</span>
                <span class="tok-nx">name</span><span class="tok-o">:</span> <span class="tok-s1">&#39;SHA-1&#39;</span>
            <span class="tok-p">},</span> <span class="tok-nx">plainText</span><span class="tok-p">).</span><span class="tok-nx">then</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">arg2</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">hash</span> <span class="tok-o">==</span> <span class="tok-nx">bytesToHex</span><span class="tok-p">(</span><span class="tok-k">new</span> <span class="tok-nx">Uint8Array</span><span class="tok-p">(</span><span class="tok-nx">arg2</span><span class="tok-p">)))</span> <span class="tok-p">{</span>
                    <span class="tok-nx">props</span> <span class="tok-o">=</span> <span class="tok-p">{};</span>
                    <span class="tok-nx">props</span><span class="tok-p">[</span><span class="tok-s1">&#39;type&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;application/octet-stream&#39;</span><span class="tok-p">;</span>
                    <span class="tok-nx">blob</span> <span class="tok-o">=</span> <span class="tok-k">new</span> <span class="tok-nx">Blob</span><span class="tok-p">([</span><span class="tok-nx">plainText</span><span class="tok-p">],</span> <span class="tok-nx">props</span><span class="tok-p">);</span>
                    <span class="tok-nx">url</span> <span class="tok-o">=</span> <span class="tok-nx">URL</span><span class="tok-p">.</span><span class="tok-nx">createObjectURL</span><span class="tok-p">(</span><span class="tok-nx">blob</span><span class="tok-p">);</span>
                    <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;status&#39;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&lt;a href=&quot;&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">url</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;&quot; download=&quot;stage5.zip&quot;&gt;download stage5&lt;/a&gt;&#39;</span><span class="tok-p">;</span>
                <span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-p">{</span>
                    <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;status&#39;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&lt;b&gt;Failed to load stage5&lt;/b&gt;&#39;</span><span class="tok-p">;</span>
                <span class="tok-p">}</span>
            <span class="tok-p">});</span>
        <span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
            <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;status&#39;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&lt;b&gt;Failed to load stage5&lt;/b&gt;&#39;</span><span class="tok-p">;</span>
        <span class="tok-p">});</span>
    <span class="tok-p">}).</span><span class="tok-k">catch</span><span class="tok-p">(</span><span class="tok-kd">function</span><span class="tok-p">()</span> <span class="tok-p">{</span>
        <span class="tok-nb">document</span><span class="tok-p">.</span><span class="tok-nx">getElementById</span><span class="tok-p">(</span><span class="tok-s1">&#39;status&#39;</span><span class="tok-p">).</span><span class="tok-nx">innerHTML</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&lt;b&gt;Failed to load stage5&lt;/b&gt;&#39;</span><span class="tok-p">;</span>
    <span class="tok-p">});</span>
<span class="tok-p">}</span>
<span class="tok-nb">window</span><span class="tok-p">.</span><span class="tok-nx">setTimeout</span><span class="tok-p">(</span><span class="tok-nx">f3</span><span class="tok-p">,</span> <span class="tok-mi">1000</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce code extrait un vecteur d&#8217;initialisation et une clé de déchiffrement
depuis l&#8217;agent utilisateur (&#8220;User-Agent&#8221;) du navigateur. Le déchiffrement
est ensuite effectué en AES-CBC puis une empreinte SHA-1 est calculée sur
les données obtenues. Si cette empreinte correspond à la valeur de la variable
<code>hash</code>, alors un lien vers les données déchiffrées est ajouté à la page. Sinon,
le message <code>&lt;b&gt;Failed to load stage5&lt;/b&gt;</code> est affiché.</p>
</div>
<div class="paragraph">
<p>Pour arriver à déchiffrer correctement, il faut donc déterminer l&#8217;agent utilisateur
qui permet de retrouver le bon SHA-1. Trois indices dans le fichier HTML permettent
d&#8217;en savoir plus sur cet agent utilisateur :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la page contient un lien vers <code>chrome://browser/content/preferences/preferences.xul</code>
qui n&#8217;est valable que sous Firefox ;</p>
</li>
<li>
<p>le code JavaScript fait appel à la bibliothèque <code>crypto.subtle</code> qui n&#8217;est compatible
qu&#8217;avec les versions de Firefox ultérieures à 34 (d&#8217;après la page
<a href="https://developer.mozilla.org/fr/docs/Web/API/SubtleCrypto#Browser_compatibility">SubleCrypto#Browser_compatibility</a>) ;</p>
</li>
<li>
<p>enfin, le fichier HTML utilise la série de polices <code>Lucida Grande, Lucida Sans Unicode, Lucida Sans, Geneva, Verdana, sans-serif</code> :
une recherche sur Internet retourne la page Wikipedia <a href="http://en.wikipedia.org/wiki/Lucida_Grande">Lucida_Grande</a> qui précise
que cette police est utilisée sous MAC OS X.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sur la base de ces informations, il ne reste plus qu&#8217;à générer tous les agent utilisateurs
possibles, en respectant la convention décrite sur la page <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Gecko_user_agent_string_reference">Gecko_user_agent_string_reference</a>,
tenter un déchiffrement après avoir extrait le vecteur d&#8217;initialisation et la clé puis
vérifier l&#8217;empreinte SHA-1 des données déchiffrées jusqu&#8217;à obtenir celle attendue.</p>
</div>
<div class="paragraph">
<p>Le script Ruby suivant implémente cette méthode pour retrouver l&#8217;agent utilisateur recherché :</p>
</div>
<div class="listingblock">
<div class="title">bf.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-nb">require</span> <span class="tok-s1">&#39;openssl&#39;</span>
<span class="tok-nb">require</span> <span class="tok-s1">&#39;digest&#39;</span>

<span class="tok-n">bindata</span> <span class="tok-o">=</span> <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;data.bin&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;rb&quot;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">read</span>
<span class="tok-n">expected_sha1</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;08c3be636f7dffd91971f65be4cec3c6d162cb1c&quot;</span>

<span class="tok-k">def</span> <span class="tok-nf">extract_key_iv_from_ua</span><span class="tok-p">(</span><span class="tok-n">ua</span><span class="tok-p">)</span>
  <span class="tok-n">iv</span> <span class="tok-o">=</span> <span class="tok-n">ua</span><span class="tok-o">[</span><span class="tok-n">ua</span><span class="tok-o">.</span><span class="tok-n">index</span><span class="tok-p">(</span><span class="tok-s1">&#39;(&#39;</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">16</span><span class="tok-o">]</span>
  <span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-n">ua</span><span class="tok-o">[</span><span class="tok-n">ua</span><span class="tok-o">.</span><span class="tok-n">index</span><span class="tok-p">(</span><span class="tok-s1">&#39;)&#39;</span><span class="tok-p">)</span> <span class="tok-o">-</span> <span class="tok-mi">16</span><span class="tok-p">,</span> <span class="tok-mi">16</span><span class="tok-o">]</span>
  <span class="tok-k">return</span> <span class="tok-o">[</span><span class="tok-n">iv</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-o">]</span>
<span class="tok-k">end</span>

<span class="tok-k">def</span> <span class="tok-nf">generate_ua_list</span>
  <span class="tok-n">res</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
  <span class="tok-n">s</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;Mozilla/5.0&quot;</span>
  <span class="tok-n">platforms</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>

  <span class="tok-n">osx_versions</span> <span class="tok-o">=</span> <span class="tok-o">[</span> <span class="tok-s2">&quot;10.0&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;10.1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;10.2&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;10.3&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;10.4&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;10.5&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;10.6&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;10.7&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;10.8&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;10.9&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;10.10&quot;</span> <span class="tok-o">]</span>
  <span class="tok-n">osx_versions</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">ver</span><span class="tok-o">|</span>
    <span class="tok-n">platforms</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;Macintosh; Intel Mac OS X </span><span class="tok-si">#{</span><span class="tok-n">ver</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span>
    <span class="tok-n">platforms</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;Macintosh; PPC Mac OS X </span><span class="tok-si">#{</span><span class="tok-n">ver</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span>
  <span class="tok-k">end</span>

  <span class="tok-n">gecko_versions</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
  <span class="tok-p">(</span><span class="tok-mi">34</span><span class="tok-o">.</span><span class="tok-n">.</span><span class="tok-mi">38</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-p">{</span> <span class="tok-o">|</span><span class="tok-n">i</span><span class="tok-o">|</span> <span class="tok-n">gecko_versions</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;</span><span class="tok-si">#{</span><span class="tok-n">i</span><span class="tok-si">}</span><span class="tok-s2">.0&quot;</span> <span class="tok-p">}</span>

  <span class="tok-n">platforms</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">platform</span><span class="tok-o">|</span>
    <span class="tok-n">gecko_versions</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-p">{</span> <span class="tok-o">|</span><span class="tok-n">version</span><span class="tok-o">|</span> <span class="tok-n">res</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;</span><span class="tok-si">#{</span><span class="tok-n">s</span><span class="tok-si">}</span><span class="tok-s2"> (</span><span class="tok-si">#{</span><span class="tok-n">platform</span><span class="tok-si">}</span><span class="tok-s2">; rv:</span><span class="tok-si">#{</span><span class="tok-n">version</span><span class="tok-si">}</span><span class="tok-s2">) Gecko&quot;</span> <span class="tok-p">}</span>
  <span class="tok-k">end</span>

  <span class="tok-k">return</span> <span class="tok-n">res</span>
<span class="tok-k">end</span>

<span class="tok-n">generate_ua_list</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">ua</span><span class="tok-o">|</span>
  <span class="tok-n">iv</span><span class="tok-p">,</span> <span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-n">extract_key_iv_from_ua</span><span class="tok-p">(</span><span class="tok-n">ua</span><span class="tok-p">)</span>

  <span class="tok-n">cipher</span> <span class="tok-o">=</span> <span class="tok-no">OpenSSL</span><span class="tok-o">::</span><span class="tok-no">Cipher</span><span class="tok-o">::</span><span class="tok-no">AES</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-s1">&#39;128-CBC&#39;</span><span class="tok-p">)</span>
  <span class="tok-n">cipher</span><span class="tok-o">.</span><span class="tok-n">decrypt</span>
  <span class="tok-n">cipher</span><span class="tok-o">.</span><span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-n">key</span>
  <span class="tok-n">cipher</span><span class="tok-o">.</span><span class="tok-n">iv</span> <span class="tok-o">=</span> <span class="tok-n">iv</span>

  <span class="tok-k">begin</span>
    <span class="tok-n">plain</span> <span class="tok-o">=</span> <span class="tok-n">cipher</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span><span class="tok-n">bindata</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-n">cipher</span><span class="tok-o">.</span><span class="tok-n">final</span>
    <span class="tok-n">sha1</span> <span class="tok-o">=</span> <span class="tok-no">Digest</span><span class="tok-o">::</span><span class="tok-no">SHA1</span><span class="tok-o">.</span><span class="tok-n">hexdigest</span><span class="tok-p">(</span><span class="tok-n">plain</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-n">sha1</span> <span class="tok-o">==</span> <span class="tok-n">expected_sha1</span> <span class="tok-k">then</span>
      <span class="tok-nb">puts</span> <span class="tok-s2">&quot;[*] Found, ua = </span><span class="tok-si">#{</span><span class="tok-n">ua</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span>
      <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;stage5.zip&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;wb&quot;</span><span class="tok-p">)</span> <span class="tok-p">{</span> <span class="tok-o">|</span><span class="tok-n">f</span><span class="tok-o">|</span> <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">write</span> <span class="tok-n">plain</span> <span class="tok-p">}</span>
      <span class="tok-nb">exit</span>
    <span class="tok-k">end</span>
  <span class="tok-k">rescue</span> <span class="tok-no">OpenSSL</span><span class="tok-o">::</span><span class="tok-no">Cipher</span><span class="tok-o">::</span><span class="tok-no">CipherError</span> <span class="tok-o">=&gt;</span> <span class="tok-n">e</span>
    <span class="tok-nb">puts</span> <span class="tok-n">e</span>
  <span class="tok-k">end</span>

<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Son exécution sur le fichier <code>data.bin</code> contenant les données de la variable <code>data</code>
retourne le résultat suivant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ./bf.rb
<span class="tok-go">bad decrypt</span>
<span class="tok-go">bad decrypt</span>
<span class="tok-go">[...]</span>
<span class="tok-go">bad decrypt</span>
<span class="tok-go">bad decrypt</span>
<span class="tok-go">[*] Found, ua = Mozilla/5.0 (Macintosh; Intel Mac OS X 10.6; rv:35.0) Gecko</span>
<span class="tok-gp">$</span> file stage5.zip
<span class="tok-go">stage5.zip: Zip archive data, at least v2.0 to extract</span>
<span class="tok-gp">$</span> unzip -t stage5.zip
<span class="tok-go">Archive:  stage5.zip</span>
<span class="tok-go">    testing: input.bin                OK</span>
<span class="tok-go">    testing: schematic.pdf            OK</span>
<span class="tok-go">No errors detected in compressed data of stage5.zip.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le contenu de l&#8217;archive obtenue sera étudié dans la suite de ce document.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stage_5_st20">Stage 5 : ST20</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_découverte">Découverte</h3>
<div class="paragraph">
<p>L&#8217;archive obtenue suite à la résolution de l&#8217;étape précédente contient deux fichiers, <code>input.bin</code> et
<code>schematic.pdf</code>.</p>
</div>
<div class="paragraph">
<p>D&#8217;après le résultat de la commande <code>file</code>, le fichier <code>input.bin</code> ne correspond
pas à un format connu. Cependant, il contient quelques chaînes de caractères
intéressantes, comme présenté ci-dessous :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>$ file input.bin
input.bin: data
$ strings input.bin
$ P#
$z$y
Boot ok
Code Ok
Decrypt
$ P#
[...]
a       qC$
 e         |
KEY:
congratulations.tar.bz2
[...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le fichier <code>schematic.pdf</code> correspond à l&#8217;image ci-dessous :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_schematic.svg" alt="rk schematic">
</div>
<div class="title">Figure 2. schematic.pdf</div>
</div>
<div class="paragraph">
<p>Plusieurs informations intéressantes sont sur ce schéma :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>on y découvre la notion de <a href="http://en.wikipedia.org/wiki/Transputer">&#8220;transputer&#8221;</a>
qui est une architecture matérielle particulière conçue pour effectuer des calculs en parallèle ;</p>
</li>
<li>
<p>le vecteur de test fourni permet de déduire qu&#8217;il s&#8217;agit d&#8217;une implémentation d&#8217;un
algorithme de déchiffrement ;</p>
</li>
<li>
<p>enfin, toujours au niveau de ce même vecteur de test, la chaîne déchiffrée mentionne une architecture
dite &#8220;ST20&#8221;.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La section <a href="http://en.wikipedia.org/wiki/Transputer#Design">Design</a> de la page Wikipedia sur les
transputers explique les grands principes de cette architecture matérielle. En particulier,
un transputer est capable de communiquer avec d&#8217;autres transputers à l&#8217;aide d&#8217;un lien série. De plus,
un transputer peut démarrer de façon classique à l&#8217;aide d&#8217;une ROM ou de façon plus originale
en utilisant un lien série. Le schéma fourni laisse penser que le transputer 0 démarre
de cette façon, en lisant les données du fichier <code>input.bin</code> depuis un lien.</p>
</div>
<div class="paragraph">
<p>La <a href="http://pdf.datasheetcatalog.com/datasheet/stmicroelectronics/4942.pdf">documentation</a> disponible
sur le processeur ST20 détaille ce mode de démarrage :</p>
</div>
<div class="quoteblock">
<blockquote>
When booting from a link, the ST20-GP1 will wait for the first bootstrap message to arrive on the
link. The first byte received down the link is the control byte. If the control byte is greater than 1 (i.e.
2 to 255), it is taken as the length in bytes of the boot code to be loaded down the link. The bytes
following the control byte are then placed in internal memory starting at location MemStart.
Following reception of the last byte the ST20-GP1 will start executing code at MemStart. The
memory space immediately above the loaded code is used as work space. A byte arriving on the
bootstrapping link after the last bootstrap byte, is retained and no acknowledge is sent until a
process inputs from the link.
</blockquote>
<div class="attribution">
&#8212; ST20-GP1 datasheet
</div>
</div>
<div class="paragraph">
<p>Pour comprendre la routine de déchiffrement implémentée au sein du fichier <code>input.bin</code>,
il va être nécessaire de désassembler les données correspondant au programme puis
de les analyser pour retrouver l&#8217;algorithme. Fort heureusement, un désassembleur
pour le processeur ST20 est disponible sur Internet : <a href="http://digifusion.jeamland.org/st20dis">st20dis</a>.</p>
</div>
<div class="paragraph">
<p>De plus, l&#8217;identification sur Internet d&#8217;un
<a href="http://pdf.datasheetcatalog.com/datasheet/SGSThomsonMicroelectronics/mXruvtu.pdf">manuel</a> sur
le jeu d&#8217;instruction du processeur aide à interpréter la sortie du désassembleur.</p>
</div>
</div>
<div class="sect2">
<h3 id="_présentation_de_l_architecture">Présentation de l&#8217;architecture</h3>
<div class="paragraph">
<p>Pour faciliter la compréhension de la suite de ce document, il est nécessaire de présenter quelques spécificités
de l&#8217;architecture du processeur ST20.</p>
</div>
<div class="paragraph">
<p>Tout d&#8217;abord, il s&#8217;agit d&#8217;un processeur 32 bits qui utilise une représentation little-endian des données en mémoire. Ainsi, <code>0xcafebabe</code> sera
représenté en mémoire par <code>BE BA FE CA</code>.</p>
</div>
<div class="paragraph">
<p>Les registres disponibles sur ST20 sont :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Wptr</code> : pointe vers une zone mémoire où sont stockées les données locales (peut être assimilé à un pointeur de pile) ;</p>
</li>
<li>
<p><code>IptrReg</code> : pointe sur la prochaine instruction à exécuter ;</p>
</li>
<li>
<p><code>StatusReg</code> : registre de statut ;</p>
</li>
<li>
<p><code>Areg</code>, <code>Breg</code> et <code>Creg</code> : forme une pile d&#8217;évaluation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le registre <code>Wptr</code> contient l&#8217;adresse pour accéder aux variables locales d&#8217;une fonction. La valeur
du registre est décrémentée à l&#8217;entrée d&#8217;une fonction pour réserver l&#8217;espace nécessaire. L&#8217;accès aux variables
se fait alors via le registre <code>Wptr</code> qui se comporte comme un tableau de mots (32 bits) : l&#8217;adresse de la variable
<code>var_3</code> est égale à <code>Wptr + 4 * 3</code>.</p>
</div>
<div class="paragraph">
<p>Enfin, les registres <code>Areg</code>, <code>Breg</code> et <code>Creg</code> sont la source et la destination pour la plupart
des opérations arithmétiques ou logiques. Lorsqu&#8217;une valeur est chargée, alors <code>Breg</code> est poussé
dans <code>Creg</code>, <code>Areg</code> est poussé dans <code>Breg</code> et la valeur chargée est stockée dans <code>Areg</code>. A l&#8217;inverse, lorsqu&#8217;une
valeur est stockée depuis <code>Areg</code>, <code>Areg</code> prend la valeur de <code>Breg</code>, <code>Breg</code> celle de <code>Creg</code> et <code>Creg</code>
devient indéfini.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rétro_conception">Rétro-conception</h3>
<div class="paragraph">
<p>Pour commencer, le premier réflexe est alors de lancer <code>st20dis</code> sur le fichier <code>input.bin</code> en commençant
à désassembler à l&#8217;octet 0 :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> st20dis-linux -A input.bin
<span class="tok-go">; New subroutine 0+1; References: 0, Local Vars: 0</span>
<span class="tok-go">00000000: f8                    sub_0:        prod             ; product - A = A * B (no overflow check)</span>

<span class="tok-go">; New subroutine 1+d; References: 0, Local Vars: 76</span>
<span class="tok-go">00000001: 64 b4                 sub_1:        ajw #-4c         ; adjust workspace - Move workspace pointer</span>
<span class="tok-go">00000003: 40                                  ldc #0           ; load constant - A = n, B=A, C=B</span>
<span class="tok-go">00000004: d1                                  stl #1 [var_1]   ; store local - workspace[n] = A, A=B, B=C</span>
<span class="tok-go">00000005: 40                                  ldc #0           ; load constant - A = n, B=A, C=B</span>
<span class="tok-go">00000006: d3                                  stl #3 [var_3]   ; store local - workspace[n] = A, A=B, B=C</span>
<span class="tok-go">00000007: 24 f2                               mint             ; minimum integer - A = MostNeg</span>
<span class="tok-go">00000009: 24 20 50                            ldnlp #400       ; load non-local pointer - A = &amp;A[n]</span>
<span class="tok-go">0000000c: 23 fc                               gajw             ; general adjust workspace - Wptr &lt;=&gt; A</span>

<span class="tok-go">; New subroutine e+f8; References: 0, Local Vars: 76</span>
<span class="tok-go">0000000e: 64 b4                 sub_e:        ajw #-4c         ; adjust workspace - Move workspace pointer</span>
<span class="tok-go">00000010: 2c 49                               ldc #c9          ; load constant - A = n, B=A, C=B</span>
<span class="tok-go">00000012: 21 fb                               ldpi [str_dd]    ; Load pointer to instruction - A = next instruction + A</span>
<span class="tok-go">00000014: 24 f2                               mint             ; minimum integer - A = MostNeg</span>
<span class="tok-go">[...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le désassembleur a l&#8217;air de fonctionner correctement et la sortie semble cohérente.
Cependant, la toute première instruction semble étrange. Le registre <code>A</code>
est mis à jour avec le résultat de la multiplication entre les registres <code>A</code>
et <code>B</code> sachant que, d&#8217;après la documentation, tous les registres sont dans un
état indéfini au démarrage. En réalité, le premier octet du fichier (<code>0xf8</code>) correspond
à la valeur &#8220;control byte&#8221; qui spécifie, lors d&#8217;un démarrage via un lien série,
la quantité de données qui sera placée dans la mémoire du processeur pour être
exécutée.</p>
</div>
<div class="paragraph">
<p>Le code du démarrage du premier transputer est alors extrait avec les commandes
 ci-dessous :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>input.bin <span class="tok-nv">count</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-p">|</span> xxd -
<span class="tok-go">0000000: f8 </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>input.bin <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">skip</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">count</span><span class="tok-o">=</span><span class="tok-k">$((</span><span class="tok-m">0</span>xf8<span class="tok-k">))</span> <span class="tok-nv">of</span><span class="tok-o">=</span>t0.bin</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>valeur du control byte</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le désassembleur <code>st20dis</code> est alors appelé sur le fichier <code>t0.bin</code> résultat
pour enfin obtenir le fichier <a href="#_t0_asm">t0.asm</a> (disponible en annexe).</p>
</div>
<div class="sect3">
<h4 id="_transputer_0">Transputer 0</h4>
<div class="paragraph">
<p>Le transputer 0 s&#8217;initialise avec les instructions ci-dessous qui ne servent
qu&#8217;à positionner le pointeur de pile :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="st20"><span class="tok-c">; New subroutine 0+d; References: 0, Local Vars: 76</span>
<span class="tok-nl">00000000:</span> <span class="tok-s">64 b4 </span>    <span class="tok-nl">sub_0:</span>        <span class="tok-k">ajw</span> <span class="tok-mh">#-4c</span>       <span class="tok-c">; réserve 76 variables locales</span>
<span class="tok-nl">00000002:</span> <span class="tok-s">40 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">00000003:</span> <span class="tok-s">d1 </span>                     <span class="tok-k">stl</span> <span class="tok-mh">#1</span> <span class="tok-no">[var_1]</span> <span class="tok-c">; var_1 = 0</span>
<span class="tok-nl">00000004:</span> <span class="tok-s">40 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">00000005:</span> <span class="tok-s">d3 </span>                     <span class="tok-k">stl</span> <span class="tok-mh">#3</span> <span class="tok-no">[var_3]</span> <span class="tok-c">; var_3 = 0</span>
<span class="tok-nl">00000006:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>           <span class="tok-c">; A = MostNeg (0x80000000)</span>
<span class="tok-nl">00000008:</span> <span class="tok-s">24 20 50 </span>               <span class="tok-k">ldnlp</span> <span class="tok-mh">#400</span>     <span class="tok-c">; A = MostNeg @ 0x400</span>
<span class="tok-nl">0000000b:</span> <span class="tok-s">23 fc </span>                  <span class="tok-k">gajw</span>           <span class="tok-c">; Wptr = MostNeg @ 0x400</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exécution continue avec les instructions suivantes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="st20"><span class="tok-c">; New subroutine d+eb; References: 0, Local Vars: 76</span>
<span class="tok-nl">0000000d:</span> <span class="tok-s">64 b4 </span>    <span class="tok-nl">sub_d:</span>        <span class="tok-k">ajw</span> <span class="tok-mh">#-4c</span>           <span class="tok-c">; réserve 76 variables locales (word)</span>
<span class="tok-nl">0000000f:</span> <span class="tok-s">2c 49 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#c9</span>
<span class="tok-nl">00000011:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[str_dc]</span>
<span class="tok-nl">00000013:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000015:</span> <span class="tok-s">48 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#8</span>
<span class="tok-nl">00000016:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>               <span class="tok-c">; out(8, 0x80000000, &quot;Boot ok&quot;)</span>
<span class="tok-nl">00000017:</span> <span class="tok-s">24 19 </span>    <span class="tok-nl">loc_17:</span>       <span class="tok-k">ldlp</span> <span class="tok-mh">#49</span> <span class="tok-no">[&amp;var_73]</span>
<span class="tok-nl">00000019:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>              <span class="tok-c">; A = 0x80000000</span>
<span class="tok-nl">0000001b:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>          <span class="tok-c">; A = 0x80000000 + 4 * 4 = 0x80000010</span>
<span class="tok-nl">0000001c:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000001d:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(12, 0x80000010, &amp;var_73)</span>
<span class="tok-nl">0000001e:</span> <span class="tok-s">24 79 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#49</span> <span class="tok-no">[var_73]</span>
<span class="tok-nl">00000020:</span> <span class="tok-s">21 a5 </span>                  <span class="tok-k">cj</span> <span class="tok-nl">loc_37</span>         <span class="tok-c">; saute à loc_37 si var_73 == 0</span>
<span class="tok-nl">00000022:</span> <span class="tok-s">2c 4d </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#cd</span>
<span class="tok-nl">00000024:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[loc_f3]</span>
<span class="tok-nl">00000026:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000028:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">00000029:</span> <span class="tok-s">24 79 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#49</span> <span class="tok-no">[var_73]</span>
<span class="tok-nl">0000002b:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(var_73, 0x80000010, loc_f3)</span>
<span class="tok-nl">0000002c:</span> <span class="tok-s">2c 43 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#c3</span>
<span class="tok-nl">0000002e:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[loc_f3]</span>
<span class="tok-nl">00000030:</span> <span class="tok-s">24 7a </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#4a</span> <span class="tok-no">[var_74]</span>
<span class="tok-nl">00000032:</span> <span class="tok-s">24 79 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#49</span> <span class="tok-no">[var_73]</span>
<span class="tok-nl">00000034:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>               <span class="tok-c">; out(var_73, var_74, loc_f3)</span>
<span class="tok-nl">00000035:</span> <span class="tok-s">61 00 </span>                  <span class="tok-k">j</span> <span class="tok-nl">loc_17</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce code fait appel à deux instructions d&#8217;entrée/sortie <code>in</code> et <code>out</code> qui ont
pour paramètres :</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Instruction</th>
<th class="tableblock halign-left valign-top">Arg0</th>
<th class="tableblock halign-left valign-top">Arg1</th>
<th class="tableblock halign-left valign-top">Arg2</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>in</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Longueur</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pointeur vers un channel</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse destination</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>out</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Longueur</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pointeur vers un channel</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> Adresse source</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>On peut alors résumer ce code ainsi :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>envoi de <code>"Boot ok"</code> sur le channel <code>0x80000000</code> ;</p>
</li>
<li>
<p>lecture de 12 octets (3 mots) du channel <code>0x80000010</code> vers l&#8217;adresse <code>&amp;var_73</code> (les variables
<code>var_73</code>, <code>var_74</code> et <code>var_75</code> sont mises à jour) ;</p>
</li>
<li>
<p>si <code>var_73 == 0</code>, sortie de la boucle et poursuite de l&#8217;exécution à l&#8217;adresse <code>loc_37</code> ;</p>
</li>
<li>
<p>sinon lecture de <code>var_73</code> octets depuis le channel <code>0x80000010</code> vers l&#8217;adresse <code>loc_f3</code> ;</p>
</li>
<li>
<p>écriture de <code>var_73</code> octets depuis l&#8217;adresse <code>loc_f3</code> vers le channel référencé
par <code>var_74</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La documentation précise le rôle des channels <code>0x80000000</code> et <code>0x80000010</code> :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_st20_memmap.png" alt="rk st20 memmap">
</div>
</div>
<div class="paragraph">
<p>Les channels <code>0x80000000</code> et <code>0x80000010</code> sont donc respectivement
la sortie et l&#8217;entrée du lien 0, qui n&#8217;est autre que le lien de démarrage qui permet
de lire le contenu du fichier <code>input.bin</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Dans le reste de ce document, un channel sera désigné par son index relatif
à <code>0x80000000</code>. Par exemple, le channel 4 correspond à l&#8217;adresse <code>0x80000010</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Pour comprendre la nature des données stockées à l&#8217;adresse <code>&amp;var_73</code>, on peut alors
simuler une lecture de 3 mots sur le channel 4 avec la commande <code>dd</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>input.bin <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">skip</span><span class="tok-o">=</span><span class="tok-k">$((</span><span class="tok-m">1</span><span class="tok-o">+</span><span class="tok-m">0</span>xf8<span class="tok-k">))</span> <span class="tok-nv">count</span><span class="tok-o">=</span><span class="tok-m">12</span> <span class="tok-p">|</span> xxd -
<span class="tok-go">0000000: 7100 0000 0400 0080 0000 0000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le résultat de la lecture (instruction <code>in</code> à l&#8217;adresse <code>0x1d</code>) est donc :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>var_73</code> : <code>0x71</code> ;</p>
</li>
<li>
<p><code>var_74</code> : <code>0x80000004</code> (channel 1) ;</p>
</li>
<li>
<p><code>var_75</code> : <code>0</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Par la suite, <code>0x71</code> octets vont être lus sur le channel 4 puis envoyés sur le channel
1. L&#8217;opération peut alors être répétée plusieurs fois, jusqu&#8217;à obtenir une longueur
(<code>var_73</code>) égale à 0 :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>input.bin <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">skip</span><span class="tok-o">=</span><span class="tok-k">$((</span><span class="tok-m">1</span><span class="tok-o">+</span><span class="tok-m">0</span>xf8+12+0x71<span class="tok-k">))</span> <span class="tok-nv">count</span><span class="tok-o">=</span><span class="tok-m">12</span> <span class="tok-p">|</span> xxd -
<span class="tok-go">0000000: 7100 0000 0800 0080 0000 0000</span>
<span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>input.bin <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">skip</span><span class="tok-o">=</span><span class="tok-k">$((</span><span class="tok-m">1</span><span class="tok-o">+</span><span class="tok-m">0</span>xf8+12+0x71+12+0x71<span class="tok-k">))</span> <span class="tok-nv">count</span><span class="tok-o">=</span><span class="tok-m">12</span> <span class="tok-p">|</span> xxd -
<span class="tok-go">0000000: 7100 0000 0c00 0080 0000 0000</span>
<span class="tok-go">[...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ces opérations peuvent être automatisées par le script Ruby ci-dessous :</p>
</div>
<div id="_split_rb" class="listingblock">
<div class="title">split.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-k">def</span> <span class="tok-nf">read_byte</span>
  <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-vg">$data</span><span class="tok-o">[</span><span class="tok-vg">$offset</span><span class="tok-o">]</span>
  <span class="tok-vg">$offset</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span>
  <span class="tok-k">return</span> <span class="tok-n">b</span>
<span class="tok-k">end</span>

<span class="tok-k">def</span> <span class="tok-nf">read_word</span>
  <span class="tok-n">word</span> <span class="tok-o">=</span> <span class="tok-vg">$data</span><span class="tok-o">[</span><span class="tok-vg">$offset</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-o">]</span>
  <span class="tok-n">word</span> <span class="tok-o">=</span> <span class="tok-n">word</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;L&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">first</span>
  <span class="tok-vg">$offset</span> <span class="tok-o">+=</span> <span class="tok-mi">4</span>
  <span class="tok-k">return</span> <span class="tok-n">word</span>
<span class="tok-k">end</span>

<span class="tok-k">def</span> <span class="tok-nf">read_bytes</span><span class="tok-p">(</span><span class="tok-n">n</span><span class="tok-p">)</span>
  <span class="tok-n">bytes</span> <span class="tok-o">=</span> <span class="tok-vg">$data</span><span class="tok-o">[</span><span class="tok-vg">$offset</span><span class="tok-p">,</span> <span class="tok-n">n</span><span class="tok-o">]</span>
  <span class="tok-vg">$offset</span> <span class="tok-o">+=</span> <span class="tok-n">n</span>
  <span class="tok-k">return</span> <span class="tok-n">bytes</span>
<span class="tok-k">end</span>

<span class="tok-k">def</span> <span class="tok-nf">read_msg</span>
  <span class="tok-o">[</span> <span class="tok-n">read_word</span><span class="tok-p">,</span> <span class="tok-n">read_word</span><span class="tok-p">,</span> <span class="tok-n">read_word</span> <span class="tok-o">]</span>
<span class="tok-k">end</span>

<span class="tok-n">input</span> <span class="tok-o">=</span> <span class="tok-no">ARGV</span><span class="tok-o">.</span><span class="tok-n">shift</span>
<span class="tok-n">ext</span> <span class="tok-o">=</span> <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">extname</span><span class="tok-p">(</span><span class="tok-n">input</span><span class="tok-p">)</span>
<span class="tok-n">fname</span> <span class="tok-o">=</span> <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">basename</span><span class="tok-p">(</span><span class="tok-n">input</span><span class="tok-p">,</span> <span class="tok-n">ext</span><span class="tok-p">)</span>

<span class="tok-vg">$data</span> <span class="tok-o">=</span> <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-n">input</span><span class="tok-p">,</span> <span class="tok-s2">&quot;rb&quot;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">read</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>
<span class="tok-vg">$offset</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>

<span class="tok-n">control_byte</span> <span class="tok-o">=</span> <span class="tok-n">read_byte</span>
<span class="tok-nb">puts</span> <span class="tok-s2">&quot;[+] control byte: 0x%02x&quot;</span> <span class="tok-o">%</span> <span class="tok-n">control_byte</span>

<span class="tok-n">code</span> <span class="tok-o">=</span> <span class="tok-n">read_bytes</span><span class="tok-p">(</span><span class="tok-n">control_byte</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>
<span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-si">#{</span><span class="tok-n">fname</span><span class="tok-si">}</span><span class="tok-s2">_code.bin&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;wb&quot;</span><span class="tok-p">)</span> <span class="tok-p">{</span> <span class="tok-o">|</span><span class="tok-n">f</span><span class="tok-o">|</span> <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">write</span> <span class="tok-n">code</span> <span class="tok-p">}</span>
<span class="tok-nb">puts</span> <span class="tok-s2">&quot;[+] code written to </span><span class="tok-si">#{</span><span class="tok-n">fname</span><span class="tok-si">}</span><span class="tok-s2">_code.bin&quot;</span>

<span class="tok-n">channels_data</span> <span class="tok-o">=</span> <span class="tok-no">Hash</span><span class="tok-o">.</span><span class="tok-n">new</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">h</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-o">|</span> <span class="tok-n">h</span><span class="tok-o">[</span><span class="tok-n">k</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;&quot;</span><span class="tok-p">}</span>
<span class="tok-kp">loop</span> <span class="tok-k">do</span>
  <span class="tok-n">len</span><span class="tok-p">,</span> <span class="tok-n">channel</span><span class="tok-p">,</span> <span class="tok-n">var_75</span> <span class="tok-o">=</span> <span class="tok-n">read_msg</span>
  <span class="tok-k">if</span> <span class="tok-n">len</span> <span class="tok-o">==</span> <span class="tok-mi">0</span>
    <span class="tok-nb">puts</span> <span class="tok-s2">&quot;[+] len: 0x%02x, channel: 0x%02x, var_75: 0x%02x&quot;</span> <span class="tok-o">%</span> <span class="tok-o">[</span> <span class="tok-n">len</span><span class="tok-p">,</span> <span class="tok-n">channel</span><span class="tok-p">,</span> <span class="tok-n">var_75</span> <span class="tok-o">]</span>
    <span class="tok-k">break</span>
  <span class="tok-k">end</span>
  <span class="tok-n">channel_idx</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">channel</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xff</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-mi">4</span>
  <span class="tok-nb">puts</span> <span class="tok-s2">&quot;[+] 0x%02x bytes =&gt; channel </span><span class="tok-si">#{</span><span class="tok-n">channel_idx</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span> <span class="tok-o">%</span> <span class="tok-n">len</span>
  <span class="tok-n">channels_data</span><span class="tok-o">[</span><span class="tok-n">channel_idx</span><span class="tok-o">]</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">read_bytes</span><span class="tok-p">(</span><span class="tok-n">len</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-n">channels_data</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">idx</span><span class="tok-p">,</span> <span class="tok-n">s</span><span class="tok-o">|</span>
  <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-si">#{</span><span class="tok-n">fname</span><span class="tok-si">}</span><span class="tok-s2">_channel_</span><span class="tok-si">#{</span><span class="tok-n">idx</span><span class="tok-si">}</span><span class="tok-s2">.bin&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;wb&quot;</span><span class="tok-p">)</span> <span class="tok-p">{</span> <span class="tok-o">|</span><span class="tok-n">f</span><span class="tok-o">|</span> <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">write</span> <span class="tok-n">s</span><span class="tok-p">}</span>
  <span class="tok-nb">puts</span> <span class="tok-s2">&quot;[+] wrote 0x%02x bytes to </span><span class="tok-si">#{</span><span class="tok-n">fname</span><span class="tok-si">}</span><span class="tok-s2">_channel_</span><span class="tok-si">#{</span><span class="tok-n">idx</span><span class="tok-si">}</span><span class="tok-s2">.bin&quot;</span> <span class="tok-o">%</span> <span class="tok-n">s</span><span class="tok-o">.</span><span class="tok-n">size</span>
<span class="tok-k">end</span>

<span class="tok-n">remaining</span> <span class="tok-o">=</span> <span class="tok-vg">$data</span><span class="tok-o">[</span><span class="tok-vg">$offset</span><span class="tok-o">.</span><span class="tok-n">.</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">].</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>
<span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;</span><span class="tok-si">#{</span><span class="tok-n">fname</span><span class="tok-si">}</span><span class="tok-s2">_remaining.bin&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;wb&quot;</span><span class="tok-p">)</span> <span class="tok-p">{</span> <span class="tok-o">|</span><span class="tok-n">f</span><span class="tok-o">|</span> <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">write</span> <span class="tok-n">remaining</span> <span class="tok-p">}</span>
<span class="tok-nb">puts</span> <span class="tok-s2">&quot;[+] wrote 0x%02x bytes to </span><span class="tok-si">#{</span><span class="tok-n">fname</span><span class="tok-si">}</span><span class="tok-s2">_remaining.bin&quot;</span> <span class="tok-o">%</span> <span class="tok-n">remaining</span><span class="tok-o">.</span><span class="tok-n">size</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On obtient alors le résultat suivant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ./split.rb input.bin
<span class="tok-go">[+] control byte: 0xf8</span>
<span class="tok-go">[+] code written to input_code.bin</span>
<span class="tok-go">[+] 0x71 bytes =&gt; channel 1</span>
<span class="tok-go">[+] 0x71 bytes =&gt; channel 2</span>
<span class="tok-go">[+] 0x71 bytes =&gt; channel 3</span>
<span class="tok-go">[+] 0x31 bytes =&gt; channel 1</span>
<span class="tok-go">[+] 0x31 bytes =&gt; channel 1</span>
<span class="tok-go">[+] 0x31 bytes =&gt; channel 1</span>
<span class="tok-go">[+] 0x31 bytes =&gt; channel 2</span>
<span class="tok-go">[+] 0x31 bytes =&gt; channel 2</span>
<span class="tok-go">[+] 0x31 bytes =&gt; channel 2</span>
<span class="tok-go">[+] 0x31 bytes =&gt; channel 3</span>
<span class="tok-go">[+] 0x31 bytes =&gt; channel 3</span>
<span class="tok-go">[+] 0x31 bytes =&gt; channel 3</span>
<span class="tok-go">[+] 0x5c bytes =&gt; channel 1</span>
<span class="tok-go">[+] 0x5c bytes =&gt; channel 1</span>
<span class="tok-go">[+] 0x98 bytes =&gt; channel 1</span>
<span class="tok-go">[+] 0x70 bytes =&gt; channel 2</span>
<span class="tok-go">[+] 0xa8 bytes =&gt; channel 2</span>
<span class="tok-go">[+] 0x60 bytes =&gt; channel 2</span>
<span class="tok-go">[+] 0xa4 bytes =&gt; channel 3</span>
<span class="tok-go">[+] 0x7c bytes =&gt; channel 3</span>
<span class="tok-go">[+] 0x90 bytes =&gt; channel 3</span>
<span class="tok-go">[+] len: 0x00, channel: 0x00, var_75: 0x00</span>
<span class="tok-go">[+] wrote 0x254 bytes to input_channel_1.bin</span>
<span class="tok-go">[+] wrote 0x27c bytes to input_channel_2.bin</span>
<span class="tok-go">[+] wrote 0x2b4 bytes to input_channel_3.bin</span>
<span class="tok-go">[+] wrote 0x3d316 bytes to input_remaining.bin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les données enregistrées dans <code>input_channel_1.bin</code>, <code>input_channel_2.bin</code> et
<code>input_channel_3.bin</code> seront analysées dans la suite de ce document :
d&#8217;après le schéma fourni, on peut supposer qu&#8217;il s&#8217;agit des données envoyées
respectivement aux transputers 1, 2 et 3.</p>
</div>
<div class="paragraph">
<p>On s&#8217;intéresse à ce stade aux données contenues dans le fichier <code>input_remaining.bin</code>,
c&#8217;est-à-dire celles présentes sur le lien 0 à la sortie de la première boucle :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> hexdump -C input_remaining.bin<span class="tok-p">|</span>head -n 4
<span class="tok-go">00000000  4b 45 59 3a ff ff ff ff  ff ff ff ff ff ff ff ff  |KEY:............|</span>
<span class="tok-go">00000010  17 63 6f 6e 67 72 61 74  75 6c 61 74 69 6f 6e 73  |.congratulations|</span>
<span class="tok-go">00000020  2e 74 61 72 2e 62 7a 32  fe f3 50 dc 81 bc 97 27  |.tar.bz2..P....&#39;|</span>
<span class="tok-go">00000030  89 ac 72 28 cb 50 a4 09  d3 18 17 fc c3 9a 61 a0  |..r(.P........a.|</span>
<span class="tok-go">[...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Plusieurs valeurs intéressantes peuvent être distinguées :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la chaîne de caractères <code>KEY:</code> ;</p>
</li>
<li>
<p>une série de 12 octets valant <code>0xff</code> ;</p>
</li>
<li>
<p>la valeur <code>0x17 = 23</code> sur un octet ;</p>
</li>
<li>
<p>la chaîne de caractères <code>congratulations.tar.bz2</code> ;</p>
</li>
<li>
<p>enfin, au décalage <code>4 + 12 + 1 + 23 = 40</code>, des données semblant aléatoires, jusqu&#8217;à la fin du fichier.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On peut remarquer que la longueur de la chaîne <code>congratulations.tar.bz2</code> veut 23 octets.</p>
</div>
<div class="paragraph">
<p>L&#8217;analyse du code assembleur se poursuit alors à l&#8217;adresse <code>loc_37</code>, après la sortie de la boucle :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="st20"><span class="tok-nl">00000037:</span> <span class="tok-s">24 19 </span>    <span class="tok-nl">loc_37:</span>       <span class="tok-k">ldlp</span> <span class="tok-mh">#49</span> <span class="tok-no">[&amp;var_73]</span>
<span class="tok-nl">00000039:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000003b:</span> <span class="tok-s">51 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#1</span>
<span class="tok-nl">0000003c:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000003d:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>               <span class="tok-c">; out(12, MostNeg @ 1, &amp;var_73)</span>
<span class="tok-nl">0000003e:</span> <span class="tok-s">24 19 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#49</span> <span class="tok-no">[&amp;var_73]</span>
<span class="tok-nl">00000040:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000042:</span> <span class="tok-s">52 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#2</span>
<span class="tok-nl">00000043:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000044:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(12, MostNeg @ 2, &amp;var_73)</span>
<span class="tok-nl">00000045:</span> <span class="tok-s">24 19 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#49</span> <span class="tok-no">[&amp;var_73]</span>
<span class="tok-nl">00000047:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000049:</span> <span class="tok-s">53 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#3</span>
<span class="tok-nl">0000004a:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000004b:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(12, MostNeg @ 3, &amp;var_73)</span>
<span class="tok-nl">0000004c:</span> <span class="tok-s">29 44 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#94</span>
<span class="tok-nl">0000004e:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[str_e4]</span>
<span class="tok-nl">00000050:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000052:</span> <span class="tok-s">48 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#8</span>
<span class="tok-nl">00000053:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(8, MostNeg, &quot;Code Ok&quot;)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ces instructions se contentent d&#8217;écrire le contenu des variables <code>var_73</code>, <code>var_74</code> et <code>var_75</code>
sur les channels 1, 2, et 3. A la sortie de la première boucle, ces trois
variables valent 0 d&#8217;après la sortie du script <code>split.rb</code>. Les fichiers <code>input_channel_1.bin</code>, <code>input_channel_2.bin</code> et
<code>input_channel_3.bin</code> sont mis à jour en conséquence :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>/dev/zero <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">count</span><span class="tok-o">=</span><span class="tok-m">12</span> <span class="tok-nv">of</span><span class="tok-o">=</span>input_channel_1.bin <span class="tok-nv">seek</span><span class="tok-o">=</span><span class="tok-k">$((</span><span class="tok-m">0</span>x254<span class="tok-k">))</span>
<span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>/dev/zero <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">count</span><span class="tok-o">=</span><span class="tok-m">12</span> <span class="tok-nv">of</span><span class="tok-o">=</span>input_channel_2.bin <span class="tok-nv">seek</span><span class="tok-o">=</span><span class="tok-k">$((</span><span class="tok-m">0</span>x27c<span class="tok-k">))</span>
<span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>/dev/zero <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">count</span><span class="tok-o">=</span><span class="tok-m">12</span> <span class="tok-nv">of</span><span class="tok-o">=</span>input_channel_3.bin <span class="tok-nv">seek</span><span class="tok-o">=</span><span class="tok-k">$((</span><span class="tok-m">0</span>x2b4<span class="tok-k">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le message <code>Code Ok</code> est ensuite envoyé sur le channel 0 et l&#8217;exécution continue à l&#8217;adresse <code>loc_54</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="st20"><span class="tok-nl">00000054:</span> <span class="tok-s">12 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#2</span> <span class="tok-no">[&amp;var_2]</span>
<span class="tok-nl">00000055:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000057:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">00000058:</span> <span class="tok-s">44 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#4</span>
<span class="tok-nl">00000059:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(4, MostNeg @ 4, &amp;var_2)</span>
<span class="tok-nl">0000005a:</span> <span class="tok-s">15 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#5</span> <span class="tok-no">[&amp;var_5]</span>
<span class="tok-nl">0000005b:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000005d:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">0000005e:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000005f:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(12, MostNeg @ 4, &amp;var_5)</span>
<span class="tok-nl">00000060:</span> <span class="tok-s">28 48 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#88</span>
<span class="tok-nl">00000062:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[str_ec]</span>
<span class="tok-nl">00000064:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000066:</span> <span class="tok-s">48 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#8</span>
<span class="tok-nl">00000067:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(8, MostNeg, &quot;Decrypt&quot;)</span>
<span class="tok-nl">00000068:</span> <span class="tok-s">13 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#3</span> <span class="tok-no">[&amp;var_3]</span>
<span class="tok-nl">00000069:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000006b:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">0000006c:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">0000006d:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(1, MostNeg @ 4, &amp;var_3)</span>
<span class="tok-nl">0000006e:</span> <span class="tok-s">19 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#9</span> <span class="tok-no">[&amp;var_9]</span>
<span class="tok-nl">0000006f:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000071:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">00000072:</span> <span class="tok-s">13 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#3</span> <span class="tok-no">[&amp;var_3]</span>
<span class="tok-nl">00000073:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>
<span class="tok-nl">00000074:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(*var3, MostNeg @ 4, &amp;var_9)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il est intéressant de mettre en relation ces instructions avec les données du fichier
<code>remaining.bin</code> précédemment analysées :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la lecture de 4 octets sur le channel 4 permet de stocker la chaîne <code>KEY:</code> dans <code>var_2</code> ;</p>
</li>
<li>
<p>la lecture de 12 octets sur le channel 4 stocke les 12 octets valant <code>0xFF</code> dans <code>var_5</code>, <code>var_6</code> et <code>var_7</code> ;</p>
</li>
<li>
<p>un octet est lu sur le channel 4, qui vaut 23 (longueur de <code>congratulations.tar.bz2</code>) ;</p>
</li>
<li>
<p>23 octets sont donc lus sur le channel, ce qui permet de stocker <code>congratulations.tar.bz2</code>
à l&#8217;adresse de <code>var_9</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>De plus, la chaîne <code>Decrypt</code> est envoyée sur le channel 0, ce qui laisse supposer que les instructions
à venir implémentent une routine de déchiffrement.</p>
</div>
<div class="paragraph">
<p>Le transputer 0 poursuit son exécution avec les instructions suivantes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="st20"><span class="tok-nl">00000075:</span> <span class="tok-s">40 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">00000076:</span> <span class="tok-s">d4 </span>                     <span class="tok-k">stl</span> <span class="tok-mh">#4</span> <span class="tok-no">[var_4]</span>    <span class="tok-c">; var_4 = 0</span>
<span class="tok-nl">00000077:</span> <span class="tok-s">11 </span>       <span class="tok-nl">loc_77:</span>       <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000078:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000007a:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">0000007b:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">0000007c:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(1, MostNeg @ 4, &amp;var_1)</span>
<span class="tok-nl">0000007d:</span> <span class="tok-s">15 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#5</span> <span class="tok-no">[&amp;var_5]</span>
<span class="tok-nl">0000007e:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000080:</span> <span class="tok-s">51 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000081:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000082:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>               <span class="tok-c">; out(12, MostNeg @ 1, &amp;var_5)</span>
<span class="tok-nl">00000083:</span> <span class="tok-s">15 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#5</span> <span class="tok-no">[&amp;var_5]</span>
<span class="tok-nl">00000084:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000086:</span> <span class="tok-s">52 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#2</span>
<span class="tok-nl">00000087:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000088:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>               <span class="tok-c">; out(12, MostNeg @ 2, &amp;var_5)</span>
<span class="tok-nl">00000089:</span> <span class="tok-s">15 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#5</span> <span class="tok-no">[&amp;var_5]</span>
<span class="tok-nl">0000008a:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000008c:</span> <span class="tok-s">53 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#3</span>
<span class="tok-nl">0000008d:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000008e:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>               <span class="tok-c">; out(12, MostNeg @ 3, &amp;var_5)</span>
<span class="tok-nl">0000008f:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">00000090:</span> <span class="tok-s">81 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000091:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000093:</span> <span class="tok-s">55 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#5</span>
<span class="tok-nl">00000094:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000095:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(1, MostNeg @ 5, &amp;var_0 + 1)</span>
<span class="tok-nl">00000096:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">00000097:</span> <span class="tok-s">82 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#2</span>
<span class="tok-nl">00000098:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000009a:</span> <span class="tok-s">56 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#6</span>
<span class="tok-nl">0000009b:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">0000009c:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(1, MostNeg @ 6, &amp;var_0 + 2)</span>
<span class="tok-nl">0000009d:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">0000009e:</span> <span class="tok-s">83 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#3</span>
<span class="tok-nl">0000009f:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">000000a1:</span> <span class="tok-s">57 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#7</span>
<span class="tok-nl">000000a2:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">000000a3:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(1, MostNeg @ 7, &amp;var_0 + 3)</span>
<span class="tok-nl">000000a4:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">000000a5:</span> <span class="tok-s">81 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">000000a6:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>
<span class="tok-nl">000000a7:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">000000a8:</span> <span class="tok-s">82 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#2</span>
<span class="tok-nl">000000a9:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>
<span class="tok-nl">000000aa:</span> <span class="tok-s">23 f3 </span>                  <span class="tok-k">xor</span>               <span class="tok-c">; A = var_0[2] ^ var_0[1]</span>
<span class="tok-nl">000000ac:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">000000ad:</span> <span class="tok-s">83 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#3</span>
<span class="tok-nl">000000ae:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>
<span class="tok-nl">000000af:</span> <span class="tok-s">23 f3 </span>                  <span class="tok-k">xor</span>               <span class="tok-c">; A = var_0[3] ^ ( var_0[2] ^ var_0[1] )</span>
<span class="tok-nl">000000b1:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">000000b2:</span> <span class="tok-s">81 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">000000b3:</span> <span class="tok-s">23 fb </span>                  <span class="tok-k">sb</span>                <span class="tok-c">; var_0[1] = var_0[3] ^ ( var_0[2] ^ var_0[1] )</span>
<span class="tok-nl">000000b5:</span> <span class="tok-s">11 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">000000b6:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>                <span class="tok-c">; A = var_1</span>
<span class="tok-nl">000000b7:</span> <span class="tok-s">74 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#4</span> <span class="tok-no">[var_4]</span>    <span class="tok-c">; A = var_4, B = var_1</span>
<span class="tok-nl">000000b8:</span> <span class="tok-s">15 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#5</span> <span class="tok-no">[&amp;var_5]</span>  <span class="tok-c">; A = &amp;var_5, B = var_4, C = var_1</span>
<span class="tok-nl">000000b9:</span> <span class="tok-s">f2 </span>                     <span class="tok-k">bsub</span>              <span class="tok-c">; A = &amp;var_5 + var_4, B = var_1</span>
<span class="tok-nl">000000ba:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>                <span class="tok-c">; A = var_5[var_4], B = var_1</span>
<span class="tok-nl">000000bb:</span> <span class="tok-s">74 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#4</span> <span class="tok-no">[var_4]</span>    <span class="tok-c">; A = var_4, B = var_5[var_4], C = var_1</span>
<span class="tok-nl">000000bc:</span> <span class="tok-s">2c f1 </span>                  <span class="tok-k">ssub</span>              <span class="tok-c">; A = var_4 + 2 * var_5[var_4], B = var_1</span>
<span class="tok-nl">000000be:</span> <span class="tok-s">23 f3 </span>                  <span class="tok-k">xor</span>               <span class="tok-c">; A = (var_4 + 2 * var_5[var_4]) ^ var_1</span>
<span class="tok-nl">000000c0:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">000000c1:</span> <span class="tok-s">23 fb </span>                  <span class="tok-k">sb</span>                <span class="tok-c">; var_0[0] = (var_4 + 2 * var_5[var_4]) ^ var_1</span>
<span class="tok-nl">000000c3:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">000000c4:</span> <span class="tok-s">81 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">000000c5:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>                <span class="tok-c">; A = var_0[1]</span>
<span class="tok-nl">000000c6:</span> <span class="tok-s">74 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#4</span> <span class="tok-no">[var_4]</span>
<span class="tok-nl">000000c7:</span> <span class="tok-s">15 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#5</span> <span class="tok-no">[&amp;var_5]</span>
<span class="tok-nl">000000c8:</span> <span class="tok-s">f2 </span>                     <span class="tok-k">bsub</span>              <span class="tok-c">; A = &amp;var_5 + var_4, B = var_0[1]</span>
<span class="tok-nl">000000c9:</span> <span class="tok-s">23 fb </span>                  <span class="tok-k">sb</span>                <span class="tok-c">; var_5[var_4] = var_0[1]</span>
<span class="tok-nl">000000cb:</span> <span class="tok-s">74 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#4</span> <span class="tok-no">[var_4]</span>
<span class="tok-nl">000000cc:</span> <span class="tok-s">81 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">000000cd:</span> <span class="tok-s">25 fa </span>                  <span class="tok-k">dup</span>               <span class="tok-c">; A = var_4 + 1, B = var_4 + 1</span>
<span class="tok-nl">000000cf:</span> <span class="tok-s">d4 </span>                     <span class="tok-k">stl</span> <span class="tok-mh">#4</span> <span class="tok-no">[var_4]</span>    <span class="tok-c">; var_4 var_4 + 1, A = var_4 + 1</span>
<span class="tok-nl">000000d0:</span> <span class="tok-s">cc </span>                     <span class="tok-k">eqc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">000000d1:</span> <span class="tok-s">a3 </span>                     <span class="tok-k">cj</span> <span class="tok-nl">loc_d5</span>         <span class="tok-c">; saute à loc_d5 si var_4 != 12</span>
<span class="tok-nl">000000d2:</span> <span class="tok-s">80 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">000000d3:</span> <span class="tok-s">40 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">000000d4:</span> <span class="tok-s">d4 </span>                     <span class="tok-k">stl</span> <span class="tok-mh">#4</span> <span class="tok-no">[var_4]</span>    <span class="tok-c">; var_4 = 0</span>
<span class="tok-nl">000000d5:</span> <span class="tok-s">10 </span>       <span class="tok-nl">loc_d5:</span>       <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">000000d6:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">000000d8:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">000000d9:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>               <span class="tok-c">; out(1, MostNeg, &amp;var_0)</span>
<span class="tok-nl">000000da:</span> <span class="tok-s">66 0b </span>                  <span class="tok-k">j</span> <span class="tok-nl">loc_77</span>          <span class="tok-c">; saute à loc_77</span>
<span class="tok-nl">000000dc:</span> <span class="tok-s">** </span>       <span class="tok-nl">str_dc:</span>      <span class="tok-s">.string</span> <span class="tok-s">&quot;Boot ok&quot;</span>
<span class="tok-nl">000000e4:</span> <span class="tok-s">** </span>       <span class="tok-nl">str_e4:</span>      <span class="tok-s">.string</span> <span class="tok-s">&quot;Code Ok&quot;</span>
<span class="tok-nl">000000ec:</span> <span class="tok-s">** </span>       <span class="tok-nl">str_ec:</span>      <span class="tok-s">.string</span> <span class="tok-s">&quot;Decrypt&quot;</span>
<span class="tok-nl">000000f4:</span> <span class="tok-s">24 bc </span>                  <span class="tok-k">ajw</span> <span class="tok-mh">#4c</span>
<span class="tok-nl">000000f6:</span> <span class="tok-s">22 f0 </span>                  <span class="tok-k">ret</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il s&#8217;agit de la boucle principale du transputer 0. La variable <code>var_4</code> est mise à 0 puis la boucle
effectue les opérations suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>loc_7c</code> : lecture d&#8217;un octet depuis le channel 4, stockage dans <code>var_1</code> ;</p>
</li>
<li>
<p><code>loc_80</code> à <code>loc_8e</code> : envoi des 12 octets à l&#8217;adresse <code>&amp;var_5</code> vers les channels 1, 2, 3 ;</p>
</li>
<li>
<p><code>loc_8f</code> à <code>loc_a3</code> : lecture d&#8217;un octet sur les channels 5, 6, et 7, respectivement stocké dans <code>var_0[1]</code>, <code>var_0[2]</code> et <code>var_0[3]</code> ;</p>
</li>
<li>
<p><code>loc_b3</code> : mise à jour de l&#8217;octet <code>var_0[1]</code> avec l&#8217;opération <code>var_0[3] ^ ( var_0[2] ^ var_0[1] )</code> ;</p>
</li>
<li>
<p><code>loc_c1</code> : mise à jour de l&#8217;octet <code>var_0[0]</code> avec l&#8217;opération <code>(var_4 + 2 * var_5[var_4]) ^ var_1</code> ;</p>
</li>
<li>
<p><code>loc_c9</code> : mise à jour de l&#8217;octet <code>var_5[var_4]</code> avec l&#8217;octet précédemment calculé <code>var_0[1]</code> ;</p>
</li>
<li>
<p><code>loc_cb</code> à <code>loc_d4</code> : incrément de 1 de la variable <code>var_4</code>, remise à 0 si <code>var_4 == 12</code> ;</p>
</li>
<li>
<p><code>loc_d5</code> à <code>loc_da</code>: envoi de l&#8217;octet <code>var_0[0]</code> sur le channel 0 et retour au début de la boucle.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sachant qu&#8217;il s&#8217;agit très certainement d&#8217;une routine de déchiffrement, il est raisonnable de faire
les hypothèses suivantes sur le rôle de chaque variable :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>var_4</code> est un compteur de boucle qui varie entre 0 et 11 ;</p>
</li>
<li>
<p><code>var_1</code> est un octet chiffré ;</p>
</li>
<li>
<p><code>var_5</code> contient la clé courante (12 fois <code>0xff</code> à l&#8217;entrée de la boucle),
celle-ci est envoyée aux transputers 1, 2 et 3 via leurs channels respectifs ;</p>
</li>
<li>
<p>les transputers 1, 2 et 3 retournent chacun un octet sur les channels 5, 6 et 7 qui sont stockés dans
la variable temporaire <code>var_0</code> ;</p>
</li>
<li>
<p><code>var_0[1]</code> contient un octet qui sera utilisé pour mettre à jour la clé courante à la position <code>var_4</code> ;</p>
</li>
<li>
<p><code>var_0[0]</code> correspond au résultat du déchiffrement de l&#8217;octet stocké dans <code>var_1</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ces opérations peuvent être traduites en pseudo-code C de la façon suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">void</span> <span class="tok-nf">transputer_0</span><span class="tok-p">(</span><span class="tok-kt">void</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">t1</span><span class="tok-p">,</span> <span class="tok-n">t2</span><span class="tok-p">,</span> <span class="tok-n">t3</span><span class="tok-p">,</span> <span class="tok-n">i</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-mi">12</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s">&quot;</span><span class="tok-se">\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
    <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-k">for</span> <span class="tok-p">(;;)</span> <span class="tok-p">{</span>
       <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">);</span>    <span class="tok-c1">// lecture de l&#39;octet chiffré</span>

       <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">);</span> <span class="tok-c1">// envoi de la clé au transputer 1</span>
       <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">);</span> <span class="tok-c1">// envoi de la clé au transputer 2</span>
       <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">);</span> <span class="tok-c1">// envoi de la clé au transputer 3</span>

       <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">5</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">t1</span><span class="tok-p">);</span>   <span class="tok-c1">// lecture d&#39;un octet depuis le transputer 1</span>
       <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">6</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">t2</span><span class="tok-p">);</span>   <span class="tok-c1">// lecture d&#39;un octet depuis le transputer 2</span>
       <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">7</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">t3</span><span class="tok-p">);</span>   <span class="tok-c1">// lecture d&#39;un octet depuis le transputer 3</span>

       <span class="tok-n">p</span> <span class="tok-o">=</span> <span class="tok-p">(</span> <span class="tok-n">i</span> <span class="tok-o">+</span> <span class="tok-mi">2</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-p">)</span> <span class="tok-o">^</span> <span class="tok-n">c</span><span class="tok-p">;</span> <span class="tok-c1">// déchiffrement de l&#39;octet</span>
       <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">t3</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-n">t2</span> <span class="tok-o">^</span> <span class="tok-n">t1</span><span class="tok-p">);</span>    <span class="tok-c1">// mise à jour de la clé</span>
       <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">;</span>
       <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">%</span> <span class="tok-mi">12</span><span class="tok-p">);</span>

       <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">p</span><span class="tok-p">);</span> <span class="tok-c1">// envoi de l&#39;octet déchiffré</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que le fonctionnement du transputer 0 est compris, il reste à analyser les transputers 1, 2 et 3
pour déterminer les traitements effectués sur la clé courante à chaque itération. Pour cela,
les données envoyées sur les channels 1, 2 et 3 avant le début de la boucle principale du transputer 0 doivent
être examinées : il s&#8217;agit en pratique des fichiers <code>input_channel_1.bin</code>, <code>input_channel_2.bin</code> et
<code>input_channel_3.bin</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transputers_1_2_et_3">Transputers 1, 2 et 3</h4>
<div class="paragraph">
<p>Pour des raisons de clarté, les fichiers <code>input_channel_1.bin</code>, <code>input_channel_2.bin</code> et
<code>input_channel_3.bin</code> ont été renommés en <code>t1.bin</code>, <code>t2.bin</code> et <code>t3.bin</code>.</p>
</div>
<div class="paragraph">
<p>De façon similaire au premier transputer, ces trois transputers démarrent sur un lien série.
Pour le transputer 1, la valeur du &#8220;control byte&#8221; et le bloc de code sont extraits avec les commandes ci-dessous :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>t1.bin <span class="tok-nv">count</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-p">|</span> xxd -
<span class="tok-go">0000000: 70</span>
<span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>t1.bin <span class="tok-nv">count</span><span class="tok-o">=</span><span class="tok-k">$((</span><span class="tok-m">0</span>x70<span class="tok-k">))</span> <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">skip</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">of</span><span class="tok-o">=</span>t1_code.bin</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le résultat peut alors être désassemblé avec <code>st20dis</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> st20dis-linux t1_code.bin &gt; t1.asm</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le fichier résultant <a href="#_t1_asm">t1.asm</a> est disponible en annexe.</p>
</div>
<div class="paragraph">
<p>Comme vu précédemment, le transputer 1 commence par positionner le pointeur de pile :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="st20"><span class="tok-c">; New subroutine 0+9; References: 0, Local Vars: 8</span>
<span class="tok-nl">00000000:</span> <span class="tok-s">60 b8 </span>    <span class="tok-nl">sub_0:</span>        <span class="tok-k">ajw</span> <span class="tok-mh">#-8</span>       <span class="tok-c">; réserve 8 variables locales</span>
<span class="tok-nl">00000002:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>          <span class="tok-c">; A = MostNeg</span>
<span class="tok-nl">00000004:</span> <span class="tok-s">24 20 50 </span>               <span class="tok-k">ldnlp</span> <span class="tok-mh">#400</span>    <span class="tok-c">; A = MostNeg @ 0x400</span>
<span class="tok-nl">00000007:</span> <span class="tok-s">23 fc </span>                  <span class="tok-k">gajw</span>          <span class="tok-c">; Wptr = MostNeg @ 0x400</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Une première boucle est ensuite exécutée :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="st20"><span class="tok-c">; New subroutine 9+67; References: 0, Local Vars: 8</span>
<span class="tok-nl">00000009:</span> <span class="tok-s">60 b8 </span>    <span class="tok-nl">sub_9:</span>        <span class="tok-k">ajw</span> <span class="tok-mh">#-8</span>           <span class="tok-c">; réserve 8 variables locales</span>
<span class="tok-nl">0000000b:</span> <span class="tok-s">15 </span>       <span class="tok-nl">loc_b:</span>        <span class="tok-k">ldlp</span> <span class="tok-mh">#5</span> <span class="tok-no">[&amp;var_5]</span>
<span class="tok-nl">0000000c:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000000e:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">0000000f:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000010:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(12, MostNeg @ 4, &amp;var_5)</span>
<span class="tok-nl">00000011:</span> <span class="tok-s">75 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#5</span> <span class="tok-no">[var_5]</span>
<span class="tok-nl">00000012:</span> <span class="tok-s">21 a2 </span>                  <span class="tok-k">cj</span> <span class="tok-nl">loc_26</span>         <span class="tok-c">; saute à loc_26 si var_5 == 0</span>
<span class="tok-nl">00000014:</span> <span class="tok-s">25 44 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#54</span>
<span class="tok-nl">00000016:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[loc_6c]</span>
<span class="tok-nl">00000018:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000001a:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">0000001b:</span> <span class="tok-s">75 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#5</span> <span class="tok-no">[var_5]</span>
<span class="tok-nl">0000001c:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(var_5, MostNeg @ 4, loc_6c)</span>
<span class="tok-nl">0000001d:</span> <span class="tok-s">24 4b </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#4b</span>
<span class="tok-nl">0000001f:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[loc_6c]</span>
<span class="tok-nl">00000021:</span> <span class="tok-s">76 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#6</span> <span class="tok-no">[var_6]</span>
<span class="tok-nl">00000022:</span> <span class="tok-s">75 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#5</span> <span class="tok-no">[var_5]</span>
<span class="tok-nl">00000023:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>               <span class="tok-c">; out(var_5, var_6, loc_6c)</span>
<span class="tok-nl">00000024:</span> <span class="tok-s">61 05 </span>                  <span class="tok-k">j</span> <span class="tok-nl">loc_b</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette boucle est quasiment identique à la première boucle du transputer 0. On est alors
tenté d&#8217;utiliser le script <code>split.rb</code> développé précédemment pour extraire les données
envoyées sur chaque channel :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ./split.rb t1.bin
<span class="tok-go">[+] control byte: 0x70</span>
<span class="tok-go">[+] code written to t1_code.bin</span>
<span class="tok-go">[+] 0x25 bytes =&gt; channel 1</span>
<span class="tok-go">[+] 0x25 bytes =&gt; channel 2</span>
<span class="tok-go">[+] 0x25 bytes =&gt; channel 3</span>
<span class="tok-go">[+] 0x50 bytes =&gt; channel 1</span>
<span class="tok-go">[+] 0x50 bytes =&gt; channel 2</span>
<span class="tok-go">[+] 0x8c bytes =&gt; channel 3</span>
<span class="tok-go">[+] len: 0x00, channel: 0x00, var_75: 0x00</span>
<span class="tok-go">[+] wrote 0x75 bytes to t1_channel_1.bin</span>
<span class="tok-go">[+] wrote 0x75 bytes to t1_channel_2.bin</span>
<span class="tok-go">[+] wrote 0xb1 bytes to t1_channel_3.bin</span>
<span class="tok-go">[+] wrote 0x00 bytes to t1_remaining.bin</span>
<span class="tok-gp">$</span> ./split.rb t2.bin
<span class="tok-go">[+] control byte: 0x70</span>
<span class="tok-go">[+] code written to t2_code.bin</span>
<span class="tok-go">[+] 0x25 bytes =&gt; channel 1</span>
<span class="tok-go">[+] 0x25 bytes =&gt; channel 2</span>
<span class="tok-go">[+] 0x25 bytes =&gt; channel 3</span>
<span class="tok-go">[+] 0x64 bytes =&gt; channel 1</span>
<span class="tok-go">[+] 0x9c bytes =&gt; channel 2</span>
<span class="tok-go">[+] 0x54 bytes =&gt; channel 3</span>
<span class="tok-go">[+] len: 0x00, channel: 0x00, var_75: 0x00</span>
<span class="tok-go">[+] wrote 0x89 bytes to t2_channel_1.bin</span>
<span class="tok-go">[+] wrote 0xc1 bytes to t2_channel_2.bin</span>
<span class="tok-go">[+] wrote 0x79 bytes to t2_channel_3.bin</span>
<span class="tok-go">[+] wrote 0x00 bytes to t2_remaining.bin</span>
<span class="tok-gp">$</span> ./split.rb t3.bin
<span class="tok-go">[+] control byte: 0x70</span>
<span class="tok-go">[+] code written to t3_code.bin</span>
<span class="tok-go">[+] 0x25 bytes =&gt; channel 1</span>
<span class="tok-go">[+] 0x25 bytes =&gt; channel 2</span>
<span class="tok-go">[+] 0x25 bytes =&gt; channel 3</span>
<span class="tok-go">[+] 0x98 bytes =&gt; channel 1</span>
<span class="tok-go">[+] 0x70 bytes =&gt; channel 2</span>
<span class="tok-go">[+] 0x84 bytes =&gt; channel 3</span>
<span class="tok-go">[+] len: 0x00, channel: 0x00, var_75: 0x00</span>
<span class="tok-go">[+] wrote 0xbd bytes to t3_channel_1.bin</span>
<span class="tok-go">[+] wrote 0x95 bytes to t3_channel_2.bin</span>
<span class="tok-go">[+] wrote 0xa9 bytes to t3_channel_3.bin</span>
<span class="tok-go">[+] wrote 0x00 bytes to t3_remaining.bin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le script fonctionne correctement sur les trois transputers et pour chacun d&#8217;eux, les
données envoyées sur les channels 1, 2 et 3 sont extraites. On peut remarquer qu&#8217;après avoir
effectué cette première boucle, il n&#8217;y a plus de données en attente sur le lien série (les fichiers
<code>t1_remaining.bin</code>, <code>t2_remaining.bin</code> et <code>t3_remaining.bin</code> sont vides).
On remarque également que le &#8220;control byte&#8221; est identique pour les trois transputers. En réalité, le code
extrait est le même pour les trois, comme indiqué ci-dessous :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> md5sum t*_code.bin
<span class="tok-go">0cbeb2a7a4f269356aeec0fe6bfc9192  t1_code.bin</span>
<span class="tok-go">0cbeb2a7a4f269356aeec0fe6bfc9192  t2_code.bin</span>
<span class="tok-go">0cbeb2a7a4f269356aeec0fe6bfc9192  t3_code.bin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il suffit donc d&#8217;analyser un seul transputer pour comprendre les trois.</p>
</div>
<div class="paragraph">
<p>L&#8217;analyse continue ensuite après la première boucle, à l&#8217;adresse <code>loc_26</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="st20"><span class="tok-nl">00000026:</span> <span class="tok-s">11 </span>       <span class="tok-nl">loc_26:</span>       <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000027:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000029:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">0000002a:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000002b:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(12, MostNeg @ 4, &amp;var_1)</span>
<span class="tok-nl">0000002c:</span> <span class="tok-s">11 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">0000002d:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000002f:</span> <span class="tok-s">51 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000030:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000031:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(12, MostNeg @ 1, &amp;var_1)</span>
<span class="tok-nl">00000032:</span> <span class="tok-s">11 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000033:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000035:</span> <span class="tok-s">52 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#2</span>
<span class="tok-nl">00000036:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000037:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(12, MostNeg @ 2, &amp;var_1)</span>
<span class="tok-nl">00000038:</span> <span class="tok-s">11 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000039:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000003b:</span> <span class="tok-s">53 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#3</span>
<span class="tok-nl">0000003c:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000003d:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(12, MostNeg @ 3, &amp;var_1)</span>
<span class="tok-nl">0000003e:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">0000003f:</span> <span class="tok-s">81 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000040:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000042:</span> <span class="tok-s">55 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#5</span>
<span class="tok-nl">00000043:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000044:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(1, MostNeg @ 5, &amp;var_0 + 1)</span>
<span class="tok-nl">00000045:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">00000046:</span> <span class="tok-s">82 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#2</span>
<span class="tok-nl">00000047:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000049:</span> <span class="tok-s">56 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#6</span>
<span class="tok-nl">0000004a:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">0000004b:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(1, MostNeg @ 6, &amp;var_0 + 2)</span>
<span class="tok-nl">0000004c:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">0000004d:</span> <span class="tok-s">83 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#3</span>
<span class="tok-nl">0000004e:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000050:</span> <span class="tok-s">57 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#7</span>
<span class="tok-nl">00000051:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000052:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(1, MostNeg @ 7, &amp;var_0 + 3)</span>
<span class="tok-nl">00000053:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">00000054:</span> <span class="tok-s">81 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000055:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>                 <span class="tok-c">; A = var_0[1]</span>
<span class="tok-nl">00000056:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">00000057:</span> <span class="tok-s">82 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#2</span>
<span class="tok-nl">00000058:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>                 <span class="tok-c">; A = var_0[2], B = var_0[1]</span>
<span class="tok-nl">00000059:</span> <span class="tok-s">23 f3 </span>                  <span class="tok-k">xor</span>                <span class="tok-c">; A = var_0[2] ^ var_0[1]</span>
<span class="tok-nl">0000005b:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">0000005c:</span> <span class="tok-s">83 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#3</span>
<span class="tok-nl">0000005d:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>                 <span class="tok-c">; A = var_0[3], B = var_0[2] ^ var_0[1]</span>
<span class="tok-nl">0000005e:</span> <span class="tok-s">23 f3 </span>                  <span class="tok-k">xor</span>                <span class="tok-c">; A = var_0[3] ^ (var_0[2] ^ var_0[1])</span>
<span class="tok-nl">00000060:</span> <span class="tok-s">25 fa </span>                  <span class="tok-k">dup</span>                <span class="tok-c">; A = var_0[3] ^ (var_0[2] ^ var_0[1]), B = A</span>
<span class="tok-nl">00000062:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">00000063:</span> <span class="tok-s">23 fb </span>                  <span class="tok-k">sb</span>                 <span class="tok-c">; var_0[0] = var_0[3] ^ (var_0[2] ^ var_0[1])</span>
<span class="tok-nl">00000065:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">00000066:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000068:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000069:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(1, MostNeg, var_0[3] ^ (var_0[2] ^ var_0[1]))</span>
<span class="tok-nl">0000006a:</span> <span class="tok-s">64 0a </span>                  <span class="tok-k">j</span> <span class="tok-nl">loc_26</span>           <span class="tok-c">; saute à loc_26</span>
<span class="tok-nl">0000006c:</span> <span class="tok-s">00 </span>       <span class="tok-nl">loc_6c:</span>       <span class="tok-k">nop</span>
<span class="tok-nl">0000006d:</span> <span class="tok-s">b8 </span>                     <span class="tok-k">ajw</span> <span class="tok-mh">#8</span>
<span class="tok-nl">0000006e:</span> <span class="tok-s">22 f0 </span>                  <span class="tok-k">ret</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce code revient à effectuer les opérations suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>loc_26</code> à <code>loc_2b</code> : lecture de 12 octets du channel 4 vers l&#8217;adresse de <code>var_1</code> ;</p>
</li>
<li>
<p><code>loc_2c</code> à <code>loc_3d</code> : envoi de 12 octets de l&#8217;adresse de <code>var_1</code> vers les channels 1, 2 et 3 ;</p>
</li>
<li>
<p><code>loc_3e</code> à <code>loc_52</code> : lecture d&#8217;un octet sur les channels 5, 6, et 7, respectivement stocké dans <code>var_0[1]</code>, <code>var_0[2]</code> et <code>var_0[3]</code> ;</p>
</li>
<li>
<p><code>loc_53</code> à <code>loc_63</code> : mise à jour de l&#8217;octet <code>var_0[0]</code> avec l&#8217;opération <code>var_0[3] ^ ( var_0[2] ^ var_0[1] )</code> ;</p>
</li>
<li>
<p><code>loc_65</code> à <code>loc_6a</code> : envoi de l&#8217;octet <code>var_0[0]</code> vers le channel 0 et saut à l&#8217;adresse <code>loc_26</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ces opérations peuvent être traduites en pseudo-code C de la façon suivante :</p>
</div>
<div id="_transputer_1" class="listingblock">
<div class="title">Pseudo-code transputer 1</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">void</span> <span class="tok-nf">transputer_1</span><span class="tok-p">(</span><span class="tok-kt">void</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">res</span><span class="tok-p">,</span> <span class="tok-n">t4</span><span class="tok-p">,</span> <span class="tok-n">t5</span><span class="tok-p">,</span> <span class="tok-n">t6</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-mi">12</span><span class="tok-p">];</span>

    <span class="tok-k">for</span> <span class="tok-p">(;;)</span> <span class="tok-p">{</span>
        <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">);</span> <span class="tok-c1">// lecture de la clé</span>

        <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">);</span> <span class="tok-c1">// envoi de la clé au transputer 4</span>
        <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">);</span> <span class="tok-c1">// envoi de la clé au transputer 5</span>
        <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">);</span> <span class="tok-c1">// envoi de la clé au transputer 6</span>

        <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">5</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">t4</span><span class="tok-p">);</span> <span class="tok-c1">// lecture d&#39;un octet depuis le transputer 4</span>
        <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">6</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">t5</span><span class="tok-p">);</span> <span class="tok-c1">// lecture d&#39;un octet depuis le transputer 5</span>
        <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">7</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">t6</span><span class="tok-p">);</span> <span class="tok-c1">// lecture d&#39;un octet depuis le transputer 6</span>

        <span class="tok-n">res</span> <span class="tok-o">=</span> <span class="tok-n">t6</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-n">t5</span> <span class="tok-o">^</span> <span class="tok-n">t4</span><span class="tok-p">);</span>

        <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">res</span><span class="tok-p">);</span> <span class="tok-c1">// envoi de res sur le channel 0</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le fonctionnement des transputers 2 et 3 est identique. Pour terminer l&#8217;analyse,
il faut donc s&#8217;intéresser aux transputers 4 à 12.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transputers_4_à_12">Transputers 4 à 12</h4>
<div class="paragraph">
<p>Le transputer 4 est initialisé avec les données envoyées par le transputer 1 sur le channel 1,
c&#8217;est-à-dire :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> hexdump -C t1_channel_1.bin
<span class="tok-go">00000000  24 60 bd 24 f2 24 20 50  23 fc 60 bd 10 24 f2 54  |$`.$.$ P#.`..$.T|</span>
<span class="tok-go">00000010  4c f7 4b 21 fb 24 f2 54  70 f7 43 21 fb 72 f2 f6  |L.K!.$.Tp.C!.r..|</span>
<span class="tok-go">00000020  00 b3 22 f0 20 44 00 00  00 00 00 00 00 0c 00 00  |..&quot;. D..........|</span>
<span class="tok-go">00000030  00 73 72 74 f7 22 f0 73  72 74 fb 22 f0 60 bb 40  |.srt.&quot;.srt.&quot;.`.@|</span>
<span class="tok-go">00000040  d1 40 11 23 fb 4c d0 12  24 f2 54 76 61 93 40 d0  |.@.#.L..$.Tva.@.|</span>
<span class="tok-go">00000050  70 12 f2 f1 11 f1 f2 2f  4f 24 f6 11 23 fb 70 81  |p....../O$..#.p.|</span>
<span class="tok-go">00000060  d0 4c 70 f9 a2 61 09 41  d0 11 24 f2 76 63 98 20  |.Lp..a.A..$.vc. |</span>
<span class="tok-go">00000070  62 03 20 20 20                                    |b.   |</span>
<span class="tok-go">00000075</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le &#8220;control byte&#8221; valant <code>0x24</code>, on peut alors extraire le code d&#8217;initialisation (fichier <code>t4_code.bin</code>)
et les données restantes sur le lien (fichier <code>t4_remaining.bin</code>) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>t1_channel_1.bin <span class="tok-nv">of</span><span class="tok-o">=</span>t4_code.bin <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">skip</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">count</span><span class="tok-o">=</span><span class="tok-k">$((</span><span class="tok-m">0</span>x24<span class="tok-k">))</span>
<span class="tok-go">36+0 records in</span>
<span class="tok-go">36+0 records out</span>
<span class="tok-go">36 bytes (36 B) copied, 0.000228839 s, 157 kB/s</span>
<span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>t1_channel_1.bin <span class="tok-nv">of</span><span class="tok-o">=</span>t4_remaining.bin <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">skip</span><span class="tok-o">=</span><span class="tok-k">$((</span><span class="tok-m">1</span><span class="tok-o">+</span><span class="tok-m">0</span>x24<span class="tok-k">))</span>
<span class="tok-go">80+0 records in</span>
<span class="tok-go">80+0 records out</span>
<span class="tok-go">80 bytes (80 B) copied, 0.000308885 s, 259 kB/s</span>
<span class="tok-gp">$</span> st20dis-linux t4_code.bin &gt; t4.asm</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le résultat du désassemblage du code d&#8217;initialisation est présenté ci-dessous :</p>
</div>
<div class="listingblock">
<div class="title">t4.asm</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="st20"><span class="tok-c">; New subroutine 0+9; References: 0, Local Vars: 3</span>
<span class="tok-nl">00000000:</span> <span class="tok-s">60 bd </span>    <span class="tok-nl">sub_0:</span>        <span class="tok-k">ajw</span> <span class="tok-mh">#-3</span>            <span class="tok-c">; réserve 3 variables</span>
<span class="tok-nl">00000002:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000004:</span> <span class="tok-s">24 20 50 </span>               <span class="tok-k">ldnlp</span> <span class="tok-mh">#400</span>
<span class="tok-nl">00000007:</span> <span class="tok-s">23 fc </span>                  <span class="tok-k">gajw</span>               <span class="tok-c">; Wptr = MostNeg @ 0x400</span>

<span class="tok-c">; New subroutine 9+1b; References: 0, Local Vars: 3</span>
<span class="tok-nl">00000009:</span> <span class="tok-s">60 bd </span>    <span class="tok-nl">sub_9:</span>        <span class="tok-k">ajw</span> <span class="tok-mh">#-3</span>            <span class="tok-c">; réserve 3 variables</span>
<span class="tok-nl">0000000b:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">0000000c:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000000e:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">0000000f:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000010:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(12, MostNeg @ 4, &amp;var_0)</span>
<span class="tok-nl">00000011:</span> <span class="tok-s">4b </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#b</span>
<span class="tok-nl">00000012:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[loc_1f]</span>
<span class="tok-nl">00000014:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000016:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">00000017:</span> <span class="tok-s">70 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>
<span class="tok-nl">00000018:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(var_0, MostNeg @ 4, loc_1f)</span>
<span class="tok-nl">00000019:</span> <span class="tok-s">43 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#3</span>
<span class="tok-nl">0000001a:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[loc_1f]</span>
<span class="tok-nl">0000001c:</span> <span class="tok-s">72 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#2</span> <span class="tok-no">[var_2]</span>
<span class="tok-nl">0000001d:</span> <span class="tok-s">f2 </span>                     <span class="tok-k">bsub</span>               <span class="tok-c">; A = var_2 + loc_1f</span>
<span class="tok-nl">0000001e:</span> <span class="tok-s">f6 </span>                     <span class="tok-k">gcall</span>              <span class="tok-c">; gcall(var_2 + loc_1f)</span>
<span class="tok-nl">0000001f:</span> <span class="tok-s">00 </span>       <span class="tok-nl">loc_1f:</span>       <span class="tok-k">nop</span>
<span class="tok-nl">00000020:</span> <span class="tok-s">b3 </span>                     <span class="tok-k">ajw</span> <span class="tok-mh">#3</span>
<span class="tok-nl">00000021:</span> <span class="tok-s">22 f0 </span>                  <span class="tok-k">ret</span>
<span class="tok-nl">00000023:</span> <span class="tok-s">20 </span>                     <span class="tok-s">.db</span> <span class="tok-mh">#20</span> <span class="tok-s">&#39; &#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce code d&#8217;initialisation réalise les opérations suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>lecture de 12 octets sur le channel 4, stockage à l&#8217;adresse <code>&amp;var_0</code> (les variables <code>var_0</code>, <code>var_1</code> et <code>var_2</code> sont donc mises à jour) ;</p>
</li>
<li>
<p>lecture de <code>var_0</code> octets sur le channel, stockage à l&#8217;adresse <code>loc_1f</code> ;</p>
</li>
<li>
<p>appel d&#8217;une fonction à l&#8217;adresse <code>loc_1f + var_2</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On peut alors s&#8217;intéresser aux données restantes sur le lien pour comprendre l&#8217;état des trois variables :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>t4_remaining.bin <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">count</span><span class="tok-o">=</span><span class="tok-m">12</span> <span class="tok-p">|</span> xxd -
<span class="tok-go">0000000: 4400 0000 0000 0000 0c00 0000            D...........</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les trois variables sont alors initialisées de la façon suivante :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>var_0</code> : <code>0x44</code> ;</p>
</li>
<li>
<p><code>var_1</code> : <code>0</code> ;</p>
</li>
<li>
<p><code>var_2</code> : <code>0xc</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le code d&#8217;initialisation va donc lire <code>0x44 = 68</code> octets sur le lien série,
stocker le résultat à l&#8217;adresse <code>loc_1f</code>, puis appeler une fonction à l&#8217;adresse
<code>loc_1f + 0xc</code>. Le code exécuté est extrait puis désassemblé avec les commandes ci-dessous :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>t4_remaining.bin <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">count</span><span class="tok-o">=</span><span class="tok-k">$((</span><span class="tok-m">0</span>x44<span class="tok-k">))</span> <span class="tok-nv">skip</span><span class="tok-o">=</span><span class="tok-m">12</span> &gt; t4_code_gcall.bin
<span class="tok-gp">$</span> hexdump -C t4_code_gcall.bin
<span class="tok-go">00000000  73 72 74 f7 22 f0 73 72  74 fb 22 f0 60 bb 40 d1  |srt.&quot;.srt.&quot;.`.@.|</span>
<span class="tok-go">00000010  40 11 23 fb 4c d0 12 24  f2 54 76 61 93 40 d0 70  |@.#.L..$.Tva.@.p|</span>
<span class="tok-go">00000020  12 f2 f1 11 f1 f2 2f 4f  24 f6 11 23 fb 70 81 d0  |....../O$..#.p..|</span>
<span class="tok-go">00000030  4c 70 f9 a2 61 09 41 d0  11 24 f2 76 63 98 20 62  |Lp..a.A..$.vc. b|</span>
<span class="tok-go">00000040  03 20 20 20                                       |.   |</span>
<span class="tok-go">00000044</span>
<span class="tok-gp">$</span> st20dis-linux t4_code_gcall.bin &gt; t4_code_gcall.asm
<span class="tok-gp">$</span> ls -al t4_remaining.bin
<span class="tok-go">-rw-rw-r-- 1 jpe jpe 80 avril 21 21:12 t4_remaining.bin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Au passage, on peut remarquer que le fichier <code>t4_remaining.bin</code> (80 octets) contient uniquement
les 12 octets permettant d&#8217;initialiser les trois variables et les <code>0x44 = 68</code> octets correspondant
au code exécuté par l&#8217;instruction <code>gcall</code> : il n&#8217;y a donc plus de données en attente sur le lien 0.</p>
</div>
<div class="paragraph">
<p>Le résultat du désassemblage est le suivant :</p>
</div>
<div id="_t4_code_gcall" class="listingblock">
<div class="title">t4_code_gcall.asm</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="st20"><span class="tok-c">; New subroutine 0+6; References: 1, Local Vars: 0</span>
<span class="tok-c">;       Called/referenced from 1b</span>
<span class="tok-nl">00000000:</span> <span class="tok-s">73 </span>    <span class="tok-nl">sub_0:</span>        <span class="tok-k">ldl</span> <span class="tok-mh">#3</span> <span class="tok-no">[arg_3]</span>
<span class="tok-nl">00000001:</span> <span class="tok-s">72 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#2</span> <span class="tok-no">[arg_2]</span>
<span class="tok-nl">00000002:</span> <span class="tok-s">74 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#4</span> <span class="tok-no">[arg_4]</span>
<span class="tok-nl">00000003:</span> <span class="tok-s">f7 </span>                  <span class="tok-k">in</span>                   <span class="tok-c">; in(arg_4, arg_2, arg_3)</span>
<span class="tok-nl">00000004:</span> <span class="tok-s">22 f0 </span>               <span class="tok-k">ret</span>

<span class="tok-c">; New subroutine 6+6; References: 1, Local Vars: 0</span>
<span class="tok-c">;       Called/referenced from 3c</span>
<span class="tok-nl">00000006:</span> <span class="tok-s">73 </span>    <span class="tok-nl">sub_6:</span>        <span class="tok-k">ldl</span> <span class="tok-mh">#3</span> <span class="tok-no">[arg_3]</span>
<span class="tok-nl">00000007:</span> <span class="tok-s">72 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#2</span> <span class="tok-no">[arg_2]</span>
<span class="tok-nl">00000008:</span> <span class="tok-s">74 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#4</span> <span class="tok-no">[arg_4]</span>
<span class="tok-nl">00000009:</span> <span class="tok-s">fb </span>                  <span class="tok-k">out</span>                 <span class="tok-c">; out(arg_4, arg_2, arg_3)</span>
<span class="tok-nl">0000000a:</span> <span class="tok-s">22 f0 </span>               <span class="tok-k">ret</span>

<span class="tok-c">; New subroutine c+38; References: 0, Local Vars: 5</span>
<span class="tok-nl">0000000c:</span> <span class="tok-s">60 bb </span> <span class="tok-nl">sub_c:</span>        <span class="tok-k">ajw</span> <span class="tok-mh">#-5</span>               <span class="tok-c">; point d&#39;entrée</span>
<span class="tok-nl">0000000e:</span> <span class="tok-s">40 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">0000000f:</span> <span class="tok-s">d1 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#1</span> <span class="tok-no">[var_1]</span>        <span class="tok-c">; var_1 = 0</span>
<span class="tok-nl">00000010:</span> <span class="tok-s">40 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">00000011:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000012:</span> <span class="tok-s">23 fb </span>               <span class="tok-k">sb</span>                    <span class="tok-c">; var_1[0] = 0</span>
<span class="tok-nl">00000014:</span> <span class="tok-s">4c </span>    <span class="tok-nl">loc_14:</span>       <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000015:</span> <span class="tok-s">d0 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>        <span class="tok-c">; var_0 = 12</span>
<span class="tok-nl">00000016:</span> <span class="tok-s">12 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#2</span> <span class="tok-no">[&amp;var_2]</span>      <span class="tok-c">; A = &amp;var_2</span>
<span class="tok-nl">00000017:</span> <span class="tok-s">24 f2 </span>               <span class="tok-k">mint</span>                  <span class="tok-c">; A = MostNeg, B = &amp;var_2</span>
<span class="tok-nl">00000019:</span> <span class="tok-s">54 </span>                  <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>              <span class="tok-c">; A = MostNeg @ 4, B = &amp;var_2</span>
<span class="tok-nl">0000001a:</span> <span class="tok-s">76 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#6</span> <span class="tok-no">[arg_1]</span>        <span class="tok-c">; A = arg_1, B = MostNeg @ 4, C = &amp;var_2</span>
<span class="tok-nl">0000001b:</span> <span class="tok-s">61 93 </span>               <span class="tok-k">call</span> <span class="tok-nl">sub_0</span>            <span class="tok-c">; sub_0(arg1, MostNeg @ 4, &amp;var_2) &lt;=&gt;</span>
                                                     <span class="tok-c">; in(var_0 = 12, MostNeg @ 4, &amp;var_2)</span>
<span class="tok-nl">0000001d:</span> <span class="tok-s">40 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">0000001e:</span> <span class="tok-s">d0 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>        <span class="tok-c">; var_0 = 0</span>
<span class="tok-nl">0000001f:</span> <span class="tok-s">70 </span>    <span class="tok-nl">loc_1f:</span>       <span class="tok-k">ldl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>
<span class="tok-nl">00000020:</span> <span class="tok-s">12 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#2</span> <span class="tok-no">[&amp;var_2]</span>
<span class="tok-nl">00000021:</span> <span class="tok-s">f2 </span>                  <span class="tok-k">bsub</span>
<span class="tok-nl">00000022:</span> <span class="tok-s">f1 </span>                  <span class="tok-k">lb</span>                    <span class="tok-c">; A = var_2[var_0]</span>
<span class="tok-nl">00000023:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000024:</span> <span class="tok-s">f1 </span>                  <span class="tok-k">lb</span>                    <span class="tok-c">; A = var_1[0], B = var_2[var_0]</span>
<span class="tok-nl">00000025:</span> <span class="tok-s">f2 </span>                  <span class="tok-k">bsub</span>                  <span class="tok-c">; A = var_1[0] + var_2[var_0]</span>
<span class="tok-nl">00000026:</span> <span class="tok-s">2f 4f </span>               <span class="tok-k">ldc</span> <span class="tok-mh">#ff</span>
<span class="tok-nl">00000028:</span> <span class="tok-s">24 f6 </span>               <span class="tok-k">and</span>                   <span class="tok-c">; A = (var_1[0] + var_2[var_0]) &amp; 0xff</span>
<span class="tok-nl">0000002a:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">0000002b:</span> <span class="tok-s">23 fb </span>               <span class="tok-k">sb</span>                    <span class="tok-c">; var_1[0] = (var_1[0] + var_2[var_0]) &amp; 0xff</span>
<span class="tok-nl">0000002d:</span> <span class="tok-s">70 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>
<span class="tok-nl">0000002e:</span> <span class="tok-s">81 </span>                  <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">0000002f:</span> <span class="tok-s">d0 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>        <span class="tok-c">; var_0 += 1</span>
<span class="tok-nl">00000030:</span> <span class="tok-s">4c </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000031:</span> <span class="tok-s">70 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>
<span class="tok-nl">00000032:</span> <span class="tok-s">f9 </span>                  <span class="tok-k">gt</span>
<span class="tok-nl">00000033:</span> <span class="tok-s">a2 </span>                  <span class="tok-k">cj</span> <span class="tok-nl">loc_36</span>             <span class="tok-c">; saute à loc_36 si var_0 &gt;= 12</span>
<span class="tok-nl">00000034:</span> <span class="tok-s">61 09 </span>               <span class="tok-k">j</span> <span class="tok-nl">loc_1f</span>              <span class="tok-c">; saute à loc_1f</span>
<span class="tok-nl">00000036:</span> <span class="tok-s">41 </span>    <span class="tok-nl">loc_36:</span>       <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000037:</span> <span class="tok-s">d0 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>        <span class="tok-c">; var_0 = 1</span>
<span class="tok-nl">00000038:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>      <span class="tok-c">; A = &amp;var_1</span>
<span class="tok-nl">00000039:</span> <span class="tok-s">24 f2 </span>               <span class="tok-k">mint</span>                  <span class="tok-c">; A = MostNeg, B = &amp;var_1</span>
<span class="tok-nl">0000003b:</span> <span class="tok-s">76 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#6</span> <span class="tok-no">[arg_1]</span>        <span class="tok-c">; A = arg_1, B = MostNeg, C = &amp;var_1</span>
<span class="tok-nl">0000003c:</span> <span class="tok-s">63 98 </span>               <span class="tok-k">call</span> <span class="tok-nl">sub_6</span>            <span class="tok-c">; sub_6(arg_1, MostNeg, &amp;var_1) &lt;=&gt;</span>
                                                     <span class="tok-c">; out(var_0 = 1, MostNeg, &amp;var_1)</span>
<span class="tok-nl">0000003e:</span> <span class="tok-s">20 </span>                  <span class="tok-s">.db</span> <span class="tok-mh">#20</span> <span class="tok-s">&#39; &#39;</span>
<span class="tok-nl">0000003f:</span> <span class="tok-s">62 03 </span>               <span class="tok-k">j</span> <span class="tok-nl">loc_14</span>              <span class="tok-c">; saute à loc_14</span>
<span class="tok-nl">00000041:</span> <span class="tok-s">20 </span>                  <span class="tok-s">.db</span> <span class="tok-mh">#20</span> <span class="tok-s">&#39; &#39;</span>
<span class="tok-nl">00000042:</span> <span class="tok-s">20 </span>                  <span class="tok-s">.db</span> <span class="tok-mh">#20</span> <span class="tok-s">&#39; &#39;</span>
<span class="tok-nl">00000043:</span> <span class="tok-s">20 </span>                  <span class="tok-s">.db</span> <span class="tok-mh">#20</span> <span class="tok-s">&#39; &#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exécution commence avec l&#8217;appel de la fonction <code>sub_c</code> (point d&#8217;entrée). On constate la présence
de deux boucles imbriquées, ainsi que des appels à deux fonctions, <code>sub_0</code> et <code>sub_6</code>. Pour
comprendre comment s&#8217;effectue le passage de paramètres, il est nécessaire de se référer à la
documentation. D&#8217;après celle-ci, les paramètres sont passés dans les registres <code>A</code>, <code>B</code>, <code>C</code> et
le pointeur de pile est décalé pour réserver 4 variables :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_st20_call.png" alt="rk st20 call">
</div>
</div>
<div class="paragraph">
<p>Les deux fonctions <code>sub_0</code> et <code>sub_6</code> font référence à un quatrième argument, <code>arg_4</code>. Il s&#8217;agit
en fait de la valeur stockée dans <code>var_0</code> au niveau de la fonction appelante.</p>
</div>
<div class="paragraph">
<p>La fonction <code>sub_c</code> peut être traduite dans le pseudo-code C ci-dessous :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="C"><span class="tok-cm">/* Transputer 4 */</span>
<span class="tok-kt">void</span> <span class="tok-nf">sub_c_t4</span><span class="tok-p">(</span><span class="tok-kt">uint32_t</span> <span class="tok-n">arg_1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">var_1</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_2</span><span class="tok-p">[</span><span class="tok-mi">12</span><span class="tok-p">];</span>

    <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-k">for</span> <span class="tok-p">(;;)</span> <span class="tok-p">{</span>
        <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-n">var_2</span><span class="tok-p">);</span>
        <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-n">var_1</span> <span class="tok-o">+</span> <span class="tok-n">var_2</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>
        <span class="tok-p">}</span>
        <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_1</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La fonction <code>sub_c</code> commence par initialiser un état (la variable <code>var_1</code>) puis
entre dans une boucle infinie. Celle-ci va lire 12 octets sur le channel 4 puis
entre dans une seconde boucle pour mettre à jour la variable <code>var_1</code> en fonction
des 12 octets lus. Enfin, le contenu de la variable <code>var_1</code> est envoyé sur le channel 0
et l&#8217;exécution reprend au début de la boucle infinie.</p>
</div>
<div class="paragraph">
<p>Les 12 octets lus sur le channel 4 correspondent aux données envoyées
par le transputer 1 (voir <a href="#_transputer_1">Pseudo-code transputer 1</a>), à savoir la clé courante. Le résultat est stocké à
l&#8217;adresse <code>var_2</code>.</p>
</div>
<div class="paragraph">
<p>Il faut maintenant analyser les transputers 5 à 12 de la même façon.
Le script Ruby ci-dessous automatise les opérations d&#8217;extraction
des différentes parties de code :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-no">Dir</span><span class="tok-o">[</span><span class="tok-s2">&quot;t*_channel_*.bin&quot;</span><span class="tok-o">].</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-nb">p</span><span class="tok-o">|</span>
  <span class="tok-nb">p</span> <span class="tok-o">=~</span> <span class="tok-sr">/t(\d)+_channel_(\d+)+\.bin/</span>
  <span class="tok-n">t_src</span><span class="tok-p">,</span> <span class="tok-n">c</span> <span class="tok-o">=</span> <span class="tok-vg">$1</span><span class="tok-o">.</span><span class="tok-n">to_i</span><span class="tok-p">,</span> <span class="tok-vg">$2</span><span class="tok-o">.</span><span class="tok-n">to_i</span>
  <span class="tok-n">t_dst</span> <span class="tok-o">=</span> <span class="tok-n">t_src</span> <span class="tok-o">*</span> <span class="tok-mi">3</span> <span class="tok-o">+</span> <span class="tok-n">c</span>
  <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-nb">p</span><span class="tok-p">,</span> <span class="tok-s2">&quot;rb&quot;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">read</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>

  <span class="tok-n">control_byte</span> <span class="tok-o">=</span> <span class="tok-n">data</span><span class="tok-o">.</span><span class="tok-n">shift</span>
  <span class="tok-n">init_code</span> <span class="tok-o">=</span> <span class="tok-n">data</span><span class="tok-o">.</span><span class="tok-n">shift</span><span class="tok-p">(</span><span class="tok-n">control_byte</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>

  <span class="tok-n">size</span><span class="tok-p">,</span> <span class="tok-n">_</span><span class="tok-p">,</span> <span class="tok-n">offset</span> <span class="tok-o">=</span> <span class="tok-o">*</span><span class="tok-n">data</span><span class="tok-o">.</span><span class="tok-n">shift</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;LLL&#39;</span><span class="tok-p">)</span>
  <span class="tok-n">code</span> <span class="tok-o">=</span> <span class="tok-n">data</span><span class="tok-o">.</span><span class="tok-n">shift</span><span class="tok-p">(</span><span class="tok-n">size</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">pack</span><span class="tok-p">(</span><span class="tok-s1">&#39;C*&#39;</span><span class="tok-p">)</span>

  <span class="tok-n">init_code_path</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;t</span><span class="tok-si">#{</span><span class="tok-n">t_dst</span><span class="tok-si">}</span><span class="tok-s2">_code.bin&quot;</span>
  <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-n">init_code_path</span><span class="tok-p">,</span> <span class="tok-s2">&quot;wb&quot;</span><span class="tok-p">)</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">f</span><span class="tok-o">|</span> <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">write</span> <span class="tok-n">init_code</span><span class="tok-p">}</span>

  <span class="tok-n">code_path</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;t</span><span class="tok-si">#{</span><span class="tok-n">t_dst</span><span class="tok-si">}</span><span class="tok-s2">_code_gcall.bin&quot;</span>
  <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-n">code_path</span><span class="tok-p">,</span> <span class="tok-s2">&quot;wb&quot;</span><span class="tok-p">)</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">f</span><span class="tok-o">|</span> <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">write</span> <span class="tok-n">code</span><span class="tok-p">}</span>

  <span class="tok-n">remaining</span> <span class="tok-o">=</span> <span class="tok-n">data</span><span class="tok-o">.</span><span class="tok-n">size</span>
  <span class="tok-nb">puts</span> <span class="tok-s2">&quot;T</span><span class="tok-si">#{</span><span class="tok-n">t_dst</span><span class="tok-si">}</span><span class="tok-s2">, init_code =&gt; </span><span class="tok-si">#{</span><span class="tok-n">init_code_path</span><span class="tok-si">}</span><span class="tok-s2">, code =&gt; </span><span class="tok-si">#{</span><span class="tok-n">code_path</span><span class="tok-si">}</span><span class="tok-s2">, offset: </span><span class="tok-si">#{</span><span class="tok-n">offset</span><span class="tok-si">}</span><span class="tok-s2">, remaining: </span><span class="tok-si">#{</span><span class="tok-n">remaining</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Son exécution retourne le résultat suivant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span>  ./extract.rb
<span class="tok-go">T12, init_code =&gt; t12_code.bin, code =&gt; t12_code_gcall.bin, offset: 12, remaining: 0</span>
<span class="tok-go">T10, init_code =&gt; t10_code.bin, code =&gt; t10_code_gcall.bin, offset: 12, remaining: 0</span>
<span class="tok-go">T6, init_code =&gt; t6_code.bin, code =&gt; t6_code_gcall.bin, offset: 12, remaining: 0</span>
<span class="tok-go">T11, init_code =&gt; t11_code.bin, code =&gt; t11_code_gcall.bin, offset: 12, remaining: 0</span>
<span class="tok-go">T4, init_code =&gt; t4_code.bin, code =&gt; t4_code_gcall.bin, offset: 12, remaining: 0</span>
<span class="tok-go">T5, init_code =&gt; t5_code.bin, code =&gt; t5_code_gcall.bin, offset: 12, remaining: 0</span>
<span class="tok-go">T7, init_code =&gt; t7_code.bin, code =&gt; t7_code_gcall.bin, offset: 12, remaining: 0</span>
<span class="tok-go">T9, init_code =&gt; t9_code.bin, code =&gt; t9_code_gcall.bin, offset: 12, remaining: 0</span>
<span class="tok-go">T8, init_code =&gt; t8_code.bin, code =&gt; t8_code_gcall.bin, offset: 12, remaining: 0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On constate que le code d&#8217;initialisation est identique pour tous ces transputers :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> md5sum t*_code.bin
<span class="tok-go">3baf20a3228b40f92da74bc37f1655b1  t10_code.bin</span>
<span class="tok-go">3baf20a3228b40f92da74bc37f1655b1  t11_code.bin</span>
<span class="tok-go">3baf20a3228b40f92da74bc37f1655b1  t12_code.bin</span>
<span class="tok-go">3baf20a3228b40f92da74bc37f1655b1  t4_code.bin</span>
<span class="tok-go">3baf20a3228b40f92da74bc37f1655b1  t5_code.bin</span>
<span class="tok-go">3baf20a3228b40f92da74bc37f1655b1  t6_code.bin</span>
<span class="tok-go">3baf20a3228b40f92da74bc37f1655b1  t7_code.bin</span>
<span class="tok-go">3baf20a3228b40f92da74bc37f1655b1  t8_code.bin</span>
<span class="tok-go">3baf20a3228b40f92da74bc37f1655b1  t9_code.bin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Par contre, le code correspondant à la fonction appelée par l&#8217;instruction <code>gcall</code> est différent
pour chaque transputer :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> md5sum t*_code_gcall.bin
<span class="tok-go">36301de282128261ce30c7c7ee9e7bbd  t10_code_gcall.bin</span>
<span class="tok-go">cd8aebe05554ed86a6f3ad427baa6518  t11_code_gcall.bin</span>
<span class="tok-go">33ae0ea641c046913845a24e2033cd34  t12_code_gcall.bin</span>
<span class="tok-go">51be7b81c12f08e0756fa2d91c70f199  t4_code_gcall.bin</span>
<span class="tok-go">94441e3bff1beafb2a871078875f6d8a  t5_code_gcall.bin</span>
<span class="tok-go">26f82821abe326242096929df7af0bcb  t6_code_gcall.bin</span>
<span class="tok-go">13433117ca2c08b05a2d67b43f8ff40c  t7_code_gcall.bin</span>
<span class="tok-go">e72410105cdc42151108b42000dc4c17  t8_code_gcall.bin</span>
<span class="tok-go">0107b594c3601eee98adc4bf7fae57d4  t9_code_gcall.bin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour poursuivre, il faut donc désassembler chacun de ces fichiers (sauf pour le transputer 4
qui a déjà été traité) puis analyser la sortie.</p>
</div>
<div class="paragraph">
<p>L&#8217;analyse du code désassemblé ne pose pas de difficultés particulières et peut être
effectuée de façon similaire à celle du transputer 4. Tous les transputers de 4 à 12 suivent
une même logique qui peut être décrite ainsi :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>initialisation d&#8217;un état (exemple : mise à zéro d&#8217;une variable) ;</p>
</li>
<li>
<p>démarrage d&#8217;une boucle infinie :</p>
<div class="ulist">
<ul>
<li>
<p>lecture des 12 octets de la clé courante,</p>
</li>
<li>
<p>mise à jour de l&#8217;état en fonction des 12 octets lus,</p>
</li>
<li>
<p>calcul de la valeur de retour,</p>
</li>
<li>
<p>envoi d&#8217;un octet de l&#8217;état et retour au début de la boucle.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le pseudo-code ci-dessous est obtenu pour les transputers 5 à 10 :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-cm">/* Transputer 5 */</span>
<span class="tok-kt">void</span> <span class="tok-nf">sub_c_t5</span><span class="tok-p">(</span><span class="tok-kt">uint32_t</span> <span class="tok-n">arg_1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">var_1</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_2</span><span class="tok-p">[</span><span class="tok-mi">12</span><span class="tok-p">];</span>

    <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-c1">// initialisation de l&#39;état</span>
    <span class="tok-k">for</span> <span class="tok-p">(;;)</span> <span class="tok-p">{</span>
        <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-n">var_2</span><span class="tok-p">);</span> <span class="tok-c1">// lecture de la clé</span>
        <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-n">var_1</span> <span class="tok-o">^</span> <span class="tok-n">var_2</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>
        <span class="tok-p">}</span>
        <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_1</span><span class="tok-p">);</span> <span class="tok-c1">// envoi du résultat</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-cm">/* Transputer 6 */</span>
<span class="tok-kt">void</span> <span class="tok-nf">sub_c_t6</span><span class="tok-p">(</span><span class="tok-kt">uint32_t</span> <span class="tok-n">arg1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint16_t</span> <span class="tok-n">k1</span><span class="tok-p">,</span> <span class="tok-n">k2</span><span class="tok-p">,</span> <span class="tok-n">k3</span><span class="tok-p">,</span> <span class="tok-n">var_1</span><span class="tok-p">,</span> <span class="tok-n">var_3</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_4</span><span class="tok-p">[</span><span class="tok-mi">12</span><span class="tok-p">];</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span>

    <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-n">var_3</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-k">for</span> <span class="tok-p">(;;)</span> <span class="tok-p">{</span>
        <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-n">var_4</span><span class="tok-p">);</span> <span class="tok-c1">// lecture de la clé</span>

        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">var_3</span> <span class="tok-o">==</span> <span class="tok-mi">0</span><span class="tok-p">)</span> <span class="tok-p">{</span> <span class="tok-c1">// initialisation de l&#39;état</span>
            <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">var_1</span> <span class="tok-o">+</span> <span class="tok-n">var_4</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">])</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xffff</span><span class="tok-p">;</span>
            <span class="tok-p">}</span>
            <span class="tok-n">var_3</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
        <span class="tok-p">}</span>

        <span class="tok-n">k1</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">var_1</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0x8000</span><span class="tok-p">)</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mh">0xf</span><span class="tok-p">;</span>
        <span class="tok-n">k2</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">var_1</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0x4000</span><span class="tok-p">)</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mh">0xe</span><span class="tok-p">;</span>
        <span class="tok-n">k2</span> <span class="tok-o">=</span> <span class="tok-n">k2</span> <span class="tok-o">^</span> <span class="tok-n">k1</span><span class="tok-p">;</span>
        <span class="tok-n">k3</span> <span class="tok-o">=</span> <span class="tok-n">var_1</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
        <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-n">k3</span> <span class="tok-o">^</span> <span class="tok-n">k2</span><span class="tok-p">;</span> <span class="tok-c1">// mise à jour de l&#39;état</span>
        <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_1</span><span class="tok-p">);</span> <span class="tok-c1">// envoi du résultat</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-cm">/* Transputer 7 */</span>
<span class="tok-kt">void</span> <span class="tok-nf">sub_c_t7</span><span class="tok-p">(</span><span class="tok-kt">uint32_t</span> <span class="tok-n">arg1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_1</span><span class="tok-p">,</span> <span class="tok-n">var_2</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">12</span><span class="tok-p">];</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span>

    <span class="tok-k">for</span> <span class="tok-p">(;;)</span> <span class="tok-p">{</span>
        <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_3</span><span class="tok-p">);</span> <span class="tok-c1">// lecture de la clé</span>
        <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
        <span class="tok-n">var_2</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>

        <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">6</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-n">var_1</span> <span class="tok-o">+=</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>
            <span class="tok-n">var_2</span> <span class="tok-o">+=</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-n">i</span> <span class="tok-o">+</span> <span class="tok-mi">6</span><span class="tok-p">];</span>
        <span class="tok-p">}</span>

        <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-n">var_1</span> <span class="tok-o">^</span> <span class="tok-n">var_2</span><span class="tok-p">;</span>
        <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_1</span><span class="tok-p">);</span> <span class="tok-c1">// envoi du résultat</span>
   <span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-cm">/* Transputer 8 */</span>
<span class="tok-kt">void</span> <span class="tok-nf">sub_c_t8</span><span class="tok-p">(</span><span class="tok-kt">uint32_t</span> <span class="tok-n">arg1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_1</span><span class="tok-p">,</span> <span class="tok-n">var_2</span><span class="tok-p">,</span> <span class="tok-n">var_3</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_4</span><span class="tok-p">[</span><span class="tok-mi">4</span><span class="tok-p">][</span><span class="tok-mi">12</span><span class="tok-p">];</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">j</span><span class="tok-p">;</span>

    <span class="tok-cm">/* initialisation de l&#39;état */</span>
    <span class="tok-n">var_2</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">4</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
       <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">j</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">j</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">j</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
           <span class="tok-n">var_4</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">][</span><span class="tok-n">j</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
       <span class="tok-p">}</span>
    <span class="tok-p">}</span>

    <span class="tok-k">for</span> <span class="tok-p">(;;)</span> <span class="tok-p">{</span>
        <span class="tok-cm">/* mise à jour de l&#39;état */</span>
        <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-n">var_4</span><span class="tok-p">[</span><span class="tok-n">var_2</span><span class="tok-p">]);</span> <span class="tok-c1">// lecture de la clé courante</span>
        <span class="tok-n">var_2</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">var_2</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-o">%</span> <span class="tok-mi">4</span><span class="tok-p">;</span>

        <span class="tok-cm">/* calcul du résultat */</span>
        <span class="tok-n">var_3</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
        <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">4</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
            <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">j</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">j</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">j</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                <span class="tok-n">var_1</span> <span class="tok-o">+=</span> <span class="tok-n">var_4</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">][</span><span class="tok-n">j</span><span class="tok-p">];</span>
            <span class="tok-p">}</span>
            <span class="tok-n">var_3</span> <span class="tok-o">=</span> <span class="tok-n">var_1</span> <span class="tok-o">^</span> <span class="tok-n">var_3</span><span class="tok-p">;</span>
        <span class="tok-p">}</span>
        <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_3</span><span class="tok-p">);</span> <span class="tok-c1">// envoi du résultat</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-cm">/* Transputer 9 */</span>
<span class="tok-kt">void</span> <span class="tok-nf">sub_c_t9</span><span class="tok-p">(</span><span class="tok-kt">uint32_t</span> <span class="tok-n">arg1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var1</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_2</span><span class="tok-p">[</span><span class="tok-mi">12</span><span class="tok-p">];</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span>

    <span class="tok-k">for</span> <span class="tok-p">(;;)</span> <span class="tok-p">{</span>
        <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
        <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-n">var_2</span><span class="tok-p">);</span> <span class="tok-c1">// lecture de la clé</span>
        <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-n">var_1</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-n">var_2</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">&amp;</span> <span class="tok-mi">7</span><span class="tok-p">));</span>
        <span class="tok-p">}</span>
        <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_1</span><span class="tok-p">);</span> <span class="tok-c1">// envoi du résultat</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-cm">/* Transputer 10 */</span>
<span class="tok-kt">void</span> <span class="tok-nf">sub_c_t10</span><span class="tok-p">(</span><span class="tok-kt">uint32_t</span> <span class="tok-n">arg1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_1</span><span class="tok-p">,</span> <span class="tok-n">var_2</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_4</span><span class="tok-p">[</span><span class="tok-mi">4</span><span class="tok-p">][</span><span class="tok-mi">12</span><span class="tok-p">];</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">j</span><span class="tok-p">;</span>

    <span class="tok-cm">/* initialisation de l&#39;état */</span>
    <span class="tok-n">var_2</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">4</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
       <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">j</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">j</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">j</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
           <span class="tok-n">var_4</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">][</span><span class="tok-n">j</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
       <span class="tok-p">}</span>
    <span class="tok-p">}</span>

    <span class="tok-k">for</span> <span class="tok-p">(;;)</span> <span class="tok-p">{</span>
        <span class="tok-cm">/* mise à jour de l&#39;état */</span>
        <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-n">var_4</span><span class="tok-p">[</span><span class="tok-n">var_2</span><span class="tok-p">]);</span> <span class="tok-c1">// lecture de la clé courante</span>
        <span class="tok-n">var_2</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">var_2</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-o">%</span> <span class="tok-mi">4</span><span class="tok-p">;</span>

        <span class="tok-cm">/* calcul du résultat */</span>
        <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
        <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">4</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-n">var_1</span> <span class="tok-o">+=</span> <span class="tok-n">var_4</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">][</span><span class="tok-mi">0</span><span class="tok-p">];</span>
        <span class="tok-p">}</span>
        <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-n">var_1</span> <span class="tok-o">&amp;</span> <span class="tok-mi">3</span><span class="tok-p">;</span>
        <span class="tok-n">j</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">var_1</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">4</span><span class="tok-p">)</span> <span class="tok-o">%</span> <span class="tok-mi">12</span><span class="tok-p">;</span>
        <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-n">var_4</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">][</span><span class="tok-n">j</span><span class="tok-p">];</span>

        <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_1</span><span class="tok-p">);</span> <span class="tok-c1">// envoi du résultat</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les transputers 11 et 12 présentent cependant une particularité par rapport aux précédents :
ils sont en effet reliés par un lien de communication. Pour comprendre l&#8217;utilité de celui-ci,
il faut examiner le code assembleur des deux transputers.</p>
</div>
<div class="paragraph">
<p>Le code du transputer 11 est présenté ci-dessous :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="st20"><span class="tok-nl">0000000c:</span> <span class="tok-s">60 ba </span> <span class="tok-nl">sub_c:</span>        <span class="tok-k">ajw</span> <span class="tok-mh">#-6</span>
<span class="tok-nl">0000000e:</span> <span class="tok-s">40 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">0000000f:</span> <span class="tok-s">d1 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#1</span> <span class="tok-no">[var_1]</span>      <span class="tok-c">; var_1 = 0</span>
<span class="tok-nl">00000010:</span> <span class="tok-s">40 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">00000011:</span> <span class="tok-s">d2 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#2</span> <span class="tok-no">[var_2]</span>      <span class="tok-c">; var_2 = 0</span>
<span class="tok-nl">00000012:</span> <span class="tok-s">4c </span>    <span class="tok-nl">loc_12:</span>       <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000013:</span> <span class="tok-s">d0 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>      <span class="tok-c">; var_0 = 12</span>
<span class="tok-nl">00000014:</span> <span class="tok-s">13 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#3</span> <span class="tok-no">[&amp;var_3]</span>
<span class="tok-nl">00000015:</span> <span class="tok-s">24 f2 </span>               <span class="tok-k">mint</span>
<span class="tok-nl">00000017:</span> <span class="tok-s">54 </span>                  <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">00000018:</span> <span class="tok-s">77 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#7</span> <span class="tok-no">[arg_1]</span>
<span class="tok-nl">00000019:</span> <span class="tok-s">61 95 </span>               <span class="tok-k">call</span> <span class="tok-nl">sub_0</span>           <span class="tok-c">; in(12, MostNeg @ 4, &amp;var_3)</span>
<span class="tok-nl">0000001b:</span> <span class="tok-s">40 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">0000001c:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">0000001d:</span> <span class="tok-s">23 fb </span>               <span class="tok-k">sb</span>                   <span class="tok-c">; var_1[0] = 0</span>
<span class="tok-nl">0000001f:</span> <span class="tok-s">13 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#3</span> <span class="tok-no">[&amp;var_3]</span>
<span class="tok-nl">00000020:</span> <span class="tok-s">f1 </span>                  <span class="tok-k">lb</span>                   <span class="tok-c">; A = var_3[0]</span>
<span class="tok-nl">00000021:</span> <span class="tok-s">13 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#3</span> <span class="tok-no">[&amp;var_3]</span>
<span class="tok-nl">00000022:</span> <span class="tok-s">83 </span>                  <span class="tok-k">adc</span> <span class="tok-mh">#3</span>
<span class="tok-nl">00000023:</span> <span class="tok-s">f1 </span>                  <span class="tok-k">lb</span>                   <span class="tok-c">; A = var_3[3], B = var_3[0]</span>
<span class="tok-nl">00000024:</span> <span class="tok-s">23 f3 </span>               <span class="tok-k">xor</span>                  <span class="tok-c">; A = var_3[3] ^ var_3[0]</span>
<span class="tok-nl">00000026:</span> <span class="tok-s">13 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#3</span> <span class="tok-no">[&amp;var_3]</span>
<span class="tok-nl">00000027:</span> <span class="tok-s">87 </span>                  <span class="tok-k">adc</span> <span class="tok-mh">#7</span>
<span class="tok-nl">00000028:</span> <span class="tok-s">f1 </span>                  <span class="tok-k">lb</span>                   <span class="tok-c">; A = var_3[7], B = var_3[3] ^ var_3[0]</span>
<span class="tok-nl">00000029:</span> <span class="tok-s">23 f3 </span>               <span class="tok-k">xor</span>                  <span class="tok-c">; A = var_3[7] ^ ( var_3[3] ^ var_3[0] )</span>
<span class="tok-nl">0000002b:</span> <span class="tok-s">2f 4f </span>               <span class="tok-k">ldc</span> <span class="tok-mh">#ff</span>              <span class="tok-c">;</span>
<span class="tok-nl">0000002d:</span> <span class="tok-s">24 f6 </span>               <span class="tok-k">and</span>                  <span class="tok-c">;</span>
<span class="tok-nl">0000002f:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>     <span class="tok-c">;</span>
<span class="tok-nl">00000030:</span> <span class="tok-s">23 fb </span>               <span class="tok-k">sb</span>                   <span class="tok-c">; var_1[0] = ( var_3[7] ^ ( var_3[3] ^ var_3[0] ) ) &amp; 0xff</span>
<span class="tok-nl">00000032:</span> <span class="tok-s">41 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000033:</span> <span class="tok-s">d0 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>
<span class="tok-nl">00000034:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000035:</span> <span class="tok-s">24 f2 </span>               <span class="tok-k">mint</span>
<span class="tok-nl">00000037:</span> <span class="tok-s">51 </span>                  <span class="tok-k">ldnlp</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000038:</span> <span class="tok-s">77 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#7</span> <span class="tok-no">[arg_1]</span>
<span class="tok-nl">00000039:</span> <span class="tok-s">63 9b </span>               <span class="tok-k">call</span> <span class="tok-nl">sub_6</span>           <span class="tok-c">; out(1, MostNeg @ 1, &amp;var_1)</span>
                                                    <span class="tok-c">; envoi d&#39;un octet à T12</span>
<span class="tok-nl">0000003b:</span> <span class="tok-s">41 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">0000003c:</span> <span class="tok-s">d0 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>
<span class="tok-nl">0000003d:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">0000003e:</span> <span class="tok-s">24 f2 </span>               <span class="tok-k">mint</span>
<span class="tok-nl">00000040:</span> <span class="tok-s">55 </span>                  <span class="tok-k">ldnlp</span> <span class="tok-mh">#5</span>
<span class="tok-nl">00000041:</span> <span class="tok-s">77 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#7</span> <span class="tok-no">[arg_1]</span>
<span class="tok-nl">00000042:</span> <span class="tok-s">64 9c </span>               <span class="tok-k">call</span> <span class="tok-nl">sub_0</span>           <span class="tok-c">; in(1, MostNeg @ 5, &amp;var_1)</span>
                                                    <span class="tok-c">; lecture d&#39;un octet depuis T12</span>
<span class="tok-nl">00000044:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000045:</span> <span class="tok-s">f1 </span>                  <span class="tok-k">lb</span>
<span class="tok-nl">00000046:</span> <span class="tok-s">4c </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000047:</span> <span class="tok-s">21 ff </span>               <span class="tok-k">rem</span>                  <span class="tok-c">; A = var_1[0] % 12</span>
<span class="tok-nl">00000049:</span> <span class="tok-s">2f 4f </span>               <span class="tok-k">ldc</span> <span class="tok-mh">#ff</span>
<span class="tok-nl">0000004b:</span> <span class="tok-s">24 f6 </span>               <span class="tok-k">and</span>
<span class="tok-nl">0000004d:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">0000004e:</span> <span class="tok-s">23 fb </span>               <span class="tok-k">sb</span>                   <span class="tok-c">; var_1[0] = (var_1[0] % 12) &amp; 0xff</span>
<span class="tok-nl">00000050:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000051:</span> <span class="tok-s">f1 </span>                  <span class="tok-k">lb</span>
<span class="tok-nl">00000052:</span> <span class="tok-s">13 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#3</span> <span class="tok-no">[&amp;var_3]</span>
<span class="tok-nl">00000053:</span> <span class="tok-s">f2 </span>                  <span class="tok-k">bsub</span>
<span class="tok-nl">00000054:</span> <span class="tok-s">f1 </span>                  <span class="tok-k">lb</span>                   <span class="tok-c">; A = var_3[var_1[0]]</span>
<span class="tok-nl">00000055:</span> <span class="tok-s">12 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#2</span> <span class="tok-no">[&amp;var_2]</span>
<span class="tok-nl">00000056:</span> <span class="tok-s">23 fb </span>               <span class="tok-k">sb</span>                   <span class="tok-c">; var_2[0] = var_3[var_1[0]]</span>
<span class="tok-nl">00000058:</span> <span class="tok-s">41 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000059:</span> <span class="tok-s">d0 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>
<span class="tok-nl">0000005a:</span> <span class="tok-s">12 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#2</span> <span class="tok-no">[&amp;var_2]</span>
<span class="tok-nl">0000005b:</span> <span class="tok-s">24 f2 </span>               <span class="tok-k">mint</span>
<span class="tok-nl">0000005d:</span> <span class="tok-s">77 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#7</span> <span class="tok-no">[arg_1]</span>
<span class="tok-nl">0000005e:</span> <span class="tok-s">65 96 </span>               <span class="tok-k">call</span> <span class="tok-nl">sub_6</span>           <span class="tok-c">; out(1, MostNeg, &amp;var_2)</span>
<span class="tok-nl">00000060:</span> <span class="tok-s">20 </span>                  <span class="tok-s">.db</span> <span class="tok-mh">#20</span> <span class="tok-s">&#39; &#39;</span>
<span class="tok-nl">00000061:</span> <span class="tok-s">65 0f </span>               <span class="tok-k">j</span> <span class="tok-nl">loc_12</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les opérations suivantes sont donc effectuées :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>mise à zéro de <code>var_1</code> et <code>var_2</code> ;</p>
</li>
<li>
<p>début de la boucle infinie :</p>
<div class="ulist">
<ul>
<li>
<p>lecture des 12 octets de clé dans <code>var_3</code>,</p>
</li>
<li>
<p>mise à jour de <code>var_1</code> en fonction des 12 octets lus,</p>
</li>
<li>
<p>envoi de la nouvelle valeur de <code>var_1</code> au transputer 12,</p>
</li>
<li>
<p>lecture d&#8217;une nouvelle valeur de <code>var_1</code> depuis le transputer 12,</p>
</li>
<li>
<p>mise à jour de <code>var_2</code> selon l&#8217;opération <code>var_2 = var_3[var_1 % 12]</code>,</p>
</li>
<li>
<p>envoi de <code>var_2</code> sur le lien 0 puis retour au début de la boucle.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le pseudo-code C correspondant est présenté ci-dessous :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-cm">/* Transputer 11 */</span>
<span class="tok-kt">void</span> <span class="tok-nf">sub_c_t11</span><span class="tok-p">(</span><span class="tok-kt">uint32_t</span> <span class="tok-n">arg1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
   <span class="tok-kt">uint8_t</span> <span class="tok-n">var_1</span><span class="tok-p">,</span> <span class="tok-n">var_2</span><span class="tok-p">;</span>
   <span class="tok-kt">uint8_t</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">12</span><span class="tok-p">];</span>

   <span class="tok-k">for</span> <span class="tok-p">(;;)</span> <span class="tok-p">{</span>
       <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-n">var_3</span><span class="tok-p">);</span> <span class="tok-c1">// lecture de la clé courante</span>
       <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">7</span><span class="tok-p">]</span> <span class="tok-o">^</span> <span class="tok-p">(</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]</span> <span class="tok-o">^</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-p">);</span>

       <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_1</span><span class="tok-p">);</span> <span class="tok-c1">// envoi d&#39;un octet au transputer 12</span>
       <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">5</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_1</span><span class="tok-p">);</span>  <span class="tok-c1">// lecture d&#39;un octet depuis le transputer 12</span>

       <span class="tok-n">var_2</span> <span class="tok-o">=</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-n">var_1</span> <span class="tok-o">%</span> <span class="tok-mi">12</span><span class="tok-p">];</span>
       <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_2</span><span class="tok-p">);</span> <span class="tok-c1">// envoi du résultat sur le lien 0</span>
   <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Une analyse similaire est alors effectuée sur le code du transputer 12 :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="st20"><span class="tok-nl">0000000c:</span> <span class="tok-s">60 ba </span> <span class="tok-nl">sub_c:</span>        <span class="tok-k">ajw</span> <span class="tok-mh">#-6</span>
<span class="tok-nl">0000000e:</span> <span class="tok-s">40 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">0000000f:</span> <span class="tok-s">d2 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#2</span> <span class="tok-no">[var_2]</span>    <span class="tok-c">; var_2 = 0</span>
<span class="tok-nl">00000010:</span> <span class="tok-s">40 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">00000011:</span> <span class="tok-s">d1 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#1</span> <span class="tok-no">[var_1]</span>    <span class="tok-c">; var_1 = 0</span>
<span class="tok-nl">00000012:</span> <span class="tok-s">40 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">00000013:</span> <span class="tok-s">d0 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>    <span class="tok-c">; var_0 = 0</span>
<span class="tok-nl">00000014:</span> <span class="tok-s">40 </span>    <span class="tok-nl">loc_14:</span>       <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">00000015:</span> <span class="tok-s">70 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>
<span class="tok-nl">00000016:</span> <span class="tok-s">13 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#3</span> <span class="tok-no">[&amp;var_3]</span>
<span class="tok-nl">00000017:</span> <span class="tok-s">f2 </span>                  <span class="tok-k">bsub</span>
<span class="tok-nl">00000018:</span> <span class="tok-s">23 fb </span>               <span class="tok-k">sb</span>                <span class="tok-c">; var_3[var_0] = 0</span>
<span class="tok-nl">0000001a:</span> <span class="tok-s">70 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>
<span class="tok-nl">0000001b:</span> <span class="tok-s">81 </span>                  <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">0000001c:</span> <span class="tok-s">d0 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>    <span class="tok-c">; var_0 += 1</span>
<span class="tok-nl">0000001d:</span> <span class="tok-s">4c </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000001e:</span> <span class="tok-s">70 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>
<span class="tok-nl">0000001f:</span> <span class="tok-s">f9 </span>                  <span class="tok-k">gt</span>
<span class="tok-nl">00000020:</span> <span class="tok-s">a2 </span>                  <span class="tok-k">cj</span> <span class="tok-nl">loc_23</span>         <span class="tok-c">; saute à loc_23 si var_0 &gt;= 12</span>
<span class="tok-nl">00000021:</span> <span class="tok-s">60 01 </span>               <span class="tok-k">j</span> <span class="tok-nl">loc_14</span>          <span class="tok-c">; saute à loc_14</span>
<span class="tok-nl">00000023:</span> <span class="tok-s">40 </span>    <span class="tok-nl">loc_23:</span>       <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">00000024:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000025:</span> <span class="tok-s">23 fb </span>               <span class="tok-k">sb</span>                <span class="tok-c">; var_1[0] = 0</span>
<span class="tok-nl">00000027:</span> <span class="tok-s">13 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#3</span> <span class="tok-no">[&amp;var_3]</span>
<span class="tok-nl">00000028:</span> <span class="tok-s">81 </span>                  <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000029:</span> <span class="tok-s">f1 </span>                  <span class="tok-k">lb</span>                <span class="tok-c">; A = var_3[1]</span>
<span class="tok-nl">0000002a:</span> <span class="tok-s">13 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#3</span> <span class="tok-no">[&amp;var_3]</span>
<span class="tok-nl">0000002b:</span> <span class="tok-s">85 </span>                  <span class="tok-k">adc</span> <span class="tok-mh">#5</span>
<span class="tok-nl">0000002c:</span> <span class="tok-s">f1 </span>                  <span class="tok-k">lb</span>                <span class="tok-c">; A = var_3[5], B = var_3[1]</span>
<span class="tok-nl">0000002d:</span> <span class="tok-s">23 f3 </span>               <span class="tok-k">xor</span>               <span class="tok-c">; A = var_3[5] ^ var_3[1]</span>
<span class="tok-nl">0000002f:</span> <span class="tok-s">13 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#3</span> <span class="tok-no">[&amp;var_3]</span>
<span class="tok-nl">00000030:</span> <span class="tok-s">89 </span>                  <span class="tok-k">adc</span> <span class="tok-mh">#9</span>
<span class="tok-nl">00000031:</span> <span class="tok-s">f1 </span>                  <span class="tok-k">lb</span>                <span class="tok-c">; A = var_3[9], B = var_3[5] ^ var_3[1]</span>
<span class="tok-nl">00000032:</span> <span class="tok-s">23 f3 </span>               <span class="tok-k">xor</span>               <span class="tok-c">; A = var_3[9] ^ (var_3[5] ^ var_3[1])</span>
<span class="tok-nl">00000034:</span> <span class="tok-s">2f 4f </span>               <span class="tok-k">ldc</span> <span class="tok-mh">#ff</span>
<span class="tok-nl">00000036:</span> <span class="tok-s">24 f6 </span>               <span class="tok-k">and</span>
<span class="tok-nl">00000038:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000039:</span> <span class="tok-s">23 fb </span>               <span class="tok-k">sb</span>                <span class="tok-c">; var_1[0] = (var_3[9] ^ (var_3[5] ^ var_3[1])) &amp; 0xff</span>
<span class="tok-nl">0000003b:</span> <span class="tok-s">4c </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000003c:</span> <span class="tok-s">d0 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>
<span class="tok-nl">0000003d:</span> <span class="tok-s">13 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#3</span> <span class="tok-no">[&amp;var_3]</span>
<span class="tok-nl">0000003e:</span> <span class="tok-s">24 f2 </span>               <span class="tok-k">mint</span>
<span class="tok-nl">00000040:</span> <span class="tok-s">54 </span>                  <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">00000041:</span> <span class="tok-s">77 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#7</span> <span class="tok-no">[arg_1]</span>
<span class="tok-nl">00000042:</span> <span class="tok-s">64 9c </span>               <span class="tok-k">call</span> <span class="tok-nl">sub_0</span>        <span class="tok-c">; in(12, MostNeg @ 4, &amp;var_3)</span>
                                                 <span class="tok-c">; lecture des 12 octets de clé courante</span>
<span class="tok-nl">00000044:</span> <span class="tok-s">41 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000045:</span> <span class="tok-s">d0 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>
<span class="tok-nl">00000046:</span> <span class="tok-s">12 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#2</span> <span class="tok-no">[&amp;var_2]</span>
<span class="tok-nl">00000047:</span> <span class="tok-s">24 f2 </span>               <span class="tok-k">mint</span>
<span class="tok-nl">00000049:</span> <span class="tok-s">55 </span>                  <span class="tok-k">ldnlp</span> <span class="tok-mh">#5</span>
<span class="tok-nl">0000004a:</span> <span class="tok-s">77 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#7</span> <span class="tok-no">[arg_1]</span>
<span class="tok-nl">0000004b:</span> <span class="tok-s">64 93 </span>               <span class="tok-k">call</span> <span class="tok-nl">sub_0</span>       <span class="tok-c">; in(1, MostNeg @ 5, &amp;var_2)</span>
                                                <span class="tok-c">; lecture d&#39;un octet depuis le transputer 11</span>
<span class="tok-nl">0000004d:</span> <span class="tok-s">41 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">0000004e:</span> <span class="tok-s">d0 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>
<span class="tok-nl">0000004f:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000050:</span> <span class="tok-s">24 f2 </span>               <span class="tok-k">mint</span>
<span class="tok-nl">00000052:</span> <span class="tok-s">51 </span>                  <span class="tok-k">ldnlp</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000053:</span> <span class="tok-s">77 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#7</span> <span class="tok-no">[arg_1]</span>
<span class="tok-nl">00000054:</span> <span class="tok-s">64 90 </span>               <span class="tok-k">call</span> <span class="tok-nl">sub_6</span>       <span class="tok-c">; out(1, MostNeg @ 1, &amp;var_1)</span>
                                                <span class="tok-c">; envoi d&#39;un octet vers le transputer 11</span>
<span class="tok-nl">00000056:</span> <span class="tok-s">12 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#2</span> <span class="tok-no">[&amp;var_2]</span>
<span class="tok-nl">00000057:</span> <span class="tok-s">f1 </span>                  <span class="tok-k">lb</span>
<span class="tok-nl">00000058:</span> <span class="tok-s">4c </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000059:</span> <span class="tok-s">21 ff </span>               <span class="tok-k">rem</span>
<span class="tok-nl">0000005b:</span> <span class="tok-s">2f 4f </span>               <span class="tok-k">ldc</span> <span class="tok-mh">#ff</span>
<span class="tok-nl">0000005d:</span> <span class="tok-s">24 f6 </span>               <span class="tok-k">and</span>
<span class="tok-nl">0000005f:</span> <span class="tok-s">12 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#2</span> <span class="tok-no">[&amp;var_2]</span>
<span class="tok-nl">00000060:</span> <span class="tok-s">23 fb </span>               <span class="tok-k">sb</span>               <span class="tok-c">; var_2[0] = (var_2[0] % 12) &amp; 0xff</span>
<span class="tok-nl">00000062:</span> <span class="tok-s">12 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#2</span> <span class="tok-no">[&amp;var_2]</span>
<span class="tok-nl">00000063:</span> <span class="tok-s">f1 </span>                  <span class="tok-k">lb</span>
<span class="tok-nl">00000064:</span> <span class="tok-s">13 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#3</span> <span class="tok-no">[&amp;var_3]</span>
<span class="tok-nl">00000065:</span> <span class="tok-s">f2 </span>                  <span class="tok-k">bsub</span>
<span class="tok-nl">00000066:</span> <span class="tok-s">f1 </span>                  <span class="tok-k">lb</span>
<span class="tok-nl">00000067:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000068:</span> <span class="tok-s">23 fb </span>               <span class="tok-k">sb</span>               <span class="tok-c">; var_1[0] = var_3[var_2[0]]</span>
<span class="tok-nl">0000006a:</span> <span class="tok-s">41 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">0000006b:</span> <span class="tok-s">d0 </span>                  <span class="tok-k">stl</span> <span class="tok-mh">#0</span> <span class="tok-no">[var_0]</span>
<span class="tok-nl">0000006c:</span> <span class="tok-s">11 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">0000006d:</span> <span class="tok-s">24 f2 </span>               <span class="tok-k">mint</span>
<span class="tok-nl">0000006f:</span> <span class="tok-s">77 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#7</span> <span class="tok-no">[arg_1]</span>
<span class="tok-nl">00000070:</span> <span class="tok-s">66 94 </span>               <span class="tok-k">call</span> <span class="tok-nl">sub_6</span>       <span class="tok-c">; out(1, MostNeg, &amp;var_1)</span>
<span class="tok-nl">00000072:</span> <span class="tok-s">20 </span>                  <span class="tok-s">.db</span> <span class="tok-mh">#20</span> <span class="tok-s">&#39; &#39;</span>
<span class="tok-nl">00000073:</span> <span class="tok-s">65 0e </span>               <span class="tok-k">j</span> <span class="tok-nl">loc_23</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le transputer 12 effectue les opérations suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>initialisation d&#8217;un état : 12 octets mis à 0 à l&#8217;adresse <code>&amp;var_3</code> ;</p>
</li>
<li>
<p>début de la boucle infinie :</p>
<div class="ulist">
<ul>
<li>
<p>mise à jour de la variable <code>var_1</code> en fonction des données de <code>var_3</code>,</p>
</li>
<li>
<p>lecture et stockage dans <code>var_3</code> des 12 octets de la clé courante,</p>
</li>
<li>
<p>lecture et stockage dans <code>var_2</code> d&#8217;un octet lu depuis le transputer 11,</p>
</li>
<li>
<p>envoi du contenu de <code>var_1</code> vers le transputer 11,</p>
</li>
<li>
<p>mise à jour de <code>var_1</code> selon l&#8217;opération <code>var_1 = var_3[var_2 % 12]</code>,</p>
</li>
<li>
<p>envoi de <code>var_1</code> sur le lien 0 et retour au début de la boucle.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le pseudo-code C correspondant est :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-cm">/* Transputer 12 */</span>
<span class="tok-kt">void</span> <span class="tok-nf">sub_c_t12</span><span class="tok-p">(</span><span class="tok-kt">uint32_t</span> <span class="tok-n">arg1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-kt">uint8_t</span> <span class="tok-n">var1</span><span class="tok-p">,</span> <span class="tok-n">var2</span><span class="tok-p">;</span>
  <span class="tok-kt">uint8_t</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">12</span><span class="tok-p">];</span>

  <span class="tok-n">memset</span><span class="tok-p">(</span><span class="tok-n">var_3</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">);</span> <span class="tok-c1">// initialisation de l&#39;état</span>
  <span class="tok-k">for</span> <span class="tok-p">(;;)</span> <span class="tok-p">{</span>
     <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">9</span><span class="tok-p">]</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">5</span><span class="tok-p">]</span> <span class="tok-o">^</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]);</span>
     <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-n">var_3</span><span class="tok-p">);</span> <span class="tok-c1">// lecture de la clé courante, mise à jour de l&#39;état</span>

     <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">5</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_2</span><span class="tok-p">);</span> <span class="tok-c1">// lecture d&#39;un octet depuis le transputer 11</span>
     <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_1</span><span class="tok-p">);</span> <span class="tok-c1">// envoi d&#39;un octet vers le transputer 11</span>

     <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-n">var_2</span> <span class="tok-o">%</span> <span class="tok-mi">12</span><span class="tok-p">];</span>
     <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_1</span><span class="tok-p">);</span> <span class="tok-c1">// envoi du résultat sur le lien 0</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le lien entre les transputers 11 et 12 ne sert finalement qu&#8217;à échanger un octet.
Il est donc possible de les rendre indépendants l&#8217;un de l&#8217;autre en transposant le calcul
de la valeur échangée. La gestion de l&#8217;état faite par le transputer 12 doit également
être transposée au niveau du transputer 11 car la valeur envoyée dépend de cet état.</p>
</div>
<div class="paragraph">
<p>Le résultat en pseudo-code est alors le suivant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">void</span> <span class="tok-nf">sub_c_t11</span><span class="tok-p">(</span><span class="tok-kt">uint32_t</span> <span class="tok-n">arg1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
   <span class="tok-kt">uint8_t</span> <span class="tok-n">var_1</span><span class="tok-p">,</span> <span class="tok-n">var_2</span><span class="tok-p">;</span>
   <span class="tok-kt">uint8_t</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">12</span><span class="tok-p">];</span>

   <span class="tok-n">memset</span><span class="tok-p">(</span><span class="tok-n">var_3</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">);</span> <span class="tok-c1">// initialisation de l&#39;état</span>
   <span class="tok-k">for</span> <span class="tok-p">(;;)</span> <span class="tok-p">{</span>
       <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">9</span><span class="tok-p">]</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">5</span><span class="tok-p">]</span> <span class="tok-o">^</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]);</span>
       <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-n">var_3</span><span class="tok-p">);</span> <span class="tok-c1">// lecture de la clé courante, mise à jour de l&#39;état</span>

       <span class="tok-n">var_2</span> <span class="tok-o">=</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-n">var_1</span> <span class="tok-o">%</span> <span class="tok-mi">12</span><span class="tok-p">];</span>
       <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_2</span><span class="tok-p">);</span> <span class="tok-c1">// envoi du résultat sur le lien 0</span>
   <span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-kt">void</span> <span class="tok-nf">sub_c_t12</span><span class="tok-p">(</span><span class="tok-kt">uint32_t</span> <span class="tok-n">arg1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
  <span class="tok-kt">uint8_t</span> <span class="tok-n">var1</span><span class="tok-p">,</span> <span class="tok-n">var2</span><span class="tok-p">;</span>
  <span class="tok-kt">uint8_t</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">12</span><span class="tok-p">];</span>

  <span class="tok-k">for</span> <span class="tok-p">(;;)</span> <span class="tok-p">{</span>
     <span class="tok-n">in</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-n">var_3</span><span class="tok-p">);</span> <span class="tok-c1">// lecture de la clé courante</span>
     <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">7</span><span class="tok-p">]</span> <span class="tok-o">^</span> <span class="tok-p">(</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]</span> <span class="tok-o">^</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-p">);</span>

     <span class="tok-n">var_2</span> <span class="tok-o">=</span> <span class="tok-n">var_3</span><span class="tok-p">[</span><span class="tok-n">var_1</span> <span class="tok-o">%</span> <span class="tok-mi">12</span><span class="tok-p">];</span>
     <span class="tok-n">out</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">var_2</span><span class="tok-p">);</span> <span class="tok-c1">// envoi du résultat sur le lien 0</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette implémentation des transputers 11 et 12 est équivalente à celle obtenue précédemment
mais les deux transputers sont cette fois indépendants.</p>
</div>
<div class="paragraph">
<p>La fonction de chaque transputer étant maintenant connue, il reste alors à implémenter
la routine de déchiffrement.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implémentation_de_l_algorithme">Implémentation de l&#8217;algorithme</h3>
<div class="paragraph">
<p>L&#8217;objectif à cet stade est de produire une implémentation de l&#8217;algorithme qui passe le
vecteur de test fourni dans le schéma, à savoir :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Test vector:
key = “*SSTIC-2015*”
data = “1d87c4c4e0ee40383c59447f23798d9fefe74fb82480766e”.decode(“hex”)
decrypt(key, data) == “I love ST20 architecture”</code></pre>
</div>
</div>
<div class="paragraph">
<p>Plusieurs difficultés se présentent lors de la conception du programme :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>les transputers communiquent entre eux avec des instructions <code>in</code> et <code>out</code> ;</p>
</li>
<li>
<p>la plupart des transputers initialisent et maintiennent un état entre chaque itération.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il est assez facile de résoudre le premier point. En effet, on peut remarquer que les communications
entre deux transputers suivent toujours le même schéma : un envoi de 12 octets suivi d&#8217;une lecture d&#8217;un octet.
Ces communications peuvent donc être remplacées par un appel de fonction qui prendrait en paramètre
un chaîne de 12 octets et retournerait un octet comme résultat. Chacune de ces fonctions représenterait
une itération d&#8217;un transputer.</p>
</div>
<div class="paragraph">
<p>Au niveau de la gestion des états, trois possibilités existent :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un état d&#8217;un transputer peut être représenté par des variables statiques déclarées dans le corps de la fonction.
Une de ces variables précise si le transputer est initialisé ou non. Dans ce dernier cas, la fonction initialise l&#8217;état
avant de procéder à l&#8217;itération ;</p>
</li>
<li>
<p>plutôt que des variables statiques, il est possible de déclarer des variables globales qui peuvent être modifiées en dehors
de la fonction correspondant au transputer (par exemple pour définir une fonction d&#8217;initialisation globale) ;</p>
</li>
<li>
<p>enfin, les états des transputers peuvent être déclarés au sein d&#8217;une même structure qui sera passée en paramètre des fonctions. Cette structure
sera initialisée par une fonction principale avant de passer la main au transputer 0.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La dernière possibilité est celle qui a été retenue : elle présente l&#8217;avantage d&#8217;être thread-safe.</p>
</div>
<div class="paragraph">
<p>La structure correspondante est définie ainsi :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-k">typedef</span> <span class="tok-k">struct</span> <span class="tok-n">tr_ctx</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t4_st</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t5_st</span><span class="tok-p">;</span>
    <span class="tok-kt">uint16_t</span> <span class="tok-n">t6_st</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t8_idx</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t8_st</span><span class="tok-p">[</span><span class="tok-mi">4</span><span class="tok-p">][</span><span class="tok-mi">12</span><span class="tok-p">];</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t10_idx</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t10_st</span><span class="tok-p">[</span><span class="tok-mi">4</span><span class="tok-p">][</span><span class="tok-mi">12</span><span class="tok-p">];</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t12_st</span><span class="tok-p">[</span><span class="tok-mi">12</span><span class="tok-p">];</span>
<span class="tok-p">}</span> <span class="tok-kt">tr_ctx_t</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Elle est initialisée simplement par la fonction ci-dessous :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">void</span> <span class="tok-nf">init_ctx</span><span class="tok-p">(</span><span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span>

    <span class="tok-n">memset</span><span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-k">struct</span> <span class="tok-n">tr_ctx</span><span class="tok-p">));</span>

    <span class="tok-cm">/* t6 init */</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span>
        <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t6_st</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t6_st</span> <span class="tok-o">+</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">])</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xffff</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La fonction correspondant au transputer 0 devient alors :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">void</span> <span class="tok-nf">transputer_0</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">cipher</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">cipher_len</span><span class="tok-p">,</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">plain</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">current_key</span><span class="tok-p">[</span><span class="tok-mi">12</span><span class="tok-p">];</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t1_res</span><span class="tok-p">,</span> <span class="tok-n">t2_res</span><span class="tok-p">,</span> <span class="tok-n">t3_res</span><span class="tok-p">;</span>

    <span class="tok-n">memcpy</span><span class="tok-p">(</span><span class="tok-n">current_key</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">);</span>

    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">cipher_len</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">t1_res</span> <span class="tok-o">=</span> <span class="tok-n">transputer_1</span><span class="tok-p">(</span><span class="tok-n">current_key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
        <span class="tok-n">t2_res</span> <span class="tok-o">=</span> <span class="tok-n">transputer_2</span><span class="tok-p">(</span><span class="tok-n">current_key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
        <span class="tok-n">t3_res</span> <span class="tok-o">=</span> <span class="tok-n">transputer_3</span><span class="tok-p">(</span><span class="tok-n">current_key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>

<span class="tok-cp">#if DEBUG</span>
        <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;[T0] T1 : 0x%2.2x T2 : 0x%2.2x T3 : 0x%2.2x</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-n">t1_res</span><span class="tok-p">,</span> <span class="tok-n">t2_res</span><span class="tok-p">,</span> <span class="tok-n">t3_res</span><span class="tok-p">);</span>
<span class="tok-cp">#endif</span>

        <span class="tok-n">plain</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">cipher</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-mi">2</span> <span class="tok-o">*</span> <span class="tok-n">current_key</span><span class="tok-p">[</span><span class="tok-n">i</span> <span class="tok-o">%</span> <span class="tok-mi">12</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-n">i</span> <span class="tok-o">%</span> <span class="tok-mi">12</span><span class="tok-p">);</span>

        <span class="tok-n">current_key</span><span class="tok-p">[</span><span class="tok-n">i</span> <span class="tok-o">%</span> <span class="tok-mi">12</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">t1_res</span> <span class="tok-o">^</span> <span class="tok-n">t2_res</span><span class="tok-p">)</span> <span class="tok-o">^</span> <span class="tok-n">t3_res</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La fonction correspondant à un transputer de second niveau (1, 2 ou 3) est présentée ci-dessous :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">uint8_t</span> <span class="tok-nf">transputer_1</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">c</span><span class="tok-p">;</span>

    <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-n">transputer_4</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
    <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-n">transputer_5</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
    <span class="tok-n">c</span> <span class="tok-o">=</span> <span class="tok-n">transputer_6</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
<span class="tok-cp">#if DEBUG</span>
    <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;[T1] T4 : 0x%2.2x T5 : 0x%2.2x T6 : 0x%2.2x</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-cp">#endif</span>

    <span class="tok-k">return</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-o">^</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-o">^</span> <span class="tok-n">c</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Enfin, un exemple de fonction correspondant à un transputer de troisième niveau est :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">uint8_t</span> <span class="tok-nf">transputer_4</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span>

    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span>
        <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t4_st</span> <span class="tok-o">+=</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>

    <span class="tok-k">return</span> <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t4_st</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La fonction principale pour lancer un déchiffrement est la suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">void</span> <span class="tok-nf">decrypt</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">cipher</span><span class="tok-p">,</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">plain</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">size</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">tr_ctx_t</span> <span class="tok-n">ctx</span><span class="tok-p">;</span>
    <span class="tok-n">init_ctx</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ctx</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">key</span><span class="tok-p">);</span>
    <span class="tok-n">transputer_0</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">cipher</span><span class="tok-p">,</span> <span class="tok-n">size</span><span class="tok-p">,</span> <span class="tok-n">plain</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">ctx</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il ne reste plus maintenant qu&#8217;à tester cette implémentation. Pour cela,
l&#8217;émulateur <a href="http://sourceforge.net/projects/st20emu">st20emu</a> est utilisé
pour vérifier que le résultat de chaque transputer est cohérent avec
une trace d&#8217;exécution obtenue par émulation.</p>
</div>
<div class="paragraph">
<p>Par exemple, le résultat des transputers de 7 à 12 avec pour la clé <code>*SSTIC-2015*</code> est :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ./decrypt
<span class="tok-go">[T1] T4 : 0xcf T5 : 0x75 T6 : 0x9e</span>
<span class="tok-go">[T2] T7 : 0xaf T8 : 0xcf T9 : 0x06</span>
<span class="tok-go">[T3] T10: 0x00 T11: 0x2a T12: 0x49</span>
<span class="tok-go">[T0] T1 : 0x24 T2 : 0x66 T3 : 0x63</span>
<span class="tok-go">[...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On peut alors charger dans l&#8217;émulateur le code du transputer 4 (fichier <code>t4_code_gcall.bin</code>)
et vérifier que le résultat (<code>0xcf</code>) est identique. L&#8217;émulateur ne supportant pas l&#8217;instruction <code>in</code>,
il faut donc simuler le chargement de la clé en affectant les variables <code>var_2</code>, <code>var_3</code> et <code>var_3</code>
à la main (voir <a href="#_t4_code_gcall">t4_code_gcall.asm</a> à l&#8217;adresse <code>0x1b</code>). La trace de l&#8217;émulateur est présentée ci-dessous :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> wine st20emu.exe
<span class="tok-go">Cannot open INI file ST20EMU.INI</span>
<span class="tok-go">Using program defaults</span>
<span class="tok-go">MAX_UNPROMPTED_INSTR=1000000</span>
<span class="tok-go">WARN_UNPROMPTED_INSTR=100000</span>
<span class="tok-go">UNDEFINED_WORD=0xaaaaaaaa</span>
<span class="tok-go">START_ADDR=0x7ffffffe</span>
<span class="tok-go">MEM_START_VAL=0x80000140</span>
<span class="tok-go">ST20_PRODUCT_ID=0x2d4c9041</span>
<span class="tok-go">TIMER_GUESS=0x20000000</span>
<span class="tok-go">WPTR_END_ADDR=0x1fffffff</span>

<span class="tok-go">A=0xaaaaaaaa B=0xaaaaaaaa C=0xaaaaaaaa  Iptr=0x7ffffffe</span>
<span class="tok-go">Wptr  0=0xaaaaaaaa</span>

<span class="tok-go">An uninitialized memory byte was accessed</span>
<span class="tok-go">Error occurred when reading instruction at 7ffffffe, offset  0</span>
<span class="tok-go">7ffffffe   j loc_7ffffffe</span>
<span class="tok-gp">&gt;</span> l 7ff80000 t4_code_gcall.bin <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-go">Read 68 bytes from t4_code_gcall.bin</span>
<span class="tok-gp">&gt;</span> i 7ff8000c <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-gp">&gt;</span> s i 7ff8001d <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-gp">&gt;</span> g
<span class="tok-go">ERROR: Invalid Wptr word referenced</span>
<span class="tok-go">This instruction (in) has not been implemented yet</span>
<span class="tok-go">Watch condition encountered</span>
<span class="tok-go">A=0x0000000c B=0x80000010 C=0x1ffffff0  Iptr=0x7ff8001d</span>
<span class="tok-go">Wptr  0=0x0000000c  1=0x00000000  2=0xaaaaaaaa  3=0xaaaaaaaa</span>
<span class="tok-go">      4=0xaaaaaaaa  5=0xaaaaaaaa</span>

<span class="tok-go">7ff8001d  40  ldc 0</span>
<span class="tok-gp">&gt;</span> w <span class="tok-m">2</span> 5453532a <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-gp">&gt;</span> w <span class="tok-m">3</span> 322d4349 <i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-gp">&gt;</span> w <span class="tok-m">4</span> 2a353130 <i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-gp">&gt;</span> s i 7ff8003c <i class="conum" data-value="7"></i><b>(7)</b>
<span class="tok-gp">&gt;</span> g
<span class="tok-go">ERROR: Invalid Wptr word referenced</span>
<span class="tok-go">Watch condition encountered</span>
<span class="tok-go">A=0x00000000 B=0x80000000 C=0x1fffffec  Iptr=0x7ff8003c</span>
<span class="tok-go">Wptr  0=0x00000001  1=0x000000cf  2=0x5453532a  3=0x322d4349 </span><i class="conum" data-value="8"></i><b>(8)</b>
<span class="tok-go">      4=0x2a353130  5=0xaaaaaaaa</span>

<span class="tok-go">7ff8003c  63 98  call sub_7ff80006</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>charge le code du transputer</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>règle le point d&#8217;entrée</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>place un point d&#8217;arrêt après la lecture de la clé</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>*SST</code> dans var_2</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>IC-2</code> dans var_3</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>015*</code> dans var_4</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>place un point d&#8217;arrêt avant l&#8217;envoi du résultat</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>résultat dans var_1</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le résultat est bien <code>0xcf</code> dans les deux cas. De la même manière,
il est possible de valider individuellement l&#8217;implémentation de chaque transputer. On peut alors essayer
de passer le vecteur de test.</p>
</div>
<div class="paragraph">
<p>La fonction ci-dessous implémente ce test :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-kt">int</span> <span class="tok-nf">self_test</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">count</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">ret</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">i</span><span class="tok-p">;</span>
    <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-s">&quot;*SSTIC-2015*&quot;</span><span class="tok-p">;</span>
    <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">cipher</span> <span class="tok-o">=</span> <span class="tok-s">&quot;</span><span class="tok-se">\x1d\x87\xc4\xc4\xe0\xee\x40\x38\x3c\x59\x44\x7f\x23\x79\x8d\x9f\xef\xe7\x4f\xb8\x24\x80\x76\x6e</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
    <span class="tok-kt">char</span> <span class="tok-n">plain</span><span class="tok-p">[</span><span class="tok-mi">24</span><span class="tok-p">];</span>
    <span class="tok-kt">int</span> <span class="tok-n">data_size</span> <span class="tok-o">=</span> <span class="tok-mi">24</span><span class="tok-p">;</span>

    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">count</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">ret</span> <span class="tok-o">==</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">decrypt</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">cipher</span><span class="tok-p">,</span> <span class="tok-n">plain</span><span class="tok-p">,</span> <span class="tok-n">data_size</span><span class="tok-p">);</span>
        <span class="tok-n">ret</span> <span class="tok-o">=</span> <span class="tok-n">strncmp</span><span class="tok-p">(</span><span class="tok-s">&quot;I love ST20 architecture&quot;</span><span class="tok-p">,</span> <span class="tok-n">plain</span><span class="tok-p">,</span> <span class="tok-n">data_size</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>

    <span class="tok-k">return</span> <span class="tok-n">ret</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kt">int</span> <span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">argc</span><span class="tok-p">,</span> <span class="tok-kt">char</span> <span class="tok-o">**</span><span class="tok-n">argv</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">self_test</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span> <span class="tok-o">!=</span> <span class="tok-mi">0</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">fprintf</span><span class="tok-p">(</span><span class="tok-n">stderr</span><span class="tok-p">,</span> <span class="tok-s">&quot;self-test failed</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
        <span class="tok-n">exit</span><span class="tok-p">(</span><span class="tok-n">EXIT_FAILURE</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
    <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;[+] self-test passed</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

    <span class="tok-k">return</span> <span class="tok-n">EXIT_SUCCESS</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il est recommandé d&#8217;effectuer le test plusieurs fois de suite pour s&#8217;assurer que la réinitialisation
des transputers est correcte. Le résultat est le suivant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> make decrypt
<span class="tok-go">gcc -O3 -march=native -fomit-frame-pointer -funroll-loops -Wall -D_STANDALONE_ -o decrypt decrypt.c</span>
<span class="tok-gp">$</span> ./decrypt
<span class="tok-go">[T1] T4 : 0xcf T5 : 0x75 T6 : 0x9e</span>
<span class="tok-go">[T2] T7 : 0xaf T8 : 0xcf T9 : 0x06</span>
<span class="tok-go">[T3] T10: 0x00 T11: 0x2a T12: 0x49</span>
<span class="tok-go">[T0] T1 : 0x24 T2 : 0x66 T3 : 0x63</span>
<span class="tok-go">[...]</span>
<span class="tok-go">[+] self-test passed</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On dispose alors à ce stade d&#8217;une implémentation supposée correcte (fichier <a href="#_decrypt_c">decrypt.c</a> en annexe)
de la routine de déchiffrement.</p>
</div>
</div>
<div class="sect2">
<h3 id="_attaque_par_force_brute">Attaque par force brute</h3>
<div class="paragraph">
<p>Il reste maintenant à déterminer la clé valide permettant de déchiffrer les données
embarquées dans le fichier <code>input.bin</code>. La démarche initiale est alors la suivante :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>déterminer une liste de clés candidates et, pour chacune, :</p>
<div class="ulist">
<ul>
<li>
<p>effectuer un déchiffrement,</p>
</li>
<li>
<p>calculer l&#8217;empreinte SHA256 des données obtenues et comparer le résultat
avec l&#8217;empreinte <code>decrypted</code> présente sur le schéma <code>schematic.pdf</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si les deux empreintes sont identiques, alors la clé candidate courante est celle
recherchée.</p>
</div>
<div class="paragraph">
<p>Cette approche se heurte cependant à plusieurs difficultés :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>sachant que la longueur de la clé est de 12 octets, soit 96 bits,
l&#8217;espace de clés à tester est gigantesque (\$2^96\$ clés différentes) ;</p>
</li>
<li>
<p>l&#8217;algorithme de déchiffrement n&#8217;est pas particulièrement efficace car il agit
octet par octet sur les données chiffrées : le test d&#8217;une clé est en conséquence
assez long.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour poursuivre, ces deux difficultés doivent être résolues. Au niveau du nombre de clés à tester,
il est possible de fortement réduire leur nombre. En effet, si on reprend l&#8217;algorithme
de déchiffrement, on peut se rendre compte que les 12 premiers octets déchiffrés
sont directement corrélés avec la clé par la formule suivante :</p>
</div>
<div class="stemblock">
<div class="content">
\$p_i = c_i \oplus ( (2 * k_i + i) % 256 )\$
</div>
</div>
<div class="paragraph">
<p>où \$p_i\$ est l&#8217;octet déchiffré, \$c_i\$ l&#8217;octet chiffré et \$k_i\$ l&#8217;octet
de clé à la position \$i\$, pour \$i in [0, 11\$]. L&#8217;opération modulo 256
est nécessaire car le résultat est stocké dans octet (soit un entier de 8 bits).</p>
</div>
<div class="paragraph">
<p>La formule précédente revient à dire qu&#8217;il existe un entier \$n\$ tel que :</p>
</div>
<div class="stemblock">
<div class="content">
\$256 * n + c_i \oplus p_i = 2 * k_i + i\$
</div>
</div>
<div class="paragraph">
<p>Un octet de clé est donc corrélé avec les octets de clair et chiffré correspondants
de la façon suivante :</p>
</div>
<div class="stemblock">
<div class="content">
\$k_i = (256 * n + c_i \oplus p_i - i) / 2 = 128 * n + (c_i \oplus p_i - i) / 2\$
</div>
</div>
<div class="paragraph">
<p>Par conséquent, en identifiant un clair connu sur le début du fichier, on pourra
alors réduire grandement l&#8217;espace des clés à tester. On peut alors faire l&#8217;hypothèse,
 à cause de la présence de la chaîne <code>congratulations.tar.bz2</code> dans le fichier <code>input.bin</code>,
que les données déchiffrées correspondant à une archive au standard bzip2.</p>
</div>
<div class="paragraph">
<p>La page Wikipedia sur bzip2 décrit le <a href="http://en.wikipedia.org/wiki/Bzip2#File_format">format</a> d&#8217;un
fichier bzip2. On identifie alors certaines valeurs constantes au début du fichier :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>.magic:16                       = 'BZ' signature/magic number
.version:8                      = 'h' for Bzip2 ('H'uffman coding), '0' for Bzip1 (deprecated)
.hundred_k_blocksize:8          = '1'..'9' block-size 100 kB-900 kB (uncompressed)

.compressed_magic:48            = 0x314159265359 (BCD (pi))
.crc:32                         = checksum for this block</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il s&#8217;agit donc de :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BZh</code> pour les trois premiers octets ;</p>
</li>
<li>
<p>une valeur comprise entre 1 et 9 pour le quatrième octet ;</p>
</li>
<li>
<p>enfin la valeur de Pi pour les 6 octets suivants.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Les 10 premiers octets sont donc prévisibles et permettent de limiter les clés
candidates. Pour cela, un script Ruby a été développé qui détermine, pour les 10
premiers octets, les valeurs possibles d&#8217;un octet de clé en fonction de l&#8217;octet
de clair connu et de l&#8217;octet chiffré correspondants.</p>
</div>
<div class="listingblock">
<div class="title">find-key.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-n">cipher</span> <span class="tok-o">=</span> <span class="tok-o">[</span> <span class="tok-mh">0xfe</span><span class="tok-p">,</span> <span class="tok-mh">0xf3</span><span class="tok-p">,</span> <span class="tok-mh">0x50</span><span class="tok-p">,</span> <span class="tok-mh">0xdc</span><span class="tok-p">,</span> <span class="tok-mh">0x81</span><span class="tok-p">,</span> <span class="tok-mh">0xbc</span><span class="tok-p">,</span> <span class="tok-mh">0x97</span><span class="tok-p">,</span> <span class="tok-mh">0x27</span><span class="tok-p">,</span> <span class="tok-mh">0x89</span><span class="tok-p">,</span> <span class="tok-mh">0xac</span> <span class="tok-o">]</span>
<span class="tok-n">plains</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
<span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-o">.</span><span class="tok-n">.</span><span class="tok-mi">9</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">i</span><span class="tok-o">|</span>
  <span class="tok-n">plains</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-o">[</span> <span class="tok-s1">&#39;B&#39;</span><span class="tok-o">.</span><span class="tok-n">ord</span><span class="tok-p">,</span> <span class="tok-s1">&#39;Z&#39;</span><span class="tok-o">.</span><span class="tok-n">ord</span><span class="tok-p">,</span> <span class="tok-s1">&#39;h&#39;</span><span class="tok-o">.</span><span class="tok-n">ord</span><span class="tok-p">,</span> <span class="tok-mh">0x30</span> <span class="tok-o">+</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-mh">0x31</span><span class="tok-p">,</span> <span class="tok-mh">0x41</span><span class="tok-p">,</span> <span class="tok-mh">0x59</span><span class="tok-p">,</span> <span class="tok-mh">0x26</span><span class="tok-p">,</span> <span class="tok-mh">0x53</span><span class="tok-p">,</span> <span class="tok-mh">0x59</span> <span class="tok-o">]</span>
<span class="tok-k">end</span>

<span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>

<span class="tok-n">plains</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">plain</span><span class="tok-o">|</span>
  <span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-o">.</span><span class="tok-n">.</span><span class="tok-mi">9</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">i</span><span class="tok-o">|</span>
    <span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-o">.</span><span class="tok-n">.</span><span class="tok-mi">255</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">c</span><span class="tok-o">|</span>
      <span class="tok-n">t</span> <span class="tok-o">=</span> <span class="tok-n">cipher</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">]</span> <span class="tok-o">^</span> <span class="tok-p">((</span> <span class="tok-mi">2</span> <span class="tok-o">*</span> <span class="tok-n">c</span> <span class="tok-o">+</span> <span class="tok-n">i</span> <span class="tok-p">)</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xff</span><span class="tok-p">)</span>
      <span class="tok-k">if</span> <span class="tok-n">t</span> <span class="tok-o">==</span> <span class="tok-n">plain</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">]</span>
        <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">]</span> <span class="tok-o">||=</span> <span class="tok-o">[]</span><span class="tok-p">)</span>
        <span class="tok-n">a</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">c</span> <span class="tok-k">unless</span> <span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-n">include?</span> <span class="tok-n">c</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span>

<span class="tok-n">keys</span> <span class="tok-o">=</span> <span class="tok-n">key</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">].</span><span class="tok-n">product</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">key</span><span class="tok-o">[</span><span class="tok-mi">1</span><span class="tok-o">.</span><span class="tok-n">.</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-o">]</span><span class="tok-p">)</span>

<span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;#define KEYS_COUNT </span><span class="tok-si">#{</span><span class="tok-n">keys</span><span class="tok-o">.</span><span class="tok-n">size</span><span class="tok-si">}</span><span class="tok-se">\n\n</span><span class="tok-s2">&quot;</span>
<span class="tok-n">result</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;char keys[KEYS_COUNT][12] = {</span><span class="tok-se">\n</span><span class="tok-s2">&quot;</span>

<span class="tok-n">result</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-n">keys</span><span class="tok-o">.</span><span class="tok-n">map</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">x</span><span class="tok-o">|</span>
  <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-o">]</span>
  <span class="tok-s2">&quot;    { &quot;</span> <span class="tok-o">+</span> <span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-n">map</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">y</span><span class="tok-o">|</span> <span class="tok-s2">&quot;0x%02x&quot;</span> <span class="tok-o">%</span> <span class="tok-n">y</span><span class="tok-p">}</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">(</span><span class="tok-s2">&quot;, &quot;</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-s2">&quot; }&quot;</span>
<span class="tok-k">end</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">(</span><span class="tok-s2">&quot;,</span><span class="tok-se">\n</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>

<span class="tok-n">result</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-s2">&quot;</span><span class="tok-se">\n</span><span class="tok-s2">};&quot;</span>

<span class="tok-nb">puts</span> <span class="tok-n">result</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le script génère un fichier <code>.h</code> contenant 5120 clés qui peut alors être inclus dans un programme en
C pour effectuer l&#8217;attaque par force brute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ./find-key.rb
<span class="tok-gp">#</span>define KEYS_COUNT 5120

<span class="tok-go">char keys[KEYS_COUNT][12] = {</span>
<span class="tok-go">    { 0x5e, 0x54, 0x1b, 0x75, 0x56, 0x7c, 0x64, 0x7d, 0x69, 0x76, 0x00, 0x00 },</span>
<span class="tok-go">    { 0x5e, 0x54, 0x1b, 0x75, 0x56, 0x7c, 0x64, 0x7d, 0x69, 0xf6, 0x00, 0x00 },</span>
<span class="tok-go">    { 0x5e, 0x54, 0x1b, 0x75, 0x56, 0x7c, 0x64, 0x7d, 0xe9, 0x76, 0x00, 0x00 },</span>
<span class="tok-go">    { 0x5e, 0x54, 0x1b, 0x75, 0x56, 0x7c, 0x64, 0x7d, 0xe9, 0xf6, 0x00, 0x00 },</span>
<span class="tok-go">    { 0x5e, 0x54, 0x1b, 0x75, 0x56, 0x7c, 0x64, 0xfd, 0x69, 0x76, 0x00, 0x00 },</span>
<span class="tok-go">    { 0x5e, 0x54, 0x1b, 0x75, 0x56, 0x7c, 0x64, 0xfd, 0x69, 0xf6, 0x00, 0x00 },</span>
<span class="tok-go">    { 0x5e, 0x54, 0x1b, 0x75, 0x56, 0x7c, 0x64, 0xfd, 0xe9, 0x76, 0x00, 0x00 },</span>
<span class="tok-go">[...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les deux derniers octets doivent être déterminés par force brute, ce qui revient
à un espace de clés correspondant à \$5120 * 2^8 * 2^8 = 5120 * 2^16\$ possibilités.</p>
</div>
<div class="paragraph">
<p>La seconde difficulté réside dans la lenteur de l&#8217;algorithme qui limite
les possibilités d&#8217;attaque par force brute. Pour contourner cette difficulté,
l&#8217;idéal serait de pouvoir éliminer les mauvaises clés candidates sans avoir
à déchiffrer l&#8217;intégralité des données. S&#8217;il est possible de déterminer un clair connu
dans le début du fichier déchiffré (autre que les 10 premiers octets), alors une
vérification sur le début des données déchiffrées permettrait de ne retenir que les
bons candidats. Si une clé candidate passe ce premier filtre, alors un déchiffrement
complet est ensuite réalisé pour comparer les empreintes SHA256.</p>
</div>
<div class="paragraph">
<p>Un fichier au format bzip2, de taille comparable à celui recherché, est alors
généré pour tenter d&#8217;identifier un clair connu :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>/dev/urandom <span class="tok-nv">of</span><span class="tok-o">=</span>test.bin <span class="tok-nv">bs</span><span class="tok-o">=</span>256K <span class="tok-nv">count</span><span class="tok-o">=</span>1
<span class="tok-go">1+0 records in</span>
<span class="tok-go">1+0 records out</span>
<span class="tok-go">262144 bytes (262 kB) copied, 0.0222051 s, 11.8 MB/s</span>
<span class="tok-gp">$</span> bzip2 test.bin
<span class="tok-gp">$</span> hexdump -C test.bin.bz2
<span class="tok-go">00000000  42 5a 68 39 31 41 59 26  53 59 48 b3 90 17 00 32  |BZh91AY&amp;SYH....2|</span>
<span class="tok-go">00000010  78 ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |x...............|</span>
<span class="tok-go">00000020  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span>
<span class="tok-go">[...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On remarque que le début du fichier contient de nombreuses occurrences de la valeur <code>0xff</code>. L&#8217;heuristique
retenue consiste alors à tester la présence des octets <code>ff ff ff ff</code> dans les
32 premiers octets déchiffrés.</p>
</div>
<div class="paragraph">
<p>Une version simplifiée de l&#8217;attaque par force brute est présentée ci-dessous :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">plain_sha256</span> <span class="tok-o">=</span> <span class="tok-s">&quot;9128135129d2be652809f5a1d337211affad91ed5827474bf9bd7e285ecef321&quot;</span><span class="tok-p">;</span>

<span class="tok-kt">void</span> <span class="tok-nf">bf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">cipher_data</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">size</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">key</span><span class="tok-p">;</span>
        <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">plain_data</span> <span class="tok-o">=</span> <span class="tok-nb">NULL</span><span class="tok-p">;</span>
        <span class="tok-kt">char</span> <span class="tok-n">sha256</span><span class="tok-p">[</span><span class="tok-mi">65</span><span class="tok-p">];</span>
        <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">j</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">l</span><span class="tok-p">;</span>

        <span class="tok-n">plain_data</span> <span class="tok-o">=</span> <span class="tok-n">malloc</span><span class="tok-p">(</span><span class="tok-n">size</span><span class="tok-p">);</span>

        <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">KEYS_COUNT</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                <span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-n">keys</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>

                <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">j</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">j</span> <span class="tok-o">&lt;</span> <span class="tok-mi">256</span><span class="tok-p">;</span> <span class="tok-n">j</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                        <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-mi">10</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">j</span><span class="tok-p">;</span>

                        <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">k</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">k</span> <span class="tok-o">&lt;</span> <span class="tok-mi">256</span><span class="tok-p">;</span> <span class="tok-n">k</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                                <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-mi">11</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">k</span><span class="tok-p">;</span>

                                <span class="tok-n">decrypt</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">cipher_data</span><span class="tok-p">,</span> <span class="tok-n">plain_data</span><span class="tok-p">,</span> <span class="tok-mi">32</span><span class="tok-p">);</span>
                                <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">memmem</span><span class="tok-p">(</span><span class="tok-n">plain_data</span><span class="tok-p">,</span> <span class="tok-mi">32</span><span class="tok-p">,</span> <span class="tok-s">&quot;</span><span class="tok-se">\xFF\xFF\xFF\xFF</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">))</span>
                                        <span class="tok-k">continue</span><span class="tok-p">;</span>

                                <span class="tok-n">decrypt</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">cipher_data</span><span class="tok-p">,</span> <span class="tok-n">plain_data</span><span class="tok-p">,</span> <span class="tok-n">size</span><span class="tok-p">);</span>
                                <span class="tok-n">sha256sum</span><span class="tok-p">(</span><span class="tok-n">plain_data</span><span class="tok-p">,</span> <span class="tok-n">size</span><span class="tok-p">,</span> <span class="tok-n">sha256</span><span class="tok-p">);</span>

                                <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">strncmp</span><span class="tok-p">(</span><span class="tok-n">sha256</span><span class="tok-p">,</span> <span class="tok-n">plain_sha256</span><span class="tok-p">,</span> <span class="tok-mi">64</span><span class="tok-p">))</span> <span class="tok-p">{</span>
                                        <span class="tok-n">fprintf</span><span class="tok-p">(</span><span class="tok-n">stderr</span><span class="tok-p">,</span> <span class="tok-s">&quot;[!] key = &quot;</span><span class="tok-p">);</span>
                                        <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">l</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">l</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">l</span><span class="tok-o">++</span><span class="tok-p">)</span>
                                                <span class="tok-n">fprintf</span><span class="tok-p">(</span><span class="tok-n">stderr</span><span class="tok-p">,</span> <span class="tok-s">&quot;%2.2x&quot;</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-n">l</span><span class="tok-p">]</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xff</span><span class="tok-p">);</span>

                                        <span class="tok-k">goto</span> <span class="tok-n">finish</span><span class="tok-p">;</span>
                                <span class="tok-p">}</span>
                        <span class="tok-p">}</span>
                <span class="tok-p">}</span>
        <span class="tok-p">}</span>

<span class="tok-nl">finish</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">plain_data</span><span class="tok-p">)</span>
                <span class="tok-n">free</span><span class="tok-p">(</span><span class="tok-n">plain_data</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Une version améliorée, disponible en annexe (<a href="#_bf_c">bf.c</a>), utilise OpenMP pour
paralléliser les calculs et permet de retrouver la clé valide en l&#8217;espace d&#8217;une minute :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> make bf
<span class="tok-go">./find-key.rb &gt; keys.h</span>
<span class="tok-go">gcc -c -O3 -march=native -fomit-frame-pointer -funroll-loops -Wall -fopenmp -o bf.o bf.c</span>
<span class="tok-go">gcc -c -O3 -march=native -fomit-frame-pointer -funroll-loops -Wall -o decrypt.o decrypt.c</span>
<span class="tok-go">gcc -O3 -march=native -fomit-frame-pointer -funroll-loops -Wall -fopenmp -o bf bf.o decrypt.o -lcrypto</span>
<span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>input_remaining.bin <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">skip</span><span class="tok-o">=</span><span class="tok-m">40</span> <span class="tok-nv">of</span><span class="tok-o">=</span>encrypted.bin <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-gp">$</span> sha256sum encrypted.bin
<span class="tok-go">a5790b4427bc13e4f4e9f524c684809ce96cd2f724e29d94dc999ec25e166a81  encrypted.bin</span>
<span class="tok-gp">$</span> <span class="tok-nb">time</span> ./bf encrypted.bin
<span class="tok-go">[+] self-test passed</span>
<span class="tok-go">[+] starting 4 threads</span>
<span class="tok-go">[+] testing 5120 keys</span>
<span class="tok-go">[!] key = 5ed49b7156fce47de976dac5</span>
<span class="tok-go">[+] result saved in congratulations.tar.bz2</span>
<span class="tok-go">./bf encrypted.bin  282,40s user 0,09s system 385% cpu 1:13,34 total</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>input_remaining</code> est obtenu à l&#8217;aide du script <a href="#_split_rb">split.rb</a> depuis le fichier <code>input.bin</code>, 40 est le décalage
jusqu&#8217;aux données chiffrées</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La clé a finalement été identifiée (<code>5ed49b7156fce47de976dac5</code>) et le résultat est sauvegardé dans le fichier
<code>congratulations.tar.bz2</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stego_stage">Stage 6 : stéganographie</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_congratulations_jpg">congratulations.jpg</h3>
<div class="paragraph">
<p>Le fichier obtenu à l&#8217;étape précédente est une archive au format <code>.tar.bz2</code> qui contient
une image <code>JPEG</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> sha256sum congratulations.tar.bz2
<span class="tok-go">9128135129d2be652809f5a1d337211affad91ed5827474bf9bd7e285ecef321  congratulations.tar.bz2</span>
<span class="tok-gp">$</span> tar jxvf congratulations.tar.bz2
<span class="tok-go">congratulations.jpg</span>
<span class="tok-gp">$</span> file congratulations.jpg
<span class="tok-go">congratulations.jpg: JPEG image data, JFIF standard 1.01</span>
<span class="tok-gp">$</span> ls -al congratulations.jpg
<span class="tok-go">-rw-r--r-- 1 jpe jpe 252569 mars  23 10:34 congratulations.jpg</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le fichier <code>congratulations.jpg</code> correspond à l&#8217;image ci-dessous :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_congratulations.jpg" alt="rk congratulations">
</div>
</div>
<div class="paragraph">
<p>A première vue, selon la commande <code>jpeginfo</code>, le fichier semble valide :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> jpeginfo -c congratulations.jpg
<span class="tok-go">congratulations.jpg  636 x 474  24bit JFIF  P  252569  [OK]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La taille du fichier est néanmoins suspecte (252569 octets), pour une image de cette
 dimension. En effet, en utilisant l&#8217;outil <code>hachoir</code>, on identifie une autre archive
 <code>.tar.bz2</code> à l&#8217;intérieur de l&#8217;image :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> hachoir-subfile congratulations.jpg
<span class="tok-go">[+] Start search on 252569 bytes (246.6 KB)</span>

<span class="tok-go">[+] File at 0 size=55248 (54.0 KB): JPEG picture</span>
<span class="tok-go">[+] File at 55248: bzip2 archive</span>

<span class="tok-go">[+] End of search -- offset=252569 (246.6 KB)</span>
<span class="tok-gp">$</span> dd <span class="tok-k">if</span><span class="tok-o">=</span>congratulations.jpg <span class="tok-nv">of</span><span class="tok-o">=</span>out.tar.bz2 <span class="tok-nv">bs</span><span class="tok-o">=</span><span class="tok-m">1</span> <span class="tok-nv">skip</span><span class="tok-o">=</span><span class="tok-m">55248</span> 2&gt;/dev/null
<span class="tok-gp">$</span> tar jxvf out.tar.bz2
<span class="tok-go">congratulations.png</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;analyse du fichier <code>congratulations.png</code> constitue la seconde phase de cette étape.</p>
</div>
</div>
<div class="sect2">
<h3 id="_congratulations_png">congratulations.png</h3>
<div class="paragraph">
<p>L&#8217;image obtenue est présentée ci-dessous :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_congratulations.png" alt="rk congratulations">
</div>
</div>
<div class="paragraph">
<p>Elle est similaire au fichier <code>congratulations.jpg</code>, seul le message du bas a changé.
On peut alors tester l&#8217;intégrité du fichier avec la commande <code>pngcheck</code>, comme présenté
ci-dessous :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> pngcheck -v congratulations.png
<span class="tok-go">File: congratulations.png (197557 bytes)</span>
<span class="tok-go">  chunk IHDR at offset 0x0000c, length 13</span>
<span class="tok-go">    636 x 474 image, 32-bit RGB+alpha, non-interlaced</span>
<span class="tok-go">  chunk bKGD at offset 0x00025, length 6</span>
<span class="tok-go">    red = 0x00ff, green = 0x00ff, blue = 0x00ff</span>
<span class="tok-go">  chunk pHYs at offset 0x00037, length 9: 3543x3543 pixels/meter (90 dpi)</span>
<span class="tok-go">  chunk tIME at offset 0x0004c, length 7: 27 Feb 2015 13:40:19 UTC</span>
<span class="tok-go">  chunk sTic at offset 0x0005f, length 4919:  illegal reserved-bit-set chunk</span>
<span class="tok-go">ERRORS DETECTED in congratulations.png</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le fichier semble contenir un "chunk" de type <code>sTic</code>. Une rapide recherche sur
Internet permet de confirmer qu&#8217;il ne s&#8217;agit pas d&#8217;un type valide.</p>
</div>
<div class="paragraph">
<p>Le script Ruby ci-dessous permet de lister tous les types de "chunk" :</p>
</div>
<div class="listingblock">
<div class="title">list-chunks.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-nb">require</span> <span class="tok-s1">&#39;chunky_png&#39;</span>

<span class="tok-n">png_stream</span> <span class="tok-o">=</span> <span class="tok-no">ChunkyPNG</span><span class="tok-o">::</span><span class="tok-no">Datastream</span><span class="tok-o">.</span><span class="tok-n">from_file</span><span class="tok-p">(</span><span class="tok-no">ARGV</span><span class="tok-o">.</span><span class="tok-n">shift</span><span class="tok-p">)</span>
<span class="tok-n">png_stream</span><span class="tok-o">.</span><span class="tok-n">each_chunk</span> <span class="tok-p">{</span> <span class="tok-o">|</span><span class="tok-n">chunk</span><span class="tok-o">|</span> <span class="tok-nb">puts</span> <span class="tok-n">chunk</span><span class="tok-o">.</span><span class="tok-n">type</span> <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Son exécution retourne le résultat suivant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ./list-chunks.rb congratulations.png
<span class="tok-go">IHDR</span>
<span class="tok-go">bKGD</span>
<span class="tok-go">pHYs</span>
<span class="tok-go">tIME</span>
<span class="tok-go">sTic</span>
<span class="tok-go">sTic</span>
<span class="tok-go">[...]</span>
<span class="tok-go">sTic</span>
<span class="tok-go">sTic</span>
<span class="tok-go">IDAT</span>
<span class="tok-go">IDAT</span>
<span class="tok-go">IDAT</span>
<span class="tok-go">IDAT</span>
<span class="tok-go">IDAT</span>
<span class="tok-go">IDAT</span>
<span class="tok-go">IDAT</span>
<span class="tok-go">IDAT</span>
<span class="tok-go">IEND</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Une invite <code>irb</code> est alors utilisée pour examiner le fichier en mode interactif :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="irb"><span class="tok-go">$ irb</span>
<span class="tok-gp">irb(main):001:0&gt; </span><span class="tok-nb">require</span> <span class="tok-s1">&#39;chunky_png&#39;</span>
<span class="tok-go"> =&gt; true</span>
<span class="tok-gp">irb(main):002:0&gt; </span><span class="tok-n">png_stream</span> <span class="tok-o">=</span> <span class="tok-no">ChunkyPNG</span><span class="tok-o">::</span><span class="tok-no">Datastream</span><span class="tok-o">.</span><span class="tok-n">from_file</span><span class="tok-p">(</span><span class="tok-s2">&quot;congratulations.png&quot;</span><span class="tok-p">)</span>
<span class="tok-gp">irb(main):003:0&gt; </span><span class="tok-n">chunks</span> <span class="tok-o">=</span> <span class="tok-n">png_stream</span><span class="tok-o">.</span><span class="tok-n">chunks</span><span class="tok-o">.</span><span class="tok-n">select</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">c</span><span class="tok-o">|</span> <span class="tok-n">c</span><span class="tok-o">.</span><span class="tok-n">type</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;sTic&quot;</span><span class="tok-p">}</span>
<span class="tok-gp">irb(main):004:0&gt; </span><span class="tok-n">chunks</span><span class="tok-o">.</span><span class="tok-n">size</span>
<span class="tok-go"> =&gt; 28</span>
<span class="tok-gp">irb(main):005:0&gt; </span><span class="tok-n">chunks</span><span class="tok-o">.</span><span class="tok-n">first</span>
<span class="tok-go"> =&gt; #&lt;ChunkyPNG::Chunk::Generic:0x0000000280a910 @type=&quot;sTic&quot;, @content=&quot;x\x9C\x84[...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le fichier contient donc 28 chunks de type <code>sTic</code>. On peut alors s&#8217;intéresser aux données
contenues dans le premier chunk.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="irb"><span class="tok-gp">irb(main):006:0&gt; </span><span class="tok-n">chunks</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-o">].</span><span class="tok-n">content</span><span class="tok-o">[</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-o">].</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;H*&#39;</span><span class="tok-p">)</span>
<span class="tok-go"> =&gt; [&quot;789c84b6&quot;]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Une recherche de <code>0x78 0x9c</code> sur Internet permet d&#8217;identifier un probable
début de stream Zlib. On peut alors tenter une décompression et sauvegarder le résulat.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="irb"><span class="tok-gp">irb(main):007:0&gt; </span><span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-n">chunks</span><span class="tok-o">.</span><span class="tok-n">map</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">c</span><span class="tok-o">|</span> <span class="tok-n">c</span><span class="tok-o">.</span><span class="tok-n">content</span><span class="tok-p">}</span><span class="tok-o">.</span><span class="tok-n">join</span>
<span class="tok-gp">irb(main):008:0&gt; </span><span class="tok-nb">require</span> <span class="tok-s1">&#39;zlib&#39;</span>
<span class="tok-go"> =&gt; false</span>
<span class="tok-gp">irb(main):009:0&gt; </span><span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;out.bin&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;wb&quot;</span><span class="tok-p">)</span> <span class="tok-p">{</span><span class="tok-o">|</span><span class="tok-n">f</span><span class="tok-o">|</span> <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">write</span> <span class="tok-no">Zlib</span><span class="tok-o">::</span><span class="tok-no">Inflate</span><span class="tok-o">.</span><span class="tok-n">inflate</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">)</span> <span class="tok-p">}</span>
<span class="tok-go"> =&gt; 133048</span>
<span class="tok-gp">irb(main):010:0&gt; </span><span class="tok-nb">puts</span> <span class="tok-sb">`file out.bin`</span>
<span class="tok-go">out.bin: bzip2 compressed data, block size = 900k</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le résultat obtenu est un fichier <code>bzip2</code> qui est en fait une archive <code>tar.bz2</code>
contenant une nouvelle image :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> tar jxvf out.bin
<span class="tok-go">congratulations.tiff</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette image doit alors être analysée pour poursuivre le challenge.</p>
</div>
</div>
<div class="sect2">
<h3 id="_congratulations_tiff">congratulations.tiff</h3>
<div class="paragraph">
<p>L&#8217;image obtenue est la suivante :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_congratulations_tiff.png" alt="rk congratulations tiff">
</div>
</div>
<div class="paragraph">
<p>L&#8217;outil <code>tiffinfo</code> permet d&#8217;obtenir des informations sur le fichier :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> ls -al congratulations.tiff
<span class="tok-go">-rw-r--r-- 1 jpe jpe 904520 mars  23 10:34 congratulations.tiff</span>
<span class="tok-gp">$</span> tiffinfo -v congratulations.tiff
<span class="tok-go">TIFF Directory at offset 0x8 (8)</span>
<span class="tok-go">  Image Width: 636 Image Length: 474</span>
<span class="tok-go">  Bits/Sample: 8</span>
<span class="tok-go">  Compression Scheme: None</span>
<span class="tok-go">  Photometric Interpretation: RGB color</span>
<span class="tok-go">  Samples/Pixel: 3</span>
<span class="tok-go">  Rows/Strip: 474</span>
<span class="tok-go">  Planar Configuration: single image plane</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sachant que 8 bits sont utilisés pour stocker un "sample", qu&#8217;un pixel nécessite 3
"samples" et que les dimensions de l&#8217;image sont <code>636 x 474</code>, il faut donc
<code>3 * 636 * 474 = 904392</code> octets pour stocker l&#8217;ensemble des pixels. Par rapport
à la taille totale du fichier (904520 octets), il ne reste plus que 128 octets
qui correspondent aux entêtes du fichier. Un rapide examen de ces
derniers, en utlisant par exemple le script <a href="#_parse_tiff_rb">parse_tiff.rb</a> disponible en
annexe, ne permet pas d&#8217;identifier de données cachées pouvant représenter
l&#8217;adresse email recherchée. Toutes les données du fichier étant alors utilisées
pour représenter l&#8217;image, il faut donc aller chercher ailleurs pour poursuivre
le challenge.</p>
</div>
<div class="paragraph">
<p>Une hypothèse intéressante est de supposer que la suite du challenge ne peut
être stockée que dans les informations décrivant chaque pixel. Une technique
stéganographique bien connue permet justement de réaliser cet objectif, en utilisant
les bits les moins significatifs (dits de poids faible) de chaque pixel pour
dissimuler de l&#8217;information.</p>
</div>
<div class="paragraph">
<p>L&#8217;outil <a href="https://github.com/apsdehal/ctf-tools">StegSolve @ <strong>GitHub</strong></a>, bien connu
des participants de CTF, est utile pour détecter l&#8217;utilisation de techniques
stéganographiques au sein d&#8217;une image. Il permet notamment de visualiser séparement
chaque bit des trois composantes RGB pour vérifier leur utilisation au
niveau de l&#8217;image.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
StegSolve ne sait pas analyser directement une image au format TIFF mais une
conversion sans perte au format PNG (par exemple avec ImageMagick)
conserve le codage des pixels.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;examen de la composante rouge met en évidence une anomalie au niveau
du bit 0 :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_stegsolve_red0.png" alt="rk stegsolve red0">
</div>
</div>
<div class="paragraph">
<p>De la même manière, le bit 0 de la composante verte semble être
utilisé pour stocker des données :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_stegsolve_green0.png" alt="rk stegsolve green0">
</div>
</div>
<div class="paragraph">
<p>Ces données sont finalement extraites à l&#8217;aide de la fonctionnalité
&#8220;Data Extract&#8221; de StegSolve, en sélectionnant les bits 0 des composantes
vertes et rouges. On peut alors reconnaitre un entête d&#8217;une
archive <code>bzip2</code>, comme présenté ci-dessous :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_stegsolve_data.png" alt="rk stegsolve data">
</div>
</div>
<div class="paragraph">
<p>Il ne reste plus alors qu&#8217;à sauvegarder le résultat pour poursuivre le
challenge.</p>
</div>
</div>
<div class="sect2">
<h3 id="_congratulations_gif">congratulations.gif</h3>
<div class="paragraph">
<p>Le fichier obtenu à la phase précédente est une archive <code>tar.bz2</code> contenant
une nouvelle image à analyser, <code>congratulations.gif</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span class="tok-gp">$</span> tar jxvf step4.bz2

<span class="tok-go">bzip2: (stdin): trailing garbage after EOF ignored</span>
<span class="tok-go">congratulations.gif</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette image est présentée ci-dessous :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_congratulations_gif.png" alt="rk congratulations gif">
</div>
</div>
<div class="paragraph">
<p>On peut alors profiter que StegSolve soit toujours lancé pour charger l&#8217;image
obtenue et l&#8217;analyser.</p>
</div>
<div class="paragraph">
<p>La fonctionnalité &#8220;Random colour map&#8221; affiche finalement l&#8217;adresse
email de validation, comme présenté ci-dessous :</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/rk_stegsolve_random.png" alt="rk stegsolve random">
</div>
</div>
<div class="paragraph">
<p>En plissant les yeux et en faisant attention, on arrive enfin à recopier
l&#8217;adresse de validation qui est : <code>1713e7c1d0b750ccd4e002bb957aa799@challenge.sstic.org</code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le challenge de cette année s&#8217;est révélé original par rapport au nombre d&#8217;étapes à franchir. Celles-ci, de difficulté variable, touchent
à des problématiques variées qui requièrent une certaine polyvalence au niveau des compétences nécessaires.</p>
</div>
<div class="paragraph">
<p>L&#8217;ensemble des outils développés sera mis à disposition à l&#8217;adresse <a href="https://github.com/nieluj/sstic2015" class="bare">https://github.com/nieluj/sstic2015</a> une fois le challenge terminé.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_annexes">Annexes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_stage_4">Stage 4</h3>
<div id="_clean_js" class="listingblock">
<div class="title">clean.js</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125</div></td><td class="code"><span class="tok-kd">var</span> <span class="tok-nx">fs</span> <span class="tok-o">=</span> <span class="tok-nx">require</span><span class="tok-p">(</span><span class="tok-s1">&#39;fs&#39;</span><span class="tok-p">);</span>

<span class="tok-kd">var</span> <span class="tok-nx">esprima</span> <span class="tok-o">=</span> <span class="tok-nx">require</span><span class="tok-p">(</span><span class="tok-s1">&#39;esprima&#39;</span><span class="tok-p">);</span>
<span class="tok-kd">var</span> <span class="tok-nx">estraverse</span> <span class="tok-o">=</span> <span class="tok-nx">require</span><span class="tok-p">(</span><span class="tok-s1">&#39;estraverse&#39;</span><span class="tok-p">);</span>
<span class="tok-kd">var</span> <span class="tok-nx">escodegen</span> <span class="tok-o">=</span> <span class="tok-nx">require</span><span class="tok-p">(</span><span class="tok-s1">&#39;escodegen&#39;</span><span class="tok-p">);</span>

<span class="tok-kd">var</span> <span class="tok-nx">filename</span> <span class="tok-o">=</span> <span class="tok-nx">process</span><span class="tok-p">.</span><span class="tok-nx">argv</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">];</span>
<span class="tok-kd">var</span> <span class="tok-nx">ast</span> <span class="tok-o">=</span> <span class="tok-nx">esprima</span><span class="tok-p">.</span><span class="tok-nx">parse</span><span class="tok-p">(</span><span class="tok-nx">fs</span><span class="tok-p">.</span><span class="tok-nx">readFileSync</span><span class="tok-p">(</span><span class="tok-nx">filename</span><span class="tok-p">));</span>

<span class="tok-kd">function</span> <span class="tok-nx">simplify_node</span><span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">((</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;BinaryExpression&#39;</span><span class="tok-p">)</span> <span class="tok-o">&amp;&amp;</span>
        <span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">left</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Literal&#39;</span><span class="tok-p">)</span> <span class="tok-o">&amp;&amp;</span>
        <span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">right</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Literal&#39;</span><span class="tok-p">))</span> <span class="tok-p">{</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">operator</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;+&#39;</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-k">return</span> <span class="tok-p">{</span>
                <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Literal&#39;</span><span class="tok-p">,</span>
                <span class="tok-nx">value</span><span class="tok-o">:</span> <span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">left</span><span class="tok-p">.</span><span class="tok-nx">value</span> <span class="tok-o">+</span> <span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">right</span><span class="tok-p">.</span><span class="tok-nx">value</span><span class="tok-p">,</span>
                <span class="tok-nx">raw</span><span class="tok-o">:</span> <span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">left</span><span class="tok-p">.</span><span class="tok-nx">raw</span> <span class="tok-o">+</span> <span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">right</span><span class="tok-p">.</span><span class="tok-nx">raw</span>
            <span class="tok-p">};</span>
        <span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">operator</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;*&#39;</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-k">return</span> <span class="tok-p">{</span>
                <span class="tok-nx">type</span><span class="tok-o">:</span> <span class="tok-s1">&#39;Literal&#39;</span><span class="tok-p">,</span>
                <span class="tok-nx">value</span><span class="tok-o">:</span> <span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">left</span><span class="tok-p">.</span><span class="tok-nx">value</span> <span class="tok-o">*</span> <span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">right</span><span class="tok-p">.</span><span class="tok-nx">value</span><span class="tok-p">,</span>
                <span class="tok-nx">raw</span><span class="tok-o">:</span> <span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">left</span><span class="tok-p">.</span><span class="tok-nx">raw</span> <span class="tok-o">*</span> <span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">right</span><span class="tok-p">.</span><span class="tok-nx">raw</span>
            <span class="tok-p">};</span>
        <span class="tok-p">}</span>
    <span class="tok-p">}</span>
    <span class="tok-k">return</span> <span class="tok-nx">node</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kd">function</span> <span class="tok-nx">simplify_ast</span><span class="tok-p">(</span><span class="tok-nx">ast</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kd">var</span> <span class="tok-nx">assignments</span> <span class="tok-o">=</span> <span class="tok-p">{};</span>
    <span class="tok-kd">var</span> <span class="tok-nx">f_count</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-kd">var</span> <span class="tok-nx">scopeChain</span> <span class="tok-o">=</span> <span class="tok-p">[];</span>

    <span class="tok-nx">estraverse</span><span class="tok-p">.</span><span class="tok-nx">traverse</span><span class="tok-p">(</span><span class="tok-nx">ast</span><span class="tok-p">,</span> <span class="tok-p">{</span>
        <span class="tok-nx">enter</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">,</span> <span class="tok-nx">parent</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-kd">var</span> <span class="tok-nx">scopeName</span><span class="tok-p">;</span>
            <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;FunctionDeclaration&#39;</span><span class="tok-p">)</span>
                <span class="tok-nx">scopeName</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;function_&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">id</span><span class="tok-p">.</span><span class="tok-nx">name</span><span class="tok-p">;</span>

            <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Program&#39;</span><span class="tok-p">)</span>
                <span class="tok-nx">scopeName</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;program&#39;</span><span class="tok-p">;</span>

            <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">scopeName</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                <span class="tok-nx">scopeChain</span><span class="tok-p">.</span><span class="tok-nx">push</span><span class="tok-p">(</span><span class="tok-nx">scopeName</span><span class="tok-p">);</span>
                <span class="tok-nx">assignments</span><span class="tok-p">[</span><span class="tok-nx">scopeName</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{};</span>
            <span class="tok-p">}</span>

            <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Identifier&#39;</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                <span class="tok-kd">var</span> <span class="tok-nx">currentScope</span> <span class="tok-o">=</span> <span class="tok-nx">scopeChain</span><span class="tok-p">[</span><span class="tok-nx">scopeChain</span><span class="tok-p">.</span><span class="tok-nx">length</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">];</span>
                <span class="tok-nx">k</span> <span class="tok-o">=</span> <span class="tok-nx">assignments</span><span class="tok-p">[</span><span class="tok-nx">currentScope</span><span class="tok-p">][</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">name</span><span class="tok-p">];</span>
                <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">parent</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;AssignmentExpression&#39;</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                    <span class="tok-cm">/* Node is on the left-hand side of the assignment */</span>
                    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">parent</span><span class="tok-p">.</span><span class="tok-nx">left</span> <span class="tok-o">==</span> <span class="tok-nx">node</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                        <span class="tok-nx">right</span> <span class="tok-o">=</span> <span class="tok-nx">parent</span><span class="tok-p">.</span><span class="tok-nx">right</span><span class="tok-p">;</span>
                        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-nx">k</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                            <span class="tok-nx">assignments</span><span class="tok-p">[</span><span class="tok-nx">currentScope</span><span class="tok-p">][</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">name</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
                                <span class="tok-nx">node</span><span class="tok-o">:</span> <span class="tok-nx">right</span><span class="tok-p">,</span>
                                <span class="tok-nx">ref_count</span><span class="tok-o">:</span> <span class="tok-mi">1</span>
                            <span class="tok-p">};</span>
                        <span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-p">{</span>
                            <span class="tok-cm">/* Not the first assignment, increasing ref count */</span>
                            <span class="tok-nx">k</span><span class="tok-p">[</span><span class="tok-s1">&#39;ref_count&#39;</span><span class="tok-p">]</span><span class="tok-o">++</span><span class="tok-p">;</span>
                        <span class="tok-p">}</span>
                    <span class="tok-p">}</span>
                <span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-k">if</span> <span class="tok-p">((</span><span class="tok-nx">parent</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;UpdateExpression&#39;</span><span class="tok-p">)</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-nx">k</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                    <span class="tok-nx">k</span><span class="tok-p">[</span><span class="tok-s1">&#39;ref_count&#39;</span><span class="tok-p">]</span><span class="tok-o">++</span><span class="tok-p">;</span>
                <span class="tok-p">}</span>
            <span class="tok-p">}</span>
        <span class="tok-p">},</span>
        <span class="tok-nx">leave</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">,</span> <span class="tok-nx">parent</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-k">if</span> <span class="tok-p">((</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;FunctionDeclaration&#39;</span><span class="tok-p">)</span> <span class="tok-o">||</span> <span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Program&#39;</span><span class="tok-p">))</span> <span class="tok-p">{</span>
                <span class="tok-nx">scopeChain</span><span class="tok-p">.</span><span class="tok-nx">pop</span><span class="tok-p">();</span>
            <span class="tok-p">}</span>
        <span class="tok-p">}</span>
    <span class="tok-p">});</span>

    <span class="tok-nx">scopeChain</span> <span class="tok-o">=</span> <span class="tok-p">[];</span>

    <span class="tok-nx">result</span> <span class="tok-o">=</span> <span class="tok-nx">estraverse</span><span class="tok-p">.</span><span class="tok-nx">replace</span><span class="tok-p">(</span><span class="tok-nx">ast</span><span class="tok-p">,</span> <span class="tok-p">{</span>
        <span class="tok-nx">enter</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">,</span> <span class="tok-nx">parent</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;FunctionDeclaration&#39;</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                <span class="tok-nx">scopeChain</span><span class="tok-p">.</span><span class="tok-nx">push</span><span class="tok-p">(</span><span class="tok-s1">&#39;function_&#39;</span> <span class="tok-o">+</span> <span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">id</span><span class="tok-p">.</span><span class="tok-nx">name</span><span class="tok-p">);</span>
            <span class="tok-p">}</span>
            <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Program&#39;</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                <span class="tok-nx">scopeChain</span><span class="tok-p">.</span><span class="tok-nx">push</span><span class="tok-p">(</span><span class="tok-s1">&#39;program&#39;</span><span class="tok-p">);</span>
            <span class="tok-p">}</span>

            <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Identifier&#39;</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                <span class="tok-kd">var</span> <span class="tok-nx">currentScope</span> <span class="tok-o">=</span> <span class="tok-nx">scopeChain</span><span class="tok-p">[</span><span class="tok-nx">scopeChain</span><span class="tok-p">.</span><span class="tok-nx">length</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">];</span>
                <span class="tok-nx">k</span> <span class="tok-o">=</span> <span class="tok-nx">assignments</span><span class="tok-p">[</span><span class="tok-nx">currentScope</span><span class="tok-p">][</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">name</span><span class="tok-p">]</span> <span class="tok-o">||</span> <span class="tok-nx">assignments</span><span class="tok-p">[</span><span class="tok-s1">&#39;program&#39;</span><span class="tok-p">][</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">name</span><span class="tok-p">];</span>

                <span class="tok-k">if</span> <span class="tok-p">((</span><span class="tok-nx">parent</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;AssignmentExpression&#39;</span><span class="tok-p">)</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-p">(</span><span class="tok-nx">parent</span><span class="tok-p">.</span><span class="tok-nx">left</span> <span class="tok-o">==</span> <span class="tok-nx">node</span><span class="tok-p">)</span> <span class="tok-o">||</span>
                    <span class="tok-p">(</span><span class="tok-nx">parent</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;UpdateExpression&#39;</span><span class="tok-p">))</span> <span class="tok-p">{</span>
                    <span class="tok-k">return</span> <span class="tok-nx">node</span><span class="tok-p">;</span>
                <span class="tok-p">}</span>
                <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nx">k</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-nx">k</span><span class="tok-p">[</span><span class="tok-s1">&#39;ref_count&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                    <span class="tok-k">if</span> <span class="tok-p">((</span><span class="tok-nx">k</span><span class="tok-p">.</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Literal&#39;</span><span class="tok-p">)</span> <span class="tok-o">||</span> <span class="tok-p">(</span><span class="tok-nx">k</span><span class="tok-p">.</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Identifier&#39;</span><span class="tok-p">))</span> <span class="tok-p">{</span>
                        <span class="tok-k">return</span> <span class="tok-nx">k</span><span class="tok-p">.</span><span class="tok-nx">node</span><span class="tok-p">;</span>
                    <span class="tok-p">}</span>
                <span class="tok-p">}</span>
            <span class="tok-p">}</span>
            <span class="tok-k">return</span> <span class="tok-nx">simplify_node</span><span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">);</span>
        <span class="tok-p">},</span>
        <span class="tok-nx">leave</span><span class="tok-o">:</span> <span class="tok-kd">function</span><span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">,</span> <span class="tok-nx">parent</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-k">if</span> <span class="tok-p">((</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;FunctionDeclaration&#39;</span><span class="tok-p">)</span> <span class="tok-o">||</span> <span class="tok-p">(</span><span class="tok-nx">node</span><span class="tok-p">.</span><span class="tok-nx">type</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;Program&#39;</span><span class="tok-p">))</span> <span class="tok-p">{</span>
                <span class="tok-nx">scopeChain</span><span class="tok-p">.</span><span class="tok-nx">pop</span><span class="tok-p">();</span>
            <span class="tok-p">}</span>
        <span class="tok-p">}</span>
    <span class="tok-p">});</span>

    <span class="tok-k">return</span> <span class="tok-nx">result</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-cm">/* Looking for a fix point */</span>
<span class="tok-nx">new_code</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;&quot;</span>
<span class="tok-k">do</span> <span class="tok-p">{</span>
    <span class="tok-nx">old_code</span> <span class="tok-o">=</span> <span class="tok-nx">new_code</span><span class="tok-p">;</span>
    <span class="tok-nx">ast</span> <span class="tok-o">=</span> <span class="tok-nx">simplify_ast</span><span class="tok-p">(</span><span class="tok-nx">ast</span><span class="tok-p">);</span>
    <span class="tok-nx">new_code</span> <span class="tok-o">=</span> <span class="tok-nx">escodegen</span><span class="tok-p">.</span><span class="tok-nx">generate</span><span class="tok-p">(</span><span class="tok-nx">ast</span><span class="tok-p">);</span>
<span class="tok-p">}</span>
<span class="tok-k">while</span> <span class="tok-p">(</span><span class="tok-nx">new_code</span> <span class="tok-o">!=</span> <span class="tok-nx">old_code</span><span class="tok-p">);</span>

<span class="tok-nx">console</span><span class="tok-p">.</span><span class="tok-nx">log</span><span class="tok-p">(</span><span class="tok-nx">new_code</span><span class="tok-p">);</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stage_5">Stage 5</h3>
<div id="_t0_asm" class="listingblock">
<div class="title">t0.asm</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="st20"><span class="tok-c">; New subroutine 0+d; References: 0, Local Vars: 76</span>
<span class="tok-nl">00000000:</span> <span class="tok-s">64 b4 </span>    <span class="tok-nl">sub_0:</span>        <span class="tok-k">ajw</span> <span class="tok-mh">#-4c</span>       <span class="tok-c">; réserve 76 variables locales</span>
<span class="tok-nl">00000002:</span> <span class="tok-s">40 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">00000003:</span> <span class="tok-s">d1 </span>                     <span class="tok-k">stl</span> <span class="tok-mh">#1</span> <span class="tok-no">[var_1]</span> <span class="tok-c">; var_1 = 0</span>
<span class="tok-nl">00000004:</span> <span class="tok-s">40 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">00000005:</span> <span class="tok-s">d3 </span>                     <span class="tok-k">stl</span> <span class="tok-mh">#3</span> <span class="tok-no">[var_3]</span> <span class="tok-c">; var_3 = 0</span>
<span class="tok-nl">00000006:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>           <span class="tok-c">; A = MostNeg</span>
<span class="tok-nl">00000008:</span> <span class="tok-s">24 20 50 </span>               <span class="tok-k">ldnlp</span> <span class="tok-mh">#400</span>     <span class="tok-c">; A = MostNeg @ 0x400</span>
<span class="tok-nl">0000000b:</span> <span class="tok-s">23 fc </span>                  <span class="tok-k">gajw</span>           <span class="tok-c">; Wptr = MostNeg @ 0x400</span>

<span class="tok-c">; New subroutine d+eb; References: 0, Local Vars: 76</span>
<span class="tok-nl">0000000d:</span> <span class="tok-s">64 b4 </span>    <span class="tok-nl">sub_d:</span>        <span class="tok-k">ajw</span> <span class="tok-mh">#-4c</span>           <span class="tok-c">; réserve 76 variables locales</span>
<span class="tok-nl">0000000f:</span> <span class="tok-s">2c 49 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#c9</span>
<span class="tok-nl">00000011:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[str_dc]</span>
<span class="tok-nl">00000013:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000015:</span> <span class="tok-s">48 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#8</span>
<span class="tok-nl">00000016:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(8, MostNeg, &quot;Boot ok&quot;)</span>
<span class="tok-nl">00000017:</span> <span class="tok-s">24 19 </span>    <span class="tok-nl">loc_17:</span>       <span class="tok-k">ldlp</span> <span class="tok-mh">#49</span> <span class="tok-no">[&amp;var_73]</span>
<span class="tok-nl">00000019:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000001b:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">0000001c:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000001d:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(12, MostNeg @ 4, &amp;var_73)</span>
<span class="tok-nl">0000001e:</span> <span class="tok-s">24 79 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#49</span> <span class="tok-no">[var_73]</span>
<span class="tok-nl">00000020:</span> <span class="tok-s">21 a5 </span>                  <span class="tok-k">cj</span> <span class="tok-nl">loc_37</span>         <span class="tok-c">; saute à loc_37 si var_73 == 0</span>
<span class="tok-nl">00000022:</span> <span class="tok-s">2c 4d </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#cd</span>
<span class="tok-nl">00000024:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[loc_f3]</span>
<span class="tok-nl">00000026:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000028:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">00000029:</span> <span class="tok-s">24 79 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#49</span> <span class="tok-no">[var_73]</span>
<span class="tok-nl">0000002b:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(var_73, MostNeg @ 4, loc_f3)</span>
<span class="tok-nl">0000002c:</span> <span class="tok-s">2c 43 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#c3</span>
<span class="tok-nl">0000002e:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[loc_f3]</span>
<span class="tok-nl">00000030:</span> <span class="tok-s">24 7a </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#4a</span> <span class="tok-no">[var_74]</span>
<span class="tok-nl">00000032:</span> <span class="tok-s">24 79 </span>                  <span class="tok-k">ldl</span> <span class="tok-mh">#49</span> <span class="tok-no">[var_73]</span>
<span class="tok-nl">00000034:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>               <span class="tok-c">; out(var_73, var_74, loc_f3)</span>
<span class="tok-nl">00000035:</span> <span class="tok-s">61 00 </span>                  <span class="tok-k">j</span> <span class="tok-nl">loc_17</span>
<span class="tok-nl">00000037:</span> <span class="tok-s">24 19 </span>    <span class="tok-nl">loc_37:</span>       <span class="tok-k">ldlp</span> <span class="tok-mh">#49</span> <span class="tok-no">[&amp;var_73]</span>
<span class="tok-nl">00000039:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000003b:</span> <span class="tok-s">51 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#1</span>
<span class="tok-nl">0000003c:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000003d:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>               <span class="tok-c">; out(12, MostNeg @ 1, &amp;var_73)</span>
<span class="tok-nl">0000003e:</span> <span class="tok-s">24 19 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#49</span> <span class="tok-no">[&amp;var_73]</span>
<span class="tok-nl">00000040:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000042:</span> <span class="tok-s">52 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#2</span>
<span class="tok-nl">00000043:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000044:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(12, MostNeg @ 2, &amp;var_73)</span>
<span class="tok-nl">00000045:</span> <span class="tok-s">24 19 </span>                  <span class="tok-k">ldlp</span> <span class="tok-mh">#49</span> <span class="tok-no">[&amp;var_73]</span>
<span class="tok-nl">00000047:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000049:</span> <span class="tok-s">53 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#3</span>
<span class="tok-nl">0000004a:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000004b:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(12, MostNeg @ 3, &amp;var_73)</span>
<span class="tok-nl">0000004c:</span> <span class="tok-s">29 44 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#94</span>
<span class="tok-nl">0000004e:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[str_e4]</span>
<span class="tok-nl">00000050:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000052:</span> <span class="tok-s">48 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#8</span>
<span class="tok-nl">00000053:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(8, MostNeg, &quot;Code Ok&quot;)</span>
<span class="tok-nl">00000054:</span> <span class="tok-s">12 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#2</span> <span class="tok-no">[&amp;var_2]</span>
<span class="tok-nl">00000055:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000057:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">00000058:</span> <span class="tok-s">44 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#4</span>
<span class="tok-nl">00000059:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(4, MostNeg @ 4, &amp;var_2)</span>
<span class="tok-nl">0000005a:</span> <span class="tok-s">15 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#5</span> <span class="tok-no">[&amp;var_5]</span>
<span class="tok-nl">0000005b:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000005d:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">0000005e:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000005f:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(12, MostNeg @ 4, &amp;var_5)</span>
<span class="tok-nl">00000060:</span> <span class="tok-s">28 48 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#88</span>
<span class="tok-nl">00000062:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[str_ec]</span>
<span class="tok-nl">00000064:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000066:</span> <span class="tok-s">48 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#8</span>
<span class="tok-nl">00000067:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(8, MostNeg, &quot;Decrypt&quot;)</span>
<span class="tok-nl">00000068:</span> <span class="tok-s">13 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#3</span> <span class="tok-no">[&amp;var_3]</span>
<span class="tok-nl">00000069:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000006b:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">0000006c:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">0000006d:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(1, MostNeg @ 4, &amp;var_3)</span>
<span class="tok-nl">0000006e:</span> <span class="tok-s">19 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#9</span> <span class="tok-no">[&amp;var_9]</span>
<span class="tok-nl">0000006f:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000071:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">00000072:</span> <span class="tok-s">13 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#3</span> <span class="tok-no">[&amp;var_3]</span>
<span class="tok-nl">00000073:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>
<span class="tok-nl">00000074:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(*var3, MostNeg @ 4, &amp;var_9)</span>
<span class="tok-nl">00000075:</span> <span class="tok-s">40 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">00000076:</span> <span class="tok-s">d4 </span>                     <span class="tok-k">stl</span> <span class="tok-mh">#4</span> <span class="tok-no">[var_4]</span>    <span class="tok-c">; var_4 = 0</span>
<span class="tok-nl">00000077:</span> <span class="tok-s">11 </span>       <span class="tok-nl">loc_77:</span>       <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000078:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000007a:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">0000007b:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">0000007c:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(1, MostNeg @ 4, &amp;var_1)</span>
<span class="tok-nl">0000007d:</span> <span class="tok-s">15 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#5</span> <span class="tok-no">[&amp;var_5]</span>
<span class="tok-nl">0000007e:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000080:</span> <span class="tok-s">51 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000081:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000082:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>               <span class="tok-c">; out(12, MostNeg @ 1, &amp;var_5)</span>
<span class="tok-nl">00000083:</span> <span class="tok-s">15 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#5</span> <span class="tok-no">[&amp;var_5]</span>
<span class="tok-nl">00000084:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000086:</span> <span class="tok-s">52 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#2</span>
<span class="tok-nl">00000087:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000088:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>               <span class="tok-c">; out(12, MostNeg @ 2, &amp;var_5)</span>
<span class="tok-nl">00000089:</span> <span class="tok-s">15 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#5</span> <span class="tok-no">[&amp;var_5]</span>
<span class="tok-nl">0000008a:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000008c:</span> <span class="tok-s">53 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#3</span>
<span class="tok-nl">0000008d:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000008e:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>               <span class="tok-c">; out(12, MostNeg @ 3, &amp;var_5)</span>
<span class="tok-nl">0000008f:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">00000090:</span> <span class="tok-s">81 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000091:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000093:</span> <span class="tok-s">55 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#5</span>
<span class="tok-nl">00000094:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000095:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(1, MostNeg @ 5, &amp;var_0 + 1)</span>
<span class="tok-nl">00000096:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">00000097:</span> <span class="tok-s">82 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#2</span>
<span class="tok-nl">00000098:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000009a:</span> <span class="tok-s">56 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#6</span>
<span class="tok-nl">0000009b:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">0000009c:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(1, MostNeg @ 6, &amp;var_0 + 2)</span>
<span class="tok-nl">0000009d:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">0000009e:</span> <span class="tok-s">83 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#3</span>
<span class="tok-nl">0000009f:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">000000a1:</span> <span class="tok-s">57 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#7</span>
<span class="tok-nl">000000a2:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">000000a3:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                <span class="tok-c">; in(1, MostNeg @ 7, &amp;var_0 + 3)</span>
<span class="tok-nl">000000a4:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">000000a5:</span> <span class="tok-s">81 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">000000a6:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>
<span class="tok-nl">000000a7:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">000000a8:</span> <span class="tok-s">82 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#2</span>
<span class="tok-nl">000000a9:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>
<span class="tok-nl">000000aa:</span> <span class="tok-s">23 f3 </span>                  <span class="tok-k">xor</span>               <span class="tok-c">; A = var_0[2] ^ var_0[1]</span>
<span class="tok-nl">000000ac:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">000000ad:</span> <span class="tok-s">83 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#3</span>
<span class="tok-nl">000000ae:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>
<span class="tok-nl">000000af:</span> <span class="tok-s">23 f3 </span>                  <span class="tok-k">xor</span>               <span class="tok-c">; A = var_0[3] ^ ( var_0[2] ^ var_0[1] )</span>
<span class="tok-nl">000000b1:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">000000b2:</span> <span class="tok-s">81 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">000000b3:</span> <span class="tok-s">23 fb </span>                  <span class="tok-k">sb</span>                <span class="tok-c">; var_0[1] = var_0[3] ^ ( var_0[2] ^ var_0[1] )</span>
<span class="tok-nl">000000b5:</span> <span class="tok-s">11 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">000000b6:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>                <span class="tok-c">; A = var_1</span>
<span class="tok-nl">000000b7:</span> <span class="tok-s">74 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#4</span> <span class="tok-no">[var_4]</span>    <span class="tok-c">; A = var_4, B = var_1</span>
<span class="tok-nl">000000b8:</span> <span class="tok-s">15 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#5</span> <span class="tok-no">[&amp;var_5]</span>  <span class="tok-c">; A = &amp;var_5, B = var_4, C = var_1</span>
<span class="tok-nl">000000b9:</span> <span class="tok-s">f2 </span>                     <span class="tok-k">bsub</span>              <span class="tok-c">; A = &amp;var_5 + var_4, B = var_1</span>
<span class="tok-nl">000000ba:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>                <span class="tok-c">; A = var_5[var_4], B = var_1</span>
<span class="tok-nl">000000bb:</span> <span class="tok-s">74 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#4</span> <span class="tok-no">[var_4]</span>    <span class="tok-c">; A = var_4, B = var_5[var_4], C = var_1</span>
<span class="tok-nl">000000bc:</span> <span class="tok-s">2c f1 </span>                  <span class="tok-k">ssub</span>              <span class="tok-c">; A = var_4 + 2 * var_5[var_4], B = var_1</span>
<span class="tok-nl">000000be:</span> <span class="tok-s">23 f3 </span>                  <span class="tok-k">xor</span>               <span class="tok-c">; A = (var_4 + 2 * var_5[var_4]) ^ var_1</span>
<span class="tok-nl">000000c0:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">000000c1:</span> <span class="tok-s">23 fb </span>                  <span class="tok-k">sb</span>                <span class="tok-c">; var_0[0] = (var_4 + 2 * var_5[var_4]) ^ var_1</span>
<span class="tok-nl">000000c3:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">000000c4:</span> <span class="tok-s">81 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">000000c5:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>                <span class="tok-c">; A = var_0[1]</span>
<span class="tok-nl">000000c6:</span> <span class="tok-s">74 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#4</span> <span class="tok-no">[var_4]</span>
<span class="tok-nl">000000c7:</span> <span class="tok-s">15 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#5</span> <span class="tok-no">[&amp;var_5]</span>
<span class="tok-nl">000000c8:</span> <span class="tok-s">f2 </span>                     <span class="tok-k">bsub</span>              <span class="tok-c">; A = &amp;var_5 + var_4, B = var_0[1]</span>
<span class="tok-nl">000000c9:</span> <span class="tok-s">23 fb </span>                  <span class="tok-k">sb</span>                <span class="tok-c">; var_5[var_4] = var_0[1]</span>
<span class="tok-nl">000000cb:</span> <span class="tok-s">74 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#4</span> <span class="tok-no">[var_4]</span>
<span class="tok-nl">000000cc:</span> <span class="tok-s">81 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">000000cd:</span> <span class="tok-s">25 fa </span>                  <span class="tok-k">dup</span>               <span class="tok-c">; A = var_4 + 1, B = var_4 + 1</span>
<span class="tok-nl">000000cf:</span> <span class="tok-s">d4 </span>                     <span class="tok-k">stl</span> <span class="tok-mh">#4</span> <span class="tok-no">[var_4]</span>    <span class="tok-c">; var_4 var_4 + 1, A = var_4 + 1</span>
<span class="tok-nl">000000d0:</span> <span class="tok-s">cc </span>                     <span class="tok-k">eqc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">000000d1:</span> <span class="tok-s">a3 </span>                     <span class="tok-k">cj</span> <span class="tok-nl">loc_d5</span>         <span class="tok-c">; saute à loc_d5 si var_4 != 12</span>
<span class="tok-nl">000000d2:</span> <span class="tok-s">80 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">000000d3:</span> <span class="tok-s">40 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#0</span>
<span class="tok-nl">000000d4:</span> <span class="tok-s">d4 </span>                     <span class="tok-k">stl</span> <span class="tok-mh">#4</span> <span class="tok-no">[var_4]</span>    <span class="tok-c">; var_4 = 0</span>
<span class="tok-nl">000000d5:</span> <span class="tok-s">10 </span>       <span class="tok-nl">loc_d5:</span>       <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">000000d6:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">000000d8:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">000000d9:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>               <span class="tok-c">; out(1, MostNeg, &amp;var_0)</span>
<span class="tok-nl">000000da:</span> <span class="tok-s">66 0b </span>                  <span class="tok-k">j</span> <span class="tok-nl">loc_77</span>          <span class="tok-c">; saute à loc_77</span>
<span class="tok-nl">000000dc:</span> <span class="tok-s">** </span>       <span class="tok-nl">str_dc:</span>      <span class="tok-s">.string</span> <span class="tok-s">&quot;Boot ok&quot;</span>
<span class="tok-nl">000000e4:</span> <span class="tok-s">** </span>       <span class="tok-nl">str_e4:</span>      <span class="tok-s">.string</span> <span class="tok-s">&quot;Code Ok&quot;</span>
<span class="tok-nl">000000ec:</span> <span class="tok-s">** </span>       <span class="tok-nl">str_ec:</span>      <span class="tok-s">.string</span> <span class="tok-s">&quot;Decrypt&quot;</span>
<span class="tok-nl">000000f4:</span> <span class="tok-s">24 bc </span>                  <span class="tok-k">ajw</span> <span class="tok-mh">#4c</span>
<span class="tok-nl">000000f6:</span> <span class="tok-s">22 f0 </span>                  <span class="tok-k">ret</span></code></pre>
</div>
</div>
<div id="_t1_asm" class="listingblock">
<div class="title">t1.asm</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="st20"><span class="tok-c">; New subroutine 0+9; References: 0, Local Vars: 8</span>
<span class="tok-nl">00000000:</span> <span class="tok-s">60 b8 </span>    <span class="tok-nl">sub_0:</span>        <span class="tok-k">ajw</span> <span class="tok-mh">#-8</span>       <span class="tok-c">; réserve 8 variables locales</span>
<span class="tok-nl">00000002:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>          <span class="tok-c">; A = MostNeg</span>
<span class="tok-nl">00000004:</span> <span class="tok-s">24 20 50 </span>               <span class="tok-k">ldnlp</span> <span class="tok-mh">#400</span>    <span class="tok-c">; A = MostNeg @ 0x400</span>
<span class="tok-nl">00000007:</span> <span class="tok-s">23 fc </span>                  <span class="tok-k">gajw</span>          <span class="tok-c">; Wptr = MostNeg @ 0x400</span>

<span class="tok-c">; New subroutine 9+67; References: 0, Local Vars: 8</span>
<span class="tok-nl">00000009:</span> <span class="tok-s">60 b8 </span>    <span class="tok-nl">sub_9:</span>        <span class="tok-k">ajw</span> <span class="tok-mh">#-8</span>            <span class="tok-c">; réserve 8 variables locales</span>
<span class="tok-nl">0000000b:</span> <span class="tok-s">15 </span>       <span class="tok-nl">loc_b:</span>        <span class="tok-k">ldlp</span> <span class="tok-mh">#5</span> <span class="tok-no">[&amp;var_5]</span>
<span class="tok-nl">0000000c:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000000e:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">0000000f:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000010:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(12, MostNeg @ 4, &amp;var_5)</span>
<span class="tok-nl">00000011:</span> <span class="tok-s">75 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#5</span> <span class="tok-no">[var_5]</span>
<span class="tok-nl">00000012:</span> <span class="tok-s">21 a2 </span>                  <span class="tok-k">cj</span> <span class="tok-nl">loc_26</span>          <span class="tok-c">; saute à loc_26 si var_5 == 0</span>
<span class="tok-nl">00000014:</span> <span class="tok-s">25 44 </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#54</span>
<span class="tok-nl">00000016:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[loc_6c]</span>
<span class="tok-nl">00000018:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000001a:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">0000001b:</span> <span class="tok-s">75 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#5</span> <span class="tok-no">[var_5]</span>
<span class="tok-nl">0000001c:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(var_5, MostNeg @ 4, loc_6c)</span>
<span class="tok-nl">0000001d:</span> <span class="tok-s">24 4b </span>                  <span class="tok-k">ldc</span> <span class="tok-mh">#4b</span>
<span class="tok-nl">0000001f:</span> <span class="tok-s">21 fb </span>                  <span class="tok-k">ldpi</span> <span class="tok-no">[loc_6c]</span>
<span class="tok-nl">00000021:</span> <span class="tok-s">76 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#6</span> <span class="tok-no">[var_6]</span>
<span class="tok-nl">00000022:</span> <span class="tok-s">75 </span>                     <span class="tok-k">ldl</span> <span class="tok-mh">#5</span> <span class="tok-no">[var_5]</span>
<span class="tok-nl">00000023:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(var_5, var_6, loc_6c)</span>
<span class="tok-nl">00000024:</span> <span class="tok-s">61 05 </span>                  <span class="tok-k">j</span> <span class="tok-nl">loc_b</span>
<span class="tok-nl">00000026:</span> <span class="tok-s">11 </span>       <span class="tok-nl">loc_26:</span>       <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000027:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000029:</span> <span class="tok-s">54 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#4</span>
<span class="tok-nl">0000002a:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000002b:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(12, MostNeg @ 4, &amp;var_1)</span>
<span class="tok-nl">0000002c:</span> <span class="tok-s">11 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">0000002d:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000002f:</span> <span class="tok-s">51 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000030:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000031:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(12, MostNeg @ 1, &amp;var_1)</span>
<span class="tok-nl">00000032:</span> <span class="tok-s">11 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000033:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000035:</span> <span class="tok-s">52 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#2</span>
<span class="tok-nl">00000036:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">00000037:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(12, MostNeg @ 2, &amp;var_1)</span>
<span class="tok-nl">00000038:</span> <span class="tok-s">11 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#1</span> <span class="tok-no">[&amp;var_1]</span>
<span class="tok-nl">00000039:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">0000003b:</span> <span class="tok-s">53 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#3</span>
<span class="tok-nl">0000003c:</span> <span class="tok-s">4c </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#c</span>
<span class="tok-nl">0000003d:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(12, MostNeg @ 3, &amp;var_1)</span>
<span class="tok-nl">0000003e:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">0000003f:</span> <span class="tok-s">81 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000040:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000042:</span> <span class="tok-s">55 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#5</span>
<span class="tok-nl">00000043:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000044:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(1, MostNeg @ 5, &amp;var_0 + 1)</span>
<span class="tok-nl">00000045:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">00000046:</span> <span class="tok-s">82 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#2</span>
<span class="tok-nl">00000047:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000049:</span> <span class="tok-s">56 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#6</span>
<span class="tok-nl">0000004a:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">0000004b:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(1, MostNeg @ 6, &amp;var_0 + 2)</span>
<span class="tok-nl">0000004c:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">0000004d:</span> <span class="tok-s">83 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#3</span>
<span class="tok-nl">0000004e:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000050:</span> <span class="tok-s">57 </span>                     <span class="tok-k">ldnlp</span> <span class="tok-mh">#7</span>
<span class="tok-nl">00000051:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000052:</span> <span class="tok-s">f7 </span>                     <span class="tok-k">in</span>                 <span class="tok-c">; in(1, MostNeg @ 7, &amp;var_0 + 3)</span>
<span class="tok-nl">00000053:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">00000054:</span> <span class="tok-s">81 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000055:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>                 <span class="tok-c">; A = var_0[1]</span>
<span class="tok-nl">00000056:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">00000057:</span> <span class="tok-s">82 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#2</span>
<span class="tok-nl">00000058:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>                 <span class="tok-c">; A = var_0[2], B = var_0[1]</span>
<span class="tok-nl">00000059:</span> <span class="tok-s">23 f3 </span>                  <span class="tok-k">xor</span>                <span class="tok-c">; A = var_0[2] ^ var_0[1]</span>
<span class="tok-nl">0000005b:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">0000005c:</span> <span class="tok-s">83 </span>                     <span class="tok-k">adc</span> <span class="tok-mh">#3</span>
<span class="tok-nl">0000005d:</span> <span class="tok-s">f1 </span>                     <span class="tok-k">lb</span>                 <span class="tok-c">; A = var_0[3], B = var_0[2] ^ var_0[1]</span>
<span class="tok-nl">0000005e:</span> <span class="tok-s">23 f3 </span>                  <span class="tok-k">xor</span>                <span class="tok-c">; A = var_0[3] ^ (var_0[2] ^ var_0[1])</span>
<span class="tok-nl">00000060:</span> <span class="tok-s">25 fa </span>                  <span class="tok-k">dup</span>                <span class="tok-c">; A = var_0[3] ^ (var_0[2] ^ var_0[1]), B = A</span>
<span class="tok-nl">00000062:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">00000063:</span> <span class="tok-s">23 fb </span>                  <span class="tok-k">sb</span>                 <span class="tok-c">; var_0[0] = var_0[3] ^ (var_0[2] ^ var_0[1])</span>
<span class="tok-nl">00000065:</span> <span class="tok-s">10 </span>                     <span class="tok-k">ldlp</span> <span class="tok-mh">#0</span> <span class="tok-no">[&amp;var_0]</span>
<span class="tok-nl">00000066:</span> <span class="tok-s">24 f2 </span>                  <span class="tok-k">mint</span>
<span class="tok-nl">00000068:</span> <span class="tok-s">41 </span>                     <span class="tok-k">ldc</span> <span class="tok-mh">#1</span>
<span class="tok-nl">00000069:</span> <span class="tok-s">fb </span>                     <span class="tok-k">out</span>                <span class="tok-c">; out(1, MostNeg, var_0[3] ^ (var_0[2] ^ var_0[1]))</span>
<span class="tok-nl">0000006a:</span> <span class="tok-s">64 0a </span>                  <span class="tok-k">j</span> <span class="tok-nl">loc_26</span>           <span class="tok-c">; saute à loc_26</span>
<span class="tok-nl">0000006c:</span> <span class="tok-s">00 </span>       <span class="tok-nl">loc_6c:</span>       <span class="tok-k">nop</span>
<span class="tok-nl">0000006d:</span> <span class="tok-s">b8 </span>                     <span class="tok-k">ajw</span> <span class="tok-mh">#8</span>
<span class="tok-nl">0000006e:</span> <span class="tok-s">22 f0 </span>                  <span class="tok-k">ret</span></code></pre>
</div>
</div>
<div id="_decrypt_c" class="listingblock">
<div class="title">decrypt.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-cp">#include &lt;stdio.h&gt;</span>
<span class="tok-cp">#include &lt;stdlib.h&gt;</span>
<span class="tok-cp">#include &lt;stdint.h&gt;</span>
<span class="tok-cp">#include &lt;string.h&gt;</span>

<span class="tok-cp">#define DEBUG 0</span>

<span class="tok-k">typedef</span> <span class="tok-k">struct</span> <span class="tok-n">tr_ctx</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t4_st</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t5_st</span><span class="tok-p">;</span>
    <span class="tok-kt">uint16_t</span> <span class="tok-n">t6_st</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t8_idx</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t8_st</span><span class="tok-p">[</span><span class="tok-mi">4</span><span class="tok-p">][</span><span class="tok-mi">12</span><span class="tok-p">];</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t10_idx</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t10_st</span><span class="tok-p">[</span><span class="tok-mi">4</span><span class="tok-p">][</span><span class="tok-mi">12</span><span class="tok-p">];</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t12_st</span><span class="tok-p">[</span><span class="tok-mi">12</span><span class="tok-p">];</span>
<span class="tok-p">}</span> <span class="tok-kt">tr_ctx_t</span><span class="tok-p">;</span>

<span class="tok-kr">inline</span> <span class="tok-kt">uint8_t</span> <span class="tok-nf">transputer_4</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span>

    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span>
        <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t4_st</span> <span class="tok-o">+=</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>

    <span class="tok-k">return</span> <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t4_st</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kr">inline</span> <span class="tok-kt">uint8_t</span> <span class="tok-nf">transputer_5</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span>

    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span>
        <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t5_st</span> <span class="tok-o">^=</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>

    <span class="tok-k">return</span> <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t5_st</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kr">inline</span> <span class="tok-kt">uint8_t</span> <span class="tok-nf">transputer_6</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint16_t</span> <span class="tok-n">k1</span><span class="tok-p">,</span> <span class="tok-n">k2</span><span class="tok-p">,</span> <span class="tok-n">k3</span><span class="tok-p">;</span>

    <span class="tok-n">k1</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t6_st</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0x8000</span><span class="tok-p">)</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mh">0xf</span><span class="tok-p">;</span>
    <span class="tok-n">k2</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t6_st</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0x4000</span><span class="tok-p">)</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mh">0xe</span><span class="tok-p">;</span>

    <span class="tok-n">k2</span> <span class="tok-o">^=</span> <span class="tok-n">k1</span><span class="tok-p">;</span>
    <span class="tok-n">k3</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t6_st</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-mi">1</span><span class="tok-p">);</span>

    <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t6_st</span> <span class="tok-o">=</span> <span class="tok-n">k3</span> <span class="tok-o">^</span> <span class="tok-n">k2</span><span class="tok-p">;</span>

    <span class="tok-k">return</span> <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t6_st</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xff</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kr">inline</span> <span class="tok-kt">uint8_t</span> <span class="tok-nf">transputer_1</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">c</span><span class="tok-p">;</span>

    <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-n">transputer_4</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
    <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-n">transputer_5</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
    <span class="tok-n">c</span> <span class="tok-o">=</span> <span class="tok-n">transputer_6</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
<span class="tok-cp">#if DEBUG</span>
    <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;[T1] T4 : 0x%2.2x T5 : 0x%2.2x T6 : 0x%2.2x</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-cp">#endif</span>

    <span class="tok-k">return</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-o">^</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-o">^</span> <span class="tok-n">c</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kr">inline</span> <span class="tok-kt">uint8_t</span> <span class="tok-nf">transputer_7</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_1</span><span class="tok-p">,</span> <span class="tok-n">var_2</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span>

    <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">var_2</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>

    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">6</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">var_1</span> <span class="tok-o">+=</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>
        <span class="tok-n">var_2</span> <span class="tok-o">+=</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-n">i</span> <span class="tok-o">+</span> <span class="tok-mi">6</span><span class="tok-p">];</span>
    <span class="tok-p">}</span>

    <span class="tok-k">return</span> <span class="tok-n">var_1</span> <span class="tok-o">^</span> <span class="tok-n">var_2</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kr">inline</span> <span class="tok-kt">uint8_t</span> <span class="tok-nf">transputer_8</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">j</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_3</span><span class="tok-p">,</span> <span class="tok-n">var_1</span><span class="tok-p">;</span>

    <span class="tok-n">memcpy</span><span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t8_st</span><span class="tok-p">[</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t8_idx</span><span class="tok-p">],</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">);</span>
    <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t8_idx</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t8_idx</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-o">%</span> <span class="tok-mi">4</span><span class="tok-p">;</span>

    <span class="tok-n">var_3</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">4</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
        <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">j</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">j</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">j</span><span class="tok-o">++</span><span class="tok-p">)</span>
            <span class="tok-n">var_1</span> <span class="tok-o">+=</span> <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t8_st</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">][</span><span class="tok-n">j</span><span class="tok-p">];</span>

        <span class="tok-n">var_3</span> <span class="tok-o">=</span> <span class="tok-n">var_1</span> <span class="tok-o">^</span> <span class="tok-n">var_3</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>

    <span class="tok-k">return</span> <span class="tok-n">var_3</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kr">inline</span> <span class="tok-kt">uint8_t</span> <span class="tok-nf">transputer_9</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_1</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span>

    <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span>
        <span class="tok-n">var_1</span> <span class="tok-o">^=</span> <span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0x7</span><span class="tok-p">));</span>

    <span class="tok-k">return</span> <span class="tok-n">var_1</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kr">inline</span> <span class="tok-kt">uint8_t</span> <span class="tok-nf">transputer_2</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">c</span><span class="tok-p">;</span>

    <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-n">transputer_7</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
    <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-n">transputer_8</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
    <span class="tok-n">c</span> <span class="tok-o">=</span> <span class="tok-n">transputer_9</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
<span class="tok-cp">#if DEBUG</span>
    <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;[T2] T7 : 0x%2.2x T8 : 0x%2.2x T9 : 0x%2.2x</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-cp">#endif</span>

    <span class="tok-k">return</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-o">^</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-o">^</span> <span class="tok-n">c</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kr">inline</span> <span class="tok-kt">uint8_t</span> <span class="tok-nf">transputer_10</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">j</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_1</span><span class="tok-p">;</span>

    <span class="tok-n">memcpy</span><span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t10_st</span><span class="tok-p">[</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t10_idx</span><span class="tok-p">],</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">);</span>
    <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t10_idx</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t10_idx</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-o">%</span> <span class="tok-mi">4</span><span class="tok-p">;</span>

    <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">4</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">var_1</span> <span class="tok-o">+=</span> <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t10_st</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">][</span><span class="tok-mi">0</span><span class="tok-p">];</span>
    <span class="tok-p">}</span>

    <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-n">var_1</span> <span class="tok-o">&amp;</span> <span class="tok-mi">3</span><span class="tok-p">;</span>
    <span class="tok-n">j</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">var_1</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-mi">4</span><span class="tok-p">)</span> <span class="tok-o">%</span> <span class="tok-mi">12</span><span class="tok-p">;</span>

    <span class="tok-k">return</span> <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t10_st</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">][</span><span class="tok-n">j</span><span class="tok-p">];</span>
<span class="tok-p">}</span>

<span class="tok-kr">inline</span> <span class="tok-kt">uint8_t</span> <span class="tok-nf">transputer_11</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_1</span><span class="tok-p">;</span>

    <span class="tok-n">var_1</span> <span class="tok-o">=</span> <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t12_st</span><span class="tok-p">[</span><span class="tok-mi">9</span><span class="tok-p">]</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t12_st</span><span class="tok-p">[</span><span class="tok-mi">5</span><span class="tok-p">]</span> <span class="tok-o">^</span> <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t12_st</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]);</span>	<span class="tok-cm">/* from T12 */</span>
    <span class="tok-n">memcpy</span><span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t12_st</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">);</span>

    <span class="tok-k">return</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-n">var_1</span> <span class="tok-o">%</span> <span class="tok-mi">12</span><span class="tok-p">];</span>
<span class="tok-p">}</span>

<span class="tok-kr">inline</span> <span class="tok-kt">uint8_t</span> <span class="tok-nf">transputer_12</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">var_2</span><span class="tok-p">;</span>

    <span class="tok-n">var_2</span> <span class="tok-o">=</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-mi">7</span><span class="tok-p">]</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]</span> <span class="tok-o">^</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]);</span>	<span class="tok-cm">/* from T11 */</span>

    <span class="tok-k">return</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-n">var_2</span> <span class="tok-o">%</span> <span class="tok-mi">12</span><span class="tok-p">];</span>
<span class="tok-p">}</span>

<span class="tok-kr">inline</span> <span class="tok-kt">uint8_t</span> <span class="tok-nf">transputer_3</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">c</span><span class="tok-p">;</span>

    <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-n">transputer_10</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
    <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-n">transputer_11</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
    <span class="tok-n">c</span> <span class="tok-o">=</span> <span class="tok-n">transputer_12</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
<span class="tok-cp">#if DEBUG</span>
    <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;[T3] T10: 0x%2.2x T11: 0x%2.2x T12: 0x%2.2x</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-cp">#endif</span>

    <span class="tok-k">return</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-o">^</span> <span class="tok-n">b</span><span class="tok-p">)</span> <span class="tok-o">^</span> <span class="tok-n">c</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kt">void</span>
<span class="tok-nf">transputer_0</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">cipher</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">cipher_len</span><span class="tok-p">,</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">plain</span><span class="tok-p">,</span> <span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">current_key</span><span class="tok-p">[</span><span class="tok-mi">12</span><span class="tok-p">];</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">t1_res</span><span class="tok-p">,</span> <span class="tok-n">t2_res</span><span class="tok-p">,</span> <span class="tok-n">t3_res</span><span class="tok-p">;</span>

    <span class="tok-n">memcpy</span><span class="tok-p">(</span><span class="tok-n">current_key</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">);</span>

    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">cipher_len</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">t1_res</span> <span class="tok-o">=</span> <span class="tok-n">transputer_1</span><span class="tok-p">(</span><span class="tok-n">current_key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
        <span class="tok-n">t2_res</span> <span class="tok-o">=</span> <span class="tok-n">transputer_2</span><span class="tok-p">(</span><span class="tok-n">current_key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>
        <span class="tok-n">t3_res</span> <span class="tok-o">=</span> <span class="tok-n">transputer_3</span><span class="tok-p">(</span><span class="tok-n">current_key</span><span class="tok-p">,</span> <span class="tok-n">ctx</span><span class="tok-p">);</span>

<span class="tok-cp">#if DEBUG</span>
        <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;[T0] T1 : 0x%2.2x T2 : 0x%2.2x T3 : 0x%2.2x</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-n">t1_res</span><span class="tok-p">,</span> <span class="tok-n">t2_res</span><span class="tok-p">,</span> <span class="tok-n">t3_res</span><span class="tok-p">);</span>
<span class="tok-cp">#endif</span>

        <span class="tok-n">plain</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">cipher</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">^</span> <span class="tok-p">(</span><span class="tok-mi">2</span> <span class="tok-o">*</span> <span class="tok-n">current_key</span><span class="tok-p">[</span><span class="tok-n">i</span> <span class="tok-o">%</span> <span class="tok-mi">12</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-n">i</span> <span class="tok-o">%</span> <span class="tok-mi">12</span><span class="tok-p">);</span>

        <span class="tok-n">current_key</span><span class="tok-p">[</span><span class="tok-n">i</span> <span class="tok-o">%</span> <span class="tok-mi">12</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">t1_res</span> <span class="tok-o">^</span> <span class="tok-n">t2_res</span><span class="tok-p">)</span> <span class="tok-o">^</span> <span class="tok-n">t3_res</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-kt">void</span> <span class="tok-nf">init_ctx</span><span class="tok-p">(</span><span class="tok-kt">tr_ctx_t</span> <span class="tok-o">*</span> <span class="tok-n">ctx</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span> <span class="tok-n">key</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span>

    <span class="tok-n">memset</span><span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-k">struct</span> <span class="tok-n">tr_ctx</span><span class="tok-p">));</span>

    <span class="tok-cm">/* t6 init */</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span>
        <span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t6_st</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">ctx</span><span class="tok-o">-&gt;</span><span class="tok-n">t6_st</span> <span class="tok-o">+</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">])</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xffff</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-kt">void</span> <span class="tok-nf">decrypt</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">cipher</span><span class="tok-p">,</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">plain</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">size</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">tr_ctx_t</span> <span class="tok-n">ctx</span><span class="tok-p">;</span>
    <span class="tok-n">init_ctx</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ctx</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">uint8_t</span> <span class="tok-o">*</span><span class="tok-p">)</span><span class="tok-n">key</span><span class="tok-p">);</span>
    <span class="tok-n">transputer_0</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">cipher</span><span class="tok-p">,</span> <span class="tok-n">size</span><span class="tok-p">,</span> <span class="tok-n">plain</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">ctx</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-kt">int</span> <span class="tok-nf">self_test</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">count</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">ret</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">i</span><span class="tok-p">;</span>
    <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-s">&quot;*SSTIC-2015*&quot;</span><span class="tok-p">;</span>
    <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">cipher</span> <span class="tok-o">=</span> <span class="tok-s">&quot;</span><span class="tok-se">\x1d\x87\xc4\xc4\xe0\xee\x40\x38\x3c\x59\x44\x7f\x23\x79\x8d\x9f\xef\xe7\x4f\xb8\x24\x80\x76\x6e</span><span class="tok-s">&quot;</span><span class="tok-p">;</span>
    <span class="tok-kt">char</span> <span class="tok-n">plain</span><span class="tok-p">[</span><span class="tok-mi">24</span><span class="tok-p">];</span>
    <span class="tok-kt">int</span> <span class="tok-n">data_size</span> <span class="tok-o">=</span> <span class="tok-mi">24</span><span class="tok-p">;</span>

    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">count</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-n">ret</span> <span class="tok-o">==</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">decrypt</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">cipher</span><span class="tok-p">,</span> <span class="tok-n">plain</span><span class="tok-p">,</span> <span class="tok-n">data_size</span><span class="tok-p">);</span>
        <span class="tok-n">ret</span> <span class="tok-o">=</span> <span class="tok-n">strncmp</span><span class="tok-p">(</span><span class="tok-s">&quot;I love ST20 architecture&quot;</span><span class="tok-p">,</span> <span class="tok-n">plain</span><span class="tok-p">,</span> <span class="tok-n">data_size</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>

    <span class="tok-k">return</span> <span class="tok-n">ret</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-cp">#ifdef _STANDALONE_</span>
<span class="tok-kt">int</span> <span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">argc</span><span class="tok-p">,</span> <span class="tok-kt">char</span> <span class="tok-o">**</span><span class="tok-n">argv</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">self_test</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span> <span class="tok-o">!=</span> <span class="tok-mi">0</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">fprintf</span><span class="tok-p">(</span><span class="tok-n">stderr</span><span class="tok-p">,</span> <span class="tok-s">&quot;self-test failed</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
        <span class="tok-n">exit</span><span class="tok-p">(</span><span class="tok-n">EXIT_FAILURE</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
    <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;[+] self-test passed</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

    <span class="tok-k">return</span> <span class="tok-n">EXIT_SUCCESS</span><span class="tok-p">;</span>
<span class="tok-p">}</span>
<span class="tok-cp">#endif</span></code></pre>
</div>
</div>
<div id="_bf_c" class="listingblock">
<div class="title">bf.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span class="tok-cp">#define _GNU_SOURCE</span>
<span class="tok-cp">#include &lt;stdio.h&gt;</span>
<span class="tok-cp">#include &lt;stdlib.h&gt;</span>
<span class="tok-cp">#include &lt;stdint.h&gt;</span>
<span class="tok-cp">#include &lt;unistd.h&gt;</span>
<span class="tok-cp">#include &lt;openssl/sha.h&gt;</span>
<span class="tok-cp">#include &lt;sys/stat.h&gt;</span>
<span class="tok-cp">#include &lt;fcntl.h&gt;</span>
<span class="tok-cp">#include &lt;string.h&gt;</span>
<span class="tok-cp">#include &lt;omp.h&gt;</span>

<span class="tok-cp">#include &quot;decrypt.h&quot;</span>
<span class="tok-cp">#include &quot;keys.h&quot;</span>

<span class="tok-cp">#define PLAIN_TEXT_LOOKUP_SZ 32</span>

<span class="tok-kt">void</span> <span class="tok-nf">sha256sum</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">data</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">len</span><span class="tok-p">,</span> <span class="tok-kt">char</span> <span class="tok-n">output</span><span class="tok-p">[</span><span class="tok-mi">65</span><span class="tok-p">])</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">hash</span><span class="tok-p">[</span><span class="tok-n">SHA256_DIGEST_LENGTH</span><span class="tok-p">];</span>
    <span class="tok-n">SHA256_CTX</span> <span class="tok-n">sha256</span><span class="tok-p">;</span>
    <span class="tok-n">SHA256_Init</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">sha256</span><span class="tok-p">);</span>
    <span class="tok-n">SHA256_Update</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">sha256</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-p">,</span> <span class="tok-n">len</span><span class="tok-p">);</span>
    <span class="tok-n">SHA256_Final</span><span class="tok-p">(</span><span class="tok-n">hash</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">sha256</span><span class="tok-p">);</span>

    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">SHA256_DIGEST_LENGTH</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">sprintf</span><span class="tok-p">(</span><span class="tok-n">output</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">*</span> <span class="tok-mi">2</span><span class="tok-p">),</span> <span class="tok-s">&quot;%02x&quot;</span><span class="tok-p">,</span> <span class="tok-n">hash</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]);</span>
    <span class="tok-p">}</span>
    <span class="tok-n">output</span><span class="tok-p">[</span><span class="tok-mi">64</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">cipher_sha256</span> <span class="tok-o">=</span> <span class="tok-s">&quot;a5790b4427bc13e4f4e9f524c684809ce96cd2f724e29d94dc999ec25e166a81&quot;</span><span class="tok-p">;</span>
<span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">plain_sha256</span> <span class="tok-o">=</span> <span class="tok-s">&quot;9128135129d2be652809f5a1d337211affad91ed5827474bf9bd7e285ecef321&quot;</span><span class="tok-p">;</span>

<span class="tok-kt">void</span> <span class="tok-nf">bf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">fd</span><span class="tok-p">,</span> <span class="tok-n">ret</span><span class="tok-p">,</span> <span class="tok-n">hcount</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-k">struct</span> <span class="tok-n">stat</span> <span class="tok-n">st</span><span class="tok-p">;</span>
    <span class="tok-kt">off_t</span> <span class="tok-n">size</span><span class="tok-p">;</span>
    <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">cipher_bf</span> <span class="tok-o">=</span> <span class="tok-nb">NULL</span><span class="tok-p">;</span>
    <span class="tok-kt">char</span> <span class="tok-n">sha256</span><span class="tok-p">[</span><span class="tok-mi">65</span><span class="tok-p">];</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-n">keyfound</span><span class="tok-p">;</span>
    <span class="tok-kt">uint8_t</span> <span class="tok-n">hchars</span><span class="tok-p">[</span><span class="tok-mi">4</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">{</span> <span class="tok-sc">&#39;-&#39;</span><span class="tok-p">,</span> <span class="tok-sc">&#39;\\&#39;</span><span class="tok-p">,</span> <span class="tok-sc">&#39;|&#39;</span><span class="tok-p">,</span> <span class="tok-sc">&#39;/&#39;</span> <span class="tok-p">};</span>

    <span class="tok-n">fd</span> <span class="tok-o">=</span> <span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-n">O_RDONLY</span><span class="tok-p">);</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">fd</span> <span class="tok-o">==</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">perror</span><span class="tok-p">(</span><span class="tok-s">&quot;open failed&quot;</span><span class="tok-p">);</span>
        <span class="tok-n">exit</span><span class="tok-p">(</span><span class="tok-n">EXIT_FAILURE</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
    <span class="tok-n">ret</span> <span class="tok-o">=</span> <span class="tok-n">fstat</span><span class="tok-p">(</span><span class="tok-n">fd</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">st</span><span class="tok-p">);</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">ret</span> <span class="tok-o">==</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">perror</span><span class="tok-p">(</span><span class="tok-s">&quot;fstat&quot;</span><span class="tok-p">);</span>
        <span class="tok-n">exit</span><span class="tok-p">(</span><span class="tok-n">EXIT_FAILURE</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
    <span class="tok-n">size</span> <span class="tok-o">=</span> <span class="tok-n">st</span><span class="tok-p">.</span><span class="tok-n">st_size</span><span class="tok-p">;</span>

    <span class="tok-n">cipher_bf</span> <span class="tok-o">=</span> <span class="tok-n">malloc</span><span class="tok-p">(</span><span class="tok-n">size</span><span class="tok-p">);</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">cipher_bf</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">perror</span><span class="tok-p">(</span><span class="tok-s">&quot;malloc cipher&quot;</span><span class="tok-p">);</span>
        <span class="tok-k">goto</span> <span class="tok-n">finish</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>

    <span class="tok-n">ret</span> <span class="tok-o">=</span> <span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">fd</span><span class="tok-p">,</span> <span class="tok-n">cipher_bf</span><span class="tok-p">,</span> <span class="tok-n">size</span><span class="tok-p">);</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">ret</span> <span class="tok-o">!=</span> <span class="tok-n">size</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;error during read</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
        <span class="tok-k">goto</span> <span class="tok-n">finish</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-n">close</span><span class="tok-p">(</span><span class="tok-n">fd</span><span class="tok-p">);</span>

    <span class="tok-n">sha256sum</span><span class="tok-p">(</span><span class="tok-n">cipher_bf</span><span class="tok-p">,</span> <span class="tok-n">size</span><span class="tok-p">,</span> <span class="tok-n">sha256</span><span class="tok-p">);</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">strcmp</span><span class="tok-p">(</span><span class="tok-n">sha256</span><span class="tok-p">,</span> <span class="tok-n">cipher_sha256</span><span class="tok-p">)</span> <span class="tok-o">!=</span> <span class="tok-mi">0</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;wrong sha256: %s</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-n">sha256</span><span class="tok-p">);</span>
        <span class="tok-k">goto</span> <span class="tok-n">finish</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
<span class="tok-cp">#pragma omp parallel</span>
    <span class="tok-p">{</span>
<span class="tok-cp">#pragma omp barrier</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">omp_get_thread_num</span><span class="tok-p">()</span> <span class="tok-o">==</span> <span class="tok-mi">0</span><span class="tok-p">)</span>
            <span class="tok-n">fprintf</span><span class="tok-p">(</span><span class="tok-n">stderr</span><span class="tok-p">,</span> <span class="tok-s">&quot;[+] starting %d threads</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-n">omp_get_num_threads</span><span class="tok-p">());</span>
    <span class="tok-p">}</span>

    <span class="tok-n">keyfound</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;[+] testing %d keys</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-n">KEYS_COUNT</span><span class="tok-p">);</span>
<span class="tok-cp">#pragma omp parallel</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">KEYS_COUNT</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">key</span><span class="tok-p">;</span>
        <span class="tok-kt">int</span> <span class="tok-n">j</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">l</span><span class="tok-p">,</span> <span class="tok-n">out_fd</span><span class="tok-p">,</span> <span class="tok-n">thread_id</span><span class="tok-p">;</span>
        <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">plain_bf</span> <span class="tok-o">=</span> <span class="tok-nb">NULL</span><span class="tok-p">;</span>
        <span class="tok-kt">char</span> <span class="tok-n">plain_text_lookup</span><span class="tok-p">[</span><span class="tok-n">PLAIN_TEXT_LOOKUP_SZ</span><span class="tok-p">];</span>
        <span class="tok-kt">char</span> <span class="tok-n">sha256</span><span class="tok-p">[</span><span class="tok-mi">65</span><span class="tok-p">];</span>

        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">keyfound</span> <span class="tok-o">==</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-n">KEYS_COUNT</span><span class="tok-p">;</span>
            <span class="tok-k">continue</span><span class="tok-p">;</span>
        <span class="tok-p">}</span>
        <span class="tok-n">key</span> <span class="tok-o">=</span> <span class="tok-n">keys</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">];</span>

        <span class="tok-n">thread_id</span> <span class="tok-o">=</span> <span class="tok-n">omp_get_thread_num</span><span class="tok-p">();</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">thread_id</span> <span class="tok-o">==</span> <span class="tok-mi">0</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-n">fprintf</span><span class="tok-p">(</span><span class="tok-n">stderr</span><span class="tok-p">,</span> <span class="tok-s">&quot;</span><span class="tok-se">\r</span><span class="tok-s">[%c] key = &quot;</span><span class="tok-p">,</span> <span class="tok-n">hchars</span><span class="tok-p">[</span><span class="tok-n">hcount</span><span class="tok-o">++</span> <span class="tok-o">%</span> <span class="tok-mi">4</span><span class="tok-p">]);</span>
            <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">l</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">l</span> <span class="tok-o">&lt;</span> <span class="tok-mi">10</span><span class="tok-p">;</span> <span class="tok-n">l</span><span class="tok-o">++</span><span class="tok-p">)</span>
                <span class="tok-n">fprintf</span><span class="tok-p">(</span><span class="tok-n">stderr</span><span class="tok-p">,</span> <span class="tok-s">&quot;%2.2x&quot;</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-n">l</span><span class="tok-p">]</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xff</span><span class="tok-p">);</span>
            <span class="tok-n">fprintf</span><span class="tok-p">(</span><span class="tok-n">stderr</span><span class="tok-p">,</span> <span class="tok-s">&quot;????&quot;</span><span class="tok-p">);</span>
            <span class="tok-n">fflush</span><span class="tok-p">(</span><span class="tok-n">stderr</span><span class="tok-p">);</span>
        <span class="tok-p">}</span>

        <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">j</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">j</span> <span class="tok-o">&lt;</span> <span class="tok-mi">256</span><span class="tok-p">;</span> <span class="tok-n">j</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
            <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-mi">10</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">j</span><span class="tok-p">;</span>

            <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">k</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">k</span> <span class="tok-o">&lt;</span> <span class="tok-mi">256</span><span class="tok-p">;</span> <span class="tok-n">k</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
                <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-mi">11</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">k</span><span class="tok-p">;</span>

                <span class="tok-n">decrypt</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">cipher_bf</span><span class="tok-p">,</span> <span class="tok-n">plain_text_lookup</span><span class="tok-p">,</span> <span class="tok-n">PLAIN_TEXT_LOOKUP_SZ</span><span class="tok-p">);</span>

                <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">memmem</span><span class="tok-p">(</span><span class="tok-n">plain_text_lookup</span><span class="tok-p">,</span> <span class="tok-n">PLAIN_TEXT_LOOKUP_SZ</span><span class="tok-p">,</span>
                            <span class="tok-s">&quot;</span><span class="tok-se">\xFF\xFF\xFF\xFF</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">))</span>
                    <span class="tok-k">continue</span><span class="tok-p">;</span>

                <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">plain_bf</span><span class="tok-p">)</span>
                    <span class="tok-n">plain_bf</span> <span class="tok-o">=</span> <span class="tok-n">malloc</span><span class="tok-p">(</span><span class="tok-n">size</span><span class="tok-p">);</span>

                <span class="tok-n">decrypt</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span> <span class="tok-n">cipher_bf</span><span class="tok-p">,</span> <span class="tok-n">plain_bf</span><span class="tok-p">,</span> <span class="tok-n">size</span><span class="tok-p">);</span>
                <span class="tok-n">sha256sum</span><span class="tok-p">(</span><span class="tok-n">plain_bf</span><span class="tok-p">,</span> <span class="tok-n">size</span><span class="tok-p">,</span> <span class="tok-n">sha256</span><span class="tok-p">);</span>

                <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">strncmp</span><span class="tok-p">(</span><span class="tok-n">sha256</span><span class="tok-p">,</span> <span class="tok-n">plain_sha256</span><span class="tok-p">,</span> <span class="tok-mi">64</span><span class="tok-p">))</span>
<span class="tok-cp">#pragma omp critical</span>
                <span class="tok-p">{</span>
                    <span class="tok-n">keyfound</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
                    <span class="tok-n">fprintf</span><span class="tok-p">(</span><span class="tok-n">stderr</span><span class="tok-p">,</span> <span class="tok-s">&quot;</span><span class="tok-se">\r</span><span class="tok-s">[!] key = &quot;</span><span class="tok-p">);</span>
                    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">l</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">l</span> <span class="tok-o">&lt;</span> <span class="tok-mi">12</span><span class="tok-p">;</span> <span class="tok-n">l</span><span class="tok-o">++</span><span class="tok-p">)</span>
                        <span class="tok-n">fprintf</span><span class="tok-p">(</span><span class="tok-n">stderr</span><span class="tok-p">,</span> <span class="tok-s">&quot;%2.2x&quot;</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">[</span><span class="tok-n">l</span><span class="tok-p">]</span> <span class="tok-o">&amp;</span> <span class="tok-mh">0xff</span><span class="tok-p">);</span>

                    <span class="tok-n">fprintf</span><span class="tok-p">(</span><span class="tok-n">stderr</span><span class="tok-p">,</span> <span class="tok-s">&quot;</span><span class="tok-se">\n</span><span class="tok-s">[+] result saved in congratulations.tar.bz2</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
                    <span class="tok-n">out_fd</span> <span class="tok-o">=</span> <span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s">&quot;congratulations.tar.bz2&quot;</span><span class="tok-p">,</span> <span class="tok-n">O_WRONLY</span> <span class="tok-o">|</span> <span class="tok-n">O_CREAT</span><span class="tok-p">,</span>
                            <span class="tok-n">S_IRUSR</span> <span class="tok-o">|</span> <span class="tok-n">S_IWUSR</span><span class="tok-p">);</span>
                    <span class="tok-n">ret</span> <span class="tok-o">=</span> <span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">out_fd</span><span class="tok-p">,</span> <span class="tok-n">plain_bf</span><span class="tok-p">,</span> <span class="tok-n">size</span><span class="tok-p">);</span>
                    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">ret</span> <span class="tok-o">!=</span> <span class="tok-n">size</span><span class="tok-p">)</span>
                        <span class="tok-n">perror</span><span class="tok-p">(</span><span class="tok-s">&quot;write:&quot;</span><span class="tok-p">);</span>
                    <span class="tok-n">close</span><span class="tok-p">(</span><span class="tok-n">out_fd</span><span class="tok-p">);</span>
                <span class="tok-p">}</span>
            <span class="tok-p">}</span>
        <span class="tok-p">}</span>
    <span class="tok-p">}</span>

<span class="tok-nl">finish</span><span class="tok-p">:</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">cipher_bf</span><span class="tok-p">)</span>
        <span class="tok-n">free</span><span class="tok-p">(</span><span class="tok-n">cipher_bf</span><span class="tok-p">);</span>
<span class="tok-p">}</span>

<span class="tok-kt">int</span> <span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">argc</span><span class="tok-p">,</span> <span class="tok-kt">char</span> <span class="tok-o">**</span><span class="tok-n">argv</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">self_test</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span> <span class="tok-o">!=</span> <span class="tok-mi">0</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">fprintf</span><span class="tok-p">(</span><span class="tok-n">stderr</span><span class="tok-p">,</span> <span class="tok-s">&quot;self-test failed</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
        <span class="tok-n">exit</span><span class="tok-p">(</span><span class="tok-n">EXIT_FAILURE</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
    <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;[+] self-test passed</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">argc</span> <span class="tok-o">!=</span> <span class="tok-mi">2</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;usage: %s encrypted.bin</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span> <span class="tok-n">argv</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]);</span>
        <span class="tok-n">exit</span><span class="tok-p">(</span><span class="tok-n">EXIT_FAILURE</span><span class="tok-p">);</span>
    <span class="tok-p">}</span>
    <span class="tok-n">bf</span><span class="tok-p">(</span><span class="tok-n">argv</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]);</span>

    <span class="tok-k">return</span> <span class="tok-n">EXIT_SUCCESS</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stage_6">Stage 6</h3>
<div id="_parse_tiff_rb" class="listingblock">
<div class="title">parse_tiff.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span class="tok-c1">#!/usr/bin/env ruby</span>

<span class="tok-k">def</span> <span class="tok-nf">read_byte</span>
  <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-vg">$data</span><span class="tok-o">[</span><span class="tok-vg">$offset</span><span class="tok-o">]</span>
  <span class="tok-vg">$offset</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span>
  <span class="tok-k">return</span> <span class="tok-n">b</span>
<span class="tok-k">end</span>

<span class="tok-k">def</span> <span class="tok-nf">read_word</span>
  <span class="tok-n">dword</span> <span class="tok-o">=</span> <span class="tok-vg">$data</span><span class="tok-o">[</span><span class="tok-vg">$offset</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-o">]</span>
  <span class="tok-n">dword</span> <span class="tok-o">=</span> <span class="tok-n">dword</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;S&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">first</span>
  <span class="tok-vg">$offset</span> <span class="tok-o">+=</span> <span class="tok-mi">2</span>
  <span class="tok-k">return</span> <span class="tok-n">dword</span>
<span class="tok-k">end</span>

<span class="tok-k">def</span> <span class="tok-nf">read_dword</span>
  <span class="tok-n">word</span> <span class="tok-o">=</span> <span class="tok-vg">$data</span><span class="tok-o">[</span><span class="tok-vg">$offset</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-o">]</span>
  <span class="tok-n">word</span> <span class="tok-o">=</span> <span class="tok-n">word</span><span class="tok-o">.</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-s1">&#39;L&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">first</span>
  <span class="tok-vg">$offset</span> <span class="tok-o">+=</span> <span class="tok-mi">4</span>
  <span class="tok-k">return</span> <span class="tok-n">word</span>
<span class="tok-k">end</span>

<span class="tok-k">def</span> <span class="tok-nf">read_bytes</span><span class="tok-p">(</span><span class="tok-n">n</span><span class="tok-p">)</span>
  <span class="tok-n">bytes</span> <span class="tok-o">=</span> <span class="tok-vg">$data</span><span class="tok-o">[</span><span class="tok-vg">$offset</span><span class="tok-p">,</span> <span class="tok-n">n</span><span class="tok-o">]</span>
  <span class="tok-vg">$offset</span> <span class="tok-o">+=</span> <span class="tok-n">n</span>
  <span class="tok-k">return</span> <span class="tok-n">bytes</span>
<span class="tok-k">end</span>

<span class="tok-no">TAG_TO_ASCII</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
  <span class="tok-mi">256</span> <span class="tok-o">=&gt;</span> <span class="tok-s2">&quot;ImageWidth&quot;</span><span class="tok-p">,</span>
  <span class="tok-mi">257</span> <span class="tok-o">=&gt;</span> <span class="tok-s2">&quot;ImageLength&quot;</span><span class="tok-p">,</span>
  <span class="tok-mi">258</span> <span class="tok-o">=&gt;</span> <span class="tok-s2">&quot;BitsPerSample&quot;</span><span class="tok-p">,</span>
  <span class="tok-mi">259</span> <span class="tok-o">=&gt;</span> <span class="tok-s2">&quot;Compression&quot;</span><span class="tok-p">,</span>
  <span class="tok-mi">262</span> <span class="tok-o">=&gt;</span> <span class="tok-s2">&quot;PhotometricInterpretation&quot;</span><span class="tok-p">,</span>
  <span class="tok-mi">273</span> <span class="tok-o">=&gt;</span> <span class="tok-s2">&quot;StripOffsets&quot;</span><span class="tok-p">,</span>
  <span class="tok-mi">277</span> <span class="tok-o">=&gt;</span> <span class="tok-s2">&quot;SamplesPerPixel&quot;</span><span class="tok-p">,</span>
  <span class="tok-mi">278</span> <span class="tok-o">=&gt;</span> <span class="tok-s2">&quot;RowsPerStrip&quot;</span><span class="tok-p">,</span>
  <span class="tok-mi">279</span> <span class="tok-o">=&gt;</span> <span class="tok-s2">&quot;StripByteCounts&quot;</span>
<span class="tok-p">}</span>

<span class="tok-k">if</span> <span class="tok-no">ARGV</span><span class="tok-o">.</span><span class="tok-n">size</span> <span class="tok-o">!=</span> <span class="tok-mi">1</span>
  <span class="tok-vg">$stderr</span><span class="tok-o">.</span><span class="tok-n">puts</span> <span class="tok-s2">&quot;usage: </span><span class="tok-si">#{</span><span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">basename</span><span class="tok-p">(</span><span class="tok-bp">__FILE__</span><span class="tok-p">)</span><span class="tok-si">}</span><span class="tok-s2"> image.tiff&quot;</span>
  <span class="tok-nb">exit</span>
<span class="tok-k">end</span>

<span class="tok-vg">$data</span> <span class="tok-o">=</span> <span class="tok-no">File</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-no">ARGV</span><span class="tok-o">.</span><span class="tok-n">shift</span><span class="tok-p">,</span> <span class="tok-s2">&quot;rb&quot;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">read</span>
<span class="tok-vg">$offset</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>

<span class="tok-n">magic</span> <span class="tok-o">=</span> <span class="tok-n">read_bytes</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span>
<span class="tok-k">raise</span> <span class="tok-k">unless</span> <span class="tok-n">magic</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;II&quot;</span>

<span class="tok-n">number</span> <span class="tok-o">=</span> <span class="tok-n">read_word</span>
<span class="tok-k">raise</span> <span class="tok-k">unless</span> <span class="tok-n">number</span> <span class="tok-o">==</span> <span class="tok-mi">42</span>

<span class="tok-n">ifd_offset</span> <span class="tok-o">=</span> <span class="tok-n">read_word</span>

<span class="tok-vg">$offset</span> <span class="tok-o">=</span> <span class="tok-n">ifd_offset</span>

<span class="tok-n">num_dir_entry</span> <span class="tok-o">=</span> <span class="tok-n">read_word</span>

<span class="tok-n">num_dir_entry</span><span class="tok-o">.</span><span class="tok-n">times</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">i</span><span class="tok-o">|</span>
  <span class="tok-n">tag</span> <span class="tok-o">=</span> <span class="tok-n">read_word</span>
  <span class="tok-n">type</span> <span class="tok-o">=</span> <span class="tok-n">read_word</span>
  <span class="tok-n">count</span> <span class="tok-o">=</span> <span class="tok-n">read_dword</span>
  <span class="tok-n">offset</span> <span class="tok-o">=</span> <span class="tok-n">read_dword</span>

  <span class="tok-nb">puts</span> <span class="tok-s2">&quot;[</span><span class="tok-si">#{</span><span class="tok-n">i</span><span class="tok-si">}</span><span class="tok-s2">] tag: %s, type: %d, count: %d, offset: %d&quot;</span> <span class="tok-o">%</span> <span class="tok-o">[</span> <span class="tok-no">TAG_TO_ASCII</span><span class="tok-o">[</span><span class="tok-n">tag</span><span class="tok-o">]</span> <span class="tok-o">||</span> <span class="tok-s2">&quot;</span><span class="tok-si">#{</span><span class="tok-n">tag</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">,</span> <span class="tok-n">type</span><span class="tok-p">,</span> <span class="tok-n">count</span><span class="tok-p">,</span> <span class="tok-n">offset</span> <span class="tok-o">]</span>
<span class="tok-k">end</span>

<span class="tok-n">next_ifd</span> <span class="tok-o">=</span> <span class="tok-n">read_dword</span>
<span class="tok-k">if</span> <span class="tok-n">next_ifd</span> <span class="tok-o">==</span> <span class="tok-mi">0</span>
  <span class="tok-nb">puts</span> <span class="tok-s2">&quot;No other IFD&quot;</span>
<span class="tok-k">end</span>

<span class="tok-nb">puts</span> <span class="tok-s2">&quot;offset = %d&quot;</span> <span class="tok-o">%</span> <span class="tok-vg">$offset</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2015-06-06 13:19:05 CEST
</div>
</div>
</body>
</html>
